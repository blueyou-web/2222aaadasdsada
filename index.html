<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysium: OC Community</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #0a0a0a;
            color: #e5e5e5;
            font-family: 'ui-sans-serif', system-ui, sans-serif;
            overflow: hidden;
        }
        .font-serif { font-family: 'Noto Serif KR', serif; }
        
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1a1a1a; border-radius: 10px; }
        
        /* Transitions */
        @keyframes viewEnter {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes viewExit {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-15px); }
        }
        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .view-enter { animation: viewEnter 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .view-exit { animation: viewExit 0.3s ease-in forwards; }
        .modal-enter { animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        .sidebar-btn.active {
            background-color: #d97706;
            color: white;
            box-shadow: 0 10px 20px -5px rgba(146, 64, 14, 0.5);
            transform: translateX(5px);
        }

        .chat-bubble-mine {
            background: linear-gradient(135deg, #d97706, #b45309);
            color: white;
            border-bottom-right-radius: 0;
        }
        .chat-bubble-theirs {
            background-color: #1f1f1f;
            color: #d4d4d4;
            border-bottom-left-radius: 0;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #oc-large-image {
            mask-image: linear-gradient(to left, black 70%, transparent 100%);
            filter: drop-shadow(0 0 100px rgba(0,0,0,1));
        }

        .new-badge {
            background-color: #ef4444;
            color: white;
            font-size: 8px;
            font-weight: 900;
            padding: 2px 5px;
            border-radius: 4px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        #auth-view {
    background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
    background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); /* ë³„ê°€ë£¨ íš¨ê³¼ */
}

.auth-card {
    background: rgba(15, 15, 15, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 2rem;
}

.auth-input {
    background: #050505 !important;
    border: 1px solid #1a1a1a !important;
    color: white !important;
    transition: all 0.3s ease;
}

.auth-input:focus {
    border-color: #d97706 !important;
    box-shadow: 0 0 15px rgba(217, 119, 6, 0.2);
}

.btn-initialize {
    background: #d97706 !important;
    color: white !important;
    font-weight: 800 !important;
    letter-spacing: 0.1em;
    box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
}

.btn-initialize:hover {
    background: #b45309 !important;
    transform: translateY(-1px);
}
.auth-bg-overlay {
    position: fixed;
    inset: 0;
    z-index: -1; /* ë¡œê·¸ì¸ì°½ë³´ë‹¤ ë’¤ì— ìœ„ì¹˜ */
    background-size: cover;
    background-position: center;
    filter: grayscale(100%) blur(10px) brightness(0.3); /* ê·¸ë ˆì´ + ë¸”ëŸ¬ + ì–´ë‘¡ê²Œ */
    transition: background-image 0.5s ease;
}
.new-badge {
    background: #d97706; /* amber-600 */
    color: white;
    font-size: 8px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    letter-spacing: 0.05em;
    box-shadow: 0 0 10px rgba(217, 119, 6, 0.5);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}
/* ì¡°ì‚¬ ê°€ëŠ¥ ì—¬ë¶€ í…ìŠ¤íŠ¸ ê°•ì¡° */
.status-text {
    font-size: 1.25rem; /* 20px ì •ë„ë¡œ í¬ê²Œ ì„¤ì • */
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -0.02em;
}

.new-badge {
    background: #ef4444;
    color: white;
    font-size: 9px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    animation: pulse 2s infinite;
}
    </style>
</head>
<body>

    <!-- ì´ˆê¸° ë¡œë”© ìŠ¤í¬ë¦° -->
    <div id="loading-overlay" class="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center space-y-4 transition-opacity duration-1000">
        <div class="w-16 h-[2px] bg-amber-500 animate-pulse"></div>
        <p class="text-amber-500 font-mono text-[10px] tracking-[0.5em] uppercase">Connecting to Elysium</p>
    </div>

    <div id="app-container" class="flex h-screen w-full opacity-0 transition-opacity duration-1000">
        
        <!-- Authentication Gate -->
        <div id="auth-view" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center p-6">
    
    <div id="auth-dynamic-bg" class="auth-bg-overlay"></div>
    
    <div class="text-center mb-10 animate-fade-in relative z-10">
        <div class="w-16 h-16 bg-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-[0_0_30px_rgba(217,119,6,0.4)]">
            <i data-lucide="layers" class="w-8 h-8 text-white"></i>
        </div>
        <h1 class="text-4xl font-serif font-black text-white tracking-[0.2em] uppercase mb-1">ELYSIUM</h1>
        <p class="text-[9px] text-amber-500/60 font-mono tracking-[0.4em] uppercase">Secure Archive System</p>
    </div>

    <div class="w-full max-w-[400px] auth-card p-10 space-y-8 modal-enter">
        <div class="space-y-6">
            <div class="space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Identify</label>
                <div class="relative">
                    <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-600"></i>
                    <input id="auth-id" type="text" placeholder="ERA ID" class="auth-input w-full rounded-xl pl-12 pr-6 py-4 text-sm outline-none">
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Access Key</label>
                <div class="relative">
                    <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-600"></i>
                    <input id="auth-pw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="auth-input w-full rounded-xl pl-12 pr-6 py-4 text-sm outline-none">
                </div>
            </div>

            <div id="signup-extra" class="hidden space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Personnel Name</label>
                <input id="auth-oc-name" type="text" placeholder="CHARACTER NAME" class="auth-input w-full rounded-xl px-6 py-4 text-sm outline-none">
            </div>
        </div>

        <button id="auth-submit-btn" class="btn-initialize w-full py-4 rounded-xl text-xs uppercase transition-all active:scale-95">
            Initialize Session
        </button>

        <div class="text-center">
            <button id="auth-toggle-btn" class="text-[9px] text-neutral-600 hover:text-amber-500 transition-colors uppercase tracking-[0.2em]">
                Request New Identity
            </button>
        </div>
    </div>

    <div class="mt-12 text-center opacity-30">
        <p class="text-[8px] text-neutral-500 font-mono tracking-widest uppercase">Secure Connection Established</p>
        <p class="text-[8px] text-neutral-600 font-mono mt-1">Ver 2.5.0 // ELYSIUM SYSTEM</p>
    </div>
</div>

        <!-- Sidebar -->
        <nav class="w-20 lg:w-64 border-r border-white/5 flex flex-col bg-neutral-950 z-50">
            <div class="p-8 flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-amber-600 rounded-xl flex items-center justify-center shrink-0 shadow-lg shadow-amber-900/30">
                    <i data-lucide="layers" class="w-6 h-6 text-white"></i>
                </div>
                <h1 class="text-sm font-black tracking-[0.4em] text-white hidden lg:block uppercase">Elysium</h1>
            </div>
            
            <div class="flex-1 px-4 py-4 space-y-2 overflow-y-auto" id="sidebar-nav"></div>

            <div class="p-6 border-t border-white/5 bg-black/20">
                <div class="bg-neutral-900/50 p-4 rounded-3xl flex items-center gap-3 border border-white/5 hover:border-amber-500/30 transition-all">
                    <div class="w-10 h-10 rounded-xl bg-black overflow-hidden border border-white/10 shrink-0 shadow-lg cursor-pointer transition-transform active:scale-90" onclick="switchView('profile')">
                        <img id="user-avatar" src="" class="w-full h-full object-cover hidden">
                        <div id="user-avatar-placeholder" class="w-full h-full flex items-center justify-center bg-neutral-800"><i data-lucide="user" class="w-5 h-5 text-neutral-500"></i></div>
                    </div>
                    <div class="hidden lg:block overflow-hidden flex-1">
                        <p id="user-name-display" class="text-[11px] font-black text-white truncate">Personnel</p>
                        <p id="user-id-display" class="text-[9px] text-amber-500 font-mono uppercase truncate">Guest</p>
                    </div>
                    <button onclick="handleLogout()" class="p-2 text-neutral-600 hover:text-red-500 transition-all" title="Logout">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col relative bg-neutral-950 overflow-hidden">
            <div id="content-area" class="flex-1 relative flex flex-col h-full overflow-y-auto"></div>
        </main>
<div id="discovery-panel" class="hidden fixed inset-0 z-[160] flex flex-col justify-end pointer-events-none transition-all duration-500">
    
    <div class="absolute inset-0 flex justify-center items-end pointer-events-none overflow-hidden">
        <img id="discovery-npc" src="" class="h-[90vh] w-auto object-contain transition-all duration-1000 opacity-0 transform translate-y-20 scale-105">
    </div>

    <div class="w-full h-2/3 bg-gradient-to-t from-black via-black/40 to-transparent absolute bottom-0"></div>
    
    <div class="relative z-10 w-full max-w-6xl mx-auto px-12 pb-16 pointer-events-auto">
        <div class="space-y-6">
            <div id="discovery-name-box" class="inline-flex items-center gap-3">
                <span class="w-1 h-6 bg-amber-500"></span>
                <p id="discovery-name" class="text-amber-500 text-lg font-black tracking-widest uppercase italic drop-shadow-md">Name</p>
            </div>
            
            <div class="relative group">
                <p id="discovery-clue" class="text-white text-2xl md:text-3xl font-serif leading-relaxed break-keep drop-shadow-2xl max-w-4xl transition-all duration-300">
                    ëŒ€ì‚¬ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>

            <div id="discovery-options" class="flex flex-col gap-3 mt-10 w-fit"></div>

            <div class="flex justify-between items-center pt-8 border-t border-white/10 mt-6">
                <div class="text-white/20 text-[10px] tracking-[0.8em] font-bold uppercase">Investigation System v3.0</div>
                <button id="discovery-next-btn" class="group flex items-center gap-4 text-white hover:text-amber-500 transition-all">
                    <span class="text-[10px] font-black tracking-widest uppercase opacity-40 group-hover:opacity-100">Click to Continue</span>
                    <i data-lucide="chevron-right" class="w-5 h-5 animate-pulse"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="poi-editor-modal" class="hidden fixed inset-0 z-[170] bg-black/95 flex items-center justify-center p-6 backdrop-blur-md">
    <div class="w-full max-w-2xl bg-neutral-900 border border-white/10 rounded-[2.5rem] p-8 shadow-2xl flex flex-col max-h-[90vh]">
        <h3 class="text-xl font-black text-white mb-6 uppercase tracking-widest border-b border-white/5 pb-4 flex justify-between items-center">
            Scenario Builder
            <span class="text-[10px] text-amber-500 font-normal">ë¸”ë¡ì„ ì¶”ê°€í•˜ì—¬ íë¦„ì„ ë§Œë“œì„¸ìš”</span>
        </h3>
        
        <div class="mb-4">
            <label class="text-[10px] text-neutral-500 font-bold uppercase ml-1">ì§€ì  íƒ€ì´í‹€</label>
            <input id="edit-poi-title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-white text-sm mt-1 outline-none focus:border-amber-500">
        </div>

        <div id="timeline-container" class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-3 min-h-[300px]">
            </div>

        <div class="grid grid-cols-3 gap-2 mt-6 p-4 bg-white/5 rounded-2xl border border-white/5">
            <button onclick="addTimelineBlock('npc')" class="py-3 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 text-[10px] font-black rounded-xl border border-blue-600/30 transition-all">+ NPC ëŒ€ì‚¬ ì¶”ê°€</button>
            <button onclick="addTimelineBlock('monologue')" class="py-3 bg-purple-600/20 hover:bg-purple-600/40 text-purple-400 text-[10px] font-black rounded-xl border border-purple-600/30 transition-all">+ ë‚˜ì˜ ë…ë°± ì¶”ê°€</button>
            <button onclick="addTimelineBlock('choice')" class="py-3 bg-amber-600/20 hover:bg-amber-600/40 text-amber-400 text-[10px] font-black rounded-xl border border-amber-600/30 transition-all">+ ì„ íƒì§€ ì¶”ê°€</button>
        </div>

        <div class="flex gap-3 mt-6">
            <button onclick="savePOITimeline()" class="flex-1 py-4 bg-amber-600 text-white font-black rounded-xl text-[10px] uppercase shadow-xl hover:bg-amber-700">Save Scenario</button>
            <button onclick="document.getElementById('poi-editor-modal').classList.add('hidden')" class="px-8 py-4 bg-neutral-800 text-neutral-500 font-bold rounded-xl text-[10px] uppercase">Cancel</button>
        </div>
    </div>
</div>
        <!-- Toast -->
        <div id="toast" class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 z-[150]">
            <div class="bg-amber-600 text-white px-8 py-4 rounded-2xl shadow-2xl font-black text-[10px] tracking-widest uppercase flex items-center gap-3 border border-amber-400/20 modal-enter">
                <i data-lucide="shield" class="w-4 h-4"></i>
                <span id="toast-message">Notification</span>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
<audio id="noti-sound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc, deleteDoc, writeBatch, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7XJPpZzfDbdDCsbzMVO9HTZqrpUlMX-Y",
            authDomain: "macol-acead.firebaseapp.com",
            projectId: "macol-acead",
            storageBucket: "macol-acead.firebasestorage.app",
            messagingSenderId: "231346298031",
            appId: "1:231346298031:web:3982e3b72e7214d177485a"
        };
        const appId = "oc-community-html-v6";
        const ADMIN_PW = "admin1234";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // dbì™€ authë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (Combat Skills í¸ì§‘ê¸°ì—ì„œ ì‚¬ìš©)
        window.db = db;
        window.auth = auth;
        
        // Firestore í•¨ìˆ˜ë“¤ë„ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        window.collection = collection;
        window.doc = doc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.writeBatch = writeBatch;
        window.setDoc = setDoc;

        const $ = (id) => document.getElementById(id);

        // --- Global State ---
        let state = {
            user: null,
            userAccount: null,
            accounts: [],
            chatRooms: [],
            messages: [],
            currentView: 'home',
            authMode: 'login',
            isAdmin: false,
            selectedRoomId: null,
            initDone: false,
            world: {
                title: "REVERSE: 1999 STYLE HUB",
                description: "Keep moving forward."
            },
            investigation: {
    selectedSector: null, // í˜„ì¬ ìœ ì €ê°€ ë“¤ì–´ê°„ êµ¬ì—­ ID
        foundClueIds: [],      // ìœ ì €ê°€ ë°œê²¬í•œ ë‹¨ì„œë“¤
        logs: [],
        viewedClueIds: [],     // ì „ë¬¸ì„ í™•ì¸í•œ ë‹¨ì„œë“¤ (NEW í‘œì‹œ ì œê±°ìš©)
        sectors: [
            { id: 'academy', name: 'ì•„ì¹´ë°ë¯¸', map: 'https://images.unsplash.com/photo-1523050853061-80e8a4ff147e?q=80&w=2000', desc: 'ê¸ˆì§€ëœ ì§€ì‹ì´ ì ë“  ê³³', unlockDate: '11ì›” 12ì¼', isAvailable: true },
            { id: 'forest', name: 'ìˆ²', map: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2000', desc: 'ê¸°ì²™ì´ ì‚¬ë¼ì§„ íƒœê³ ì˜ ìˆ²', unlockDate: '11ì›” 14ì¼', isAvailable: false },
            { id: 'lake', name: 'í˜¸ìˆ˜', map: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2000', desc: 'ë¹„ëª…ì„ ì‚¼í‚¨ ê³ ìš”í•œ ìˆ˜ë©´', unlockDate: '11ì›” 15ì¼', isAvailable: false }
        ],
        points: [
            // sector í•„ë“œë¥¼ ì¶”ê°€í•˜ì—¬ ê° êµ¬ì—­ì— ë§ê²Œ ë°°ì¹˜í•©ë‹ˆë‹¤.
            { id: 'p1', sector: 'academy', x: 25, y: 40, title: 'Old Harbor', clue: 'í•­êµ¬ ì°½ê³  ë’¤ì—ì„œ ì –ì€ ìª½ì§€ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.' },
            { id: 'p2', sector: 'forest', x: 60, y: 30, title: 'Central Tower', clue: 'íƒ€ì›Œ í†µì œì‹¤ ë‹¨ë§ê¸°ì—ì„œ ë¡œê·¸ë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.' }
        ]
    }
};
window.state = state;

        // --- App Lifecycle ---
        window.addEventListener('DOMContentLoaded', () => {
    initAuth();
    setupAuthEvents();
    
    // ì•ˆì „í•˜ê²Œ ìš”ì†Œë¥¼ ì°¾ì•„ì„œ ìˆì„ ë•Œë§Œ ì´ë²¤íŠ¸ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
    const adminTrigger = document.getElementById('admin-mode-trigger');
    if (adminTrigger) {
        adminTrigger.onclick = () => {
            const authView = document.getElementById('auth-view');
            if (authView) authView.classList.add('hidden');
            switchView('admin');
        };
    }
});
function getURLParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        userId: params.get('userId'),
        fromHomepage: params.get('fromHomepage') === 'true'
    };
}

const urlParams = getURLParams();
        async function initAuth() {
            onAuthStateChanged(auth, async (user) => {
                state.user = user;
                if (user) {
                    subscribeToData();
                } else {
                    hideLoading();
                    showAuthGate();
                }
            });

            if (!auth.currentUser) {
                try { await signInAnonymously(auth); } catch(e) { hideLoading(); showAuthGate(); }
            }
        }

        function hideLoading() {
            const overlay = $('loading-overlay');
            if (overlay) { overlay.style.opacity = '0'; setTimeout(() => overlay.classList.add('hidden'), 1000); }
            $('app-container').classList.remove('opacity-0');
        }

function subscribeToData() {
    const accountsRef = collection(db, 'artifacts', appId, 'public', 'data', 'accounts');
    const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms');
    const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
    const reportsRef = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
    const notiRef = collection(db, 'artifacts', appId, 'public', 'data', 'notifications');

    const loadTime = Date.now() / 1000;

    // 1. ì›”ë“œ & ìŠ¤í† ë¦¬
    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world'), (docSnap) => {
    if (docSnap.exists()) {
        const fetchedData = docSnap.data();
        
        // [í•µì‹¬] ì„œë²„ ë°ì´í„°ë¥¼ ë¡œì»¬ stateì— ë³µì‚¬
        state.world = { ...state.world, ...fetchedData };
        
        // [ì¤‘ìš”] ì¡°ì‚¬ ë°ì´í„°(í¬ì¸íŠ¸, ë°°ê²½, ìë¬¼ì‡ )ê°€ ì„œë²„ì— ìˆìœ¼ë©´ ë®ì–´ì”Œì›€
        if (fetchedData.investigation) {
            state.investigation = { 
                ...state.investigation, 
                ...fetchedData.investigation 
            };
        }
        
        console.log("âœ… ì„œë²„ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ:", state.investigation);
    }
    if (!state.world.classes) {
    state.world.classes = [
        { code: 'VANGUARD', name: 'VANGUARD', color: '#dc2626' }, // ë¹¨ê°•
        { code: 'SNIPER', name: 'SNIPER', color: '#ea580c' },   // ì£¼í™©
        { code: 'CASTER', name: 'CASTER', color: '#7c3aed' },   // ë³´ë¼
        { code: 'MEDIC', name: 'MEDIC', color: '#16a34a' },     // ì´ˆë¡
        { code: 'GUARD', name: 'GUARD', color: '#2563eb' },     // íŒŒë‘
        { code: 'SPECIALIST', name: 'SPECIALIST', color: '#db2777' } // í•‘í¬
    ];
}
    
    // í˜„ì¬ ë³´ê³  ìˆëŠ” í™”ë©´ì´ 'home'ì´ë‚˜ 'investigation'ì´ë©´ ì¦‰ì‹œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    if (state.currentView === 'home') renderView('home');
    if (state.currentView === 'investigation') renderView('investigation');
});
    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'story'), (docSnap) => {
        state.storyData = docSnap.exists() ? docSnap.data() : { chapters: [] };
        if (state.currentView === 'operation' && document.getElementById('story-timeline-root')) window.renderStoryTimeline();
    });

    // 2. ê³„ì •
    onSnapshot(accountsRef, (snapshot) => {
        state.accounts = snapshot.docs.map(d => d.data());
        updateUserSession();
        if (['members', 'admin', 'mail'].includes(state.currentView)) renderView(state.currentView);
    });

    // 3. ì±„íŒ…ë°© (ëª©ë¡ ê°±ì‹ )
    onSnapshot(roomsRef, (snapshot) => {
        state.chatRooms = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        if (state.currentView === 'mail') renderMail();
        renderSidebarUI();
    });

    // 4. [í•µì‹¬ ìˆ˜ì •] ë©”ì‹œì§€ ê°ì§€ & ì‹¤ì‹œê°„ ì½ìŒ ì²˜ë¦¬
    onSnapshot(messagesRef, (snapshot) => {
        state.messages = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        
        // í™”ë©´ ê°±ì‹ 
        if (state.currentView === 'mail' || state.isAdmin) renderView(state.currentView);
        renderSidebarUI();

        snapshot.docChanges().forEach(async (change) => {
            if (change.type === 'added') {
                const msg = change.doc.data();
                const myId = state.userAccount?.loginId;
                
                if (!state.initDone || !myId || msg.fromId === myId || msg.fromId === 'system') return;
                if (msg.timestamp && msg.timestamp.seconds <= loadTime) return;

                const room = state.chatRooms.find(r => r.id === msg.roomId);
                if (!room || !room.members.includes(myId)) return;

                // [ì¶”ê°€ë¨] ë§Œì•½ ë‚´ê°€ í˜„ì¬ ì´ ë°©ì„ ë³´ê³  ìˆë‹¤ë©´? -> ì¦‰ì‹œ ì½ìŒ ì²˜ë¦¬ (DB ì—…ë°ì´íŠ¸)
                // ì´ë ‡ê²Œ í•´ì•¼ ë‹¤ë¥¸ ë°© ê°”ë‹¤ ì™€ë„ NEWê°€ ì•ˆ ëœ¹ë‹ˆë‹¤.
                if (state.currentView === 'mail' && state.selectedRoomId === msg.roomId) {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', msg.roomId);
                    // lastRead í•„ë“œì— ë‚´ ì•„ì´ë””ì™€ í˜„ì¬ ì‹œê°„ ê¸°ë¡
                    updateDoc(roomRef, {
                        [`lastRead.${myId}`]: serverTimestamp()
                    }).catch(console.error);
                }

                // ì•Œë¦¼ ìƒì„± ë¡œì§ (ë³´ê³  ìˆëŠ” ë°©ì´ë©´ ì•Œë¦¼ ìƒëµ ê°€ëŠ¥í•˜ì§€ë§Œ, ì¼ë‹¨ ê¸°ë¡ì€ ë‚¨ê¹€)
                const isMuted = room.muted && room.muted[myId];
                if (isMuted) return;

                const newBody = `${msg.fromName}: ${msg.body.substring(0, 30)}${msg.body.length>30?'...':''}`;
                const existingNoti = state.notifications ? state.notifications.find(n => n.roomId === msg.roomId) : null;

                try {
                    if (existingNoti) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', existingNoti.id), {
                            message: newBody, timestamp: serverTimestamp(), isRead: false
                        });
                    } else {
                        await addDoc(notiRef, {
                            targetUserId: myId, roomId: msg.roomId, title: `Message from [${room.name}]`,
                            message: newBody, memo: "Unread Message", timestamp: serverTimestamp(), isRead: false
                        });
                    }
                } catch(e) { console.error(e); }
            }
        });
    });

    // 5. ê¸°íƒ€ ë¦¬ìŠ¤ë„ˆ
    onSnapshot(reportsRef, (snapshot) => {
        state.reports = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        if (state.isAdmin && state.currentView === 'admin') window.updateAdminReportsUI(); 
    });
    onSnapshot(notiRef, (snapshot) => {
        state.rawNotifications = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        updateMyNotifications();
    });
}
        function updateUserSession() {
    console.log("ğŸ”„ updateUserSession í˜¸ì¶œë¨");
    if (!state.user) {
        console.log("âŒ state.user ì—†ìŒ");
        return;
    }
    
    const myAcc = state.accounts.find(a => a.uid === state.user.uid);
    console.log("ğŸ‘¤ ë‚´ ê³„ì • ì •ë³´:", myAcc);
    console.log("ğŸ¯ combatSkills:", myAcc?.combatSkills);
    state.userAccount = myAcc || { status: 'new' };
    
    if (myAcc && myAcc.status === 'approved') {
        console.log("âœ… ìŠ¹ì¸ëœ ê³„ì • - ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™");
        // [ì¶”ê°€ë¨] ê¶Œí•œ ì²´í¬: 'staff' ë“±ê¸‰ì´ë©´ ê´€ë¦¬ì ê¶Œí•œ ìë™ ë¶€ì—¬
        if (myAcc.role === 'staff') {
            state.isAdmin = true;
            console.log("ğŸ”‘ ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬ë¨");
        }

        hideLoading();
        $('auth-view').classList.add('hidden');
        updateProfileBarUI();
        
        // ë¡œê·¸ì¸ ì™„ë£Œ ì‹œ ì•Œë¦¼ ëª©ë¡ ê°±ì‹ 
        if (typeof updateMyNotifications === 'function') updateMyNotifications();

        if (!state.initDone) {
            console.log("ğŸ¬ ì²« ë¡œê·¸ì¸ - ì‚¬ì´ë“œë°” ë Œë”ë§ ë° í™ˆ í™”ë©´ ì „í™˜");
            renderSidebarUI();
            switchView('home');
            state.initDone = true;
        }
    } else if (myAcc && myAcc.status === 'pending') {
        console.log("â³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘");
        hideLoading();
        showPendingGateUI();
    } else {
        console.log("ğŸ†• ì‹ ê·œ ì‚¬ìš©ì");
        hideLoading();
        showAuthGate();
    }
}

      window.switchView = (viewId) => {
    if (state.currentView === viewId && state.initDone) return;

    // âœ… [ì¶”ê°€í•  ë¶€ë¶„] ì¡°ì‚¬(investigation) íƒ­ìœ¼ë¡œ ì´ë™í•  ë•Œë§ˆë‹¤ ì¥ì†Œ ì •ë³´ ì´ˆê¸°í™”
    // ì´ë ‡ê²Œ í•˜ë©´ í•­ìƒ 'ëª©ë¡ í™”ë©´'ë¶€í„° ì‹œì‘í•˜ê²Œ ë©ë‹ˆë‹¤.
    if (viewId === 'investigation' && state.investigation) {
        state.investigation.currentPoi = null;
    }

    const area = $('content-area');
    area.classList.add('view-exit');
    setTimeout(() => {
        state.currentView = viewId;
        area.classList.remove('view-exit');
        area.classList.add('view-enter');
        
        renderView(viewId); // ì´ì œ ì´ˆê¸°í™”ëœ ìƒíƒœ(ëª©ë¡)ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.
        
        updateSidebarUI();
        setTimeout(() => area.classList.remove('view-enter'), 500);
    }, 300);
};

        function renderView(viewId) {
    const area = $('content-area');
    
    // ë©”ì¼ í™”ë©´ ìœ ì§€ ë¡œì§
    const isMailUpdate = (viewId === 'mail' && document.getElementById('mail-view-root'));
    if (!isMailUpdate) {
        area.innerHTML = '';
    }
    
    switch(viewId) {
    case 'home': renderHome(); break;
    case 'mail': renderMail(); break;
    case 'operation': renderOperation(); break;
    case 'investigation': renderInvestigation(); break; 
    case 'members': renderMembers(); break; 
    case 'profile': renderProfile(); break;
    case 'admin': renderAdmin(); break;
    case 'visit': renderVisitProfile(); break;
}
    
    // ì‚¬ì´ë“œë°” UIë„ ìƒíƒœì— ë§ì¶° ê°±ì‹  (í™œì„±í™” ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ ë“±)
    renderSidebarUI();
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
        // --- View Content Creators ---
        function renderHome() {
    const oc = state.userAccount || {};
    const world = state.world || {};
    
    // ì•Œë¦¼ í™•ì¸
    const myNotis = state.notifications || [];
    const hasNoti = myNotis.length > 0;

    // ì´ë¦„ ê¸¸ì´ ì¡°ì ˆ
    const nameLen = (oc.ocName || '').length;
    let nameSize;
    if (nameLen > 12) nameSize = "clamp(2rem, 4vw, 4rem)";
    else if (nameLen > 7) nameSize = "clamp(2.5rem, 5vw, 6rem)";
    else nameSize = "clamp(3rem, 6vw, 8rem)";

    $('content-area').innerHTML = `
        <div class="relative h-full w-full flex flex-col overflow-hidden bg-[#0a0a0a]">
            
            <div class="absolute inset-0 z-0">
                <img src="${oc.profile || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png'}" 
                     class="w-full h-full object-cover opacity-80 blur-[10px] scale-110 grayscale brightness-50">
                <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0a] via-[#0a0a0a]/80 to-transparent"></div>
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMDUpIiAvPgo8L3N2Zz4=')] opacity-20"></div>
            </div>

            <div class="absolute inset-y-0 right-[2%] lg:right-[8%] w-[80%] lg:w-[55%] z-10 pointer-events-none flex items-end justify-end">
                <img src="${oc.profile || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png'}" 
                     class="h-[90%] w-full object-contain object-bottom drop-shadow-2xl opacity-100 mask-image-bottom">
            </div>

            <div class="absolute top-8 right-8 z-50 pointer-events-auto">
                <button onclick="toggleNotificationModal()" class="relative group p-3 bg-neutral-900/50 rounded-full border border-white/10 hover:border-amber-500 hover:bg-amber-600/20 transition-all">
                    <i data-lucide="bell" class="w-6 h-6 text-neutral-400 group-hover:text-amber-500 transition-colors"></i>
                    ${hasNoti ? `<span class="absolute top-0 right-0 w-3 h-3 bg-red-600 rounded-full border-2 border-black animate-pulse"></span>` : ''}
                </button>
                
                <div id="noti-dropdown" class="hidden absolute top-14 right-0 w-80 bg-neutral-900 border border-amber-600/30 rounded-2xl shadow-2xl overflow-hidden backdrop-blur-xl animate-fade-in">
                    <div class="p-4 border-b border-white/5 flex justify-between items-center">
                        <span class="text-xs font-bold text-amber-500 uppercase tracking-widest">System Alerts</span>
                        <button onclick="clearAllNotifications()" class="text-[9px] text-neutral-500 hover:text-white uppercase underline">Clear All</button>
                    </div>
                    <div class="max-h-64 overflow-y-auto custom-scrollbar p-2 space-y-2">
                        ${myNotis.length === 0 ? `<p class="text-center text-[10px] text-neutral-600 py-6 italic">No new signals.</p>` : 
                            myNotis.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0)).map(n => `
                            <div class="p-3 bg-black/40 rounded-xl border border-white/5 flex gap-3 relative group">
                                <div class="w-8 h-8 rounded-full bg-amber-600/20 flex items-center justify-center shrink-0 text-amber-500"><i data-lucide="info" class="w-4 h-4"></i></div>
                                <div>
                                    <p class="text-xs text-white font-bold mb-1">${n.title}</p>
                                    <p class="text-[10px] text-neutral-400 leading-relaxed">${n.message}</p>
                                    ${n.memo ? `<p class="text-[10px] text-amber-500/80 mt-1 pl-2 border-l-2 border-amber-500/30 italic">" ${n.memo} "</p>` : ''}
                                    <p class="text-[8px] text-neutral-600 font-mono mt-1">${n.timestamp ? new Date(n.timestamp.seconds*1000).toLocaleString() : ''}</p>
                                </div>
                                <button onclick="deleteNotification('${n.id}')" class="absolute top-2 right-2 text-neutral-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>

            <div class="relative z-20 h-full flex flex-col justify-center pl-12 lg:pl-24 max-w-[65%] pointer-events-none">
                
                <div class="mb-6 flex items-center gap-4 animate-slide-up" style="animation-delay: 0.1s;">
                    <div class="bg-amber-600/20 text-amber-500 px-4 py-1.5 border border-amber-500/30 rounded-full text-[10px] font-black tracking-[0.3em] uppercase backdrop-blur-md">
                        ${oc.badgeText || 'Dossier: Authorized'}
                    </div>
                </div>

                <h1 class="font-serif font-black text-white tracking-tighter uppercase whitespace-nowrap leading-none mb-8 drop-shadow-xl animate-slide-up" 
                    style="font-size: ${nameSize}; animation-delay: 0.2s;">
                    ${oc.ocName || 'Personnel'}
                </h1>

                <div class="border-l-4 border-amber-600 pl-6 animate-slide-up" style="animation-delay: 0.3s;">
                    <h3 class="text-2xl lg:text-4xl font-serif font-bold text-white mb-4 leading-tight tracking-tight">
                        ${oc.slogan || 'ì‹œëŒ€ì— íšì„ ê·¸ì„ ìŠ¤íƒ€ì¼'}
                    </h3>
                    <p class="text-xs text-neutral-400 tracking-wide font-mono leading-relaxed max-w-md opacity-70">
                        ${oc.shortDesc || world.description}
                    </p>
                </div>

                <div class="mt-12 hidden lg:block animate-pulse max-w-md">
                    <p class="text-[10px] text-amber-500/60 font-mono tracking-[0.1em] leading-loose uppercase text-justify break-words whitespace-pre-line">
                        ${(oc.stats || 'No authorized records found.').substring(0, 300)}
                    </p>
                </div>

                <div class="mt-10 pointer-events-auto w-fit animate-slide-up" style="animation-delay: 0.4s;">
                    ${oc.linkUrl ? `
                    <a href="${oc.linkUrl}" target="_blank" class="group cursor-pointer hover:scale-105 transition-transform block">
                        <div class="bg-amber-600/10 backdrop-blur-md border border-amber-500/30 p-1 rounded-lg">
                            <div class="bg-amber-600 w-32 h-12 rounded-md relative overflow-hidden flex flex-col items-center justify-center border border-amber-400/50 shadow-[0_0_20px_rgba(217,119,6,0.4)]">
                                <div class="absolute top-0 left-0 w-full h-[1px] bg-amber-400/50"></div>
                                <div class="absolute bottom-0 left-0 w-full h-[1px] bg-amber-400/50"></div>
                                <div class="absolute -left-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-[#0a0a0a] rounded-full"></div>
                                <div class="absolute -right-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-[#0a0a0a] rounded-full"></div>
                                <p class="text-[6px] text-black/60 font-black uppercase tracking-widest mb-0.5">External Link</p>
                                <h3 class="text-xs text-white font-serif font-black uppercase tracking-tighter italic drop-shadow-md flex items-center gap-1">
                                    ${oc.linkText || 'ENTER'} <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </h3>
                            </div>
                        </div>
                    </a>` : ''}
                </div>
            </div>

            <div class="absolute right-6 lg:right-12 top-1/2 -translate-y-1/2 z-30 flex flex-col gap-4 pointer-events-auto">
                <a href="${world.banner1_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner1_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 01</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner1_text || 'NOTICE'}</h4></div>
                </a>
                <a href="${world.banner2_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner2_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 02</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner2_text || 'MISSION'}</h4></div>
                </a>
                <a href="${world.banner3_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner3_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 03</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner3_text || 'SCHEDULE'}</h4></div>
                </a>
            </div>

            <div class="absolute bottom-10 right-12 z-20 text-right pointer-events-none hidden lg:block">
                <h2 class="text-6xl font-black text-amber-600/20 tracking-tighter uppercase font-mono transform rotate-0">ABCD EASO</h2>
                <div class="flex justify-end gap-3 mt-3 pr-1"><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-1"></div><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-2"></div><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-3"></div></div>
            </div>
            <div class="absolute bottom-12 left-[30%] flex gap-12 opacity-60 pointer-events-none hidden lg:flex">
                <p class="text-[20px] text-amber-500 font-serif italic tracking-wider">${oc.keyword1 || 'Keyword 1'}</p>
                <p class="text-[20px] text-amber-400 font-serif italic tracking-wider">${oc.keyword2 || 'Keyword 2'}</p>
                <p class="text-[20px] text-amber-300 font-serif italic tracking-wider">${oc.keyword3 || 'Keyword 3'}</p>
            </div>
        </div>

        <style>
            .mask-image-bottom { -webkit-mask-image: linear-gradient(to top, transparent 0%, black 20%); mask-image: linear-gradient(to top, transparent 0%, black 20%); }
            .animate-slide-up { animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
            @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
            @keyframes loadDot { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
            .loading-dot-1 { animation: loadDot 1.2s infinite; animation-delay: 0s; }
            .loading-dot-2 { animation: loadDot 1.2s infinite; animation-delay: 0.2s; }
            .loading-dot-3 { animation: loadDot 1.2s infinite; animation-delay: 0.4s; }
        </style>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
        function renderMail() {
    const myLoginId = state.userAccount.loginId;
    
    // 1. ë°© ëª©ë¡ ì •ë ¬ (ìµœì‹ ìˆœ)
    const myRooms = state.chatRooms
        .filter(r => r.members.includes(myLoginId))
        .sort((a, b) => {
            const timeA = a.lastMessageTimestamp?.seconds || 0;
            const timeB = b.lastMessageTimestamp?.seconds || 0;
            return timeB - timeA;
        });

    const selectedRoom = state.selectedRoomId ? state.chatRooms.find(r => r.id === state.selectedRoomId) : null;

    // 2. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ (ìµœì´ˆ 1íšŒë§Œ ìƒì„±)
    const contentArea = document.getElementById('content-area');
    if (!document.getElementById('mail-view-root')) {
        contentArea.innerHTML = `
            <div id="mail-view-root" class="flex-1 flex flex-col md:flex-row h-full bg-black/20 overflow-hidden">
                <div class="w-full md:w-80 border-r border-white/5 flex flex-col bg-neutral-950/40 h-full shrink-0">
                    <div class="p-6 border-b border-white/5 flex items-center justify-between">
                        <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2"><i data-lucide="message-square" class="w-4 h-4"></i> Transmissions</h3>
                        <button onclick="showCreateGroupModal()" class="p-2 bg-white/5 rounded-lg hover:bg-white/10 text-neutral-400 transition-all"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="mail-sidebar-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar relative"></div>
                </div>
                <div id="mail-chat-panel" class="flex-1 flex flex-col overflow-hidden h-full relative"></div>
            </div>
            
            <div id="group-modal" class="hidden fixed inset-0 z-[110] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
                 <div class="w-full max-w-md bg-neutral-900 border border-white/10 rounded-[3rem] p-10 shadow-2xl modal-enter">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter">Initialize Group</h3>
                        <button onclick="document.getElementById('group-modal').classList.add('hidden')" class="text-neutral-500 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <input id="group-name-input" type="text" placeholder="Group Codename" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white mb-6">
                    <div class="space-y-2 mb-6">
                        <p class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest">Selected Personnel</p>
                        <div class="bg-neutral-950 border border-white/5 rounded-xl p-3 min-h-[3rem] flex flex-wrap gap-2" id="selected-member-tags"></div>
                        <div class="relative mt-2">
                            <input id="member-search-input" type="text" onkeyup="filterGroupMembers()" placeholder="Search Name..." class="w-full bg-neutral-950 border border-white/5 rounded-xl px-4 py-3 text-xs outline-none focus:border-amber-500 text-white pl-10">
                            <i data-lucide="search" class="w-4 h-4 text-neutral-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        </div>
                    </div>
                    <div id="member-select-list" class="max-h-48 overflow-y-auto space-y-2 mb-8 custom-scrollbar"></div>
                    <button onclick="handleCreateGroup()" class="w-full py-5 bg-amber-600 text-white font-bold rounded-2xl uppercase tracking-widest text-xs active:scale-95 shadow-xl">Deploy Signal Room</button>
                </div>
            </div>

            <div id="room-members-modal" class="hidden fixed inset-0 z-[120] bg-black/80 flex items-center justify-center p-6 backdrop-blur-md" onclick="if(event.target === this) this.classList.add('hidden')">
                <div class="w-full max-w-sm bg-neutral-900 border border-amber-600/30 rounded-[2.5rem] p-8 shadow-2xl modal-enter relative">
                    <h3 class="text-lg font-serif font-black text-white uppercase tracking-tighter mb-6 border-b border-white/10 pb-4">Linked Personnel</h3>
                    <button onclick="document.getElementById('room-members-modal').classList.add('hidden')" class="absolute top-8 right-8 text-neutral-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div id="room-members-list" class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </div>
            <style>.member-checkbox:checked + .check-icon { opacity: 1; }</style>
        `;
    }

    // 3. [í•µì‹¬ ìˆ˜ì •] ì‚¬ì´ë“œë°” ìŠ¤ë§ˆíŠ¸ ì—…ë°ì´íŠ¸ (ë””ìì¸ ë³µêµ¬ ë²„ì „)
    const sidebarList = document.getElementById('mail-sidebar-list');
    if (sidebarList) {
        if (myRooms.length === 0) {
            sidebarList.innerHTML = '<p class="text-center text-[10px] text-neutral-700 mt-20 uppercase tracking-widest font-mono">No active signals.</p>';
        } else {
            // ì‚­ì œëœ ë°© ì œê±°
            const currentIds = myRooms.map(r => r.id);
            Array.from(sidebarList.children).forEach(child => {
                if (child.tagName === 'BUTTON' && !currentIds.includes(child.getAttribute('data-room-id'))) {
                    child.remove();
                }
            });

            // ìˆœì„œëŒ€ë¡œ ìš”ì†Œ ë°°ì¹˜
            myRooms.forEach((r, index) => {
                let el = document.getElementById(`room-item-${r.id}`);
                
                // [ìˆ˜ì •ë¨] í˜„ì¬ ì„ íƒëœ ë°©ì¸ì§€ í™•ì¸
                const isSelected = selectedRoom?.id === r.id;
                const isMuted = r.muted && r.muted[myLoginId];

                // [ìˆ˜ì •ë¨] "í˜„ì¬ ì„ íƒëœ ë°©"ì´ë¼ë©´, ë°ì´í„°ìƒ ì•ˆ ì½ì€ ë©”ì‹œì§€ê°€ ìˆì–´ë„ ì½ì€ ê²ƒìœ¼ë¡œ ê°„ì£¼ (!isSelected ì¡°ê±´ ì¶”ê°€)
                const hasNew = !isSelected && r.lastMessageTimestamp && (!r.lastRead || !r.lastRead[myLoginId] || r.lastRead[myLoginId].seconds < r.lastMessageTimestamp.seconds);

                const innerHTML = `
                    <div class="relative shrink-0">
                        <div class="w-12 h-12 rounded-xl bg-black border border-white/10 flex items-center justify-center overflow-hidden transition-all group-hover:border-white/30">
                            ${getRoomIconHTML(r)}
                        </div>
                        ${hasNew ? `<div class="absolute -top-2 -right-2 bg-red-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded-full border border-black shadow-md animate-bounce">NEW</div>` : ''}
                    </div>
                    <div class="flex-1 text-left overflow-hidden">
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-1">
                                <p class="text-xs font-bold uppercase truncate ${hasNew ? 'text-white' : ''}">${r.name}</p>
                                ${isMuted ? `<i data-lucide="bell-off" class="w-3 h-3 text-neutral-600 ml-1"></i>` : ''}
                            </div>
                        </div>
                        <p class="text-[10px] truncate transition-colors ${hasNew ? 'text-amber-500 font-bold' : 'text-neutral-500 group-hover:text-neutral-400'}">${r.lastMessageBody || 'No signals transmitted.'}</p>
                    </div>
                `;

                const baseClasses = "w-full p-4 rounded-2xl flex items-center gap-4 transition-all duration-500 border cursor-pointer group relative overflow-hidden";
                const activeClasses = isSelected 
                    ? "bg-amber-600/10 border-amber-500 text-white shadow-[0_0_15px_rgba(217,119,6,0.1)]" 
                    : "bg-neutral-900/40 border-white/5 text-neutral-400 hover:bg-neutral-800 hover:border-white/10";

                if (!el) {
                    // [ì‹ ê·œ ìƒì„±]
                    el = document.createElement('button');
                    el.id = `room-item-${r.id}`;
                    el.setAttribute('data-room-id', r.id);
                    el.onclick = () => enterRoom(r.id);
                    el.className = `${baseClasses} ${activeClasses} animate-fade-in-up`;
                    el.innerHTML = innerHTML;
                    sidebarList.appendChild(el); 
                } else {
                    // [ì—…ë°ì´íŠ¸]
                    if(el.innerHTML !== innerHTML) el.innerHTML = innerHTML;
                    el.className = `${baseClasses} ${activeClasses}`;
                }

                // [ìœ„ì¹˜ ê°•ì œ ì¡°ì •] ë¶€ë“œëŸ¬ìš´ ìˆœì„œ ë³€ê²½
                const currentChildAtIndex = sidebarList.children[index];
                if (currentChildAtIndex !== el) {
                    if (currentChildAtIndex) {
                        sidebarList.insertBefore(el, currentChildAtIndex);
                    } else {
                        sidebarList.appendChild(el);
                    }
                    // 1ë“±ìœ¼ë¡œ ì˜¬ë¼ê°ˆ ë•Œ ì‚´ì§ ë°˜ì§ì„
                    if (index === 0) {
                        el.classList.add('bg-white/10');
                        setTimeout(() => el.classList.remove('bg-white/10'), 500);
                    }
                }
            });
        }
    }

    // 4. ì±„íŒ…ë°© íŒ¨ë„ (ê¸°ì¡´ ìœ ì§€)
    const chatPanel = document.getElementById('mail-chat-panel');
    if (!selectedRoom) {
        chatPanel.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center opacity-10 h-full"><i data-lucide="mail" class="w-24 h-24 mb-6"></i><p class="text-sm font-mono uppercase tracking-[0.5em]">Secure Signal Hub</p></div>`;
    } else {
        const msgs = state.messages.filter(m => m.roomId === selectedRoom.id).sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
        const headerIcon = getRoomIconHTML(selectedRoom);
        const currentRoomIdInput = document.getElementById('current-room-id-hidden');
        const isMuted = selectedRoom.muted && selectedRoom.muted[myLoginId];
        const isSameRoom = currentRoomIdInput && currentRoomIdInput.value === selectedRoom.id;

        const generateMessageHTML = (m, showDate) => {
            if (m.fromId === 'system') return `<div id="msg-${m.id}" class="flex justify-center my-2 animate-fade-in"><span class="text-[10px] text-amber-500/50 font-mono uppercase tracking-widest border border-amber-500/10 px-3 py-1 rounded-full bg-black/20"><i data-lucide="alert-circle" class="w-3 h-3 inline-block mr-1 -mt-0.5"></i> ${m.body}</span></div>`;
            const isMine = m.fromId === myLoginId;
            const senderAcc = state.accounts.find(a => a.loginId === m.fromId);
            const senderImg = senderAcc ? senderAcc.profile : '';
            const isDeleted = m.isDeleted === true;
            const displayBody = isDeleted ? "-ì‚­ì œëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤-" : m.body;
            const bubbleStyle = isDeleted ? "bg-neutral-800 border border-white/5 text-white/50 italic" : (isMine ? "chat-bubble-mine" : "chat-bubble-theirs");
            const deleteBtn = (isMine && !isDeleted) ? `<button onclick="deleteMessage('${m.id}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-neutral-600 hover:text-red-500 p-1" title="Delete"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : '';
            const timeStr = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';

            let dateDivider = '';
            if (showDate) {
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                const dateStr = new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', dateOptions);
                dateDivider = `<div class="flex items-center justify-center my-6 opacity-60"><div class="h-px w-12 bg-gradient-to-r from-transparent to-white/20"></div><span class="px-4 text-[10px] font-mono text-neutral-500 uppercase tracking-widest border border-white/10 rounded-full py-1 bg-black/30 backdrop-blur-sm">${dateStr}</span><div class="h-px w-12 bg-gradient-to-l from-transparent to-white/20"></div></div>`;
            }

            return `${dateDivider}<div id="msg-${m.id}" class="flex ${isMine ? 'justify-end' : 'justify-start'} animate-fade-in items-end gap-3 group mb-4">${!isMine ? `<div class="w-8 h-8 rounded-lg bg-black overflow-hidden shrink-0 border border-white/10 shadow-lg"><img src="${senderImg}" class="w-full h-full object-cover"></div>` : ''}<div class="max-w-[70%] flex flex-col ${isMine ? 'items-end' : 'items-start'}">${!isMine ? `<p class="text-[9px] text-amber-500 font-bold mb-1 uppercase tracking-tighter ml-1">${m.fromName}</p>` : ''}<div class="flex items-end gap-2 ${isMine ? 'flex-row-reverse' : 'flex-row'}"><div class="p-4 rounded-2xl text-sm leading-relaxed shadow-lg ${bubbleStyle}"><p class="whitespace-pre-wrap break-words">${displayBody}</p></div><div class="flex flex-col gap-1 justify-end h-full">${deleteBtn}<p class="text-[8px] opacity-40 font-mono whitespace-nowrap">${timeStr}</p></div></div></div></div>`;
        };

        if (isSameRoom) {
            const msgContainer = document.getElementById('chat-messages-container');
            if (msgContainer) {
                msgs.forEach((m, idx) => {
                    const existingEl = document.getElementById(`msg-${m.id}`);
                    let showDate = false;
                    const currDate = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                    if(idx > 0) {
                         const prevM = msgs[idx-1];
                         const prevD = prevM.timestamp ? new Date(prevM.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                         if(currDate !== prevD) showDate = true;
                    } else showDate = true;

                    if (existingEl) {
                        if (m.isDeleted && !existingEl.innerHTML.includes("-ì‚­ì œëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤-")) existingEl.outerHTML = generateMessageHTML(m, false);
                    } else {
                         const allDates = msgContainer.querySelectorAll('.font-mono');
                         if(allDates.length > 0 && allDates[allDates.length-1].innerText === currDate) showDate = false;
                        msgContainer.insertAdjacentHTML('beforeend', generateMessageHTML(m, showDate));
                        msgContainer.scrollTop = msgContainer.scrollHeight;
                    }
                });
                const muteBtn = document.getElementById('chat-mute-btn');
                if(muteBtn) muteBtn.innerHTML = isMuted ? `<i data-lucide="bell-off" class="w-5 h-5 text-red-500"></i>` : `<i data-lucide="bell" class="w-5 h-5"></i>`;
            }
        } else {
            let lastDateStr = null;
            const fullHTML = msgs.map(m => {
                let showDate = false;
                const currDate = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                if (currDate && currDate !== lastDateStr) { showDate = true; lastDateStr = currDate; }
                return generateMessageHTML(m, showDate);
            }).join('');

            chatPanel.innerHTML = `
                <div class="flex-1 flex flex-col relative h-full overflow-hidden bg-neutral-900/10">
                    <input type="hidden" id="current-room-id-hidden" value="${selectedRoom.id}">
                    <div class="p-6 border-b border-white/5 flex items-center justify-between bg-black/40 backdrop-blur-md shrink-0">
                        <div class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="showRoomMembers('${selectedRoom.id}')">
                            <div class="w-12 h-12 rounded-xl bg-amber-600/20 border border-amber-600/30 flex items-center justify-center shrink-0 overflow-hidden">${headerIcon}</div>
                            <div>
                                <h4 class="text-sm font-bold text-white uppercase tracking-widest flex items-center gap-2">${selectedRoom.name || 'Private Signal'} <i data-lucide="chevron-down" class="w-3 h-3 text-neutral-500"></i></h4>
                                <p class="text-[9px] text-neutral-500 font-mono italic uppercase">${selectedRoom.members.length} Personnel Linked</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="chat-mute-btn" onclick="toggleRoomMute('${selectedRoom.id}')" class="p-2 text-neutral-600 hover:text-amber-500 transition-all" title="${isMuted ? "Unmute" : "Mute"}">
                                ${isMuted ? `<i data-lucide="bell-off" class="w-5 h-5 text-red-500"></i>` : `<i data-lucide="bell" class="w-5 h-5"></i>`}
                            </button>
                            <button onclick="handleLeaveRoom('${selectedRoom.id}')" class="p-2 text-neutral-600 hover:text-red-500 transition-all" title="Leave Signal"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                            <button onclick="state.selectedRoomId = null; renderMail();" class="p-2 text-neutral-600 hover:text-white transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="chat-messages-container" class="flex-1 overflow-y-auto p-8 flex flex-col">${fullHTML}</div>
                    <div class="p-6 border-t border-white/5 bg-black/40">
                        <div class="flex gap-4 items-end">
                            <textarea id="chat-input" rows="1" placeholder="Transmit signal..." class="flex-1 bg-neutral-900 border border-white/10 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white transition-all resize-none custom-scrollbar" style="min-height: 56px; max-height: 120px;" oninput="autoResize(this)" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleSendChat(); }"></textarea>
                            <button onclick="handleSendChat()" class="bg-amber-600 hover:bg-amber-700 text-white p-4 rounded-2xl shadow-xl active:scale-90 h-[56px] w-[56px] flex items-center justify-center shrink-0"><i data-lucide="send" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </div>
            `;
            const container = document.getElementById('chat-messages-container');
            if (container) container.scrollTop = container.scrollHeight;
        }
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// ì „ì—­ ë³€ìˆ˜: í˜„ì¬ ëª¨ë‹¬ì—ì„œ ì„ íƒëœ ë©¤ë²„ë“¤ì˜ ID ì§‘í•©
// ì „ì—­ ë³€ìˆ˜: ì„ íƒëœ ë©¤ë²„ ID ì €ì¥
// ì „ì—­ ë³€ìˆ˜: ì„ íƒëœ ë©¤ë²„ ID ì €ì¥
window.selectedMemberSet = new Set();

// 1. ëª¨ë‹¬ ì—´ê¸° (ì´ˆê¸°í™” ë° ìœ ì € ëª©ë¡ ìƒì„±)
window.showCreateGroupModal = () => {
    window.selectedMemberSet.clear(); // ì„ íƒ ì´ˆê¸°í™”
    
    // ì„ íƒëœ íƒœê·¸ í™”ë©´ ë¹„ìš°ê¸°
    const tagContainer = document.getElementById('selected-member-tags');
    if(tagContainer) tagContainer.innerHTML = '';
    
    // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
    const searchInput = document.getElementById('member-search-input');
    if(searchInput) searchInput.value = '';

    // [í•µì‹¬] ìœ ì € ëª©ë¡ ìƒì„±í•˜ê¸° (ì´ ë¶€ë¶„ì´ ë¹ ì ¸ìˆì–´ì„œ ëª©ë¡ì´ ì•ˆ ë–´ë˜ ê²ƒì…ë‹ˆë‹¤!)
    const listContainer = document.getElementById('member-select-list');
    if (listContainer) {
        // ë‚˜ ìì‹ ì„ ì œì™¸í•œ ìŠ¹ì¸ëœ ìœ ì €ë“¤ë§Œ í•„í„°ë§
        const users = state.accounts.filter(a => a.loginId !== state.userAccount.loginId && a.status === 'approved');
        
        if (users.length === 0) {
            listContainer.innerHTML = '<p class="text-neutral-500 text-xs p-4 text-center">No other personnel available.</p>';
        } else {
            listContainer.innerHTML = users.map(u => `
                <div class="member-item flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 hover:border-amber-500/50 cursor-pointer group transition-all" onclick="toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-black overflow-hidden border border-white/10">
                            <img src="${u.profile}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <p class="member-name-text text-xs font-bold text-white group-hover:text-amber-500 transition-colors">${u.ocName}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${u.loginId}</p>
                        </div>
                    </div>
                    <div class="relative w-5 h-5 rounded-full border border-white/20 flex items-center justify-center">
                        <input type="checkbox" id="cb-${u.loginId}" class="member-checkbox appearance-none absolute inset-0 cursor-pointer" onclick="event.stopPropagation(); toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                        <div class="check-icon opacity-0 w-3 h-3 bg-amber-500 rounded-full transition-opacity"></div>
                    </div>
                </div>
            `).join('');
        }
    }

    // ëª¨ë‹¬ í‘œì‹œ
    document.getElementById('group-modal').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 2. ë©¤ë²„ ì„ íƒ í† ê¸€ (ì²´í¬ë°•ìŠ¤ ë° íƒœê·¸ ì—°ë™)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // ì´ë¯¸ ì„ íƒë¨ -> í•´ì œ
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-100');
            checkIcon.classList.add('opacity-0');
        }
    } else {
        // ë¯¸ì„ íƒ -> ì„ íƒ
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-0');
            checkIcon.classList.add('opacity-100');
        }
    }
    renderSelectedTags();
};

// 3. ì„ íƒëœ ë©¤ë²„ íƒœê·¸ ê·¸ë¦¬ê¸°
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. ê²€ìƒ‰ í•„í„°ë§
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. ê·¸ë£¹ ìƒì„± ì™„ë£Œ (DB ì „ì†¡)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // ë©¤ë²„ ëª©ë¡: ë‚˜ + ì„ íƒëœ ì‚¬ëŒë“¤
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};

// 2. ë©¤ë²„ ì„ íƒ í† ê¸€ (ì²´í¬ë°•ìŠ¤ ë° íƒœê·¸ ì—°ë™)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // ì´ë¯¸ ì„ íƒë¨ -> í•´ì œ
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) checkIcon.classList.remove('opacity-100');
        if(checkIcon) checkIcon.classList.add('opacity-0');
    } else {
        // ë¯¸ì„ íƒ -> ì„ íƒ
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) checkIcon.classList.remove('opacity-0');
        if(checkIcon) checkIcon.classList.add('opacity-100');
    }
    renderSelectedTags();
};

// 3. ì„ íƒëœ ë©¤ë²„ íƒœê·¸ ê·¸ë¦¬ê¸°
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. ê²€ìƒ‰ í•„í„°ë§
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. ê·¸ë£¹ ìƒì„± ì™„ë£Œ (DB ì „ì†¡)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // ë©¤ë²„ ëª©ë¡: ë‚˜ + ì„ íƒëœ ì‚¬ëŒë“¤
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};
        // [ìˆ˜ì •] ì±„íŒ…ë°© ì…ì¥ í•¨ìˆ˜
window.enterRoom = async (roomId) => {
    // 1. ìƒíƒœ ë³€ê²½ (í™”ë©´ ë¨¼ì € ì „í™˜)
    state.selectedRoomId = roomId;
    renderMail();

    // 2. [í•µì‹¬] ì„œë²„ì— "ë‚˜ ì´ ë°© ì½ì—ˆìŒ" ë³´ê³  (DB ì—…ë°ì´íŠ¸)
    try {
        if (state.userAccount) {
            const myId = state.userAccount.loginId;
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
            
            // lastRead ë§µì— ë‚´ ì•„ì´ë”” í‚¤ë¡œ í˜„ì¬ ì„œë²„ ì‹œê°„ ì €ì¥
            await updateDoc(roomRef, {
                [`lastRead.${myId}`]: serverTimestamp()
            });
        }
    } catch (e) {
        console.error("Failed to mark room as read:", e);
    }
};
window.selectedMemberSet = new Set();

// 1. ëª¨ë‹¬ ì—´ê¸° (ì´ë•Œ ìœ ì € ëª©ë¡ì„ ë§Œë“¤ì–´ ë„£ìŠµë‹ˆë‹¤)
window.showCreateGroupModal = () => {
    window.selectedMemberSet.clear(); // ì„ íƒ ì´ˆê¸°í™”
    
    // ì„ íƒëœ íƒœê·¸ í™”ë©´ ë¹„ìš°ê¸°
    const tagContainer = document.getElementById('selected-member-tags');
    if(tagContainer) tagContainer.innerHTML = '';
    
    // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
    const searchInput = document.getElementById('member-search-input');
    if(searchInput) searchInput.value = '';

    // [í•µì‹¬] ìœ ì € ëª©ë¡ ìƒì„±í•˜ê¸°
    const listContainer = document.getElementById('member-select-list');
    if (listContainer) {
        // ë‚˜ ìì‹ ì„ ì œì™¸í•œ ìŠ¹ì¸ëœ ìœ ì €ë“¤ë§Œ í•„í„°ë§
        const users = state.accounts.filter(a => a.loginId !== state.userAccount.loginId && a.status === 'approved');
        
        if (users.length === 0) {
            listContainer.innerHTML = '<p class="text-neutral-500 text-xs p-4 text-center">No other personnel available.</p>';
        } else {
            listContainer.innerHTML = users.map(u => `
                <div class="member-item flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 hover:border-amber-500/50 cursor-pointer group transition-all" onclick="toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-black overflow-hidden border border-white/10">
                            <img src="${u.profile}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <p class="member-name-text text-xs font-bold text-white group-hover:text-amber-500 transition-colors">${u.ocName}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${u.loginId}</p>
                        </div>
                    </div>
                    <div class="relative w-5 h-5 rounded-full border border-white/20 flex items-center justify-center">
                        <input type="checkbox" id="cb-${u.loginId}" class="member-checkbox appearance-none absolute inset-0 cursor-pointer" onclick="event.stopPropagation(); toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                        <div class="check-icon opacity-0 w-3 h-3 bg-amber-500 rounded-full transition-opacity"></div>
                    </div>
                </div>
            `).join('');
        }
    }

    // ëª¨ë‹¬ í‘œì‹œ (í‘œì¤€ ë¬¸ë²• ì‚¬ìš©)
    document.getElementById('group-modal').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 2. ë©¤ë²„ ì„ íƒ í† ê¸€ (í´ë¦­í•˜ë©´ ì²´í¬/í•´ì œ)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // ì´ë¯¸ ì„ íƒë¨ -> í•´ì œ
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-100');
            checkIcon.classList.add('opacity-0');
        }
    } else {
        // ë¯¸ì„ íƒ -> ì„ íƒ
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-0');
            checkIcon.classList.add('opacity-100');
        }
    }
    renderSelectedTags();
};

// 3. ì„ íƒëœ ë©¤ë²„ íƒœê·¸ ê·¸ë¦¬ê¸° (ìƒë‹¨ì— ì´ë¦„ í‘œì‹œ)
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. ê²€ìƒ‰ í•„í„°ë§ (ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°)
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. [ì¤‘ìš”] ê·¸ë£¹ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ (ì´ê²ƒë„ ê°™ì´ ë®ì–´ì”Œì›Œì•¼ ì‘ë™í•©ë‹ˆë‹¤)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // ë©¤ë²„ ëª©ë¡: ë‚˜ + ì„ íƒëœ ì‚¬ëŒë“¤
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};

        window.handleSendChat = async () => {
    const input = $('chat-input');
    const body = input.value.trim();
    if (!body || !state.selectedRoomId) return;
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
            roomId: state.selectedRoomId,
            fromId: state.userAccount.loginId,
            fromName: state.userAccount.ocName,
            body: body,
            timestamp: serverTimestamp()
        });
        
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', state.selectedRoomId);
        const lastReadUpdate = {
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: body
        };
        lastReadUpdate[`lastRead.${state.userAccount.loginId}`] = serverTimestamp();
        await updateDoc(roomRef, lastReadUpdate);
        
        input.value = '';
        input.style.height = '56px'; // [ì¶”ê°€ë¨] ì „ì†¡ í›„ ë†’ì´ ì´ˆê¸°í™”
        input.focus(); // [ì¶”ê°€ë¨] ì „ì†¡ í›„ í¬ì»¤ìŠ¤ ìœ ì§€
        
    } catch(e) { console.error(e); }
};
        window.handleLeaveRoom = async (roomId) => {
    if (!confirm("ì •ë§ ì´ ì±„íŒ…ë°©(Signal) ì—°ê²°ì„ ëŠìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
        const currentRoom = state.chatRooms.find(r => r.id === roomId);
        
        if (!currentRoom) return;

        // [ì¶”ê°€ëœ ë¶€ë¶„] í‡´ì¥ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
            roomId: roomId,
            fromId: 'system', // ì‹ë³„ìë¥¼ 'system'ìœ¼ë¡œ ì„¤ì •
            fromName: 'System',
            body: `${state.userAccount.ocName} ë‹˜ì´ ì—°ê²°ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.`, // ë©”ì‹œì§€ ë‚´ìš©
            timestamp: serverTimestamp()
        });

        // í˜„ì¬ ë‚´ IDë¥¼ ë©¤ë²„ ëª©ë¡ì—ì„œ ì œì™¸
        const newMembers = currentRoom.members.filter(id => id !== state.userAccount.loginId);

        if (newMembers.length === 0) {
             await updateDoc(roomRef, { members: newMembers });
        } else {
            await updateDoc(roomRef, { members: newMembers });
        }

        state.selectedRoomId = null;
        renderMail();
        showToast("Signal Disconnected.");
        
    } catch (e) {
        console.error("Error leaving room:", e);
        showToast("Error: Cannot disconnect.");
    }
};

        function renderProfile() {
    const oc = state.userAccount || {};
    $('content-area').innerHTML = `
        <div class="max-w-2xl mx-auto py-24 px-10 w-full animate-slide-up pb-40">
            <h2 class="text-4xl font-serif font-black mb-12 tracking-tighter uppercase leading-none text-white">Personnel Dossier</h2>
            <div class="bg-neutral-900 border border-white/5 rounded-[3rem] p-10 space-y-10 shadow-2xl backdrop-blur-xl">
                
                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Basic Info</h3>
                    
                    <div><label class="text-[10px] font-bold text-amber-500 uppercase block mb-2 ml-1">Top Badge Text</label><input id="edit-badge" value="${oc.badgeText || ''}" placeholder="Dossier: Authorized" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-amber-500 font-black tracking-widest uppercase"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Personnel Name</label><input id="edit-name" value="${oc.ocName || ''}" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-bold"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Visual Resource (URL)</label><input id="edit-profile" value="${oc.profile || ''}" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Slogan (Big Title)</label><input id="edit-slogan" value="${oc.slogan || ''}" class="w-full bg-black border border-amber-600/30 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-black italic"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Short Description (Subtitle)</label><input id="edit-shortDesc" value="${oc.shortDesc || ''}" placeholder="ì‹œê°„ì˜ ì†Œìš©ëŒì´ ì†ì—ì„œ..." class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white"></div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Left Ticket Button</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Ticket Name</label><input id="edit-linkText" value="${oc.linkText || ''}" placeholder="ENTER" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-black"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Ticket URL</label><input id="edit-linkUrl" value="${oc.linkUrl || ''}" placeholder="https://..." class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-amber-500"></div>
                    </div>
                </div>
<div class="space-y-6">
    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Combat Stats</h3>
    <div class="grid grid-cols-5 gap-3">
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">HP</label>
            <input id="edit-stat-hp" value="${oc.stat_hp || '100'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-red-500 outline-none" placeholder="100">
        </div>
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">MP</label>
            <input id="edit-stat-mp" value="${oc.stat_mp || '50'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-blue-500 outline-none" placeholder="50">
        </div>
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">ATK</label>
            <input id="edit-stat-atk" value="${oc.stat_atk || '10-15'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-amber-500 outline-none" placeholder="12-18">
        </div>
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">DEF</label>
            <input id="edit-stat-def" value="${oc.stat_def || '3-5'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-green-500 outline-none" placeholder="3-7">
        </div>
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">MOVE</label>
            <input id="edit-stat-move" value="${oc.stat_move || '1'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-purple-500 outline-none" placeholder="1">
        </div>
    </div>
</div>
<div class="space-y-6 mt-6">
    <div class="flex justify-between items-end border-b border-white/5 pb-2">
        <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest">Combat Skills</h3>
        <button onclick="openSkillEditor()" class="text-[10px] font-bold text-neutral-500 hover:text-amber-500 transition-colors flex items-center gap-1">
            <span>EDIT</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
        </button>
    </div>
    
    <div id="profile-equipped-skills" class="grid grid-cols-5 gap-3 min-h-[42px]">
        <div class="col-span-5 text-center py-3 border border-dashed border-white/10 rounded-xl">
            <span class="text-[10px] text-neutral-600">No skills equipped</span>
        </div>
    </div>
</div>
                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Personality Keywords</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 1</label><input id="edit-kw1" value="${oc.keyword1 || ''}" placeholder="Basiom" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-500 font-serif italic text-center"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 2</label><input id="edit-kw2" value="${oc.keyword2 || ''}" placeholder="Barbarus" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-400 font-serif italic text-center"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 3</label><input id="edit-kw3" value="${oc.keyword3 || ''}" placeholder="Beatrice" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-300 font-serif italic text-center"></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Background Description</h3>
                    <div>
                        <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Personnel Notes</label>
                        <textarea id="edit-stats" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-5 text-sm outline-none focus:border-amber-500 h-40 resize-none text-neutral-300 leading-relaxed custom-scrollbar">${oc.stats || ''}</textarea>
                    </div>
                </div>

                <div class="pt-6">
                    <button onclick="handleUpdateProfile()" class="w-full py-6 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all">Authorize Update</button>
                </div>
            </div>
        </div>
    `;
    
    // í”„ë¡œí•„ ë Œë”ë§ í›„ ìŠ¤í‚¬ í‘œì‹œ
    const skills = oc.combatSkills || [];
    console.log("ğŸ“‹ í”„ë¡œí•„ ë Œë”ë§ - ìµœì‹  ìŠ¤í‚¬ ëª©ë¡:", skills);
    
    if (typeof window.renderProfileSkills === 'function') {
        window.renderProfileSkills(skills);
    } else {
        console.warn("âš ï¸ renderProfileSkills í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ");
    }
}
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const list = document.getElementById('member-select-list');
    const items = list.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden'); // ê²€ìƒ‰ì–´ í¬í•¨ë˜ë©´ ë³´ì„
            } else {
                items[i].classList.add('hidden');    // í¬í•¨ ì•ˆë˜ë©´ ìˆ¨ê¹€
            }
        }
    }
};
        window.handleUpdateProfile = async function() {
    const user = auth.currentUser;
    if (!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }

    // 1. ì…ë ¥ì°½ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
    };

    // 2. ì €ì¥í•  ë°ì´í„° ê°ì²´ ë§Œë“¤ê¸°
    // (ì—¬ê¸°ì„œ skillsëŠ” ì œì™¸í•˜ì—¬ ê¸°ì¡´ ìŠ¤í‚¬ ë°ì´í„°ê°€ ë‚ ì•„ê°€ì§€ ì•Šê²Œ ë³´í˜¸í•©ë‹ˆë‹¤)
    const updateData = {
        badgeText: getVal('edit-badge'),
        ocName: getVal('edit-name'),
        profile: getVal('edit-profile'),
        slogan: getVal('edit-slogan'),
        shortDesc: getVal('edit-shortDesc'),
        linkText: getVal('edit-linkText'),
        linkUrl: getVal('edit-linkUrl'),
        stat_hp: getVal('edit-stat-hp'),
        stat_mp: getVal('edit-stat-mp'),
        stat_atk: getVal('edit-stat-atk'),
        stat_def: getVal('edit-stat-def'),
        stat_move: getVal('edit-stat-move'),
        keyword1: getVal('edit-kw1'),
        keyword2: getVal('edit-kw2'),
        keyword3: getVal('edit-kw3'),
        stats: getVal('edit-stats'),
        updatedAt: new Date()
    };

    if (!updateData.ocName) {
        alert("Personnel Nameì€ í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.");
        return;
    }

    try {
        // 3. [í•µì‹¬ ìˆ˜ì •] ì €ì¥ ê²½ë¡œë¥¼ í™ˆí˜ì´ì§€ê°€ ì½ëŠ” artifacts ê²½ë¡œë¡œ ë³€ê²½
        // state.userAccount.loginIdê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        const loginId = window.state?.userAccount?.loginId || user.uid;
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
        
        const btn = document.querySelector('button[onclick="handleUpdateProfile()"]');
        if(btn) btn.innerText = "UPDATING...";

        // 4. [í•µì‹¬ ìˆ˜ì •] updateDoc ëŒ€ì‹  setDoc(merge: true) ì‚¬ìš©
        // ì´ë ‡ê²Œ í•˜ë©´ ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒì„±í•˜ê³ , ìˆìœ¼ë©´ ê¸°ì¡´ ë°ì´í„°(ìŠ¤í‚¬ ë“±)ë¥¼ ìœ ì§€í•˜ë©° ë®ì–´ì”ë‹ˆë‹¤.
        await setDoc(userRef, updateData, { merge: true });
        
        // 5. ë¡œì»¬ state ì—…ë°ì´íŠ¸
        if (window.state && window.state.userAccount) {
            window.state.userAccount = { ...window.state.userAccount, ...updateData };
        }

        alert("í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        if (typeof renderProfile === 'function') {
            renderProfile(); 
        }

    } catch (e) {
        console.error("í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨:", e);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
    } finally {
        const btn = document.querySelector('button[onclick="handleUpdateProfile()"]');
        if(btn) btn.innerText = "Authorize Update";
    }
}
        function renderAdmin() {
    // 1. ê´€ë¦¬ì ë¡œê·¸ì¸ í™”ë©´ (ê¶Œí•œ ì—†ì„ ì‹œ)
    if (!state.isAdmin) {
        $('content-area').innerHTML = `
            <div class="flex-1 flex items-center justify-center p-6 h-full select-none">
                <div class="max-w-md w-full bg-neutral-900 border border-amber-600/20 p-12 rounded-[3.5rem] space-y-10 animate-fade-in shadow-2xl">
                    <div class="text-center space-y-4 mb-10">
                        <i data-lucide="shield" class="w-16 h-16 text-amber-500 mx-auto mb-4 drop-shadow-[0_0_15px_rgba(217,119,6,0.5)]"></i>
                        <h3 class="text-2xl font-black text-white uppercase tracking-widest">Administrator</h3>
                    </div>
                    <input id="admin-pw-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full bg-black border border-white/10 rounded-2xl px-6 py-5 text-center text-xl tracking-[1em] outline-none focus:border-amber-500 text-white transition-all">
                    <button onclick="handleAdminAuth()" class="w-full py-6 bg-amber-600 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all">Authorize Over-ride</button>
                </div>
            </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
        return;
    }

    // 2. ë°ì´í„° ì¤€ë¹„
    const pendings = state.accounts.filter(a => a.status === 'pending');
    const approveds = state.accounts.filter(a => a.status === 'approved');
    const w = state.world || {};
    const classes = w.classes || []; // ì§ì—…êµ° ë°ì´í„°

    // 3. ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    $('content-area').innerHTML = `
        <div class="max-w-6xl mx-auto py-20 px-10 w-full space-y-24 pb-60 animate-fade-in select-none">
            
            <div class="flex justify-between items-end border-b border-amber-900/30 pb-12">
                <h2 class="text-5xl font-black text-amber-500 uppercase tracking-tighter">Command Center</h2>
                <button onclick="state.isAdmin = false; renderView('admin');" class="px-6 py-3 bg-neutral-900 border border-white/10 rounded-xl text-[10px] text-neutral-500 hover:text-white uppercase font-bold">Logout Session</button>
            </div>

            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">System Interface Control</h3>
                
                <div class="space-y-1">
                    <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase">Login Background URL</label>
                    <input id="sys-login-bg" type="text" value="${w.login_bg || ''}" 
                           class="w-full bg-neutral-900 border border-neutral-800 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-amber-600 transition-colors" 
                           placeholder="https://...">
                    <p class="text-[9px] text-neutral-600 mt-1">ë¡œê·¸ì¸ í™”ë©´ì— ë¸”ëŸ¬ ì²˜ë¦¬ë˜ì–´ ë‚˜íƒ€ë‚  ë°°ê²½ ì´ë¯¸ì§€ì…ë‹ˆë‹¤.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 01</p>
                        <input id="sys-btn1-text" value="${w.banner1_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn1-url" value="${w.banner1_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn1-img" value="${w.banner1_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 02</p>
                        <input id="sys-btn2-text" value="${w.banner2_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn2-url" value="${w.banner2_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn2-img" value="${w.banner2_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 03</p>
                        <input id="sys-btn3-text" value="${w.banner3_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn3-url" value="${w.banner3_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn3-img" value="${w.banner3_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                </div>
                <button onclick="handleSystemUpdate()" class="w-full py-4 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl transition-all">Update System Interface</button>
            </section>
<div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
    <p class="text-amber-500 font-bold uppercase text-xs">Skill Synchronization</p>
    <input type="file" id="skill-file-input" class="hidden" accept=".json" onchange="importSkillsFromFile(event)">
    <button onclick="document.getElementById('skill-file-input').click()" 
            class="w-full py-3 bg-neutral-800 text-white text-[10px] font-black uppercase rounded-xl">
        Upload Skill Backup (.json)
    </button>
</div>
            <section class="space-y-8">
                <div class="flex justify-between items-end">
                    <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-purple-500 pl-6 tracking-[0.5em]">Class / Position Settings</h3>
                    <button onclick="addNewClass()" class="px-4 py-2 bg-purple-900/30 text-purple-400 border border-purple-500/30 rounded-lg text-[10px] font-bold uppercase hover:bg-purple-600 hover:text-white transition-all">+ Add Position</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${classes.map((cls, idx) => `
                        <div class="p-4 bg-neutral-900 border border-white/5 rounded-2xl flex items-center gap-4 relative group hover:border-purple-500/50 transition-colors">
                            <input type="color" id="cls-color-${idx}" value="${cls.color}" 
                                   class="w-12 h-12 rounded-xl border-none cursor-pointer bg-transparent" title="Change Color">
                            
                            <div class="flex-1 space-y-2">
                                <div>
                                    <input id="cls-name-${idx}" type="text" value="${cls.name}" 
                                           class="w-full bg-black border border-white/10 rounded-lg px-3 py-2 text-xs text-white font-bold uppercase focus:border-purple-500 outline-none placeholder-neutral-700"
                                           placeholder="DISPLAY NAME">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] font-bold text-neutral-600 uppercase w-8">CODE</span>
                                    <input id="cls-code-${idx}" type="text" value="${cls.code}" 
                                           class="flex-1 bg-black/50 border border-white/5 rounded px-2 py-1 text-[10px] text-neutral-400 font-mono uppercase focus:border-purple-500 outline-none"
                                           placeholder="ID (e.g. TANK)">
                                </div>
                            </div>

                            <button onclick="deleteClass(${idx})" class="absolute top-2 right-2 p-2 text-neutral-600 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100" title="Delete Class">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
                
                <button onclick="saveClassSettings()" class="w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl transition-all">
                    Save Class Configurations
                </button>
            </section>

            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-red-500 border-l-8 border-red-600 pl-6 tracking-[0.5em]">User Reports (Incoming)</h3>
                <div class="bg-neutral-900 border border-red-900/30 rounded-[2rem] p-8 min-h-[150px]" id="admin-reports-list">
                    <p class="text-neutral-500 text-xs italic text-center py-10">Accessing secure logs...</p>
                </div>
            </section>
            
            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">Recruitment Queue</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    ${pendings.map(a => `
                        <div class="p-8 bg-neutral-900 border border-white/5 rounded-[3rem] flex flex-col gap-8 shadow-2xl">
                            <div class="flex items-center gap-6">
                                <div class="w-16 h-16 rounded-[1.5rem] bg-black overflow-hidden shadow-inner">
                                    <img src="${a.profile}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 overflow-hidden">
                                    <p class="text-2xl font-black text-white uppercase truncate">${a.ocName}</p>
                                    <p class="text-[10px] text-neutral-500 font-mono mt-1">ID: ${a.loginId}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="approveUser('${a.loginId}')" class="py-4 bg-green-600 text-white text-[11px] font-black rounded-2xl uppercase tracking-widest shadow-lg shadow-green-900/20 active:scale-95 transition-all">Authorize</button>
                                <button onclick="rejectUser('${a.loginId}')" class="py-4 bg-neutral-800 text-neutral-400 text-[11px] font-black rounded-2xl uppercase active:scale-95 transition-all">Decline</button>
                            </div>
                        </div>`).join('')}
                    ${pendings.length === 0 ? '<p class="text-neutral-700 italic font-mono uppercase tracking-widest text-sm text-center col-span-full py-10">All signals clear.</p>' : ''}
                </div>
            </section>

            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">Personnel Files (Edit)</h3>
                <div class="grid grid-cols-1 gap-4">
                    ${approveds.map(a => `
                        <div class="p-6 bg-neutral-900/50 border border-white/5 rounded-3xl flex items-center justify-between group hover:border-amber-500/30 transition-all">
                            <div class="flex items-center gap-6">
                                <div class="w-14 h-14 rounded-2xl bg-black overflow-hidden"><img src="${a.profile}" class="w-full h-full object-cover"></div>
                                <div>
                                    <p class="text-lg font-black text-white uppercase">${a.ocName}</p>
                                    <p class="text-[10px] text-neutral-600 font-mono italic uppercase">ERA ID: ${a.loginId}</p>
                                </div>
                            </div>
                            <button onclick="showAdminEditModal('${a.loginId}')" class="px-6 py-3 bg-neutral-800 hover:bg-amber-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">Over-ride Record</button>
                        </div>
                    `).join('')}
                </div>
            </section>

            <div id="admin-edit-modal" class="hidden fixed inset-0 z-[120] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div id="admin-edit-container" class="w-full max-w-2xl bg-neutral-900 border border-amber-600/30 rounded-[4rem] p-12 shadow-2xl modal-enter"></div>
        </div>
        <div id="admin-reply-modal" class="hidden fixed inset-0 z-[130] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div class="w-full max-w-md bg-neutral-900 border border-amber-600/30 rounded-[3rem] p-10 shadow-2xl modal-enter">
                <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-4 text-center">Confirm & Reply</h3>
                <p class="text-xs text-neutral-500 text-center mb-6">This action will resolve the report and notify the user.</p>
                
                <textarea id="admin-reply-memo" class="w-full h-32 bg-black border border-white/10 rounded-2xl p-4 text-sm text-white resize-none outline-none focus:border-amber-500 mb-6" placeholder="Leave a message for the user..."></textarea>
                
                <div class="flex gap-4">
                    <button onclick="$('admin-reply-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button onclick="submitAdminResolution()" class="flex-1 py-4 bg-amber-600 text-white font-bold rounded-xl uppercase text-xs hover:bg-amber-700 shadow-lg">Confirm</button>
                </div>
            </div>
        </div>
        <section class="space-y-12 mt-20">
    <h3 class="text-xs font-black uppercase text-amber-500 border-l-8 border-amber-600 pl-6 tracking-[0.5em]">User Investigation Registry</h3>
    <div class="bg-neutral-900 border border-white/5 rounded-[2.5rem] overflow-hidden shadow-2xl">
        <table class="w-full text-left">
            <thead>
                <tr class="bg-white/5 border-b border-white/10 text-neutral-500 text-[9px] uppercase font-black tracking-widest">
                    <th class="p-6">Investigator</th>
                    <th class="p-6">Progress</th>
                    <th class="p-6 text-center">Clues</th>
                </tr>
            </thead>
            <tbody id="admin-user-investigation-list">
                <tr><td colspan="3" class="p-10 text-center text-neutral-600 italic">Syncing records...</td></tr>
            </tbody>
        </table>
    </div>
</section>

        </div>
        
        `;
    
    // 4. í›„ì²˜ë¦¬: ì„œë¸Œ ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ ë° ì•„ì´ì½˜ ë¡œë“œ
    if (window.updateAdminReportsUI) window.updateAdminReportsUI();
    if (window.loadUserInvestigationProgress) window.loadUserInvestigationProgress();
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// [ì¶”ê°€] ê´€ë¦¬ì í˜ì´ì§€ì— ì‹ ê³  ëª©ë¡ ê·¸ë¦¬ê¸°
window.updateAdminReportsUI = () => {
    const container = document.getElementById('admin-reports-list');
    if (!container) return;
    
    if (!state.reports || state.reports.length === 0) {
        container.innerHTML = '<p class="text-neutral-500 text-xs italic text-center py-10">No active reports.</p>';
        return;
    }
    
    container.innerHTML = state.reports
        .sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0))
        .map(r => `
            <div class="border-b border-white/5 pb-4 mb-4 last:border-0 last:mb-0 relative group">
                <div class="flex justify-between items-start mb-2 pr-16">
                    <span class="text-red-500 font-bold text-xs uppercase tracking-wider">TARGET ID: ${r.targetId}</span>
                    <span class="text-neutral-600 text-[10px] font-mono">${r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleString() : ''}</span>
                </div>
                <div class="text-white text-sm bg-black/50 p-4 rounded-xl mb-2 border border-white/5">
                    ${r.reason}
                </div>
                <p class="text-[10px] text-neutral-500 uppercase">
                    Reported by: <span class="text-amber-500 font-bold">${r.reporterName}</span> (${r.reporterId})
                </p>

                <div class="absolute bottom-4 right-0 flex gap-2">
                    <button onclick="openAdminReplyModal('${r.id}', '${r.reporterId}')" class="w-8 h-8 rounded-full bg-amber-600/20 text-amber-500 flex items-center justify-center hover:bg-amber-600 hover:text-white transition-all shadow-lg border border-amber-600/30" title="Confirm & Notify">
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteReport('${r.id}')" class="w-8 h-8 rounded-full bg-red-900/20 text-red-700 flex items-center justify-center hover:bg-red-600 hover:text-white transition-all border border-red-900/30" title="Ignore & Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `).join('');
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
// [ì¶”ê°€ë¨] ì±„íŒ…ë°© ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜ (ìµœëŒ€ 4ëª… í”„ì‚¬ í‘œì‹œ)
function getRoomIconHTML(room) {
    const myId = state.userAccount.loginId;
    
    // ë‚˜ë¥¼ ì œì™¸í•œ ë©¤ë²„ ID ëª©ë¡ ì¶”ì¶œ
    let targets = room.members.filter(id => id !== myId);
    
    // ë§Œì•½ ë‚˜ í˜¼ì ìˆëŠ” ë°©ì´ë©´(ë˜ëŠ” ëŒ€í™”ìƒëŒ€ê°€ ì—†ìœ¼ë©´) ë‚´ í”„ì‚¬ í‘œì‹œ
    if (targets.length === 0) targets = [myId];

    // ìµœëŒ€ 4ëª…ê¹Œì§€ë§Œ ì„ íƒ
    const displayIds = targets.slice(0, 4);

    // IDì— í•´ë‹¹í•˜ëŠ” í”„ë¡œí•„ ì´ë¯¸ì§€ URL ì°¾ê¸°
    const images = displayIds.map(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        return acc ? acc.profile : null;
    }).filter(img => img); // ì´ë¯¸ì§€ê°€ ìœ íš¨í•œ ê²ƒë§Œ ë‚¨ê¹€

    // Case 1: ì´ë¯¸ì§€ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ ì•„ì´ì½˜
    if (images.length === 0) {
        return `<div class="w-full h-full flex items-center justify-center bg-black"><i data-lucide="${room.type === 'group' ? 'users' : 'user'}" class="w-5 h-5 opacity-40"></i></div>`;
    }

    // Case 2: 1ëª…ì¼ ë•Œ (ê½‰ ì°¬ ì´ë¯¸ì§€)
    if (images.length === 1) {
        return `<img src="${images[0]}" class="w-full h-full object-cover">`;
    }

    // Case 3: 2~4ëª…ì¼ ë•Œ (2x2 ê·¸ë¦¬ë“œ)
    // 3ëª…ì¼ ë•ŒëŠ” ë§ˆì§€ë§‰ ì¹¸ì´ ë¹ˆì¹¸ìœ¼ë¡œ ë‚˜ì˜µë‹ˆë‹¤.
    return `
        <div class="grid grid-cols-2 w-full h-full bg-neutral-800">
            ${images.map(img => `<img src="${img}" class="w-full h-full object-cover">`).join('')}
        </div>
    `;
}
        window.showAdminEditModal = (loginId) => {
    // 1. ìœ ì € ë°ì´í„° ì°¾ê¸°
    const acc = state.accounts.find(a => a.loginId === loginId);
    if (!acc) return alert("User not found.");
    
    // 2. í´ë˜ìŠ¤(ì§ì—…êµ°) ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš© (ì˜¤ë¥˜ ë°©ì§€)
    const classes = state.world.classes || [];

    // 3. ëª¨ë‹¬ ìš”ì†Œ ì°¾ê¸°
    const modal = document.getElementById('admin-edit-modal');
    const container = document.getElementById('admin-edit-container');
    
    if (!modal || !container) {
        console.error("Admin modal elements not found!");
        return;
    }

    // 4. ëª¨ë‹¬ ë‚´ìš© ìƒì„±
    const currentRole = acc.role || 'runner';

    container.innerHTML = `
        <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-6">
            <div>
                <h3 class="text-3xl font-serif font-black text-white uppercase tracking-tighter">Over-ride Record</h3>
                <p class="text-[10px] text-amber-500 font-mono mt-1">Target ID: ${acc.loginId}</p>
            </div>
            <button onclick="document.getElementById('admin-edit-modal').classList.add('hidden')" class="text-neutral-500 hover:text-white transition-colors">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>

        <div class="space-y-8 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
            
            <div class="bg-amber-900/10 border border-amber-500/30 p-6 rounded-2xl">
                <h4 class="text-xs font-black text-amber-500 uppercase tracking-widest mb-4">Security Clearance (Role)</h4>
                <div class="relative">
                    <select id="admin-role" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white font-bold uppercase outline-none focus:border-amber-500 appearance-none">
                        <option value="runner" ${currentRole === 'runner' ? 'selected' : ''}>RUNNER (Standard User)</option>
                        <option value="staff" ${currentRole === 'staff' ? 'selected' : ''}>STAFF (Administrator)</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 pointer-events-none"></i>
                </div>
            </div>

            <div class="bg-neutral-800/30 border border-white/10 p-6 rounded-2xl mb-4">
                <h4 class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-3">Combat Position (Class)</h4>
                <div class="relative">
                    <select id="admin-position" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white font-bold uppercase outline-none focus:border-amber-500 appearance-none cursor-pointer hover:border-white/30 transition-colors">
                        <option value="UNASSIGNED">UNASSIGNED (ë¯¸ì§€ì •)</option>
                        ${classes.map(cls => `
                            <option value="${cls.code}" ${acc.position === cls.code ? 'selected' : ''}>
                                ${cls.name}
                            </option>
                        `).join('')}
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 pointer-events-none"></i>
                </div>
                <p class="text-[9px] text-neutral-600 mt-2 ml-1">* ì´ ì„¤ì •ì€ ê°¤ëŸ¬ë¦¬ í•„í„°ë§ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
            </div>

            <div class="bg-neutral-900/50 border border-white/10 p-4 rounded-2xl flex items-center justify-between">
                <div>
                    <h4 class="text-[10px] font-black text-neutral-500 uppercase tracking-widest mb-1">Account Security</h4>
                    <p class="text-xs text-neutral-400 font-mono">${acc.email || 'No Email Registered'}</p>
                </div>
                <button onclick="handleSendPasswordReset('${acc.email}')" class="flex items-center gap-2 px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 rounded-xl border border-white/5 transition-colors text-xs font-bold uppercase">
                    <i data-lucide="key" class="w-4 h-4"></i> Reset PW
                </button>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Basic Info</h4>
                
                <div>
                    <label class="text-[10px] font-bold text-amber-500 uppercase block mb-1">Email Address</label>
                    <input id="admin-email" value="${acc.email || ''}" 
                           class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white outline-none focus:border-amber-500"
                           placeholder="personnel@example.com">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Badge</label>
                    <input id="admin-badge" value="${acc.badgeText || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-amber-500 font-bold">
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Name</label>
                    <input id="admin-ocname" value="${acc.ocName || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white font-bold">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Visual Resource (Image URL)</label>
                    <input id="admin-profile" value="${acc.profile || ''}" 
                           class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400 outline-none focus:border-amber-500"
                           placeholder="https://...">
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Texts</h4>
                <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Slogan</label>
                <input id="admin-slogan" value="${acc.slogan || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white italic"></div>
                <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Short Desc</label>
                <input id="admin-shortDesc" value="${acc.shortDesc || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white"></div>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Link Button</h4>
                <div class="grid grid-cols-2 gap-4">
                    <input id="admin-linkText" value="${acc.linkText || ''}" placeholder="Name" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                    <input id="admin-linkUrl" value="${acc.linkUrl || ''}" placeholder="URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-amber-500">
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Keywords</h4>
                <div class="grid grid-cols-3 gap-4">
                    <input id="admin-kw1" value="${acc.keyword1 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-500">
                    <input id="admin-kw2" value="${acc.keyword2 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-400">
                    <input id="admin-kw3" value="${acc.keyword3 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-300">
                </div>
            </div>

            <div>
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3 mb-4">Details</h4>
                <textarea id="admin-stats" class="w-full bg-black border border-white/10 rounded-xl px-6 py-4 text-xs text-white h-32 resize-none custom-scrollbar leading-relaxed">${acc.stats || ''}</textarea>
            </div>
        </div>
        
        <div class="mt-8 space-y-3">
            <button onclick="handleAdminUpdate('${acc.loginId}')" class="w-full py-5 bg-amber-600 text-white font-black rounded-2xl uppercase tracking-[0.2em] text-xs shadow-2xl active:scale-95 transition-all hover:bg-amber-700">Confirm Over-ride</button>
            
            <button onclick="deleteUserAccount('${acc.loginId}')" class="w-full py-4 bg-red-900/20 border border-red-500/30 text-red-500 font-bold rounded-2xl uppercase tracking-[0.2em] text-[10px] hover:bg-red-900/80 hover:text-white transition-all flex items-center justify-center gap-2">
                <i data-lucide="skull" class="w-4 h-4"></i> Terminate Account
            </button>
        </div>
    `;
    
    // 5. ëª¨ë‹¬ í‘œì‹œ ë° ì•„ì´ì½˜ ë¡œë“œ
    modal.classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.changeMapImage = async (sectorIdx) => {
    if (!state.isAdmin) return;
    
    const sector = state.investigation.sectors[sectorIdx];
    const newUrl = prompt("ìƒˆë¡œìš´ ë§µ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:", sector.map);
    
    if (newUrl && newUrl.trim() !== "") {
        // ë¡œì»¬ ìƒíƒœ ë°˜ì˜
        state.investigation.sectors[sectorIdx].map = newUrl;
        
        // ì¤‘ìš”: ì„œë²„ ì €ì¥ ì‹œ investigation ì „ì²´ ê°ì²´ë¥¼ ë„˜ê²¨ì•¼ í•©ë‹ˆë‹¤.
        await window.handleSystemUpdate(); 
        renderInvestigation(); // í™”ë©´ ê°±ì‹ 
        showToast(`${sector.name} ì§€ë„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
};
// --- í•µì‹¬ ê´€ë¦¬ ë³€ìˆ˜ ---
let currentEditingIdx = null;
let playIndex = 0;
let activeTimeline = [];

// --- [í•´ê²°] ë¸”ë¡ ì¶”ê°€ í•¨ìˆ˜ë¥¼ ì „ì—­(window)ì— í™•ì‹¤íˆ ë“±ë¡ ---
window.addTimelineBlock = function(type, data = {}) {
    const container = document.getElementById('timeline-container');
    if (!container) {
        console.error("ì—ë””í„° ì»¨í…Œì´ë„ˆ(timeline-container)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const block = document.createElement('div');
    block.className = `p-4 rounded-2xl border timeline-block animate-fade-in relative bg-white/5 mb-3`;
    block.dataset.type = type;

    let inner = `<button onclick="this.parentElement.remove()" class="absolute top-2 right-3 text-white/20 hover:text-red-500 text-lg">Ã—</button>`;

    if (type === 'npc') {
        inner += `
            <div class="space-y-2">
                <span class="text-[9px] font-black text-blue-400 uppercase">NPC Dialogue</span>
                <input placeholder="í™”ì ì´ë¦„" class="blk-name w-full bg-black/40 border-none rounded-lg p-2 text-xs text-white" value="${data.name || ''}">
                <input placeholder="ì´ë¯¸ì§€ URL" class="blk-img w-full bg-black/40 border-none rounded-lg p-2 text-[10px] text-white/40" value="${data.img || ''}">
                <textarea placeholder="ëŒ€ì‚¬ ë‚´ìš©" class="blk-text w-full bg-black/40 border-none rounded-lg p-2 text-xs text-white h-16 resize-none">${data.text || ''}</textarea>
            </div>`;
    } else if (type === 'monologue') {
        inner += `
            <div class="space-y-2">
                <span class="text-[9px] font-black text-purple-400 uppercase">Monologue</span>
                <textarea placeholder="ë‚˜ì˜ ë…ë°± ë‚´ìš©" class="blk-text w-full bg-black/40 border-none rounded-lg p-2 text-xs text-purple-200 h-16 resize-none">${data.text || ''}</textarea>
            </div>`;
    } else if (type === 'choice') {
        inner += `
            <div class="space-y-2">
                <span class="text-[9px] font-black text-amber-400 uppercase">Decision Point</span>
                <input placeholder="ì„ íƒì§€ 1" class="blk-opt1 w-full bg-black/40 border-none rounded-lg p-2 text-xs text-amber-500" value="${data.opt1 || ''}">
                <textarea placeholder="ê²°ê³¼ ëŒ€ì‚¬ 1" class="blk-res1 w-full bg-black/40 border-none rounded-lg p-2 text-[10px] text-white/60 h-10">${data.res1 || ''}</textarea>
                <input placeholder="ì„ íƒì§€ 2" class="blk-opt2 w-full bg-black/40 border-none rounded-lg p-2 text-xs text-amber-500" value="${data.opt2 || ''}">
                <textarea placeholder="ê²°ê³¼ ëŒ€ì‚¬ 2" class="blk-res2 w-full bg-black/40 border-none rounded-lg p-2 text-[10px] text-white/60 h-10">${data.res2 || ''}</textarea>
            </div>`;
    }

    block.innerHTML = inner;
    container.appendChild(block);
    container.scrollTop = container.scrollHeight;
};
window.editPOI = (globalIdx) => {
    if (!state.isAdmin) return;
    currentEditingIdx = globalIdx;
    const p = state.investigation.points[globalIdx];
    
    document.getElementById('edit-poi-title').value = p.title || "";
    const container = document.getElementById('timeline-container');
    container.innerHTML = ''; // ì´ˆê¸°í™”
    
    if (p.timeline && p.timeline.length > 0) {
        p.timeline.forEach(item => addTimelineBlock(item.type, item));
    }
    
    document.getElementById('poi-editor-modal').classList.remove('hidden');
};
window.savePOITimeline = async () => {
    if (currentEditingIdx === null) return;
    
    const blocks = document.querySelectorAll('.timeline-block');
    const timeline = Array.from(blocks).map(blk => {
        const type = blk.dataset.type;
        const d = { type };
        if (type === 'npc') {
            d.name = blk.querySelector('.blk-name').value;
            d.img = blk.querySelector('.blk-img').value;
            d.text = blk.querySelector('.blk-text').value;
        } else if (type === 'monologue') {
            d.text = blk.querySelector('.blk-text').value;
        } else if (type === 'choice') {
            d.opt1 = blk.querySelector('.blk-opt1').value;
            d.res1 = blk.querySelector('.blk-res1').value;
            d.opt2 = blk.querySelector('.blk-opt2').value;
            d.res2 = blk.querySelector('.blk-res2').value;
        }
        return d;
    });

    state.investigation.points[currentEditingIdx].title = document.getElementById('edit-poi-title').value;
    state.investigation.points[currentEditingIdx].timeline = timeline;
    
    if (window.handleSystemUpdate) {
        await window.handleSystemUpdate();
    }
    
    document.getElementById('poi-editor-modal').classList.add('hidden');
    renderInvestigation();
    showToast("ì‹œë‚˜ë¦¬ì˜¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

window.savePOIEasy = async () => {
    if (currentEditingIdx === null) return;
    
    // 1. ì…ë ¥ì°½ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const title = document.getElementById('edit-poi-title').value;
    const clue = document.getElementById('edit-poi-clue').value;
    const isInteractive = document.getElementById('edit-poi-interactive').checked;
    const npcName = document.getElementById('edit-poi-npc-name').value;
    const npcImage = document.getElementById('edit-poi-npc-image').value;

    // 2. ì„ íƒì§€ ë°°ì—´ êµ¬ì„±
    const options = [];
    const opt1Text = document.getElementById('edit-opt1-text').value;
    if(opt1Text) {
        options.push({ text: opt1Text, result: document.getElementById('edit-opt1-res').value });
    }
    const opt2Text = document.getElementById('edit-opt2-text').value;
    if(opt2Text) {
        options.push({ text: opt2Text, result: document.getElementById('edit-opt2-res').value });
    }

    // 3. ë¡œì»¬ state ì—…ë°ì´íŠ¸
    state.investigation.points[currentEditingIdx] = {
        ...state.investigation.points[currentEditingIdx], // ê¸°ì¡´ ID, ì¢Œí‘œ, ì„¹ì…˜ ìœ ì§€
        title: title,
        clue: clue,
        isInteractive: isInteractive,
        npcName: npcName,
        npcImage: npcImage,
        options: options
    };
    
    // 4. ì„œë²„ ë™ê¸°í™” ë° UI ê°±ì‹ 
    try {
        if (window.handleSystemUpdate) {
            await window.handleSystemUpdate(); // ì—¬ê¸°ì„œ ì„œë²„ë¡œ ì‹¤ì œ ì €ì¥ì´ ì¼ì–´ë‚©ë‹ˆë‹¤.
        }
        document.getElementById('poi-editor-modal').classList.add('hidden');
        renderInvestigation(); // ë§µ ìœ„ì˜ ì ë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        showToast("ì§€ì  ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (e) {
        console.error("Update Error:", e);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
};

window.savePOIJson = async () => {
    try {
        const newData = JSON.parse(document.getElementById('poi-json-input').value);
        state.investigation.points[currentEditingIdx] = {
            ...state.investigation.points[currentEditingIdx],
            ...newData
        };
        await handleSystemUpdate();
        document.getElementById('poi-editor-modal').classList.add('hidden');
        renderInvestigation();
        showToast("ë°ì´í„°ê°€ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (e) {
        alert("JSON í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
};
window.handleMapClick = async (event) => {
    if (!state.isAdmin) return;
    if (event.target.closest('.clue-point')) return;

    const container = document.getElementById('map-container');
    const rect = container.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 100;
    const y = ((event.clientY - rect.top) / rect.height) * 100;

    const newPoint = {
        id: 'p' + Date.now(),
        sector: state.investigation.selectedSector,
        x: parseFloat(x.toFixed(2)),
        y: parseFloat(y.toFixed(2)),
        title: "ìƒˆ ì¡°ì‚¬ ì§€ì ",
        clue: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.",
        isInteractive: false,
        options: []
    };

    state.investigation.points.push(newPoint);
    await handleSystemUpdate();
    renderInvestigation();
    showToast("ì§€ì ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. EDITì„ ëˆŒëŸ¬ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”.");
};
// 2. í¬ì¸íŠ¸ ìš°í´ë¦­ ì‹œ ì‚­ì œ (ê´€ë¦¬ì ì „ìš©)
window.handlePointRightClick = (event, idx) => {
    if (!state.isAdmin) return;
    event.preventDefault();
    event.stopPropagation();

    if (confirm(`'${state.investigation.points[idx].title}' ì§€ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        state.investigation.points.splice(idx, 1);
        
        if (window.handleSystemUpdate) {
            window.handleSystemUpdate();
        }
        
        renderInvestigation();
        showToast("ì§€ì ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
};
window.loadUserInvestigationProgress = async () => {
    const listBody = document.getElementById('admin-user-investigation-list');
    if (!listBody) return;

    try {
        // 1. ëª¨ë“  ìœ ì € ê³„ì • ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ (ê¸°ì¡´ accounts ë°°ì—´ í™œìš© ê°€ëŠ¥)
        // ë§Œì•½ ìµœì‹  ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ì•¼ í•œë‹¤ë©´ ì•„ë˜ ë¡œì§ ì‚¬ìš©
        const usersRef = collection(db, 'artifacts', appId, 'accounts');
        const q = query(usersRef, orderBy('name', 'asc'));
        const querySnapshot = await getDocs(q);
        
        let html = '';
        const totalPoints = state.investigation.points.length; // ì „ì²´ ë‹¨ì„œ ê°œìˆ˜

        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const foundClues = userData.investigation?.foundClueIds || []; // ìœ ì € ë¬¸ì„œ ë‚´ ì €ì¥ëœ ì¡°ì‚¬ ë°ì´í„°
            const count = foundClues.length;
            const percentage = totalPoints > 0 ? Math.round((count / totalPoints) * 100) : 0;

            html += `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-neutral-800 border border-white/10 overflow-hidden flex-shrink-0">
                                ${userData.img ? `<img src="${userData.img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-neutral-600"><i data-lucide="user" class="w-4 h-4"></i></div>`}
                            </div>
                            <div>
                                <p class="text-sm font-black text-white">${userData.name || 'Unknown'}</p>
                                <p class="text-[9px] text-neutral-600 font-mono">${userData.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-6 w-64">
                        <div class="flex items-center gap-4">
                            <div class="flex-1 h-1.5 bg-neutral-800 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-600 shadow-[0_0_10px_rgba(217,119,6,0.5)]" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-[10px] font-black text-amber-500 w-10 text-right">${percentage}%</span>
                        </div>
                    </td>
                    <td class="p-6 text-center">
                        <span class="px-3 py-1 bg-neutral-800 border border-white/10 rounded-full text-[10px] font-mono text-neutral-300">
                            ${count} / ${totalPoints}
                        </span>
                    </td>
                </tr>
            `;
        });

        listBody.innerHTML = html || '<tr><td colspan="3" class="p-20 text-center text-neutral-600 italic">No users registered.</td></tr>';
        if (typeof lucide !== 'undefined') lucide.createIcons();

    } catch (e) {
        console.error("ëª…ë‹¨ ë¡œë”© ì‹¤íŒ¨:", e);
        listBody.innerHTML = '<tr><td colspan="3" class="p-20 text-center text-red-900/50 italic">Failed to load data.</td></tr>';
    }
};

// ê´€ë¦¬ì í˜ì´ì§€ ì§„ì… ì‹œ ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œí•˜ë„ë¡ renderAdmin í•˜ë‹¨ì— ì¶”ê°€
// window.loadUserInvestigationProgress();
window.handleAdminUpdate = async (loginId) => {
    try {
        const getVal = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : "";
        };

        const data = { 
            role: getVal('admin-role'),
            position: getVal('admin-position'), 
    email: getVal('admin-email'),
    badgeText: getVal('admin-badge'),
    ocName: getVal('admin-ocname'),
            email: getVal('admin-email'),
            badgeText: getVal('admin-badge'),
            ocName: getVal('admin-ocname'), 
            profile: getVal('admin-profile'), // ì´ ë¶€ë¶„ì˜ IDê°€ 'admin-profile'ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
            slogan: getVal('admin-slogan'), 
            shortDesc: getVal('admin-shortDesc'),
            linkText: getVal('admin-linkText'),
            linkUrl: getVal('admin-linkUrl'),
            keyword1: getVal('admin-kw1'),
            keyword2: getVal('admin-kw2'),
            keyword3: getVal('admin-kw3'),
            stats: getVal('admin-stats') 
        };

        const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
        await setDoc(accountRef, data, { merge: true });

        document.getElementById('admin-edit-modal').classList.add('hidden');
        showToast("Record Synchronized.");
        
        const idx = state.accounts.findIndex(a => a.loginId === loginId);
        if (idx !== -1) state.accounts[idx] = { ...state.accounts[idx], ...data };

    } catch (e) {
        console.error("ì €ì¥ ì¤‘ ì—ëŸ¬ ë°œìƒ:", e);
        showToast("Update Failed.");
    }
};


window.returnToSectors = () => {
    if (!state.investigation) return;
    state.investigation.selectedSector = null; // ì„ íƒëœ ì„¹í„° ì´ˆê¸°í™”
    renderInvestigation(); // ë‹¤ì‹œ ê·¸ë¦¬ë©´ selectedSectorê°€ nullì´ë¼ ì„¹í„° ì„ íƒì°½ì´ ëœ¹ë‹ˆë‹¤.
};

// 2. ê´€ë¦¬ììš© ìœ ì € ì¡°ì‚¬ ì§„ì²™ë„ ëª…ë‹¨ ë¡œë“œ í•¨ìˆ˜
window.loadUserInvestigationProgress = async () => {
    const listBody = document.getElementById('admin-user-investigation-list');
    if (!listBody) return;

    try {
        const usersRef = collection(db, 'artifacts', appId, 'accounts');
        const q = query(usersRef, orderBy('name', 'asc'));
        const querySnapshot = await getDocs(q);
        
        let html = '';
        const totalPoints = state.investigation.points.length;

        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const foundClues = userData.investigation?.foundClueIds || [];
            const count = foundClues.length;
            const percentage = totalPoints > 0 ? Math.round((count / totalPoints) * 100) : 0;

            html += `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-4 text-left">
                            <div class="w-10 h-10 rounded-full bg-neutral-800 border border-white/10 overflow-hidden">
                                ${userData.img ? `<img src="${userData.img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-neutral-600"><i data-lucide="user" class="w-4 h-4"></i></div>`}
                            </div>
                            <div>
                                <p class="text-sm font-black text-white">${userData.name || 'Unknown'}</p>
                                <p class="text-[9px] text-neutral-600 font-mono">${userData.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-6 w-64">
                        <div class="flex items-center gap-4">
                            <div class="flex-1 h-1.5 bg-neutral-800 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-600 shadow-[0_0_10px_rgba(217,119,6,0.5)]" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-[10px] font-black text-amber-500 w-10 text-right">${percentage}%</span>
                        </div>
                    </td>
                    <td class="p-6 text-center text-[10px] font-mono text-neutral-300">
                        ${count} / ${totalPoints}
                    </td>
                </tr>
            `;
        });

        listBody.innerHTML = html || '<tr><td colspan="3" class="p-20 text-center text-neutral-600">No data.</td></tr>';
        if (typeof lucide !== 'undefined') lucide.createIcons();

    } catch (e) {
        console.error("ëª…ë‹¨ ë¡œë”© ì‹¤íŒ¨:", e);
    }
};

window.handleDiscovery = (id) => {
    const point = state.investigation.points.find(p => p.id === id);
    if (!point) return;

    // íƒ€ì„ë¼ì¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
    activeTimeline = point.timeline || [];
    playIndex = 0;
    
    const panel = document.getElementById('discovery-panel');
    if (panel) {
        panel.classList.remove('hidden');
        
        // ë¸”ë¡ì´ í•˜ë‚˜ë„ ì—†ì„ ê²½ìš° ì²˜ë¦¬
        if (activeTimeline.length === 0) {
            document.getElementById('discovery-name').innerText = "ì‹œìŠ¤í…œ";
            document.getElementById('discovery-clue').innerText = "ì•„ì§ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì‘ì„±ë˜ì§€ ì•Šì€ ì§€ì ì…ë‹ˆë‹¤.";
            document.getElementById('discovery-next-btn').onclick = () => panel.classList.add('hidden');
        } else {
            playNextStep();
        }
    }
};

function playNextStep() {
    if (playIndex >= activeTimeline.length) {
        const panel = document.getElementById('discovery-panel');
        if (panel) panel.classList.add('hidden');
        return;
    }

    const step = activeTimeline[playIndex];
    const nameEl = document.getElementById('discovery-name');
    const clueEl = document.getElementById('discovery-clue');
    const npcImg = document.getElementById('discovery-npc');
    const optionsEl = document.getElementById('discovery-options');
    const nextBtn = document.getElementById('discovery-next-btn');

    if (optionsEl) optionsEl.innerHTML = '';
    if (nextBtn) nextBtn.classList.remove('hidden');

    const triggerFadeIn = () => {
        if (!clueEl) return;
        clueEl.classList.remove('animate-fade-in');
        void clueEl.offsetWidth;
        clueEl.classList.add('animate-fade-in');
    };

    // --- [ì¶”ê°€] ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜ ---
    const recordToLog = (speaker, text) => {
        if (!text) return;
        // ê¸°ì¡´ì— ë§Œë“¤ì–´ë‘” addInvestigationLog í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
        if (typeof addInvestigationLog === 'function') {
            addInvestigationLog(speaker, text);
            // ìš°ì¸¡ UI ë¦¬ìŠ¤íŠ¸ë¥¼ ì¦‰ì‹œ ê°±ì‹ í•©ë‹ˆë‹¤.
            if (window.updateInvestigationSideList) window.updateInvestigationSideList();
        }
    };

    if (step.type === 'npc' || step.type === 'monologue') {
        const speakerName = step.name || (step.type === 'monologue' ? "ë‚˜" : "???");
        const message = step.text || "";

        if (nameEl) nameEl.innerText = speakerName;
        if (clueEl) {
            clueEl.innerText = message;
            triggerFadeIn();
        }

        // NPC ì´ë¯¸ì§€ ì²˜ë¦¬
        if (npcImg) {
            if (step.type === 'npc' && step.img) {
                npcImg.src = step.img;
                npcImg.style.opacity = "1";
                npcImg.style.transform = "translateY(0)";
            } else {
                npcImg.style.opacity = "0";
                npcImg.style.transform = "translateY(20px)";
            }
        }

        // --- ì‹¤ì‹œê°„ ë¡œê·¸ ê¸°ë¡ ---
        recordToLog(speakerName, message);

        if (nextBtn) nextBtn.onclick = playNextStep;

    } else if (step.type === 'choice') {
        if (nextBtn) nextBtn.classList.add('hidden');
        if (nameEl) nameEl.innerText = "ì„ íƒì§€";
        if (clueEl) clueEl.innerText = "ì„ íƒì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...";

        [1, 2].forEach(i => {
            const optText = step['opt' + i];
            const resText = step['res' + i];
            
            if (optText) {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 mb-3 bg-white/5 border border-white/10 rounded-xl text-left text-white text-sm hover:bg-white hover:text-black transition-all flex items-center gap-3 group";
                btn.innerHTML = `<span class="w-1.5 h-1.5 bg-amber-500 rounded-full group-hover:scale-150 transition-transform"></span> ${optText}`;
                
                btn.onclick = () => {
                    if (clueEl) {
                        clueEl.innerText = resText || "";
                        triggerFadeIn();
                    }
                    
                    // --- ì„ íƒ ê²°ê³¼ ë¡œê·¸ ê¸°ë¡ ---
                    recordToLog(`ì„ íƒ: ${optText}`, resText);

                    if (optionsEl) optionsEl.innerHTML = '';
                    if (nextBtn) {
                        nextBtn.classList.remove('hidden');
                        nextBtn.onclick = playNextStep;
                    }
                };
                if (optionsEl) optionsEl.appendChild(btn);
            }
        });
    }

    playIndex++;
}

// ì„ íƒì§€ í‘œì‹œ (ì„¸ë ¨ëœ ì• ë‹ˆë©”ì´ì…˜ ë²„íŠ¼)
function showOptions(point) {
    const optionsEl = document.getElementById('discovery-options');
    optionsEl.innerHTML = '';
    
    point.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "group relative px-10 py-4 bg-white/5 hover:bg-white text-white hover:text-black border border-white/20 rounded-full text-sm font-bold transition-all duration-300 transform hover:translate-x-4 flex items-center gap-4";
        btn.innerHTML = `
            <span class="w-2 h-2 bg-amber-500 rounded-full group-hover:scale-150 transition-transform"></span>
            ${opt.text}
        `;
        btn.onclick = () => {
            // ì„ íƒ ê²°ê³¼ë„ ëŒ€í™”ì°½ì— í‘œì‹œ
            document.getElementById('discovery-clue').innerText = opt.result;
            optionsEl.innerHTML = '';
            setTimeout(() => finishInvestigation(point), 2000);
        };
        optionsEl.appendChild(btn);
    });
}

function finishInvestigation(point) {
    // ê¸°ë¡ ì €ì¥ ë° ì¢…ë£Œ ë¡œì§
    let localFoundIds = JSON.parse(localStorage.getItem('my_found_clues') || "[]");
    if (!localFoundIds.includes(point.id)) {
        localFoundIds.push(point.id);
        localStorage.setItem('my_found_clues', JSON.stringify(localFoundIds));
    }
    // "Close" ë²„íŠ¼ ë…¸ì¶œ í˜¹ì€ ìë™ ë‹«ê¸°
    document.getElementById('discovery-next-btn').innerHTML = "Close Signal";
    document.getElementById('discovery-next-btn').classList.remove('hidden');
    document.getElementById('discovery-next-btn').onclick = () => {
        document.getElementById('discovery-panel').classList.add('hidden');
    };
}

function addInvestigationLog(title, text) {
    if (!state.investigation.logs) state.investigation.logs = []; 
    
    state.investigation.logs.push({
        title: title,
        text: text,
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    });
}
window.saveInvestigationToDB = async () => {
    try {
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await updateDoc(worldRef, {
            "investigation.points": state.investigation.points,
            "investigation.currentMap": state.investigation.currentMap
        });
    } catch (e) {
        console.error("DB Sync Error:", e);
    }
};
window.toggleArchive = () => {
    const modal = document.getElementById('archive-modal');
    const list = document.getElementById('archive-list');
    if (!modal || !list) return;

    modal.classList.toggle('hidden');

    if (!modal.classList.contains('hidden')) {
        const inv = state.investigation;
        const foundClues = inv.points.filter(p => inv.foundClueIds.includes(p.id));

        if (foundClues.length === 0) {
            list.innerHTML = '<p class="text-center text-neutral-600 py-10 italic text-sm font-mono">NO SIGNALS ARCHIVED.</p>';
        } else {
            list.innerHTML = foundClues.map(c => {
                const isNew = !inv.viewedClueIds.includes(c.id);
                return `
                    <div onclick="showFullClue('${c.id}')" 
                         class="p-6 bg-black/40 border border-white/5 rounded-2xl mb-4 cursor-pointer hover:border-amber-500/40 transition-all group relative">
                        <div class="flex justify-between items-center mb-2 pointer-events-none">
                            <p class="text-amber-500 text-[10px] font-black uppercase tracking-[0.2em]">${c.title}</p>
                            ${isNew ? '<span class="bg-red-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded shadow-lg animate-pulse">NEW</span>' : ''}
                        </div>
                        <p class="text-xs text-neutral-400 line-clamp-1 group-hover:text-neutral-200 transition-colors pointer-events-none italic">"${c.clue}"</p>
                    </div>`;
            }).join('');
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
};

window.showFullClue = async (id) => {
    const inv = state.investigation;
    const clue = inv.points.find(p => p.id === id);
    if (!clue) return;

    // ì½ìŒ ì²˜ë¦¬ (NEW ì œê±°)
    if (!inv.viewedClueIds.includes(id)) {
        inv.viewedClueIds.push(id);
        if (window.handleSystemUpdate) await window.handleSystemUpdate();
    }

    const panel = document.getElementById('discovery-panel');
    $('discovery-title').innerText = `Archive: ${clue.title}`;
    $('discovery-clue').innerText = `"${clue.clue}"`;
    panel.classList.remove('hidden');
    
    // ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ê°±ì‹  (ëª¨ë‹¬ ë‹«ì§€ ì•Šê³  ê·¸ë¦¬ê¸°)
    window.toggleArchive(); window.toggleArchive(); 
};

// ë‹¨ì„œ ì „ë¬¸ ë³´ê¸° í•¨ìˆ˜
window.showFullClue = async (id) => {
    const inv = state.investigation;
    const clue = inv.points.find(p => p.id === id);
    if (!clue) return;

    // 1. ì½ìŒ ì²˜ë¦¬ (NEW ì œê±°)
    if (!inv.viewedClueIds) inv.viewedClueIds = [];
    if (!inv.viewedClueIds.includes(id)) {
        inv.viewedClueIds.push(id);
        // ì„œë²„ ìƒíƒœ ì €ì¥
        if (window.handleSystemUpdate) await window.handleSystemUpdate();
    }

    // 2. ì „ë¬¸ì„ ë³´ì—¬ì¤„ íŒì—… (discovery-panel ì¬í™œìš©)
    const panel = document.getElementById('discovery-panel');
    const title = document.getElementById('discovery-title');
    const clueText = document.getElementById('discovery-clue');

    if (panel && title && clueText) {
        title.innerText = `Archive: ${clue.title}`;
        clueText.innerText = `"${clue.clue}"`;
        panel.classList.remove('hidden');
    }
    
    // 3. ì•„ì¹´ì´ë¸Œ ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ê°±ì‹  (NEW ë°°ì§€ ì¦‰ì‹œ ì œê±°)
    // ëª¨ë‹¬ì„ ë‹«ì§€ ì•Šê³  ë‚´ìš©ë§Œ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
    const list = document.getElementById('archive-list');
    if (list) {
        const foundIds = inv.foundClueIds || [];
        const viewedIds = inv.viewedClueIds || [];
        const foundClues = inv.points.filter(p => foundIds.includes(p.id));
        
        list.innerHTML = foundClues.map(c => {
            const isNew = !viewedIds.includes(c.id);
            return `
                <div onclick="showFullClue('${c.id}')" 
                     class="p-5 bg-black/40 border border-white/5 rounded-2xl mb-4 cursor-pointer hover:border-amber-500/50 transition-all group relative">
                    <div class="flex justify-between items-center mb-2 pointer-events-none">
                        <p class="text-amber-500 text-[10px] font-black uppercase tracking-widest">${c.title}</p>
                        ${isNew ? '<span class="new-badge">NEW</span>' : ''}
                    </div>
                    <p class="text-xs text-neutral-500 line-clamp-1 group-hover:text-neutral-300 transition-colors pointer-events-none">${c.clue}</p>
                </div>`;
        }).join('');
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
        // [ì¶”ê°€] ì‹œìŠ¤í…œ ë°°ë„ˆ(ê´€ë¦¬ì ì „ìš©) ì €ì¥ í•¨ìˆ˜
window.handleSystemUpdate = async () => {
    // 1. ë°ì´í„° ëª¨ìœ¼ê¸° (ì…ë ¥ í•„ë“œê°€ ì—†ì„ ê²½ìš° ê¸°ì¡´ state ê°’ì„ ì‚¬ìš©í•˜ë„ë¡ ë°©ì–´ ì½”ë“œ ì¶”ê°€)
    const updateData = {
        // ë°°ë„ˆ ë° ë°°ê²½ ì„¤ì • (í™”ë©´ì— ì…ë ¥ì°½ì´ ìˆì„ ë•Œë§Œ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ í˜„ì¬ ê°’ì„ ìœ ì§€)
        login_bg: document.getElementById('sys-login-bg')?.value || state.world.login_bg || "",
        
        banner1_text: document.getElementById('sys-btn1-text')?.value || state.world.banner1_text || "",
        banner1_url: document.getElementById('sys-btn1-url')?.value || state.world.banner1_url || "",
        banner1_img: document.getElementById('sys-btn1-img')?.value || state.world.banner1_img || "",
        
        banner2_text: document.getElementById('sys-btn2-text')?.value || state.world.banner2_text || "",
        banner2_url: document.getElementById('sys-btn2-url')?.value || state.world.banner2_url || "",
        banner2_img: document.getElementById('sys-btn2-img')?.value || state.world.banner2_img || "",
        
        banner3_text: document.getElementById('sys-btn3-text')?.value || state.world.banner3_text || "",
        banner3_url: document.getElementById('sys-btn3-url')?.value || state.world.banner3_url || "",
        banner3_img: document.getElementById('sys-btn3-img')?.value || state.world.banner3_img || "",

        // [ì¤‘ìš”] ì¡°ì‚¬ ì‹œìŠ¤í…œ ì „ì²´ ë°ì´í„° í¬í•¨
        investigation: state.investigation
    };
    
    try {
        // 2. Firebase ê²½ë¡œ ì„¤ì •
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        
        // 3. ì„œë²„ì— ë°ì´í„° ì „ì†¡ (data ëŒ€ì‹  updateDataë¡œ ë³€ìˆ˜ëª… ì¼ì¹˜)
        await setDoc(worldRef, updateData, { merge: true });
        
        // ë¡œì»¬ ë°ì´í„°ë„ ìµœì‹ í™”
        state.world = { ...state.world, ...updateData };
        
        console.log("ì„œë²„ ì €ì¥ ì„±ê³µ:", updateData);
        showToast("ë°ì´í„°ê°€ ì„œë²„ì— ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (e) {
        console.error("ì„œë²„ ì €ì¥ ì—ëŸ¬ ìƒì„¸:", e);
        showToast("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. F12 ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
    }
};

        window.handleAdminAuth = () => { if ($('admin-pw-input').value === ADMIN_PW) { state.isAdmin = true; renderView('admin'); } else showToast("Access Denied."); };
        window.approveUser = async (id) => { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { status: 'approved' }, { merge: true }); showToast("Authorized."); };
        window.rejectUser = async (id) => { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { status: 'rejected' }, { merge: true }); };

        function showAuthGate() {
    const gate = $('auth-view');
    const dynamicBg = $('auth-dynamic-bg');
    
    // ê´€ë¦¬ìê°€ ì„¤ì •í•œ ì „ìš© ë°°ê²½ì´ ìˆìœ¼ë©´ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’(Banner 01 ë“±)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const bgUrl = state.world.login_bg || state.world.banner1_img || '';
    
    if (dynamicBg && bgUrl) {
        dynamicBg.style.backgroundImage = `url('${bgUrl}')`;
    }

    gate.classList.remove('hidden');
    
    if (state.authMode === 'login') {
        $('signup-extra').classList.add('hidden');
        $('auth-submit-btn').innerText = "Initialize Session";
        $('auth-toggle-btn').innerText = "Request New Identity";
    } else {
        $('signup-extra').classList.remove('hidden');
        $('auth-submit-btn').innerText = "Submit Application";
        $('auth-toggle-btn').innerText = "Already have an ID?";
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

        function setupAuthEvents() {
            $('auth-toggle-btn').onclick = () => { state.authMode = state.authMode === 'login' ? 'signup' : 'login'; showAuthGate(); };
            $('auth-submit-btn').onclick = async () => {
                const id = $('auth-id').value.trim();
                const pw = $('auth-pw').value.trim();
                if (!id || !pw) return showToast("Enter credentials.");
                if (state.authMode === 'signup') {
                    const ocName = $('auth-oc-name').value.trim();
                    if (!ocName) return showToast("Enter OC Name.");
                    const exists = state.accounts.find(a => a.loginId === id);
                    if (exists) return showToast("ID already exists.");
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), {
                            uid: state.user.uid, loginId: id, password: pw, ocName: ocName,
                            profile: "https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png",
                            slogan: "ìºì¹˜í”„ë ˆì´ì¦ˆë¥¼ ì…ë ¥í•˜ì„¸ìš”", status: 'pending', level: 30, createdAt: serverTimestamp(),
                            stats: "ì´ê³³ì— ìºë¦­í„°ì˜ ì„¤ëª…ì„ ì ìŠµë‹ˆë‹¤."
                        });
                        showPendingGateUI();
                    } catch(e) { console.error(e); }
                } else {
                    const target = state.accounts.find(a => a.loginId === id && a.password === pw);
                    if (target) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { uid: state.user.uid }, { merge: true });
                        showToast("Link established.");
                    } else { showToast("Unauthorized signal."); }
                }
            };
        }

        function showPendingGateUI() {
            $('auth-view').classList.add('hidden');
            $('content-area').innerHTML = `<div class="flex-1 flex flex-col items-center justify-center text-center p-12 h-full"><i data-lucide="clock" class="w-20 h-20 text-amber-500/20 animate-spin-slow"></i><h2 class="text-4xl font-serif font-black text-white uppercase mt-12 tracking-widest leading-none">Wait for Authorization</h2><p class="text-sm text-neutral-500 mt-6 max-w-xs leading-relaxed italic">ê´€ë¦¬ìì˜ ìŠ¹ì¸ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì‹ í˜¸ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</p><button onclick="handleLogout()" class="text-[10px] text-red-900 font-bold mt-16 uppercase underline decoration-red-950 tracking-widest">Disconnect Transmission</button></div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderSidebarUI() {
    const v = state.currentView;
    const isMobile = window.innerWidth < 768;
    
    // ëª¨ë°”ì¼ì´ë©´ í•˜ë‹¨, PCë©´ ì¢Œì¸¡
    const container = isMobile ? $('mobile-nav-bar') : $('sidebar-nav');
    if (!container) return;

    // [ìˆ˜ì •ë¨] ì½ì§€ ì•Šì€ ì±„íŒ…ë°©ì´ ìˆëŠ”ì§€ ê³„ì‚° (ë©”ì¼ë°•ìŠ¤ìš© ë ˆë“œë‹·)
    const myId = state.userAccount?.loginId;
    const hasUnreadChat = state.chatRooms.some(r => {
        // ë‚´ê°€ ì†í•œ ë°©ì´ê³  + ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ìˆê³  + (ì•ˆ ì½ì—ˆê±°ë‚˜ || ì½ì€ ì‹œê°„ì´ ë©”ì‹œì§€ ì‹œê°„ë³´ë‹¤ ì´ì „ì¼ ë•Œ)
        return r.members.includes(myId) && 
               r.lastMessageTimestamp && 
               (!r.lastRead || !r.lastRead[myId] || r.lastRead[myId].seconds < r.lastMessageTimestamp.seconds);
    });

    // ë©”ë‰´ ì•„ì´í…œ ì •ì˜
    // [ìˆ˜ì •ë¨] PC ë²„ì „ì¼ ë•Œ 'pl-8' (ì™¼ìª½ ì—¬ë°±) ì¶”ê°€í•˜ì—¬ ë²½ì—ì„œ ë„ì›€
    const navHTML = `
        <div class="flex ${isMobile ? 'flex-row justify-around w-full' : 'flex-col gap-8 pl-8'}">
            
            <button onclick="switchView('home')" class="group flex items-center gap-4 transition-all ${v === 'home' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'home' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'home' ? 'text-white' : ''}">Dashboard</span>` : ''}
            </button>

            <button onclick="switchView('mail')" class="group flex items-center gap-4 transition-all ${v === 'mail' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="mail" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'mail' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                    
                    ${hasUnreadChat ? `<span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>` : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'mail' ? 'text-white' : ''}">Mailbox</span>` : ''}
            </button>

            <button onclick="switchView('operation')" class="group flex items-center gap-4 transition-all ${v === 'operation' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="crosshair" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'operation' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'operation' ? 'text-white' : ''}">Operation</span>` : ''}
            </button>

            <button onclick="switchView('members')" class="group flex items-center gap-4 transition-all ${v === 'members' || v === 'visit' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="users" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'members' || v === 'visit' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'members' || v === 'visit' ? 'text-white' : ''}">Gallery</span>` : ''}
            </button>

            <button onclick="switchView('profile')" class="group flex items-center gap-4 transition-all ${v === 'profile' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="eye" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'profile' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'profile' ? 'text-white' : ''}">Personnel</span>` : ''}
            </button>

            <button onclick="switchView('admin')" class="group flex items-center gap-4 transition-all ${v === 'admin' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="shield" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'admin' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'admin' ? 'text-white' : ''}">System</span>` : ''}
            </button>
        </div>
    `;

    container.innerHTML = navHTML;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

        function updateSidebarUI() {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            const active = $(`nav-${state.currentView}`);
            if (active) active.classList.add('active');
        }

        function updateProfileBarUI() {
            const acc = state.userAccount;
            if (!acc || acc.status === 'new') return;
            $('user-name-display').innerText = acc.ocName || 'Personnel';
            $('user-id-display').innerText = `ID: ${acc.loginId || 'Guest'}`;
            if (acc.profile) {
                $('user-avatar').src = acc.profile;
                $('user-avatar').classList.remove('hidden');
                $('user-avatar-placeholder').classList.add('hidden');
            }
        }
        window.autoResize = (textarea) => {
    textarea.style.height = 'auto'; // ë†’ì´ ì´ˆê¸°í™”
    textarea.style.height = textarea.scrollHeight + 'px'; // ë‚´ìš©ë§Œí¼ ëŠ˜ë¦¼
};

        window.handleLogout = async () => { try { await signOut(auth); window.location.reload(); } catch(e) { console.error(e); } };

        function showToast(msg) {
            const t = $('toast');
            $('toast-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
        // [ì¶”ê°€] ë©”ì‹œì§€ ì‚­ì œ í•¨ìˆ˜ (Soft Delete)
window.deleteMessage = async (msgId) => {
    if (!confirm("ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    try {
        const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'messages', msgId);
        // ë©”ì‹œì§€ë¥¼ ì‹¤ì œë¡œ ì§€ìš°ì§€ ì•Šê³ , 'ì‚­ì œë¨' ìƒíƒœë¡œë§Œ ë³€ê²½
        await updateDoc(msgRef, {
            isDeleted: true
        });
    } catch(e) {
        console.error("Delete failed:", e);
        showToast("Error deleting message.");
    }
};
function renderVisitProfile() {
    const targetId = state.visitTargetId; // ë°©ë¬¸í•  ëŒ€ìƒ ID
    if (!targetId) return switchView('members');

    const targetUser = state.accounts.find(a => a.loginId === targetId);
    if (!targetUser) return switchView('members');

    $('content-area').innerHTML = `
        <div class="relative h-full w-full flex flex-col overflow-hidden bg-[#0a0a0a] animate-fade-in">
            
            <div class="absolute inset-0 z-0">
                <img src="${targetUser.profile}" class="w-full h-full object-cover opacity-80 blur-[10px] scale-110 grayscale brightness-50">
                <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0a] via-[#0a0a0a]/80 to-transparent"></div>
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMDUpIiAvPgo8L3N2Zz4=')] opacity-20"></div>
            </div>

            <div class="absolute inset-y-0 right-[2%] lg:right-[8%] w-[80%] lg:w-[55%] z-10 pointer-events-none flex items-end justify-end">
                <img src="${targetUser.profile}" class="h-[90%] w-full object-contain object-bottom drop-shadow-2xl opacity-100 mask-image-bottom">
            </div>

            <div class="relative z-20 h-full flex flex-col justify-center pl-12 lg:pl-24 max-w-[65%] pointer-events-none">
                <div class="mb-6 flex items-center gap-4 animate-slide-up" style="animation-delay: 0.1s;">
                    <div class="bg-amber-600/20 text-amber-500 px-4 py-1.5 border border-amber-500/30 rounded-full text-[10px] font-black tracking-[0.3em] uppercase backdrop-blur-md">
                        ${targetUser.badgeText || 'Level: ' + (targetUser.level || 'Unknown')}
                    </div>
                </div>

                <h1 class="font-serif font-black text-white tracking-tighter uppercase whitespace-nowrap leading-none mb-8 drop-shadow-xl animate-slide-up" 
                    style="font-size: clamp(3rem, 6vw, 8rem); animation-delay: 0.2s;">
                    ${targetUser.ocName}
                </h1>

                <div class="border-l-4 border-amber-600 pl-6 animate-slide-up" style="animation-delay: 0.3s;">
                    <h3 class="text-2xl lg:text-4xl font-serif font-bold text-white mb-4 leading-tight tracking-tight">
                        ${targetUser.slogan || 'No slogan registered.'}
                    </h3>
                    <p class="text-xs text-neutral-400 tracking-wide font-mono leading-relaxed max-w-md opacity-70">
                        ${targetUser.shortDesc || targetUser.stats || 'No detailed records found.'}
                    </p>
                </div>
                
                <div class="mt-10 pointer-events-auto w-fit animate-slide-up" style="animation-delay: 0.4s;">
                    ${targetUser.linkUrl ? `
                    <a href="${targetUser.linkUrl}" target="_blank" class="group cursor-pointer hover:scale-105 transition-transform block">
                        <div class="bg-amber-600/10 backdrop-blur-md border border-amber-500/30 p-1 rounded-lg">
                            <div class="bg-amber-600 w-32 h-12 rounded-md relative overflow-hidden flex flex-col items-center justify-center border border-amber-400/50 shadow-[0_0_20px_rgba(217,119,6,0.4)]">
                                <p class="text-[6px] text-black/60 font-black uppercase tracking-widest mb-0.5">External Link</p>
                                <h3 class="text-xs text-white font-serif font-black uppercase tracking-tighter italic drop-shadow-md flex items-center gap-1">
                                    ${targetUser.linkText || 'ENTER'} <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </h3>
                            </div>
                        </div>
                    </a>
                    ` : ''}
                </div>
            </div>

            <div class="absolute right-8 top-1/2 -translate-y-1/2 z-30 flex flex-col gap-6 pointer-events-auto">
                <button onclick="startOneOnOneChat('${targetUser.loginId}')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-white/10 flex items-center justify-center shadow-2xl group-hover:border-amber-500 group-hover:bg-amber-600/20 transition-all">
                        <i data-lucide="mail" class="w-6 h-6 text-white group-hover:text-amber-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-white bg-black/50 px-2 py-1 rounded">1:1 Message</span>
                </button>

                <button onclick="showToast('Gift System: Not Available Yet.')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-white/10 flex items-center justify-center shadow-2xl group-hover:border-amber-500 group-hover:bg-amber-600/20 transition-all">
                        <i data-lucide="gift" class="w-6 h-6 text-white group-hover:text-amber-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-white bg-black/50 px-2 py-1 rounded">Send Gift</span>
                </button>

                <button onclick="openReportModal('${targetUser.loginId}', '${targetUser.ocName}')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-red-900/30 flex items-center justify-center shadow-2xl group-hover:border-red-500 group-hover:bg-red-600/20 transition-all">
                        <i data-lucide="siren" class="w-6 h-6 text-red-700 group-hover:text-red-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-red-500 bg-black/50 px-2 py-1 rounded">Report User</span>
                </button>
            </div>

            <div class="absolute bottom-12 left-[30%] flex gap-12 opacity-60 pointer-events-none hidden lg:flex">
                <p class="text-[20px] text-amber-500 font-serif italic tracking-wider">${targetUser.keyword1 || ''}</p>
                <p class="text-[20px] text-amber-400 font-serif italic tracking-wider">${targetUser.keyword2 || ''}</p>
                <p class="text-[20px] text-amber-300 font-serif italic tracking-wider">${targetUser.keyword3 || ''}</p>
            </div>
            
            <button onclick="switchView('members')" class="absolute top-8 left-8 z-50 flex items-center gap-2 text-neutral-500 hover:text-white transition-colors pointer-events-auto">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                <span class="text-xs font-bold uppercase tracking-widest">Back to Gallery</span>
            </button>
        </div>

        <div id="report-modal" class="hidden fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-neutral-900 border border-red-900/30 rounded-[2.5rem] p-10 shadow-2xl modal-enter relative">
                
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="absolute top-8 right-8 text-neutral-600 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-2 text-red-500">Report User</h3>
                <p class="text-xs text-neutral-500 mb-6">Reporting: <span id="report-target-name" class="text-white font-bold"></span></p>
                
                <textarea id="report-reason" class="w-full h-32 bg-black border border-white/10 rounded-2xl p-4 text-sm text-white resize-none outline-none focus:border-red-500 mb-6 custom-scrollbar" placeholder="Please describe the reason..."></textarea>
                
                <div class="flex gap-4">
                    <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button onclick="submitReport()" class="flex-1 py-4 bg-red-700 text-white font-bold rounded-xl uppercase text-xs hover:bg-red-600 shadow-lg shadow-red-900/20">Submit Report</button>
                </div>
            </div>
        </div>
        
        <style>.mask-image-bottom { -webkit-mask-image: linear-gradient(to top, transparent 0%, black 20%); mask-image: linear-gradient(to top, transparent 0%, black 20%); }</style>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// [ê¸°ëŠ¥ 1] í”„ë¡œí•„ ë°©ë¬¸ (í˜ì´ì§€ ì´ë™)
window.visitProfile = (targetId) => {
    if (targetId === state.userAccount.loginId) {
        return switchView('home'); // ë‚˜ ìì‹ ì´ë©´ ë‚´ í™ˆìœ¼ë¡œ
    }
    state.visitTargetId = targetId;
    switchView('visit');
};

// [ê¸°ëŠ¥ 2] 1:1 ì±„íŒ…ë°© ì—°ê²° (ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ ì´ë™)
window.startOneOnOneChat = async (targetId) => {
    const myId = state.userAccount.loginId;
    
    // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” 1:1 ë°© ì°¾ê¸°
    const existingRoom = state.chatRooms.find(r => 
        r.type === 'private' && 
        r.members.includes(myId) && 
        r.members.includes(targetId)
    );

    if (existingRoom) {
        state.selectedRoomId = existingRoom.id;
        switchView('mail'); // ë©”ì¼í•¨ìœ¼ë¡œ ì´ë™
    } else {
        // ìƒˆ ë°© ìƒì„±
        const targetUser = state.accounts.find(a => a.loginId === targetId);
        const roomName = targetUser ? targetUser.ocName : targetId;
        
        try {
            const newRoomRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'));
            await setDoc(newRoomRef, {
                name: roomName, // ê°œì¸ë°©ì´ë¼ ì´ë¦„ì€ í¬ê²Œ ì¤‘ìš”ì¹˜ ì•ŠìŒ
                members: [myId, targetId],
                type: 'private',
                createdAt: serverTimestamp(),
                lastMessageTimestamp: serverTimestamp(),
                lastMessageBody: "Signal Link Established.",
                lastRead: {}
            });
            state.selectedRoomId = newRoomRef.id;
            switchView('mail'); // ë©”ì¼í•¨ìœ¼ë¡œ ì´ë™
        } catch(e) {
            console.error(e);
            showToast("Connection Failed.");
        }
    }
};

// [ê¸°ëŠ¥ 3] ì‹ ê³  ëª¨ë‹¬ ì—´ê¸°
let currentReportTargetId = null;
window.openReportModal = (targetId, targetName) => {
    currentReportTargetId = targetId;
    $('report-target-name').innerText = targetName;
    $('report-reason').value = '';
    $('report-modal').classList.remove('hidden');
};

// [ê¸°ëŠ¥ 3-1] ì‹ ê³  ì ‘ìˆ˜ (DB ì €ì¥)
window.submitReport = async () => {
    const reason = $('report-reason').value.trim();
    if (!reason) return showToast("Please enter a reason.");
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), {
            reporterId: state.userAccount.loginId,
            reporterName: state.userAccount.ocName,
            targetId: currentReportTargetId,
            reason: reason,
            timestamp: serverTimestamp(),
            status: 'pending' // ì²˜ë¦¬ ëŒ€ê¸°ì¤‘
        });
        $('report-modal').classList.add('hidden');
        showToast("Report Submitted to Admin.");
    } catch(e) {
        console.error(e);
        showToast("Report Failed.");
    }
};
// [ê¸°ëŠ¥ 1] ì•Œë¦¼ì°½ í† ê¸€
window.toggleNotificationModal = () => {
    const el = document.getElementById('noti-dropdown');
    el.classList.toggle('hidden');
};

// [ê¸°ëŠ¥ 2] ì•Œë¦¼ ì‚­ì œ
window.deleteNotification = async (id) => {
    try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', id));
    } catch(e) { console.error(e); }
};

// [ê¸°ëŠ¥ 3] ì•Œë¦¼ ì „ì²´ ì‚­ì œ
window.clearAllNotifications = async () => {
    if (!confirm("Clear all alerts?")) return;
    try {
        const batch = state.notifications.map(n => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', n.id)));
        await Promise.all(batch);
    } catch(e) { console.error(e); }
};

// [ê¸°ëŠ¥ 4] ê´€ë¦¬ì: ì‹ ê³  ì‚­ì œ (ë¬´ì‹œ)
window.deleteReport = async (reportId) => {
    if (!confirm("Delete this report permanently?")) return;
    try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId));
        showToast("Report Deleted.");
    } catch(e) { console.error(e); }
};

// [ê¸°ëŠ¥ 5] ê´€ë¦¬ì: ë‹µì¥ ëª¨ë‹¬ ì—´ê¸°
let currentResolvingReportId = null;
let currentResolvingReporterId = null;

window.openAdminReplyModal = (reportId, reporterId) => {
    currentResolvingReportId = reportId;
    currentResolvingReporterId = reporterId;
    $('admin-reply-memo').value = '';
    $('admin-reply-modal').classList.remove('hidden');
};

// [ìˆ˜ì •] ê´€ë¦¬ì: í•´ê²° ì²˜ë¦¬ (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
window.submitAdminResolution = async () => {
    const memo = $('admin-reply-memo').value.trim();
    
    // ì•ˆì „ì¥ì¹˜: IDê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ì¶œë ¥
    if (!currentResolvingReportId || !currentResolvingReporterId) {
        console.error("Missing Report ID or Reporter ID");
        showToast("Error: Target not found.");
        return;
    }

    try {
        // 1. ìœ ì €ì—ê²Œ ì•Œë¦¼ ì „ì†¡
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
            targetUserId: currentResolvingReporterId,
            title: "Report Resolved",
            message: "ê´€ë¦¬ìê°€ ë‹¹ì‹ ì˜ ì‹ ê³ ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.",
            memo: memo,
            timestamp: serverTimestamp(),
            isRead: false
        });

        // 2. ì‹ ê³  ë‚´ì—­ ì‚­ì œ
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', currentResolvingReportId));

        $('admin-reply-modal').classList.add('hidden');
        showToast("User Notified & Report Closed.");
    } catch(e) {
        console.error("Resolution Failed:", e); // ì½˜ì†”ì— ìƒì„¸ ì—ëŸ¬ ì¶œë ¥
        showToast("Action Failed. Check Console.");
    }
};
// [ìˆ˜ì •ë¨] ì•Œë¦¼ ë°ì´í„° ë™ê¸°í™” ë° ì†Œë¦¬ ì¬ìƒ
function updateMyNotifications() {
    // ì•„ì§ ì›ë³¸ ë°ì´í„°ë‚˜ ìœ ì € ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
    if (!state.rawNotifications || !state.userAccount) return;

    // í˜„ì¬ ì €ì¥ëœ ì•Œë¦¼ (ì´ì „ ìƒíƒœ)
    const prevCount = state.notifications ? state.notifications.length : 0;

    // ë‚´ ì•„ì´ë””(targetUserId)ì™€ ì¼ì¹˜í•˜ëŠ” ì•Œë¦¼ë§Œ í•„í„°ë§
    const myNewNotis = state.rawNotifications.filter(n => n.targetUserId === state.userAccount.loginId);
    
    // state ì—…ë°ì´íŠ¸
    state.notifications = myNewNotis;
    if (state.initDone && myNewNotis.length > prevCount) {
        window.playNotificationSound(); // ë ë¡±~!
        
    }
    
    if (state.currentView === 'home') renderHome();
}
// [ì¶”ê°€] ì•Œë¦¼ ì†Œë¦¬ ì¬ìƒ í•¨ìˆ˜
window.playNotificationSound = () => {
    const audio = document.getElementById('noti-sound');
    if (audio) {
        audio.volume = 0.3; // ì†Œë¦¬ í¬ê¸° ì¡°ì ˆ (0.0 ~ 1.0)
        audio.currentTime = 0; // ì—°ì† ì¬ìƒì„ ìœ„í•´ ì¬ìƒ ìœ„ì¹˜ ì´ˆê¸°í™”
        // ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì‚¬ìš©ìê°€ í™”ë©´ì„ í´ë¦­í•œ ì ì´ ì—†ìœ¼ë©´ ì†Œë¦¬ê°€ ë§‰í ìˆ˜ ìˆìŒ (catchë¡œ ì—ëŸ¬ ë°©ì§€)
        audio.play().catch(e => console.log("Audio play blocked: interact with document first."));
    }
};
// [ì¶”ê°€] ì±„íŒ…ë°© ì•Œë¦¼ ì¼œê¸°/ë„ê¸° í† ê¸€ í•¨ìˆ˜
window.toggleRoomMute = async (roomId) => {
    const myId = state.userAccount.loginId;
    const room = state.chatRooms.find(r => r.id === roomId);
    if (!room) return;

    // í˜„ì¬ ìƒíƒœ í™•ì¸ (ì—†ìœ¼ë©´ ì¼œì§„ ê²ƒ, trueë©´ êº¼ì§„ ê²ƒ)
    const currentMuteState = room.muted ? room.muted[myId] : false;
    const newMuteState = !currentMuteState; // ë°˜ëŒ€ë¡œ ì „í™˜

    try {
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
        
        // ë‚´ IDì˜ ë®¤íŠ¸ ì„¤ì •ë§Œ ì—…ë°ì´íŠ¸
        // (Firestoreì˜ ì  í‘œê¸°ë²•ì„ ì‚¬ìš©í•˜ì—¬ ê°ì²´ ë‚´ë¶€ì˜ íŠ¹ì • í•„ë“œë§Œ ìˆ˜ì •)
        await updateDoc(roomRef, {
            [`muted.${myId}`]: newMuteState
        });

        const statusMsg = newMuteState ? "Notifications Muted." : "Notifications Enabled.";
        showToast(statusMsg);
        
    } catch(e) {
        console.error(e);
        showToast("Error updating settings.");
    }
};
function renderOperation() {
    // 1. ë°ì´í„° ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
    if (!state.world.operations) {
        state.world.operations = [
            {
                id: 'op_story',
                title: 'Main Story',
                desc: 'The unraveling truth of Elysium. Begin your investigation.',
                img: 'https://images.unsplash.com/photo-1519608487953-e999c86e7455?q=80&w=1000',
                icon: 'book-open',
                action: 'renderStoryTimeline()', // ì‹¤í–‰í•  í•¨ìˆ˜ ë¬¸ìì—´
                number: '01'
            },
            {
                id: 'op_field',
                title: 'Field Work',
                desc: 'Search for clues in specific sectors.',
                img: 'https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?q=80&w=1000',
                icon: 'map',
                action: "switchView('investigation')",
                number: '02'
            },
            {
                id: 'op_raid',
                title: 'Total War', // ë ˆì´ë“œ (Raid)
                desc: 'Subjugate high-threat anomalies with your team.',
                img: 'https://images.unsplash.com/photo-1635322966219-b75ed372eb01?q=80&w=1000', // ë¶‰ì€ í†¤ ì´ë¯¸ì§€ ì¶”ì²œ
                icon: 'swords',
                action: "openRaidBoard()",
                number: '03'
            }
        ];
    }

    const ops = state.world.operations;
    const isAdmin = state.isAdmin;

    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full w-full select-none">
            
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none mix-blend-overlay"></div>
            <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-transparent to-black/90 pointer-events-none z-0"></div>

            <div class="relative z-10 px-12 pt-16 pb-8 flex justify-between items-end border-b border-white/5 mx-12">
                <div>
                    <h2 class="text-6xl md:text-7xl font-serif font-black text-white tracking-tighter uppercase leading-none italic drop-shadow-2xl">
                        Operations
                    </h2>
                    <div class="flex items-center gap-3 mt-4">
                        <span class="w-8 h-[2px] bg-amber-600"></span>
                        <p class="text-[10px] text-amber-500 font-bold tracking-[0.3em] uppercase">Active Missions & Investigations</p>
                    </div>
                </div>
                <div class="hidden md:block text-right opacity-50">
                    <p class="text-[9px] text-neutral-500 font-mono tracking-widest">SECURE CHANNEL ESTABLISHED</p>
                    <p class="text-[9px] text-neutral-600 font-mono mt-1">LAT: 37.5665 / LON: 126.9780</p>
                </div>
            </div>

            <div class="flex-1 relative z-10 flex items-center justify-center overflow-x-auto overflow-y-hidden custom-scrollbar px-12 pb-12">
                <div class="flex items-stretch gap-6 h-[500px]">
                    
                    ${ops.map((op, idx) => `
                    <div onclick="${op.action}" 
                         class="group relative w-[280px] hover:w-[380px] transition-all duration-500 ease-[cubic-bezier(0.25,1,0.5,1)] cursor-pointer">
                        
                        <div class="absolute inset-0 transform -skew-x-12 overflow-hidden border border-white/10 bg-neutral-900 group-hover:border-amber-500/50 transition-colors shadow-2xl">
                            <div class="absolute inset-0 transform skew-x-12 scale-125 origin-center transition-transform duration-700 group-hover:scale-110">
                                <img src="${op.img}" class="w-full h-full object-cover grayscale opacity-50 group-hover:opacity-100 group-hover:grayscale-0 transition-all duration-700">
                                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90 group-hover:opacity-60 transition-opacity"></div>
                            </div>
                        </div>

                        <div class="absolute inset-0 z-20 pointer-events-none">
                            
                            <div class="absolute top-6 left-8 opacity-30 group-hover:opacity-100 transition-opacity duration-500 transform -skew-x-12">
                                <span class="text-6xl font-black text-transparent stroke-text italic font-serif">${op.number}</span>
                            </div>

                            <div class="absolute bottom-0 left-0 w-full p-10 transform translate-y-4 group-hover:translate-y-0 transition-transform duration-500">
                                
                                <div class="transform -skew-x-12 origin-bottom-left">
                                    <div class="w-12 h-12 rounded-full bg-neutral-800 border border-white/20 flex items-center justify-center mb-4 text-white group-hover:bg-amber-600 group-hover:border-transparent transition-all shadow-[0_0_20px_rgba(0,0,0,0.5)]">
                                        <i data-lucide="${op.icon}" class="w-5 h-5"></i>
                                    </div>
                                    
                                    <h3 class="text-3xl font-black text-white uppercase italic tracking-tighter mb-2 drop-shadow-md whitespace-nowrap">
                                        ${op.title}
                                    </h3>
                                    
                                    <div class="w-full h-[1px] bg-white/20 mb-3 group-hover:bg-amber-500 transition-colors"></div>
                                    
                                    <p class="text-[10px] text-neutral-400 font-medium leading-relaxed line-clamp-2 h-8 mb-2 group-hover:text-neutral-200 transition-colors">
                                        ${op.desc}
                                    </p>
                                    
                                    <div class="flex items-center gap-2 text-[10px] text-amber-500 font-black tracking-widest uppercase opacity-0 group-hover:opacity-100 transition-all duration-500 translate-x-[-10px] group-hover:translate-x-0">
                                        <span>Initialize</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                    </div>
                                </div>
                            </div>

                            ${isAdmin ? `
                            <button onclick="event.stopPropagation(); openOperationEditor(${idx})" 
                                    class="absolute top-4 right-4 pointer-events-auto bg-black/50 hover:bg-amber-600 text-white p-2 rounded-full backdrop-blur-md border border-white/10 transition-colors z-50">
                                <i data-lucide="edit-2" class="w-3 h-3"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>

            <div class="absolute bottom-6 left-0 w-full flex justify-between px-12 pointer-events-none opacity-30">
                 <div class="flex gap-1">
                    <div class="w-2 h-2 bg-amber-600"></div>
                    <div class="w-2 h-2 bg-neutral-800"></div>
                    <div class="w-2 h-2 bg-neutral-800"></div>
                 </div>
                 <div class="text-[8px] text-white font-mono tracking-[0.5em]">SYSTEM READY</div>
            </div>

            <style>
                .stroke-text { -webkit-text-stroke: 1px rgba(255, 255, 255, 0.2); }
                .group:hover .stroke-text { -webkit-text-stroke: 1px rgba(217, 119, 6, 0.5); color: rgba(217, 119, 6, 0.1); }
            </style>
        </div>

        <div id="op-editor-modal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-[#0a0a0a] border border-amber-600/30 rounded-2xl p-8 shadow-2xl modal-enter relative">
                <h3 class="text-xl font-serif font-black text-white uppercase italic tracking-tighter mb-6 text-center">Edit Operation</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[9px] text-amber-500 font-bold uppercase tracking-widest">Title</label>
                        <input id="op-edit-title" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Description</label>
                        <textarea id="op-edit-desc" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none resize-none h-20"></textarea>
                    </div>
                    <div>
                        <label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Image URL</label>
                        <input id="op-edit-img" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-xs text-neutral-500 focus:border-amber-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Icon Name</label>
                            <input id="op-edit-icon" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-xs text-white focus:border-amber-500 outline-none" placeholder="lucide icon">
                        </div>
                        <div>
                            <label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Action (JS)</label>
                            <input id="op-edit-action" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-xs text-amber-500 focus:border-amber-500 outline-none">
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button onclick="document.getElementById('op-editor-modal').classList.add('hidden')" class="flex-1 py-3 bg-neutral-800 text-neutral-400 font-bold rounded-lg uppercase text-[10px] hover:text-white">Cancel</button>
                    <button id="op-save-btn" class="flex-1 py-3 bg-amber-600 text-white font-bold rounded-lg uppercase text-[10px] hover:bg-amber-700 shadow-lg transition-all">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
window.renderOperation = renderOperation;

window.renderStoryTimeline = () => {
    const chapters = state.storyData?.chapters || [];
    const isAdmin = state.isAdmin;

    $('content-area').innerHTML = `
        <div id="story-timeline-root" class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full select-none">
            
            <div class="p-12 pb-6 flex justify-between items-start z-20 bg-[#0a0a0a]/90 backdrop-blur-sm border-b border-white/5">
                <div>
                    <h2 class="text-5xl font-serif font-black text-white uppercase tracking-tighter">Main Story Timeline</h2>
                    <p class="text-[10px] text-amber-500 font-bold tracking-[0.3em] mt-2 uppercase">Chronological Records</p>
                </div>
                <div class="flex gap-4">
                    ${isAdmin ? `<button onclick="openStoryEditor('chapter', null)" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold rounded-lg uppercase tracking-wider">+ Add Chapter</button>` : ''}
                    <button
  onclick="renderOperation();"
  class="flex items-center gap-2 text-neutral-500 hover:text-white transition-colors uppercase text-xs font-bold tracking-widest border border-white/10 px-4 py-2 rounded-lg hover:bg-white/5 relative z-[100]">
  <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
</button>


                </div>
            </div>

            <div id="timeline-container" class="flex-1 overflow-x-auto custom-scrollbar w-full flex items-center cursor-grab active:cursor-grabbing relative bg-black">
                <div class="flex items-stretch h-full min-w-max pointer-events-none"> 
                    
                    ${chapters.map((chapter, cIndex) => `
                        <div class="relative flex flex-col justify-center h-full group/chapter pointer-events-auto border-r border-white/5">
                            
                            ${chapter.bgImage ? `
                                <div class="absolute inset-0 z-0 overflow-hidden">
                                    <img src="${chapter.bgImage}" class="w-full h-full object-cover opacity-20 grayscale hover:grayscale-0 transition-all duration-700 scale-105 group-hover/chapter:scale-100">
                                    <div class="absolute inset-0 bg-gradient-to-r from-black via-black/50 to-black"></div>
                                </div>
                            ` : ''}

                            <div class="relative z-10 px-12 py-20 flex flex-col h-full justify-center">
                                <div class="mb-40 border-l-4 border-amber-600 pl-4 relative">
                                    <h3 class="text-4xl font-black text-white uppercase italic tracking-tighter drop-shadow-lg">${chapter.title}</h3>
                                    <p class="text-xs text-neutral-400 font-mono mt-1 uppercase tracking-widest drop-shadow-md">${chapter.subtitle || ''}</p>
                                    
                                    ${isAdmin ? `
                                    <div class="absolute -right-2 -top-8 flex gap-2 opacity-0 group-hover/chapter:opacity-100 transition-opacity bg-black/80 px-2 py-1 rounded-lg border border-white/10 backdrop-blur-md">
                                        <button onclick="openStoryEditor('chapter', {cIdx:${cIndex}})" class="text-neutral-400 hover:text-amber-500" title="Edit Chapter"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                        <button onclick="deleteStoryChapter(${cIndex})" class="text-neutral-400 hover:text-red-500" title="Delete Chapter"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                    </div>` : ''}
                                </div>

                                <div class="flex items-center gap-0 relative">
                                    <div class="absolute top-1/2 left-0 w-full h-[2px] bg-neutral-800/80 -translate-y-1/2 z-0"></div>

                                    ${chapter.events ? chapter.events.map((evt, eIndex) => `
                                        <div class="relative z-10 flex flex-col items-center w-64 group h-16 justify-center">
                                            
                                            <div class="absolute w-60 text-center transition-all duration-300 ${eIndex % 2 === 0 ? 'bottom-full mb-1' : 'top-full mt-1'}">
                                                <p class="text-amber-500 font-bold font-mono text-xs mb-1 drop-shadow-md">${evt.year}</p>
                                                <h4 class="text-white font-black text-lg uppercase italic break-keep leading-tight drop-shadow-md">${evt.title}</h4>
                                                <p class="text-neutral-400 text-[10px] mt-2 px-2 leading-relaxed line-clamp-2 opacity-60 group-hover:opacity-100 transition-opacity drop-shadow-md">${evt.desc}</p>
                                                <div class="absolute left-1/2 -translate-x-1/2 w-px h-1 bg-neutral-600 ${eIndex % 2 === 0 ? '-bottom-1' : '-top-1'}"></div>
                                            </div>

                                            <div class="absolute w-72 p-4 rounded-xl bg-neutral-900 border border-white/20 shadow-[0_10px_40px_rgba(0,0,0,0.8)] opacity-0 group-hover:opacity-100 transition-all duration-300 z-50 pointer-events-none scale-95 group-hover:scale-100
                                                ${eIndex % 2 === 0 ? 'top-full mt-6 translate-y-2 group-hover:translate-y-0' : 'bottom-full mb-6 -translate-y-2 group-hover:translate-y-0'}">
                                                <div class="flex items-center gap-2 mb-2 border-b border-white/10 pb-2">
                                                    <i data-lucide="file-text" class="w-3 h-3 text-amber-500"></i>
                                                    <span class="text-[10px] font-bold text-white uppercase tracking-widest">Plot Summary</span>
                                                </div>
                                                <p class="text-neutral-300 text-xs leading-relaxed text-justify font-sans whitespace-pre-line">
                                                    ${evt.summary ? evt.summary : '<span class="text-neutral-600 italic">No summary details registered.</span>'}
                                                </p>
                                                <div class="absolute left-1/2 -translate-x-1/2 w-3 h-3 bg-neutral-900 border-l border-t border-white/20 transform rotate-45 ${eIndex % 2 === 0 ? '-top-1.5' : '-bottom-1.5 border-l-0 border-t-0 border-r border-b'}"></div>
                                            </div>

                                            <div onclick="${isAdmin ? `openStoryEditor('event', {cIdx:${cIndex}, eIdx:${eIndex}})` : ''}" 
                                                 class="w-12 h-12 rounded-full bg-[#0a0a0a] border-2 border-neutral-600 group-hover:border-amber-500 group-hover:scale-110 transition-all duration-300 flex items-center justify-center relative z-20 shadow-lg cursor-pointer hover:bg-neutral-800">
                                                <i data-lucide="${evt.icon || 'circle'}" class="w-5 h-5 text-neutral-400 group-hover:text-white transition-colors"></i>
                                            </div>

                                            ${eIndex !== chapter.events.length - 1 ? `<div class="absolute top-1/2 -right-[50%] -translate-y-1/2 w-1.5 h-1.5 rounded-full bg-neutral-800 z-10"></div>` : ''}
                                        </div>
                                        <div class="w-16 h-1 bg-transparent"></div>
                                    `).join('') : ''}

                                    ${isAdmin ? `<button onclick="openStoryEditor('event', {cIdx:${cIndex}, eIdx:null})" class="relative z-10 w-10 h-10 rounded-full bg-neutral-900 border border-white/20 hover:bg-amber-600 hover:text-white hover:border-amber-600 flex items-center justify-center transition-all ml-4"><i data-lucide="plus" class="w-4 h-4"></i></button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <div id="story-editor-modal" class="hidden fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-neutral-900 border border-amber-600/30 rounded-[2.5rem] p-10 shadow-2xl modal-enter">
                <h3 id="story-editor-title" class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-6 text-center">Edit Timeline</h3>
                
                <div id="story-editor-content" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"></div>

                <div class="flex gap-4 mt-8">
                    <button onclick="document.getElementById('story-editor-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button id="story-save-btn" class="flex-1 py-4 bg-amber-600 text-white font-bold rounded-xl uppercase text-xs hover:bg-amber-700 shadow-lg">Save</button>
                    <button id="story-delete-btn" class="hidden w-12 py-4 bg-red-900/50 text-red-500 font-bold rounded-xl uppercase text-xs hover:bg-red-600 hover:text-white"><i data-lucide="trash-2" class="w-4 h-4 mx-auto"></i></button>
                </div>
            </div>
        </div>
    `;

    // ë“œë˜ê·¸ ìŠ¤í¬ë¡¤
    const slider = document.getElementById('timeline-container');
    let isDown = false;
    let startX;
    let scrollLeft;
    slider.addEventListener('mousedown', (e) => { if (e.target.closest('button')) return;isDown = true; slider.classList.add('active'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
    slider.addEventListener('mouseleave', () => { isDown = false; });
    slider.addEventListener('mouseup', () => { isDown = false; });
    slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 1.5; slider.scrollLeft = scrollLeft - walk; });
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.openStoryEditor = (type, target) => {
    const modal = document.getElementById('story-editor-modal');
    const content = document.getElementById('story-editor-content');
    const title = document.getElementById('story-editor-title');
    const saveBtn = document.getElementById('story-save-btn');
    const delBtn = document.getElementById('story-delete-btn');
    
    modal.classList.remove('hidden');
    delBtn.classList.add('hidden');

    if (type === 'chapter') {
        // [ìˆ˜ì •ë¨] ì±•í„° ì¶”ê°€ ë˜ëŠ” ìˆ˜ì •
        const chapters = state.storyData?.chapters || [];
        const isEdit = target && target.cIdx !== undefined && target.cIdx !== null;
        const ch = isEdit ? chapters[target.cIdx] : {};

        title.innerText = isEdit ? "Edit Chapter" : "New Chapter";
        content.innerHTML = `
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Chapter Title</label>
            <input id="edit-ch-title" value="${ch.title || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-amber-500" placeholder="e.g. Chapter 1"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Subtitle</label>
            <input id="edit-ch-sub" value="${ch.subtitle || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-amber-500" placeholder="e.g. The Beginning"></div>
            
            <div><label class="text-[10px] text-amber-500 font-bold uppercase">Background Image URL</label>
            <input id="edit-ch-bg" value="${ch.bgImage || ''}" class="w-full bg-black border border-amber-500/30 rounded-xl px-4 py-3 text-sm text-amber-500 font-mono" placeholder="https://..."></div>
        `;
        // ì €ì¥ í•¨ìˆ˜ì— ì¸ë±ìŠ¤ ì „ë‹¬ (ìˆ˜ì •ì´ë©´ ì¸ë±ìŠ¤, ì¶”ê°€ë©´ null)
        saveBtn.onclick = () => saveStoryChapter(isEdit ? target.cIdx : null);

    } else if (type === 'event') {
        const { cIdx, eIdx } = target;
        const chapters = state.storyData.chapters;
        const isEdit = eIdx !== null;
        const evt = isEdit ? chapters[cIdx].events[eIdx] : {};

        title.innerText = isEdit ? "Edit Event" : "Add Event";
        content.innerHTML = `
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Year / Date</label>
            <input id="edit-ev-year" value="${evt.year || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-amber-500 font-bold" placeholder="2024.01"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Title</label>
            <input id="edit-ev-title" value="${evt.title || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white font-bold" placeholder="Title"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Short Desc (Always Visible)</label>
            <input id="edit-ev-desc" value="${evt.desc || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-neutral-400" placeholder="Brief description..."></div>

            <div><label class="text-[10px] text-amber-500 font-bold uppercase">Plot Summary (Hover Popup)</label>
            <textarea id="edit-ev-summary" class="w-full bg-black border border-amber-500/30 rounded-xl px-4 py-3 text-sm text-white resize-none h-24 custom-scrollbar leading-relaxed" placeholder="Enter detailed story plot here...">${evt.summary || ''}</textarea></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Icon (Lucide)</label>
            <input id="edit-ev-icon" value="${evt.icon || 'circle'}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-neutral-500 font-mono" placeholder="anchor, star..."></div>
        `;
        
        saveBtn.onclick = () => saveStoryEvent(cIdx, eIdx);
        
        if (isEdit) {
            delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteStoryEvent(cIdx, eIdx);
        }
    }
};

// [ë¡œì§] ì±•í„° ì €ì¥
window.saveStoryChapter = async (cIdx) => {
    const title = document.getElementById('edit-ch-title').value;
    const sub = document.getElementById('edit-ch-sub').value;
    const bgImage = document.getElementById('edit-ch-bg').value; // [ì¶”ê°€] ì´ë¯¸ì§€

    if (!title) return showToast("Title required.");

    const currentChapters = state.storyData?.chapters || [];
    let updatedChapters = [...currentChapters];

    if (cIdx === null) {
        // [ì¶”ê°€ ëª¨ë“œ]
        const newChapter = { title, subtitle: sub, bgImage, events: [] };
        updatedChapters.push(newChapter);
    } else {
        // [ìˆ˜ì • ëª¨ë“œ] ê¸°ì¡´ ì´ë²¤íŠ¸ëŠ” ìœ ì§€í•˜ê³  ì •ë³´ë§Œ ì—…ë°ì´íŠ¸
        updatedChapters[cIdx] = { 
            ...updatedChapters[cIdx], 
            title, 
            subtitle: sub, 
            bgImage 
        };
    }
    
    await updateStoryDB(updatedChapters);
    document.getElementById('story-editor-modal').classList.add('hidden');
};
// [ë¡œì§] ì±•í„° ì‚­ì œ
window.deleteStoryChapter = async (cIdx) => {
    if(!confirm("Delete this entire chapter?")) return;
    const chapters = [...state.storyData.chapters];
    chapters.splice(cIdx, 1);
    await updateStoryDB(chapters);
};

// [ë¡œì§] ì´ë²¤íŠ¸ ì €ì¥ (ì¶”ê°€/ìˆ˜ì •)
window.saveStoryEvent = async (cIdx, eIdx) => {
    const year = document.getElementById('edit-ev-year').value;
    const title = document.getElementById('edit-ev-title').value;
    const desc = document.getElementById('edit-ev-desc').value;
    const summary = document.getElementById('edit-ev-summary').value; // [í•„ìˆ˜] ì¤„ê±°ë¦¬
    const icon = document.getElementById('edit-ev-icon').value;

    if (!title) return showToast("Title required.");

    const chapters = [...state.storyData.chapters];
    const newEvent = { year, title, desc, summary, icon };

    if (eIdx === null) {
        chapters[cIdx].events.push(newEvent);
    } else {
        chapters[cIdx].events[eIdx] = newEvent;
    }

    await updateStoryDB(chapters);
    document.getElementById('story-editor-modal').classList.add('hidden');
};

// [ë¡œì§] ì´ë²¤íŠ¸ ì‚­ì œ
window.deleteStoryEvent = async (cIdx, eIdx) => {
    if(!confirm("Delete this event?")) return;
    const chapters = [...state.storyData.chapters];
    chapters[cIdx].events.splice(eIdx, 1);
    await updateStoryDB(chapters);
    $('story-editor-modal').classList.add('hidden');
};

// [ê³µí†µ] DB ì—…ë°ì´íŠ¸ í•¨ìˆ˜
window.updateStoryDB = async (chapters) => {
    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'story'), {
            chapters: chapters
        });
        showToast("Timeline Updated.");
    } catch(e) {
        console.error(e);
        showToast("Save Failed.");
    }
};
// [ì¶”ê°€] ìœ ì € ê³„ì • ê°•ì œ ì‚­ì œ (ê´€ë¦¬ììš©)
window.deleteUserAccount = async (loginId) => {
    // 1. ì•ˆì „ì¥ì¹˜: ì •ë§ ì‚­ì œí•  ê²ƒì¸ì§€ í™•ì¸
    if (!confirm(`WARNING: You are about to DELETE user [${loginId}].\nThis action cannot be undone.\n\nAre you sure?`)) {
        return;
    }

    try {
        // 2. DBì—ì„œ ê³„ì • ë¬¸ì„œ ì‚­ì œ
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId));
        
        // 3. ëª¨ë‹¬ ë‹«ê¸° ë° ì•Œë¦¼
        document.getElementById('admin-edit-modal').classList.add('hidden');
        showToast("User Account Terminated.");
        
        // (ì°¸ê³ : ë¦¬ìŠ¤íŠ¸ëŠ” onSnapshotì— ì˜í•´ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤)
    } catch(e) {
        console.error(e);
        showToast("Termination Failed.");
    }
};
// [ë³µêµ¬ë¨] ì±„íŒ…ë°© ë©¤ë²„ ëª©ë¡ ë³´ì—¬ì£¼ê¸° (ê·¸ë£¹ ì´ë¦„ í´ë¦­ ì‹œ)
window.showRoomMembers = (roomId) => {
    const room = state.chatRooms.find(r => r.id === roomId);
    if (!room) return;

    const list = document.getElementById('room-members-list');
    if (list) {
        list.innerHTML = room.members.map(mid => {
            const acc = state.accounts.find(a => a.loginId === mid);
            // ìœ ì € ì •ë³´ê°€ ì—†ìœ¼ë©´(íƒˆí‡´ ë“±) ê¸°ë³¸ê°’ í‘œì‹œ
            const name = acc ? acc.ocName : 'Unknown User';
            const img = acc ? acc.profile : '';
            const id = mid;
            
            return `
                <div class="flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 mb-2 last:mb-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-black overflow-hidden border border-white/10 shrink-0">
                            ${img ? `<img src="${img}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-neutral-800 flex items-center justify-center"><i data-lucide="user" class="w-5 h-5 text-neutral-500"></i></div>`}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white">${name}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${id}</p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ëª¨ë‹¬ ë„ìš°ê¸°
    const modal = document.getElementById('room-members-modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
// [ì¶”ê°€] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ë°œì†¡ í•¨ìˆ˜
window.handleSendPasswordReset = async (email) => {
    if (!email) {
        return showToast("Error: No email address found for this user.");
    }

    if (!confirm(`Send password reset email to [${email}]?`)) return;

    try {
        await sendPasswordResetEmail(auth, email);
        showToast(`Reset email sent to ${email}`);
    } catch (error) {
        console.error("Password Reset Error:", error);
        if (error.code === 'auth/user-not-found') {
            showToast("Error: User not found in Authentication.");
        } else {
            showToast("Failed to send email: " + error.message);
        }
    }
};
function renderInvestigation() {
    const inv = state.investigation;
    if (!inv.selectedSector) {
        renderSectorSelection();
        return;
    }

    const sectorIdx = inv.sectors.findIndex(s => s.id === inv.selectedSector);
    const sector = inv.sectors[sectorIdx];
    const sectorPoints = inv.points.filter(p => p.sector === inv.selectedSector);

    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-black overflow-hidden animate-fade-in relative h-full">
            <div class="absolute inset-0 z-10 pointer-events-none shadow-[inset_0_0_300px_rgba(0,0,0,1)]"></div>
            <div class="absolute inset-0 z-10 pointer-events-none bg-gradient-to-b from-black/90 via-transparent to-black/95"></div>

            <div class="p-8 flex justify-between items-center z-20 bg-black/20 backdrop-blur-sm border-b border-white/5">
    <div>
        <h2 class="text-3xl font-serif font-black text-white uppercase tracking-tighter">${sector.name}</h2>
        <button onclick="window.returnToSectors()" class="text-[10px] text-amber-500 font-bold hover:underline uppercase tracking-widest mt-1">â—€ Return to Sector Selection</button>
    </div>
    <div class="flex gap-3">
        ${state.isAdmin ? `<button onclick="changeMapImage(${sectorIdx})" class="px-6 py-2 border border-amber-500/30 text-amber-500 hover:bg-amber-500 hover:text-white rounded-lg text-xs font-bold uppercase transition-all">Change Map</button>` : ''}
        <button onclick="switchView('operation')" class="px-6 py-2 border border-white/10 text-neutral-400 hover:text-white rounded-lg text-xs font-bold uppercase transition-all">Withdraw</button>
    </div>
</div>

            <div class="flex-1 relative flex flex-row overflow-hidden">
                <div class="flex-1 relative overflow-hidden flex items-center justify-center cursor-crosshair" onclick="handleMapClick(event)">
                    <div class="absolute inset-0 flex items-center justify-center" id="map-container">
                        <img src="${sector.map}" class="w-full h-full object-cover opacity-40 grayscale hover:grayscale-0 transition-all duration-[2000ms]">
                        <div class="absolute inset-0 pointer-events-none">
                            ${sectorPoints.map((p) => {
                                const isFound = inv.foundClueIds && inv.foundClueIds.includes(p.id);
                                // ì „ì—­ points ë°°ì—´ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤ (ìˆ˜ì •ìš©)
                                const globalIdx = inv.points.findIndex(gp => gp.id === p.id);
                                
                                return `
                                    <div class="absolute w-10 h-10 -ml-5 -mt-5 flex items-center justify-center group pointer-events-auto" style="left: ${p.x}%; top: ${p.y}%;">
                                        ${!isFound ? '<div class="absolute inset-0 bg-amber-500 rounded-full animate-ping opacity-20"></div>' : ''}
                                        <div onclick="handleDiscovery('${p.id}'); event.stopPropagation();" 
                                             class="w-3 h-3 ${isFound ? 'bg-neutral-600' : 'bg-amber-600 border-amber-400'} border rounded-full transition-all cursor-pointer group-hover:scale-150">
                                        </div>
                                        
                                        <div class="absolute bottom-full mb-4 opacity-0 group-hover:opacity-100 transition-all pointer-events-none z-50 translate-y-2 group-hover:translate-y-0">
<div class="bg-neutral-900/90 backdrop-blur-md text-white text-[10px] font-black px-4 py-2 rounded-xl border border-amber-500/30 shadow-2xl flex items-center gap-3 pointer-events-auto whitespace-nowrap w-max min-w-max">
    <span class="tracking-widest inline-block">${p.title}</span>
    ${state.isAdmin ? `
        <div class="flex gap-2 ml-2 border-l border-white/10 pl-2 text-[9px] shrink-0">
            <button onclick="event.stopPropagation(); editPOI(${globalIdx})" class="text-amber-500 hover:text-white">EDIT</button>
            <button onclick="event.stopPropagation(); handlePointRightClick(event, ${globalIdx})" class="text-red-500 hover:text-white">DEL</button>
        </div>
    ` : ''}
</div>
                                        </div>
                                    </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <div class="w-80 border-l border-white/5 bg-black/40 backdrop-blur-xl z-20 flex flex-col p-6 overflow-hidden">
                    <h3 class="text-[10px] font-black text-neutral-500 uppercase tracking-[0.3em] mb-6 border-b border-white/5 pb-4">Recent Archive Logs</h3>
                    <div id="investigation-side-list" class="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2"></div>
                    <button onclick="toggleArchive()" class="mt-6 py-4 bg-white/5 border border-white/10 rounded-xl text-[9px] font-bold text-neutral-400 uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all">
                        Open Full Archive
                    </button>
                </div>
            </div>
            ... 
        </div>
    `;
    updateInvestigationSideList();
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function renderSectorSelection() {
    const inv = state.investigation;
    const isAdmin = state.isAdmin;

    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-[#080808] overflow-hidden animate-fade-in relative h-full select-none">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20 pointer-events-none"></div>
            <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-black to-transparent z-10"></div>
            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-black to-transparent z-10"></div>

            <div class="relative z-20 pt-16 pb-8 text-center space-y-2 pointer-events-none">
                <div class="inline-block border-b border-amber-600/50 pb-1 mb-2">
                    <p class="text-[10px] text-amber-500 font-bold tracking-[0.5em] uppercase">Target Selection</p>
                </div>
                <h2 class="text-6xl md:text-7xl font-serif font-black text-white italic tracking-tighter uppercase drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                    Select Sector
                </h2>
            </div>
            
            <button onclick="window.switchView('operation')" 
                    class="absolute left-12 top-20 z-30 flex items-center gap-2 text-neutral-600 hover:text-white transition-colors text-[10px] font-bold uppercase tracking-widest group cursor-pointer">
                <div class="w-8 h-[1px] bg-neutral-600 group-hover:bg-white transition-colors"></div>
                Back to Operation
            </button>

            <div id="sector-slide-container" class="flex-1 flex items-center overflow-x-auto overflow-y-hidden custom-scrollbar px-12 pb-12 z-20 cursor-grab active:cursor-grabbing w-full">
                
                <div class="flex gap-6 items-center min-w-max px-12 mx-auto">
                    
                    ${inv.sectors.map((s, idx) => {
                        const available = s.isAvailable;
                        const canEnter = available || isAdmin;
                        
                        return `
                        <div class="group relative w-[280px] h-[420px] bg-neutral-900 border border-white/10 rounded-[4px] transition-all duration-500 flex-shrink-0
                                    ${canEnter ? 'hover:w-[320px] hover:h-[460px] hover:border-amber-500/50 hover:shadow-[0_0_30px_rgba(217,119,6,0.2)] hover:z-30' : 'opacity-50 grayscale'}"
                             onclick="if(!window.isDragging) handleSectorClick('${s.id}', ${available})">
                            
                            <div class="absolute inset-0 overflow-hidden pointer-events-none">
                                <img src="${s.map}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-60 group-hover:opacity-100" draggable="false">
                                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90 group-hover:opacity-60 transition-opacity duration-500"></div>
                            </div>

                            ${!available ? `
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <i data-lucide="lock" class="w-8 h-8 text-white/30"></i>
                            </div>` : ''}

                            <div class="absolute bottom-0 left-0 w-full p-6 transform transition-all duration-500 group-hover:translate-y-[-40px] pointer-events-none">
                                <div class="w-8 h-[2px] bg-amber-500 mb-3 group-hover:w-16 transition-all duration-500"></div>
                                <span class="inline-block px-2 py-0.5 bg-neutral-800/80 border border-white/10 rounded text-[9px] text-neutral-400 font-mono mb-2 uppercase tracking-widest backdrop-blur-sm">
                                    ${s.unlockDate || 'DATE: UNKNOWN'}
                                </span>
                                <h3 class="text-3xl font-black text-white uppercase italic leading-none tracking-tighter mb-1 font-serif drop-shadow-lg">
                                    ${s.name}
                                </h3>
                                <p class="text-[10px] text-neutral-400 line-clamp-1 group-hover:text-neutral-200 transition-colors">
                                    ${s.desc}
                                </p>
                            </div>

                            ${isAdmin ? `
                            <div class="absolute bottom-0 left-0 w-full h-10 bg-black/80 border-t border-white/10 flex divide-x divide-white/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-auto z-40">
                                <button onclick="event.stopPropagation(); openSectorEditor(${idx})" class="flex-1 text-[9px] font-bold text-neutral-400 hover:text-amber-500 hover:bg-white/5 uppercase tracking-widest transition-colors">
                                    EDIT
                                </button>
                                <button onclick="event.stopPropagation(); deleteSector(${idx})" class="flex-1 text-[9px] font-bold text-neutral-400 hover:text-red-500 hover:bg-red-900/20 uppercase tracking-widest transition-colors">
                                    DEL
                                </button>
                                <button onclick="event.stopPropagation(); toggleSectorStatus(${idx})" class="flex-1 text-[9px] font-bold text-neutral-400 hover:text-white hover:bg-white/5 uppercase tracking-widest transition-colors">
                                    ${available ? 'LOCK' : 'UNLOCK'}
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        `;
                    }).join('')}

                    ${isAdmin ? `
                    <div onclick="if(!window.isDragging) openSectorEditor(null)" 
                         class="group relative w-[100px] h-[420px] hover:w-[140px] bg-neutral-900/30 border border-dashed border-white/20 rounded-[4px] cursor-pointer hover:border-amber-500 hover:bg-amber-600/10 transition-all duration-300 flex flex-col items-center justify-center gap-4 flex-shrink-0">
                        <div class="w-12 h-12 rounded-full border border-white/10 flex items-center justify-center group-hover:border-amber-500 group-hover:scale-110 transition-all">
                            <i data-lucide="plus" class="w-5 h-5 text-neutral-500 group-hover:text-amber-500"></i>
                        </div>
                        <p class="text-[9px] text-neutral-600 font-bold uppercase tracking-widest group-hover:text-amber-500 writing-vertical">
                            Add Sector
                        </p>
                    </div>
                    ` : ''}
                    
                    <div class="w-12 flex-shrink-0"></div>
                </div>
            </div>

            <div class="absolute bottom-8 w-full text-center pointer-events-none z-30">
                <p class="text-[9px] text-white/20 font-mono tracking-[1em] uppercase animate-pulse">Drag to Explore</p>
            </div>
        </div>

        <div id="sector-editor-modal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-[#0a0a0a] border border-amber-600/30 rounded-2xl p-8 shadow-2xl modal-enter relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-600 to-transparent opacity-50"></div>
                <h3 id="sector-editor-title" class="text-2xl font-serif font-black text-white uppercase italic tracking-tighter mb-8 text-center">New Sector</h3>
                <div class="space-y-5">
                    <div><label class="text-[9px] text-amber-500 font-bold uppercase tracking-widest ml-1">Sector Name</label><input id="sec-edit-name" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none transition-colors" placeholder="e.g. Ruined City"></div>
                    <div><label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest ml-1">Unlock Date / Tag</label><input id="sec-edit-date" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none transition-colors" placeholder="e.g. 1999.12.31"></div>
                    <div><label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest ml-1">Image URL</label><input id="sec-edit-img" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-xs text-amber-500 font-mono focus:border-amber-500 outline-none transition-colors" placeholder="https://..."></div>
                    <div><label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest ml-1">Description</label><textarea id="sec-edit-desc" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none resize-none h-20" placeholder="Brief description..."></textarea></div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button onclick="document.getElementById('sector-editor-modal').classList.add('hidden')" class="flex-1 py-3 bg-neutral-800 text-neutral-400 font-bold rounded-lg uppercase text-[10px] hover:text-white transition-colors tracking-widest">Cancel</button>
                    <button id="sector-save-btn" class="flex-1 py-3 bg-amber-600 text-white font-bold rounded-lg uppercase text-[10px] hover:bg-amber-700 shadow-[0_0_15px_rgba(217,119,6,0.3)] tracking-widest transition-all">Confirm</button>
                </div>
            </div>
        </div>
    `;

    // [ë“œë˜ê·¸ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸]
    const slider = document.getElementById('sector-slide-container');
    if(slider) {
        let isDown = false;
        let startX;
        let scrollLeft;
        window.isDragging = false; 

        slider.addEventListener('mousedown', (e) => {
            if(e.target.closest('button') || e.target.closest('input')) return;
            isDown = true;
            window.isDragging = false;
            slider.classList.add('active');
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        });
        slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); setTimeout(() => window.isDragging = false, 50); });
        slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('active'); setTimeout(() => window.isDragging = false, 50); });
        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 1.5;
            if(Math.abs(walk) > 5) window.isDragging = true;
            slider.scrollLeft = scrollLeft - walk;
        });
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// êµ¬ì—­ í´ë¦­ ì²˜ë¦¬ í•¨ìˆ˜ (ì´ë™ ë²„ê·¸ ìˆ˜ì •)
window.handleSectorClick = (sectorId, isAvailable) => {
    // ê´€ë¦¬ìì´ê±°ë‚˜, í•´ê¸ˆëœ êµ¬ì—­ì¼ ê²½ìš°ì—ë§Œ ì§„ì…
    if (state.isAdmin || isAvailable) {
        state.investigation.selectedSector = sectorId;
        renderInvestigation(); // ì‹¤ì œ ì§€ë„ í™”ë©´ìœ¼ë¡œ ì „í™˜
    } else {
        showToast('í˜„ì¬ ì§„ì…ì´ ë¶ˆê°€ëŠ¥í•œ êµ¬ì—­ì…ë‹ˆë‹¤.');
    }
};
window.openSectorEditor = (idx) => {
    const modal = document.getElementById('sector-editor-modal');
    const title = document.getElementById('sector-editor-title');
    const saveBtn = document.getElementById('sector-save-btn');
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    const nameIn = document.getElementById('sec-edit-name');
    const dateIn = document.getElementById('sec-edit-date');
    const imgIn = document.getElementById('sec-edit-img');
    const descIn = document.getElementById('sec-edit-desc');

    if (idx !== null) {
        // ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
        const s = state.investigation.sectors[idx];
        title.innerText = "Edit Sector";
        nameIn.value = s.name;
        dateIn.value = s.unlockDate;
        imgIn.value = s.map;
        descIn.value = s.desc;
        saveBtn.onclick = () => saveSector(idx);
    } else {
        // ì¶”ê°€ ëª¨ë“œ: ë¹ˆ ì¹¸
        title.innerText = "New Sector";
        nameIn.value = "";
        dateIn.value = "";
        imgIn.value = "";
        descIn.value = "";
        saveBtn.onclick = () => saveSector(null);
    }

    modal.classList.remove('hidden');
};

// 2. ì„¹í„° ì €ì¥ (ì¶”ê°€/ìˆ˜ì • ë¡œì§)
window.saveSector = async (idx) => {
    const name = document.getElementById('sec-edit-name').value;
    const date = document.getElementById('sec-edit-date').value;
    const img = document.getElementById('sec-edit-img').value;
    const desc = document.getElementById('sec-edit-desc').value;

    if (!name || !img) return showToast("ì´ë¦„ê³¼ ì´ë¯¸ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

    const newSectorData = {
        id: (idx !== null) ? state.investigation.sectors[idx].id : ('s_' + Date.now()), // ID ìœ ì§€ í˜¹ì€ ì‹ ê·œ ìƒì„±
        name: name,
        unlockDate: date,
        map: img,
        desc: desc,
        isAvailable: (idx !== null) ? state.investigation.sectors[idx].isAvailable : false // ê¸°ì¡´ ìƒíƒœ ìœ ì§€ í˜¹ì€ ì ê¸ˆ ìƒíƒœë¡œ ì‹œì‘
    };

    if (idx !== null) {
        // ìˆ˜ì •
        state.investigation.sectors[idx] = newSectorData;
    } else {
        // ì¶”ê°€
        state.investigation.sectors.push(newSectorData);
    }

    // ì„œë²„ ë™ê¸°í™”
    await window.handleSystemUpdate();
    
    // ëª¨ë‹¬ ë‹«ê¸° ë° í™”ë©´ ê°±ì‹ 
    document.getElementById('sector-editor-modal').classList.add('hidden');
    renderSectorSelection();
    showToast(idx !== null ? "ì„¹í„° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ìƒˆ ì„¹í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

// 3. ì„¹í„° ì‚­ì œ
window.deleteSector = async (idx) => {
    const s = state.investigation.sectors[idx];
    if (!confirm(`ì •ë§ [${s.name}] êµ¬ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

    // ë°°ì—´ì—ì„œ ì œê±°
    state.investigation.sectors.splice(idx, 1);
    
    // ì´ êµ¬ì—­ì— ì†í•œ í¬ì¸íŠ¸ë“¤ë„ ì‚­ì œí• ì§€ ì—¬ë¶€ëŠ” ì„ íƒì‚¬í•­ì´ì§€ë§Œ, ì¼ë‹¨ êµ¬ì—­ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.
    // (ì™„ë²½í•˜ê²Œ í•˜ë ¤ë©´ points ë°°ì—´ì—ì„œë„ í•´ë‹¹ sector IDë¥¼ ê°€ì§„ ê²ƒë“¤ì„ filterë¡œ ì œê±°í•´ì•¼ í•¨)
    state.investigation.points = state.investigation.points.filter(p => p.sector !== s.id);

    // ì„œë²„ ë™ê¸°í™”
    await window.handleSystemUpdate();
    renderSectorSelection();
    showToast("ì„¹í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
};
window.toggleSectorStatus = async (idx) => {
    if (!state.isAdmin) return;

    // 1. ë°ì´í„° ìƒíƒœ ë°˜ì „ (true -> false / false -> true)
    state.investigation.sectors[idx].isAvailable = !state.investigation.sectors[idx].isAvailable;

    // 2. ì„œë²„ DBì— ë³€ê²½ëœ ìƒíƒœ ì €ì¥
    if (window.handleSystemUpdate) {
        await window.handleSystemUpdate();
    }

    // 3. UI ê°±ì‹ : ì„¹í„° ì„ íƒ í™”ë©´(ìë¬¼ì‡  ë²„íŠ¼ì´ ìˆëŠ” ê³³)ì„ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
    renderSectorSelection();
    
    const statusMsg = state.investigation.sectors[idx].isAvailable ? 'í•´ê¸ˆ' : 'ì ê¸ˆ';
    showToast(`êµ¬ì—­ì´ ${statusMsg}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
};
window.updateInvestigationSideList = () => {
    const sideList = document.getElementById('investigation-side-list');
    if (!sideList) return;

    const logs = state.investigation.logs || [];

    if (logs.length === 0) {
        sideList.innerHTML = '<p class="text-[10px] text-neutral-700 italic text-center py-10">NO LOGS FOUND.</p>';
        return;
    }

    // ìµœì‹  ë¡œê·¸ê°€ ì•„ë˜ë¡œ ê°€ê²Œ í•˜ë ¤ë©´ reverse()ë¥¼ ë¹¼ê³ , ìœ„ë¡œ ê°€ê²Œ í•˜ë ¤ë©´ ë„£ìœ¼ì„¸ìš”.
    // ë¹„ì£¼ì–¼ ë…¸ë²¨ ëŠë‚Œì€ ìµœì‹  ë¡œê·¸ê°€ ì•„ë˜ì— ìŒ“ì´ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.
    sideList.innerHTML = logs.map(log => `
        <div class="p-4 bg-white/5 border-l-2 border-amber-600/30 mb-2 animate-fade-in">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[9px] text-amber-500 font-black uppercase tracking-widest">${log.title}</span>
                <span class="text-[8px] text-neutral-600">${log.time}</span>
            </div>
            <p class="text-xs text-neutral-300 leading-relaxed whitespace-pre-wrap">${log.text}</p>
        </div>
    `).join('');

    // ë¡œê·¸ê°€ ì¶”ê°€ë  ë•Œ ìë™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ë‚´ë¦¼
    sideList.scrollTop = sideList.scrollHeight;
};

window.openOperationEditor = (idx) => {
    const ops = state.world.operations;
    const op = ops[idx];
    
    document.getElementById('op-edit-title').value = op.title;
    document.getElementById('op-edit-desc').value = op.desc;
    document.getElementById('op-edit-img').value = op.img;
    document.getElementById('op-edit-icon').value = op.icon;
    document.getElementById('op-edit-action').value = op.action;
    
    const saveBtn = document.getElementById('op-save-btn');
    saveBtn.onclick = () => saveOperation(idx);
    
    document.getElementById('op-editor-modal').classList.remove('hidden');
};

window.saveOperation = async (idx) => {
    const ops = state.world.operations;
    
    // ë°ì´í„° ì—…ë°ì´íŠ¸
    ops[idx].title = document.getElementById('op-edit-title').value;
    ops[idx].desc = document.getElementById('op-edit-desc').value;
    ops[idx].img = document.getElementById('op-edit-img').value;
    ops[idx].icon = document.getElementById('op-edit-icon').value;
    ops[idx].action = document.getElementById('op-edit-action').value;
    
    // ì„œë²„ ì €ì¥ (state.world ì „ì²´ë¥¼ ì €ì¥í•˜ëŠ” handleSystemUpdate í™œìš©)
    // ì£¼ì˜: handleSystemUpdate í•¨ìˆ˜ê°€ world ê°ì²´ ì•ˆì˜ operationsë¥¼ í¬í•¨í•´ì„œ ì €ì¥í•˜ë„ë¡
    // handleSystemUpdate í•¨ìˆ˜ ë‚´ë¶€ì— 'operations: state.world.operations'ê°€ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜,
    // state.world ì „ì²´ë¥¼ merge í•˜ëŠ” ë°©ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤. 
    // ê¸°ì¡´ handleSystemUpdateê°€ ê°œë³„ í•„ë“œë§Œ ì§€ì •í•˜ê³  ìˆë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ ì§ì ‘ DB ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    
    try {
        // ë¡œì»¬ ê°±ì‹ 
        state.world.operations = ops;
        
        // DB ê°±ì‹  (ê¸°ì¡´ world ë°ì´í„°ì— operations í•„ë“œ ì¶”ê°€/ê°±ì‹ )
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await setDoc(worldRef, { operations: ops }, { merge: true });
        
        document.getElementById('op-editor-modal').classList.add('hidden');
        renderOperation(); // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        showToast("Operation card updated.");
    } catch(e) {
        console.error(e);
        showToast("Failed to save.");
    }
};
window.renderMembers = (filterCode = 'ALL') => {
    // 1. ë°ì´í„° ì•ˆì „ì¥ì¹˜: ê³„ì • ëª©ë¡ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
    const accounts = state.accounts || [];
    const members = accounts.filter(a => a.status === 'approved');

    // 2. [í•µì‹¬] ì§ì—…êµ° ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê°•ì œë¡œ ê¸°ë³¸ê°’ ìƒì„± (ì´ê²Œ ì—†ì–´ì„œ ì•ˆ ì—´ë ¸ì„ ê²ë‹ˆë‹¤!)
    if (!state.world.classes || state.world.classes.length === 0) {
        state.world.classes = [
            { code: 'VANGUARD', name: 'VANGUARD', color: '#dc2626' },
            { code: 'SNIPER', name: 'SNIPER', color: '#ea580c' },
            { code: 'CASTER', name: 'CASTER', color: '#7c3aed' },
            { code: 'MEDIC', name: 'MEDIC', color: '#16a34a' },
            { code: 'GUARD', name: 'GUARD', color: '#2563eb' },
            { code: 'SPECIALIST', name: 'SPECIALIST', color: '#db2777' }
        ];
    }
    const classes = state.world.classes;

    // 3. í•„í„°ë§ ë¡œì§
    const filtered = filterCode === 'ALL' 
        ? members 
        : members.filter(m => (m.position || 'UNASSIGNED') === filterCode);

    // 4. í™”ë©´ ê·¸ë¦¬ê¸°
    const contentArea = document.getElementById('content-area');
    if (!contentArea) return;

    contentArea.innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden h-full relative select-none animate-fade-in">
            
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10 pointer-events-none"></div>
            <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-amber-600/10 rounded-full blur-[100px] pointer-events-none"></div>
            
            <div class="z-20 px-8 pt-10 pb-4 bg-gradient-to-b from-[#0a0a0a] to-transparent shrink-0">
                <div class="flex flex-col md:flex-row justify-between items-end border-b border-white/10 pb-6 gap-6">
                    <div>
                        <h2 class="text-5xl font-serif font-black text-white uppercase tracking-tighter italic drop-shadow-lg">
                            Personnel
                        </h2>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                            <p class="text-[10px] text-amber-500 font-bold tracking-[0.3em] uppercase">
                                Active Agents: ${members.length}
                            </p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 justify-end">
                        <button onclick="renderMembers('ALL')" 
                                class="px-4 py-2 rounded-lg text-[9px] font-bold uppercase tracking-widest border transition-all duration-300
                                ${filterCode === 'ALL' ? 'bg-white text-black border-white shadow-lg scale-105' : 'bg-neutral-900 border-white/10 text-neutral-500 hover:text-white'}">
                            ALL
                        </button>
                        
                        ${classes.map(cls => `
                            <button onclick="renderMembers('${cls.code}')" 
                                    class="px-4 py-2 rounded-lg text-[9px] font-bold uppercase tracking-widest border transition-all duration-300"
                                    style="${filterCode === cls.code 
                                        ? `background-color: ${cls.color}; border-color: ${cls.color}; color: white; box-shadow: 0 0 15px ${cls.color}66; transform: scale(1.05);` 
                                        : `background-color: transparent; border-color: rgba(255,255,255,0.1); color: #737373;`}"
                                    onmouseover="this.style.color='${cls.color}'; this.style.borderColor='${cls.color}'"
                                    onmouseout="if('${filterCode}' !== '${cls.code}') { this.style.color='#737373'; this.style.borderColor='rgba(255,255,255,0.1)'; } else { this.style.color='white'; }">
                                ${cls.name}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-8 pt-4">
                ${filtered.length === 0 ? 
                    `<div class="h-64 flex flex-col items-center justify-center opacity-40">
                        <i data-lucide="users" class="w-16 h-16 mb-4 text-neutral-600"></i>
                        <p class="text-xs font-bold text-neutral-500 uppercase tracking-widest">No personnel found.</p>
                     </div>` 
                : 
                    `<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 pb-20">
                        ${filtered.map(m => {
                            const cls = classes.find(c => c.code === m.position) || { name: 'UNASSIGNED', color: '#737373' };
                            
                            return `
                            <div onclick="visitProfile('${m.loginId}')" 
                                 class="group relative aspect-[3/4.2] bg-neutral-900 rounded-[20px] overflow-hidden cursor-pointer border border-white/5 transition-all duration-300 hover:-translate-y-2 hover:shadow-[0_10px_30px_-5px_rgba(0,0,0,0.8)]"
                                 style="--hover-color: ${cls.color}">
                                
                                <div class="absolute inset-0 bg-neutral-800">
                                    <img src="${m.profile || 'https://via.placeholder.com/400x600?text=NO+IMG'}" class="w-full h-full object-cover object-top opacity-80 group-hover:opacity-100 group-hover:scale-110 transition-all duration-700 ease-in-out">
                                </div>
                                <div class="absolute inset-0 bg-gradient-to-t from-[#050505] via-black/20 to-transparent opacity-90 transition-opacity group-hover:opacity-80"></div>

                                <div class="absolute top-3 right-3 z-10">
                                    <span class="px-2 py-1 bg-black/60 backdrop-blur-md border border-white/10 rounded text-[8px] font-black uppercase tracking-wider shadow-lg"
                                          style="color: ${cls.color}; border-color: ${cls.color}44;">
                                        ${cls.name}
                                    </span>
                                </div>
                                
                                <div class="absolute bottom-0 left-0 w-full p-5 z-10">
                                    <div class="w-6 h-[3px] mb-2 group-hover:w-full transition-all duration-500 ease-out shadow-[0_0_10px_currentColor]"
                                         style="background-color: ${cls.color}; color: ${cls.color}"></div>
                                    
                                    <h3 class="text-xl md:text-2xl font-black text-white uppercase italic leading-none tracking-tighter truncate drop-shadow-md group-hover:text-white transition-colors">
                                        ${m.ocName}
                                    </h3>
                                    
                                    <div class="flex justify-between items-end mt-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                        <div class="flex flex-col">
                                            <p class="text-[8px] text-neutral-400 font-bold uppercase tracking-widest">Code Name</p>
                                            <p class="text-[9px] font-mono text-neutral-300 truncate tracking-tight">ID: ${m.loginId}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="absolute inset-0 border-2 border-transparent group-hover:border-[color:var(--hover-color)] opacity-30 rounded-[20px] pointer-events-none transition-all duration-300"></div>
                            </div>
                        `}).join('')}
                    </div>`
                }
            </div>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.saveClassSettings = async () => {
    const currentClasses = state.world.classes || [];
    
    // ì…ë ¥ëœ ê°’ë“¤ë¡œ ì—…ë°ì´íŠ¸
    const updatedClasses = currentClasses.map((cls, idx) => {
        return {
            code: cls.code, // ì½”ë“œëŠ” ìœ ì§€
            name: document.getElementById(`cls-name-${idx}`).value.toUpperCase(), // ì´ë¦„ ì—…ë°ì´íŠ¸
            color: document.getElementById(`cls-color-${idx}`).value // ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        };
    });

    try {
        // ì„œë²„ ì €ì¥
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await setDoc(worldRef, { classes: updatedClasses }, { merge: true });
        
        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        state.world.classes = updatedClasses;
        
        showToast("Class settings saved.");
        renderAdmin(); // í™”ë©´ ê°±ì‹ 
    } catch(e) {
        console.error(e);
        showToast("Failed to save settings.");
    }
};
window.syncClassInputs = () => {
    if (!state.world.classes) return;
    state.world.classes = state.world.classes.map((cls, idx) => {
        const nameInput = document.getElementById(`cls-name-${idx}`);
        const codeInput = document.getElementById(`cls-code-${idx}`);
        const colorInput = document.getElementById(`cls-color-${idx}`);
        return {
            name: nameInput ? nameInput.value.toUpperCase() : cls.name,
            code: codeInput ? codeInput.value.toUpperCase() : cls.code,
            color: colorInput ? colorInput.value : cls.color
        };
    });
};

// 2. ìƒˆ ì§ì—…êµ° ì¶”ê°€
window.addNewClass = () => {
    syncClassInputs(); // í˜„ì¬ ì…ë ¥ê°’ ì €ì¥
    state.world.classes.push({ 
        code: 'NEW', 
        name: 'NEW POSITION', 
        color: '#888888' 
    });
    renderAdmin(); // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
};

// 3. ì§ì—…êµ° ì‚­ì œ
window.deleteClass = (idx) => {
    if (!confirm("ì •ë§ ì´ í¬ì§€ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í•´ë‹¹ í¬ì§€ì…˜ì„ ê°€ì§„ ë©¤ë²„ë“¤ì€ 'UNASSIGNED'ê°€ ë©ë‹ˆë‹¤.)")) return;
    syncClassInputs(); // í˜„ì¬ ì…ë ¥ê°’ ì €ì¥
    state.world.classes.splice(idx, 1);
    renderAdmin(); // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
};

// 4. ìµœì¢… ì €ì¥ (ì„œë²„ ì „ì†¡)
window.saveClassSettings = async () => {
    syncClassInputs(); // í˜„ì¬ ì…ë ¥ê°’ í™•ì •
    
    try {
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await setDoc(worldRef, { classes: state.world.classes }, { merge: true });
        
        showToast("Class configurations saved.");
        renderAdmin(); // UI ê°±ì‹ 
    } catch(e) {
        console.error(e);
        showToast("Save failed.");
    }
};
window.openRaidBoard = function() {
    const modal = document.getElementById('raid-board-modal');
    const iframe = document.getElementById('raid-board-iframe');
    
    // í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const currentUser = state.user;
    const userId = currentUser ? currentUser.uid : 'anonymous';
    const userAccount = state.userAccount || {};
    
    // ê¸°ë³¸ ì •ë³´ (ì´ë¦„, ì´ë¯¸ì§€)
    const ocName = encodeURIComponent(userAccount.ocName || 'Unknown');
    const ocImage = encodeURIComponent(userAccount.profile || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png');
    
    // Combat Stats ê°€ì ¸ì˜¤ê¸°
    const statHp = userAccount.stat_hp || '100';
    const statMp = userAccount.stat_mp || '50';
    const statAtk = userAccount.stat_atk || '5-10';
    const statDef = userAccount.stat_def || '2-5';
    const statMove = userAccount.stat_move || '3';
    const mySkills = userAccount.combatSkills || ['move', 'slash']; // ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
    const skillParam = encodeURIComponent(mySkills.join(','));
    let rawSkills = ['move', 'slash', 'heal']; // ê¸°ë³¸ê°’
    
    // userAccountê°€ ì¡´ì¬í•˜ê³  combatSkillsê°€ ë°°ì—´ì´ë©´ ì‚¬ìš©
    if (userAccount && Array.isArray(userAccount.combatSkills) && userAccount.combatSkills.length > 0) {
        rawSkills = userAccount.combatSkills;
    }
    
    
    console.log("ğŸ® ë ˆì´ë“œ ë³´ë“œ ì—´ê¸°:", {
        userId,
        ocName: decodeURIComponent(ocName),
        skills: rawSkills
    });
    
    // game_board.htmlì— ìœ ì € ì •ë³´ ì „ë‹¬ (ë§¨ ë’¤ì— &skills=... ì¶”ê°€ë¨)
    iframe.src = `game_board.html?userId=${userId}&fromHomepage=true&userName=${ocName}&userImage=${ocImage}&statHp=${statHp}&statMp=${statMp}&statAtk=${encodeURIComponent(statAtk)}&statDef=${encodeURIComponent(statDef)}&statMove=${statMove}&skills=${skillParam}`;
    
    modal.classList.remove('hidden');
}
// ë ˆì´ë“œ ë³´ë“œ ë‹«ê¸° í•¨ìˆ˜
window.closeRaidBoard = function() {
    const modal = document.getElementById('raid-board-modal');
    const iframe = document.getElementById('raid-board-iframe');
    
    modal.classList.add('hidden');
    iframe.src = ''; // ë¦¬ì†ŒìŠ¤ í•´ì œ
}
let myEquippedSkills = []; // í˜„ì¬ ì¥ì°© ì¤‘ì¸ ìŠ¤í‚¬ ID ëª©ë¡

window.openSkillEditor = async function() {
    const user = (window.state && window.state.user) || auth.currentUser;
    if (!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
    
    document.getElementById('skill-edit-modal').classList.remove('hidden');
    await loadSkillData();
}

// 2. ìŠ¤í‚¬ í¸ì§‘ê¸° ë‹«ê¸°
window.closeSkillEditor = function() {
    document.getElementById('skill-edit-modal').classList.add('hidden');
}

// 3. ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ (ê´€ë¦¬ì UI í¬í•¨)
async function loadSkillData() {
    const libraryList = document.getElementById('skill-library-list');
    const equippedList = document.getElementById('equipped-skill-list');
    const user = (window.state && window.state.user) || auth.currentUser;

    libraryList.innerHTML = '<div class="text-gray-500 text-center text-xs py-4">Loading...</div>';
    equippedList.innerHTML = '';
    
    try {
        // A. ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸ (state.userAccount í™œìš©)
        // (ì£¼ì˜: ì‹¤ì œ ìš´ì˜ ì‹œì—” DBì˜ role í•„ë“œë¥¼ ì²´í¬í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•¨)
        const isAdmin = window.state?.userAccount?.role === 'admin' || window.state?.userAccount?.isAdmin === true; 

        // B. ê´€ë¦¬ìë¼ë©´ 'ìŠ¤í‚¬ ì¶”ê°€ í¼'ì„ ìƒë‹¨ì— í‘œì‹œ
        let adminHtml = '';
        if (isAdmin) {
            adminHtml = `
                <div class="mb-4 p-3 bg-white/5 border border-amber-500/30 rounded">
                    <p class="text-[10px] text-amber-500 font-bold mb-2 uppercase">Admin: Add New Skill</p>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input id="new-skill-name" placeholder="ìŠ¤í‚¬ ì´ë¦„ (ì˜ˆ: í™”ì—¼êµ¬)" class="bg-black text-white text-xs p-2 border border-white/10 rounded">
                        <input id="new-skill-id" placeholder="ID (ì˜ë¬¸, ì˜ˆ: fireball)" class="bg-black text-white text-xs p-2 border border-white/10 rounded">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input id="new-skill-icon" placeholder="ì•„ì´ì½˜ (ì˜ˆ: ğŸ”¥)" class="bg-black text-white text-xs p-2 border border-white/10 rounded">
                        <select id="new-skill-type" class="bg-black text-white text-xs p-2 border border-white/10 rounded">
                            <option value="Attack">Attack</option>
                            <option value="Heal">Heal</option>
                            <option value="Utility">Utility</option>
                            <option value="Support">Support</option>
                        </select>
                    </div>
                    <button onclick="addNewSkillToLibrary()" class="w-full bg-amber-600 hover:bg-amber-500 text-white text-xs font-bold py-1 rounded transition">
                        + ADD TO LIBRARY
                    </button>
                </div>
                <div class="border-b border-white/10 mb-2"></div>
            `;
        }

        // C. DBì—ì„œ ìŠ¤í‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const libSnapshot = await getDocs(collection(db, 'skillLibrary'));
        const allSkills = {};
        libSnapshot.forEach(doc => allSkills[doc.id] = doc.data());

        // D. ë‚´ ì¥ì°© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userDocRef = doc(db, 'users', user.uid);
        const userDocSnap = await getDoc(userDocRef);
        const userData = userDocSnap.data() || {};
        const myEquippedSkills = userData.combatSkills || []; 

        // E. í™”ë©´ ê·¸ë¦¬ê¸°
        // 1) ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì™¼ìª½)
        libraryList.innerHTML = adminHtml; // ê´€ë¦¬ì í¼ ë¨¼ì € ë„£ê³ 

        const sortedSkillIds = Object.keys(allSkills).sort(); // ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
        
        if (sortedSkillIds.length === 0 && !isAdmin) {
             libraryList.innerHTML += '<div class="text-gray-600 text-center text-xs py-4">ë“±ë¡ëœ ìŠ¤í‚¬ì´ ì—†ìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div>';
        }

        sortedSkillIds.forEach(skillId => {
            // ë‚´ê°€ ì¥ì°©í•˜ì§€ ì•Šì€ ê²ƒë§Œ ì™¼ìª½ì— í‘œì‹œ
            if (!myEquippedSkills.includes(skillId)) {
                createSkillElement(allSkills[skillId], libraryList);
            }
        });

        // 2) ì¥ì°© ëª©ë¡ (ì˜¤ë¥¸ìª½)
        myEquippedSkills.forEach(skillId => {
            const skill = allSkills[skillId];
            if(skill) {
                createSkillElement(skill, equippedList);
            } else {
                // DBì—ëŠ” ì—†ëŠ”ë° ë‚´ ëª©ë¡ì—” ìˆëŠ” ê²½ìš° (ì‚­ì œëœ ìŠ¤í‚¬ ë“±) - í…ìŠ¤íŠ¸ë¡œë¼ë„ í‘œì‹œ
                createSkillElement({ id: skillId, name: skillId, icon: 'â“', type: 'Unknown' }, equippedList);
            }
        });
        
        updateSkillCount();

    } catch (error) {
        console.error("ìŠ¤í‚¬ ë¡œë“œ ì˜¤ë¥˜:", error);
        libraryList.innerHTML = `<div class="text-red-500 text-center text-xs">Error: ${error.message}</div>`;
    }
}

// 4. [ê´€ë¦¬ììš©] ìƒˆ ìŠ¤í‚¬ DBì— ë“±ë¡í•˜ê¸°
window.addNewSkillToLibrary = async function() {
    const name = document.getElementById('new-skill-name').value.trim();
    const id = document.getElementById('new-skill-id').value.trim();
    const icon = document.getElementById('new-skill-icon').value.trim();
    const type = document.getElementById('new-skill-type').value;

    if (!name || !id || !icon) {
        alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    try {
        await setDoc(doc(db, 'skillLibrary', id), {
            id: id,
            name: name,
            icon: icon,
            type: type,
            desc: name // ì„¤ëª…ì€ ì¼ë‹¨ ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ
        });
        
        alert(`ìŠ¤í‚¬ [${name}] ë“±ë¡ ì™„ë£Œ!`);
        await loadSkillData(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } catch (e) {
        console.error(e);
        alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message);
    }
}

// 5. ìŠ¤í‚¬ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± UI
function createSkillElement(skill, container) {
    const div = document.createElement('div');
    div.className = 'skill-item group';
    div.draggable = true;
    div.id = `skill-${skill.id}`;
    div.dataset.skillId = skill.id;
    
    // ì‚­ì œ ë²„íŠ¼ (ê´€ë¦¬ìì¼ ê²½ìš° ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì—ì„œë§Œ ë³´ì„)
    const isAdmin = window.state?.userAccount?.role === 'admin';
    const isLibrary = container.id === 'skill-library-list';
    let deleteBtn = '';
    
    if (isAdmin && isLibrary) {
        deleteBtn = `<button onclick="deleteSkillFromLibrary('${skill.id}', event)" class="text-gray-600 hover:text-red-500 ml-2 p-1" title="ìŠ¤í‚¬ ì‚­ì œ">âœ•</button>`;
    }

    div.innerHTML = `
        <span class="skill-icon text-base">${skill.icon}</span>
        <div class="skill-info flex flex-col min-w-0">
            <div class="skill-name text-xs font-bold text-gray-200 truncate">${skill.name}</div>
            <div class="skill-type text-[9px] text-gray-500 uppercase tracking-wider">${skill.type}</div>
        </div>
        ${deleteBtn}
        <div class="text-gray-600 text-xs cursor-move ml-auto">â‰¡</div>
    `;
    
    div.addEventListener('dragstart', window.drag);
    div.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON') return; // ì‚­ì œ ë²„íŠ¼ í´ë¦­ì‹œ ì´ë™ ë°©ì§€
        toggleSkillLocation(div)
    });

    container.appendChild(div);
}

// 6. [ê´€ë¦¬ììš©] ìŠ¤í‚¬ ì‚­ì œ
window.deleteSkillFromLibrary = async function(skillId, event) {
    event.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
    if(!confirm(`ì •ë§ [${skillId}] ìŠ¤í‚¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        await deleteDoc(doc(db, 'skillLibrary', skillId));
        await loadSkillData(); // ìƒˆë¡œê³ ì¹¨
    } catch(e) {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
    }
}

// 7. ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•„ìˆ˜ í•¨ìˆ˜ë“¤ (window ì—°ê²°)
window.allowDrop = function(ev) { ev.preventDefault(); }
window.drag = function(ev) { ev.dataTransfer.setData("text", ev.target.id); }
window.drop = function(ev) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    const draggedEl = document.getElementById(data);
    if(!draggedEl) return;

    const targetZone = ev.target.closest('#equipped-skill-list') ? 'equipped' : 
                       ev.target.closest('#skill-library-list') ? 'library' : null;

    if (targetZone === 'equipped') moveSkillToEquipped(draggedEl);
    else if (targetZone === 'library') moveSkillToLibrary(draggedEl);
}

// ë‚´ë¶€ ì´ë™ ë¡œì§
function moveSkillToEquipped(el) {
    const equippedList = document.getElementById('equipped-skill-list');
    const currentCount = equippedList.querySelectorAll('.skill-item').length;
    if(currentCount >= 5) {
        alert("ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì¥ì°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
    }
    equippedList.appendChild(el);
    updateSkillCount();
}

function moveSkillToLibrary(el) {
    // ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ëŒì•„ê°ˆ ë•ŒëŠ” 'ê´€ë¦¬ì ì¶”ê°€ í¼' ë‹¤ìŒìœ¼ë¡œ ë„£ê¸° ìœ„í•´ appendChild ì‚¬ìš©
    document.getElementById('skill-library-list').appendChild(el);
    updateSkillCount();
}

function toggleSkillLocation(el) {
    const parentId = el.parentElement.id;
    if (parentId === 'skill-library-list') moveSkillToEquipped(el);
    else moveSkillToLibrary(el);
}

function updateSkillCount() {
    const equippedList = document.getElementById('equipped-skill-list');
    const count = equippedList.querySelectorAll('.skill-item').length;
    const badge = document.getElementById('skill-count-badge');
    if(badge) {
        badge.textContent = `${count} / 5`;
        badge.style.color = count === 5 ? '#ef4444' : '#6b7280';
    }
    const placeholder = equippedList.querySelector('p');
    if(placeholder) placeholder.style.display = count > 0 ? 'none' : 'block';
}

window.saveMySkills = async function() {
    // 1. í˜„ì¬ ë‚´ ê³„ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì•ˆì „í•˜ê²Œ state ì‚¬ìš©)
    const myAccount = window.state?.userAccount;
    
    if (!myAccount || !myAccount.loginId) {
        alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        return;
    }

    // 2. ì¥ì°©ëœ ìŠ¤í‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const equippedList = document.getElementById('equipped-skill-list');
    const skillItems = equippedList.querySelectorAll('.skill-item');
    const newSkills = Array.from(skillItems).map(el => el.dataset.skillId);
    
    try {
        // â–¼â–¼â–¼ [í•µì‹¬] ì €ì¥ ê²½ë¡œë¥¼ í™ˆí˜ì´ì§€ê°€ ì½ëŠ” ê³³(artifacts)ìœ¼ë¡œ ë³€ê²½ â–¼â–¼â–¼
        const loginId = myAccount.loginId;
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
        
        // 3. DBì— ì €ì¥ (merge: trueë¡œ ê¸°ì¡´ ì •ë³´ ìœ ì§€)
        await setDoc(userRef, {
            combatSkills: newSkills,
            updatedAt: new Date()
        }, { merge: true });
        
        // 4. í™”ë©´ ì¦‰ì‹œ ê°±ì‹  (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë°˜ì˜)
        // ë¡œì»¬ state ì—…ë°ì´íŠ¸
        if(window.state && window.state.userAccount) {
            window.state.userAccount.combatSkills = newSkills;
        }
        // í”„ë¡œí•„ í™”ë©´ ì—…ë°ì´íŠ¸
        if (typeof window.renderProfileSkills === 'function') {
            window.renderProfileSkills(newSkills);
        }

        window.closeSkillEditor();
        alert("ìŠ¤í‚¬ ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        
    } catch (e) {
        console.error(e);
        alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
    }
}
    </script>
    <div id="raid-board-modal" class="fixed inset-0 bg-black/95 z-[9999] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
    
    <div class="relative w-[98vw] h-[98vh] lg:w-[95vw] lg:h-[95vh] bg-[#0a0a0a] border border-[#D4B783]/40 shadow-[0_0_60px_rgba(212,183,131,0.15)] flex flex-col overflow-hidden">
        
        <div class="h-12 border-b border-[#D4B783]/20 bg-gradient-to-r from-[#1a1a1a] to-[#0a0a0a] flex items-center justify-between px-6 select-none flex-shrink-0">
            
            <div class="flex items-center gap-3">
                <div class="w-1 h-4 bg-[#D4B783] shadow-[0_0_8px_#D4B783]"></div>
                <span class="text-[#D4B783] font-serif tracking-[0.2em] text-xs lg:text-sm font-bold opacity-90">
                    TACTICAL INTERFACE
                </span>
            </div>

            <button onclick="closeRaidBoard()" class="group flex items-center gap-2 text-[#666] hover:text-[#D4B783] transition-colors duration-300 focus:outline-none">
                <span class="font-serif text-[10px] tracking-widest uppercase group-hover:tracking-[0.15em] transition-all duration-300">
                    TERMINATE
                </span>
                <div class="relative w-6 h-6 flex items-center justify-center border border-transparent group-hover:border-[#D4B783]/30 transition-all">
                    <svg class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
            </button>
        </div>

        <div class="flex-1 relative bg-black w-full h-full">
            <iframe 
                id="raid-board-iframe" 
                src="" 
                class="absolute inset-0 w-full h-full border-0"
                allow="clipboard-write"
            ></iframe>
            
            <div class="absolute bottom-0 right-0 w-3 h-3 border-b border-r border-[#D4B783]/50 pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 w-3 h-3 border-b border-l border-[#D4B783]/50 pointer-events-none"></div>
        </div>
    </div>
</div>
<div id="skill-edit-modal" class="fixed inset-0 bg-black/90 z-[10000] hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-[#0a0a0a] border border-[#D4B783]/50 w-[800px] h-[600px] flex flex-col shadow-[0_0_50px_rgba(212,183,131,0.2)]">
        
        <div class="flex justify-between items-center p-4 border-b border-[#D4B783]/30 bg-white/5">
            <h2 class="text-[#D4B783] font-serif text-xl tracking-widest">ARCANE MAPPING</h2>
            <button onclick="closeSkillEditor()" class="text-gray-400 hover:text-white">âœ•</button>
        </div>

        <div class="flex-1 flex overflow-hidden">
            <div class="w-1/2 p-4 border-r border-[#D4B783]/30 flex flex-col bg-[#111]">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-gray-400 text-xs tracking-widest uppercase">Available Arcanum</h3>
                    <button id="admin-add-skill-btn" onclick="openAdminSkillAdd()" 
                            class="hidden px-3 py-1 bg-[#D4B783]/20 hover:bg-[#D4B783]/40 text-[#D4B783] text-[10px] rounded border border-[#D4B783]/30 transition-colors">
                        + ADD SKILL
                    </button>
                </div>
                <div id="skill-library-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar" ondrop="drop(event)" ondragover="allowDrop(event)">
                    </div>
            </div>

            <div class="w-1/2 p-4 flex flex-col bg-[#0a0a0a]">
                <div class="flex justify-between mb-3">
                    <h3 class="text-[#D4B783] text-xs tracking-widest uppercase">Equipped Slots</h3>
                    <span id="skill-count-badge" class="text-xs text-gray-500">0 / 5</span>
                </div>
                
                <div id="equipped-skill-list" class="flex-1 border border-dashed border-[#D4B783]/30 rounded p-2 space-y-2 overflow-y-auto" 
                     ondrop="drop(event)" ondragover="allowDrop(event)">
                    <p class="text-gray-600 text-xs text-center mt-10 pointer-events-none">Drag skills here</p>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-[#D4B783]/30 flex justify-end gap-3 bg-black">
            <button onclick="closeSkillEditor()" class="px-6 py-2 text-gray-400 hover:text-white text-sm">CANCEL</button>
            <button onclick="saveMySkills()" class="px-6 py-2 bg-[#D4B783] text-black font-bold text-sm hover:bg-[#c1a26c]">CONFIRM SETUP</button>
        </div>
    </div>
</div>

<style>
    /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
    .skill-item {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 10px;
        cursor: grab;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s;
    }
    .skill-item:hover {
        background: rgba(212, 183, 131, 0.1);
        border-color: #D4B783;
    }
    .skill-item:active { cursor: grabbing; }
    .skill-icon { font-size: 1.2rem; }
    .skill-info { flex: 1; }
    .skill-name { color: #e5e5e5; font-size: 0.9rem; font-weight: bold; }
    .skill-type { font-size: 0.7rem; color: #888; }
</style>

<!-- ê´€ë¦¬ì ìŠ¤í‚¬ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="admin-skill-add-modal" class="fixed inset-0 bg-black/90 z-[10001] hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-[#0a0a0a] border border-[#D4B783]/50 w-[500px] flex flex-col shadow-[0_0_50px_rgba(212,183,131,0.2)]">
        
        <div class="flex justify-between items-center p-4 border-b border-[#D4B783]/30 bg-white/5">
            <h2 class="text-[#D4B783] font-serif text-xl tracking-widest">ADD NEW SKILL</h2>
            <button onclick="closeAdminSkillAdd()" class="text-gray-400 hover:text-white">âœ•</button>
        </div>

        <div class="p-6 space-y-4">
            <div>
                <label class="text-gray-400 text-xs block mb-2">Skill ID (English only, e.g., thunder_strike)</label>
                <input id="admin-skill-id" type="text" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm" placeholder="thunder_strike">
            </div>
            
            <div>
                <label class="text-gray-400 text-xs block mb-2">Skill Name (Display)</label>
                <input id="admin-skill-name" type="text" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm" placeholder="ì²œë‘¥ ê°•íƒ€">
            </div>
            
            <div>
                <label class="text-gray-400 text-xs block mb-2">Icon (Emoji)</label>
                <input id="admin-skill-icon" type="text" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm" placeholder="âš¡" maxlength="2">
            </div>
            
            <div>
                <label class="text-gray-400 text-xs block mb-2">Type</label>
                <select id="admin-skill-type" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm">
                    <option value="Attack">Attack</option>
                    <option value="Support">Support</option>
                    <option value="Heal">Heal</option>
                    <option value="Utility">Utility</option>
                    <option value="Defense">Defense</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div>
                <label class="text-gray-400 text-xs block mb-2">Description</label>
                <textarea id="admin-skill-desc" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm" rows="2" placeholder="ìŠ¤í‚¬ ì„¤ëª…"></textarea>
            </div>
        </div>

        <div class="p-4 border-t border-[#D4B783]/30 flex justify-end gap-3 bg-black">
            <button onclick="closeAdminSkillAdd()" class="px-6 py-2 text-gray-400 hover:text-white text-sm">CANCEL</button>
            <button onclick="saveAdminSkill()" class="px-6 py-2 bg-[#D4B783] text-black font-bold text-sm hover:bg-[#c1a26c]">CREATE SKILL</button>
        </div>
    </div>
</div>

<script>
// ê´€ë¦¬ì ìŠ¤í‚¬ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
window.openAdminSkillAdd = function() {
    document.getElementById('admin-skill-add-modal').classList.remove('hidden');
}

window.closeAdminSkillAdd = function() {
    document.getElementById('admin-skill-add-modal').classList.add('hidden');
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('admin-skill-id').value = '';
    document.getElementById('admin-skill-name').value = '';
    document.getElementById('admin-skill-icon').value = '';
    document.getElementById('admin-skill-type').value = 'Attack';
    document.getElementById('admin-skill-desc').value = '';
}

// ê´€ë¦¬ì ìŠ¤í‚¬ ì €ì¥
window.saveAdminSkill = async function() {
    const skillId = document.getElementById('admin-skill-id').value.trim();
    const skillName = document.getElementById('admin-skill-name').value.trim();
    const skillIcon = document.getElementById('admin-skill-icon').value.trim();
    const skillType = document.getElementById('admin-skill-type').value;
    const skillDesc = document.getElementById('admin-skill-desc').value.trim();
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!skillId || !skillName || !skillIcon) {
        alert('ìŠ¤í‚¬ ID, ì´ë¦„, ì•„ì´ì½˜ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    // ì˜ë¬¸ ID ê²€ì¦
    if (!/^[a-z_]+$/.test(skillId)) {
        alert('ìŠ¤í‚¬ IDëŠ” ì˜ë¬¸ ì†Œë¬¸ìì™€ ì–¸ë”ìŠ¤ì½”ì–´(_)ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }
    
    try {
        // Firestoreì— ìŠ¤í‚¬ ì¶”ê°€
        const skillRef = doc(window.db, 'skillLibrary', skillId);
        await setDoc(skillRef, {
            id: skillId,
            name: skillName,
            icon: skillIcon,
            type: skillType,
            desc: skillDesc || 'ì„¤ëª… ì—†ìŒ'
        });
        
        console.log('âœ… ìŠ¤í‚¬ ì¶”ê°€ ì™„ë£Œ:', skillId);
        alert(`ìŠ¤í‚¬ "${skillName}"ì´(ê°€) ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        
        // ëª¨ë‹¬ ë‹«ê³  ìŠ¤í‚¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        closeAdminSkillAdd();
        await loadSkillData();
        
    } catch (error) {
        console.error('âŒ ìŠ¤í‚¬ ì¶”ê°€ ì‹¤íŒ¨:', error);
        alert('ìŠ¤í‚¬ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
    }
}
window.renderProfileSkills = function(skills) {
    const container = document.getElementById('profile-equipped-skills');
    
    // ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´(ëª¨ë‹¬ì´ ë‹«í˜€ìˆê±°ë‚˜ í•˜ë©´) ì¤‘ë‹¨
    if (!container) return;

    // ìŠ¤í‚¬ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆì„ ë•Œ
    if (!skills || skills.length === 0) {
        container.innerHTML = `
            <div class="col-span-5 text-center py-3 border border-dashed border-white/10 rounded-xl">
                <span class="text-[10px] text-neutral-600">No skills equipped</span>
            </div>`;
        return;
    }

    // ìŠ¤í‚¬ì´ ìˆìœ¼ë©´: ìœ„ìª½ Stats ì…ë ¥ì°½ê³¼ ë˜‘ê°™ì€ ë””ìì¸ìœ¼ë¡œ í‘œì‹œ
    // (í˜„ì¬ëŠ” IDë§Œ í‘œì‹œë˜ì§€ë§Œ, ì •ìƒì ìœ¼ë¡œ ì €ì¥ëœ ê²ƒì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
    container.innerHTML = skills.map(id => `
        <div class="w-full bg-black border border-white/10 rounded-xl px-1 py-3 text-[10px] text-white text-center font-mono truncate cursor-help hover:border-amber-500 transition-colors uppercase" title="${id}">
            ${id}
        </div>
    `).join('');
}
window.importSkillsFromFile = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    
    reader.onload = async (e) => {
        try {
            const jsonContent = e.target.result;
            const importedData = JSON.parse(jsonContent);
            
            // ë°ì´í„°ê°€ ë°°ì—´ì¸ì§€ ê°ì²´ì¸ì§€ í™•ì¸í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
            let skillsToImport = [];
            if (Array.isArray(importedData)) {
                skillsToImport = importedData;
            } else if (typeof importedData === 'object' && importedData !== null) {
                skillsToImport = Object.values(importedData);
            }

            if (skillsToImport.length === 0) {
                alert("íŒŒì¼ì— ìœ íš¨í•œ ìŠ¤í‚¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (!confirm(`${skillsToImport.length}ê°œì˜ ìŠ¤í‚¬ì„ ë„ê°ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì¤‘ë³µëœ IDëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)`)) {
                event.target.value = ''; // ì·¨ì†Œ ì‹œ íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                return;
            }

            let successCount = 0;

            // í•˜ë‚˜ì”© DBì— ì €ì¥
            for (const skill of skillsToImport) {
                // í•„ìˆ˜ ë°ì´í„° ê²€ì¦ (IDì™€ ì´ë¦„ì´ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€)
                if (!skill.id || !skill.name) continue;

                // Firestore 'skillLibrary' ì»¬ë ‰ì…˜ì— ì €ì¥
                await setDoc(doc(db, 'skillLibrary', skill.id), {
                    id: skill.id,
                    name: skill.name,
                    icon: skill.icon || 'âš”ï¸',
                    type: skill.type || 'Other',
                    desc: skill.desc || skill.description || 'ê°€ì ¸ì˜¨ ìŠ¤í‚¬ì…ë‹ˆë‹¤.'
                }, { merge: true }); // merge: trueë¡œ ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸

                successCount++;
            }

            alert(`âœ… ì´ ${successCount}ê°œì˜ ìŠ¤í‚¬ì´ ë„ê°ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            
            // ìŠ¤í‚¬ í¸ì§‘ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            const editModal = document.getElementById('skill-edit-modal');
            if (editModal && !editModal.classList.contains('hidden')) {
                await loadSkillData();
            }

        } catch (error) {
            console.error("ìŠ¤í‚¬ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
            alert("íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
            // ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ ì´ˆê¸°í™”
            event.target.value = '';
        }
    };
    
    reader.readAsText(file);
};
</script>
</body>
</html>

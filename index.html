<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysium: OC Community</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #0a0a0a;
            color: #e5e5e5;
            font-family: 'ui-sans-serif', system-ui, sans-serif;
            overflow: hidden;
        }
        .font-serif { font-family: 'Noto Serif KR', serif; }
        
        /* 스크롤바 커스텀 */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1a1a1a; border-radius: 10px; }
        
        /* Transitions */
        @keyframes viewEnter {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes viewExit {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-15px); }
        }
        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .view-enter { animation: viewEnter 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .view-exit { animation: viewExit 0.3s ease-in forwards; }
        .modal-enter { animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        .sidebar-btn.active {
            background-color: #d97706;
            color: white;
            box-shadow: 0 10px 20px -5px rgba(146, 64, 14, 0.5);
            transform: translateX(5px);
        }

        .chat-bubble-mine {
            background: linear-gradient(135deg, #d97706, #b45309);
            color: white;
            border-bottom-right-radius: 0;
        }
        .chat-bubble-theirs {
            background-color: #1f1f1f;
            color: #d4d4d4;
            border-bottom-left-radius: 0;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #oc-large-image {
            mask-image: linear-gradient(to left, black 70%, transparent 100%);
            filter: drop-shadow(0 0 100px rgba(0,0,0,1));
        }

        .new-badge {
            background-color: #ef4444;
            color: white;
            font-size: 8px;
            font-weight: 900;
            padding: 2px 5px;
            border-radius: 4px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        #auth-view {
    background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
    background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); /* 별가루 효과 */
}

.auth-card {
    background: rgba(15, 15, 15, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 2rem;
}

.auth-input {
    background: #050505 !important;
    border: 1px solid #1a1a1a !important;
    color: white !important;
    transition: all 0.3s ease;
}

.auth-input:focus {
    border-color: #d97706 !important;
    box-shadow: 0 0 15px rgba(217, 119, 6, 0.2);
}

.btn-initialize {
    background: #d97706 !important;
    color: white !important;
    font-weight: 800 !important;
    letter-spacing: 0.1em;
    box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
}

.btn-initialize:hover {
    background: #b45309 !important;
    transform: translateY(-1px);
}
.auth-bg-overlay {
    position: fixed;
    inset: 0;
    z-index: -1; /* 로그인창보다 뒤에 위치 */
    background-size: cover;
    background-position: center;
    filter: grayscale(100%) blur(10px) brightness(0.3); /* 그레이 + 블러 + 어둡게 */
    transition: background-image 0.5s ease;
}
.new-badge {
    background: #d97706; /* amber-600 */
    color: white;
    font-size: 8px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    letter-spacing: 0.05em;
    box-shadow: 0 0 10px rgba(217, 119, 6, 0.5);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}
/* 조사 가능 여부 텍스트 강조 */
.status-text {
    font-size: 1.25rem; /* 20px 정도로 크게 설정 */
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -0.02em;
}

.new-badge {
    background: #ef4444;
    color: white;
    font-size: 9px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    animation: pulse 2s infinite;
}
    </style>
</head>
<body>

    <!-- 초기 로딩 스크린 -->
    <div id="loading-overlay" class="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center space-y-4 transition-opacity duration-1000">
        <div class="w-16 h-[2px] bg-amber-500 animate-pulse"></div>
        <p class="text-amber-500 font-mono text-[10px] tracking-[0.5em] uppercase">Connecting to Elysium</p>
    </div>

    <div id="app-container" class="flex h-screen w-full opacity-0 transition-opacity duration-1000">
        
        <!-- Authentication Gate -->
        <div id="auth-view" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center p-6">
    
    <div id="auth-dynamic-bg" class="auth-bg-overlay"></div>
    
    <div class="text-center mb-10 animate-fade-in relative z-10">
        <div class="w-16 h-16 bg-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-[0_0_30px_rgba(217,119,6,0.4)]">
            <i data-lucide="layers" class="w-8 h-8 text-white"></i>
        </div>
        <h1 class="text-4xl font-serif font-black text-white tracking-[0.2em] uppercase mb-1">ELYSIUM</h1>
        <p class="text-[9px] text-amber-500/60 font-mono tracking-[0.4em] uppercase">Secure Archive System</p>
    </div>

    <div class="w-full max-w-[400px] auth-card p-10 space-y-8 modal-enter">
        <div class="space-y-6">
            <div class="space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Identify</label>
                <div class="relative">
                    <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-600"></i>
                    <input id="auth-id" type="text" placeholder="ERA ID" class="auth-input w-full rounded-xl pl-12 pr-6 py-4 text-sm outline-none">
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Access Key</label>
                <div class="relative">
                    <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-600"></i>
                    <input id="auth-pw" type="password" placeholder="••••••••" class="auth-input w-full rounded-xl pl-12 pr-6 py-4 text-sm outline-none">
                </div>
            </div>

            <div id="signup-extra" class="hidden space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Personnel Name</label>
                <input id="auth-oc-name" type="text" placeholder="CHARACTER NAME" class="auth-input w-full rounded-xl px-6 py-4 text-sm outline-none">
            </div>
        </div>

        <button id="auth-submit-btn" class="btn-initialize w-full py-4 rounded-xl text-xs uppercase transition-all active:scale-95">
            Initialize Session
        </button>

        <div class="text-center">
            <button id="auth-toggle-btn" class="text-[9px] text-neutral-600 hover:text-amber-500 transition-colors uppercase tracking-[0.2em]">
                Request New Identity
            </button>
        </div>
    </div>

    <div class="mt-12 text-center opacity-30">
        <p class="text-[8px] text-neutral-500 font-mono tracking-widest uppercase">Secure Connection Established</p>
        <p class="text-[8px] text-neutral-600 font-mono mt-1">Ver 2.5.0 // ELYSIUM SYSTEM</p>
    </div>
</div>

        <!-- Sidebar -->
        <nav class="w-20 lg:w-64 border-r border-white/5 flex flex-col bg-neutral-950 z-50">
            <div class="p-8 flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-amber-600 rounded-xl flex items-center justify-center shrink-0 shadow-lg shadow-amber-900/30">
                    <i data-lucide="layers" class="w-6 h-6 text-white"></i>
                </div>
                <h1 class="text-sm font-black tracking-[0.4em] text-white hidden lg:block uppercase">Elysium</h1>
            </div>
            
            <div class="flex-1 px-4 py-4 space-y-2 overflow-y-auto" id="sidebar-nav"></div>

            <div class="p-6 border-t border-white/5 bg-black/20">
                <div class="bg-neutral-900/50 p-4 rounded-3xl flex items-center gap-3 border border-white/5 hover:border-amber-500/30 transition-all">
                    <div class="w-10 h-10 rounded-xl bg-black overflow-hidden border border-white/10 shrink-0 shadow-lg cursor-pointer transition-transform active:scale-90" onclick="switchView('profile')">
                        <img id="user-avatar" src="" class="w-full h-full object-cover hidden">
                        <div id="user-avatar-placeholder" class="w-full h-full flex items-center justify-center bg-neutral-800"><i data-lucide="user" class="w-5 h-5 text-neutral-500"></i></div>
                    </div>
                    <div class="hidden lg:block overflow-hidden flex-1">
                        <p id="user-name-display" class="text-[11px] font-black text-white truncate">Personnel</p>
                        <p id="user-id-display" class="text-[9px] text-amber-500 font-mono uppercase truncate">Guest</p>
                    </div>
                    <button onclick="handleLogout()" class="p-2 text-neutral-600 hover:text-red-500 transition-all" title="Logout">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col relative bg-neutral-950 overflow-hidden">
            <div id="content-area" class="flex-1 relative flex flex-col h-full overflow-y-auto"></div>
        </main>

        <!-- Toast -->
        <div id="toast" class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 z-[150]">
            <div class="bg-amber-600 text-white px-8 py-4 rounded-2xl shadow-2xl font-black text-[10px] tracking-widest uppercase flex items-center gap-3 border border-amber-400/20 modal-enter">
                <i data-lucide="shield" class="w-4 h-4"></i>
                <span id="toast-message">Notification</span>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
<audio id="noti-sound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7XJPpZzfDbdDCsbzMVO9HTZqrpUlMX-Y",
            authDomain: "macol-acead.firebaseapp.com",
            projectId: "macol-acead",
            storageBucket: "macol-acead.firebasestorage.app",
            messagingSenderId: "231346298031",
            appId: "1:231346298031:web:3982e3b72e7214d177485a"
        };
        const appId = "oc-community-html-v6";
        const ADMIN_PW = "admin1234";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const $ = (id) => document.getElementById(id);

        // --- Global State ---
        let state = {
            user: null,
            userAccount: null,
            accounts: [],
            chatRooms: [],
            messages: [],
            currentView: 'home',
            authMode: 'login',
            isAdmin: false,
            selectedRoomId: null,
            initDone: false,
            world: {
                title: "REVERSE: 1999 STYLE HUB",
                description: "Keep moving forward."
            },
            investigation: {
    selectedSector: null, // 현재 유저가 들어간 구역 ID
        foundClueIds: [],      // 유저가 발견한 단서들
        viewedClueIds: [],     // 전문을 확인한 단서들 (NEW 표시 제거용)
        sectors: [
            { id: 'academy', name: '아카데미', map: 'https://images.unsplash.com/photo-1523050853061-80e8a4ff147e?q=80&w=2000', desc: '금지된 지식이 잠든 곳', unlockDate: '11월 12일', isAvailable: true },
            { id: 'forest', name: '숲', map: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2000', desc: '기척이 사라진 태고의 숲', unlockDate: '11월 14일', isAvailable: false },
            { id: 'lake', name: '호수', map: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2000', desc: '비명을 삼킨 고요한 수면', unlockDate: '11월 15일', isAvailable: false }
        ],
        points: [
            // sector 필드를 추가하여 각 구역에 맞게 배치합니다.
            { id: 'p1', sector: 'academy', x: 25, y: 40, title: 'Old Harbor', clue: '항구 창고 뒤에서 젖은 쪽지를 발견했습니다.' },
            { id: 'p2', sector: 'forest', x: 60, y: 30, title: 'Central Tower', clue: '타워 통제실 단말기에서 로그를 추출했습니다.' }
        ]
    }
};

        // --- App Lifecycle ---
        window.addEventListener('DOMContentLoaded', () => {
    initAuth();
    setupAuthEvents();
    
    // 안전하게 요소를 찾아서 있을 때만 이벤트를 연결합니다.
    const adminTrigger = document.getElementById('admin-mode-trigger');
    if (adminTrigger) {
        adminTrigger.onclick = () => {
            const authView = document.getElementById('auth-view');
            if (authView) authView.classList.add('hidden');
            switchView('admin');
        };
    }
});

        async function initAuth() {
            onAuthStateChanged(auth, async (user) => {
                state.user = user;
                if (user) {
                    subscribeToData();
                } else {
                    hideLoading();
                    showAuthGate();
                }
            });

            if (!auth.currentUser) {
                try { await signInAnonymously(auth); } catch(e) { hideLoading(); showAuthGate(); }
            }
        }

        function hideLoading() {
            const overlay = $('loading-overlay');
            if (overlay) { overlay.style.opacity = '0'; setTimeout(() => overlay.classList.add('hidden'), 1000); }
            $('app-container').classList.remove('opacity-0');
        }

function subscribeToData() {
    const accountsRef = collection(db, 'artifacts', appId, 'public', 'data', 'accounts');
    const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms');
    const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
    const reportsRef = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
    const notiRef = collection(db, 'artifacts', appId, 'public', 'data', 'notifications');

    const loadTime = Date.now() / 1000;

    // 1. 월드 & 스토리
    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world'), (docSnap) => {
    if (docSnap.exists()) {
        const fetchedData = docSnap.data();
        
        // [핵심] 서버 데이터를 로컬 state에 복사
        state.world = { ...state.world, ...fetchedData };
        
        // [중요] 조사 데이터(포인트, 배경, 자물쇠)가 서버에 있으면 덮어씌움
        if (fetchedData.investigation) {
            state.investigation = { 
                ...state.investigation, 
                ...fetchedData.investigation 
            };
        }
        
        console.log("✅ 서버 데이터 동기화 완료:", state.investigation);
    }
    
    // 현재 보고 있는 화면이 'home'이나 'investigation'이면 즉시 다시 그리기
    if (state.currentView === 'home') renderView('home');
    if (state.currentView === 'investigation') renderView('investigation');
});
    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'story'), (docSnap) => {
        state.storyData = docSnap.exists() ? docSnap.data() : { chapters: [] };
        if (state.currentView === 'operation' && document.getElementById('story-timeline-root')) window.renderStoryTimeline();
    });

    // 2. 계정
    onSnapshot(accountsRef, (snapshot) => {
        state.accounts = snapshot.docs.map(d => d.data());
        updateUserSession();
        if (['members', 'admin', 'mail'].includes(state.currentView)) renderView(state.currentView);
    });

    // 3. 채팅방 (목록 갱신)
    onSnapshot(roomsRef, (snapshot) => {
        state.chatRooms = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        if (state.currentView === 'mail') renderMail();
        renderSidebarUI();
    });

    // 4. [핵심 수정] 메시지 감지 & 실시간 읽음 처리
    onSnapshot(messagesRef, (snapshot) => {
        state.messages = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        
        // 화면 갱신
        if (state.currentView === 'mail' || state.isAdmin) renderView(state.currentView);
        renderSidebarUI();

        snapshot.docChanges().forEach(async (change) => {
            if (change.type === 'added') {
                const msg = change.doc.data();
                const myId = state.userAccount?.loginId;
                
                if (!state.initDone || !myId || msg.fromId === myId || msg.fromId === 'system') return;
                if (msg.timestamp && msg.timestamp.seconds <= loadTime) return;

                const room = state.chatRooms.find(r => r.id === msg.roomId);
                if (!room || !room.members.includes(myId)) return;

                // [추가됨] 만약 내가 현재 이 방을 보고 있다면? -> 즉시 읽음 처리 (DB 업데이트)
                // 이렇게 해야 다른 방 갔다 와도 NEW가 안 뜹니다.
                if (state.currentView === 'mail' && state.selectedRoomId === msg.roomId) {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', msg.roomId);
                    // lastRead 필드에 내 아이디와 현재 시간 기록
                    updateDoc(roomRef, {
                        [`lastRead.${myId}`]: serverTimestamp()
                    }).catch(console.error);
                }

                // 알림 생성 로직 (보고 있는 방이면 알림 생략 가능하지만, 일단 기록은 남김)
                const isMuted = room.muted && room.muted[myId];
                if (isMuted) return;

                const newBody = `${msg.fromName}: ${msg.body.substring(0, 30)}${msg.body.length>30?'...':''}`;
                const existingNoti = state.notifications ? state.notifications.find(n => n.roomId === msg.roomId) : null;

                try {
                    if (existingNoti) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', existingNoti.id), {
                            message: newBody, timestamp: serverTimestamp(), isRead: false
                        });
                    } else {
                        await addDoc(notiRef, {
                            targetUserId: myId, roomId: msg.roomId, title: `Message from [${room.name}]`,
                            message: newBody, memo: "Unread Message", timestamp: serverTimestamp(), isRead: false
                        });
                    }
                } catch(e) { console.error(e); }
            }
        });
    });

    // 5. 기타 리스너
    onSnapshot(reportsRef, (snapshot) => {
        state.reports = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        if (state.isAdmin && state.currentView === 'admin') window.updateAdminReportsUI(); 
    });
    onSnapshot(notiRef, (snapshot) => {
        state.rawNotifications = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        updateMyNotifications();
    });
}
        function updateUserSession() {
    if (!state.user) return;
    const myAcc = state.accounts.find(a => a.uid === state.user.uid);
    state.userAccount = myAcc || { status: 'new' };
    
    if (myAcc && myAcc.status === 'approved') {
        // [추가됨] 권한 체크: 'staff' 등급이면 관리자 권한 자동 부여
        if (myAcc.role === 'staff') {
            state.isAdmin = true;
        }

        hideLoading();
        $('auth-view').classList.add('hidden');
        updateProfileBarUI();
        
        // 로그인 완료 시 알림 목록 갱신
        if (typeof updateMyNotifications === 'function') updateMyNotifications();

        if (!state.initDone) {
            renderSidebarUI();
            switchView('home');
            state.initDone = true;
        }
    } else if (myAcc && myAcc.status === 'pending') {
        hideLoading();
        showPendingGateUI();
    } else {
        hideLoading();
        showAuthGate();
    }
}

        // --- Core Navigation ---
        window.switchView = (viewId) => {
            if (state.currentView === viewId && state.initDone) return;
            const area = $('content-area');
            area.classList.add('view-exit');
            setTimeout(() => {
                state.currentView = viewId;
                area.classList.remove('view-exit');
                area.classList.add('view-enter');
                renderView(viewId);
                updateSidebarUI();
                setTimeout(() => area.classList.remove('view-enter'), 500);
            }, 300);
        };

        function renderView(viewId) {
    const area = $('content-area');
    
    // 메일 화면 유지 로직
    const isMailUpdate = (viewId === 'mail' && document.getElementById('mail-view-root'));
    if (!isMailUpdate) {
        area.innerHTML = '';
    }
    
    switch(viewId) {
        case 'home': renderHome(); break;
        case 'mail': renderMail(); break;
        case 'operation': renderOperation(); break;
        // ★ 아래 한 줄을 반드시 추가해야 'Field Work' 클릭 시 화면이 나옵니다.
        case 'investigation': renderInvestigation(); break; 
        case 'members': renderMembers(); break;
        case 'profile': renderProfile(); break;
        case 'admin': renderAdmin(); break;
        case 'visit': renderVisitProfile(); break;
    }
    
    // 사이드바 UI도 상태에 맞춰 갱신 (활성화 버튼 색상 변경 등)
    renderSidebarUI();
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
        // --- View Content Creators ---
        function renderHome() {
    const oc = state.userAccount || {};
    const world = state.world || {};
    
    // 알림 확인
    const myNotis = state.notifications || [];
    const hasNoti = myNotis.length > 0;

    // 이름 길이 조절
    const nameLen = (oc.ocName || '').length;
    let nameSize;
    if (nameLen > 12) nameSize = "clamp(2rem, 4vw, 4rem)";
    else if (nameLen > 7) nameSize = "clamp(2.5rem, 5vw, 6rem)";
    else nameSize = "clamp(3rem, 6vw, 8rem)";

    $('content-area').innerHTML = `
        <div class="relative h-full w-full flex flex-col overflow-hidden bg-[#0a0a0a]">
            
            <div class="absolute inset-0 z-0">
                <img src="${oc.profile || 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=1000'}" 
                     class="w-full h-full object-cover opacity-80 blur-[10px] scale-110 grayscale brightness-50">
                <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0a] via-[#0a0a0a]/80 to-transparent"></div>
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMDUpIiAvPgo8L3N2Zz4=')] opacity-20"></div>
            </div>

            <div class="absolute inset-y-0 right-[2%] lg:right-[8%] w-[80%] lg:w-[55%] z-10 pointer-events-none flex items-end justify-end">
                <img src="${oc.profile || 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=1000'}" 
                     class="h-[90%] w-full object-contain object-bottom drop-shadow-2xl opacity-100 mask-image-bottom">
            </div>

            <div class="absolute top-8 right-8 z-50 pointer-events-auto">
                <button onclick="toggleNotificationModal()" class="relative group p-3 bg-neutral-900/50 rounded-full border border-white/10 hover:border-amber-500 hover:bg-amber-600/20 transition-all">
                    <i data-lucide="bell" class="w-6 h-6 text-neutral-400 group-hover:text-amber-500 transition-colors"></i>
                    ${hasNoti ? `<span class="absolute top-0 right-0 w-3 h-3 bg-red-600 rounded-full border-2 border-black animate-pulse"></span>` : ''}
                </button>
                
                <div id="noti-dropdown" class="hidden absolute top-14 right-0 w-80 bg-neutral-900 border border-amber-600/30 rounded-2xl shadow-2xl overflow-hidden backdrop-blur-xl animate-fade-in">
                    <div class="p-4 border-b border-white/5 flex justify-between items-center">
                        <span class="text-xs font-bold text-amber-500 uppercase tracking-widest">System Alerts</span>
                        <button onclick="clearAllNotifications()" class="text-[9px] text-neutral-500 hover:text-white uppercase underline">Clear All</button>
                    </div>
                    <div class="max-h-64 overflow-y-auto custom-scrollbar p-2 space-y-2">
                        ${myNotis.length === 0 ? `<p class="text-center text-[10px] text-neutral-600 py-6 italic">No new signals.</p>` : 
                            myNotis.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0)).map(n => `
                            <div class="p-3 bg-black/40 rounded-xl border border-white/5 flex gap-3 relative group">
                                <div class="w-8 h-8 rounded-full bg-amber-600/20 flex items-center justify-center shrink-0 text-amber-500"><i data-lucide="info" class="w-4 h-4"></i></div>
                                <div>
                                    <p class="text-xs text-white font-bold mb-1">${n.title}</p>
                                    <p class="text-[10px] text-neutral-400 leading-relaxed">${n.message}</p>
                                    ${n.memo ? `<p class="text-[10px] text-amber-500/80 mt-1 pl-2 border-l-2 border-amber-500/30 italic">" ${n.memo} "</p>` : ''}
                                    <p class="text-[8px] text-neutral-600 font-mono mt-1">${n.timestamp ? new Date(n.timestamp.seconds*1000).toLocaleString() : ''}</p>
                                </div>
                                <button onclick="deleteNotification('${n.id}')" class="absolute top-2 right-2 text-neutral-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>

            <div class="relative z-20 h-full flex flex-col justify-center pl-12 lg:pl-24 max-w-[65%] pointer-events-none">
                
                <div class="mb-6 flex items-center gap-4 animate-slide-up" style="animation-delay: 0.1s;">
                    <div class="bg-amber-600/20 text-amber-500 px-4 py-1.5 border border-amber-500/30 rounded-full text-[10px] font-black tracking-[0.3em] uppercase backdrop-blur-md">
                        ${oc.badgeText || 'Dossier: Authorized'}
                    </div>
                </div>

                <h1 class="font-serif font-black text-white tracking-tighter uppercase whitespace-nowrap leading-none mb-8 drop-shadow-xl animate-slide-up" 
                    style="font-size: ${nameSize}; animation-delay: 0.2s;">
                    ${oc.ocName || 'Personnel'}
                </h1>

                <div class="border-l-4 border-amber-600 pl-6 animate-slide-up" style="animation-delay: 0.3s;">
                    <h3 class="text-2xl lg:text-4xl font-serif font-bold text-white mb-4 leading-tight tracking-tight">
                        ${oc.slogan || '시대에 획을 그을 스타일'}
                    </h3>
                    <p class="text-xs text-neutral-400 tracking-wide font-mono leading-relaxed max-w-md opacity-70">
                        ${oc.shortDesc || world.description}
                    </p>
                </div>

                <div class="mt-12 hidden lg:block animate-pulse max-w-md">
                    <p class="text-[10px] text-amber-500/60 font-mono tracking-[0.1em] leading-loose uppercase text-justify break-words whitespace-pre-line">
                        ${(oc.stats || 'No authorized records found.').substring(0, 300)}
                    </p>
                </div>

                <div class="mt-10 pointer-events-auto w-fit animate-slide-up" style="animation-delay: 0.4s;">
                    ${oc.linkUrl ? `
                    <a href="${oc.linkUrl}" target="_blank" class="group cursor-pointer hover:scale-105 transition-transform block">
                        <div class="bg-amber-600/10 backdrop-blur-md border border-amber-500/30 p-1 rounded-lg">
                            <div class="bg-amber-600 w-32 h-12 rounded-md relative overflow-hidden flex flex-col items-center justify-center border border-amber-400/50 shadow-[0_0_20px_rgba(217,119,6,0.4)]">
                                <div class="absolute top-0 left-0 w-full h-[1px] bg-amber-400/50"></div>
                                <div class="absolute bottom-0 left-0 w-full h-[1px] bg-amber-400/50"></div>
                                <div class="absolute -left-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-[#0a0a0a] rounded-full"></div>
                                <div class="absolute -right-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-[#0a0a0a] rounded-full"></div>
                                <p class="text-[6px] text-black/60 font-black uppercase tracking-widest mb-0.5">External Link</p>
                                <h3 class="text-xs text-white font-serif font-black uppercase tracking-tighter italic drop-shadow-md flex items-center gap-1">
                                    ${oc.linkText || 'ENTER'} <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </h3>
                            </div>
                        </div>
                    </a>` : ''}
                </div>
            </div>

            <div class="absolute right-6 lg:right-12 top-1/2 -translate-y-1/2 z-30 flex flex-col gap-4 pointer-events-auto">
                <a href="${world.banner1_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner1_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 01</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner1_text || 'NOTICE'}</h4></div>
                </a>
                <a href="${world.banner2_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner2_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 02</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner2_text || 'MISSION'}</h4></div>
                </a>
                <a href="${world.banner3_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner3_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 03</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner3_text || 'SCHEDULE'}</h4></div>
                </a>
            </div>

            <div class="absolute bottom-10 right-12 z-20 text-right pointer-events-none hidden lg:block">
                <h2 class="text-6xl font-black text-amber-600/20 tracking-tighter uppercase font-mono transform rotate-0">ABCD EASO</h2>
                <div class="flex justify-end gap-3 mt-3 pr-1"><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-1"></div><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-2"></div><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-3"></div></div>
            </div>
            <div class="absolute bottom-12 left-[30%] flex gap-12 opacity-60 pointer-events-none hidden lg:flex">
                <p class="text-[20px] text-amber-500 font-serif italic tracking-wider">${oc.keyword1 || 'Keyword 1'}</p>
                <p class="text-[20px] text-amber-400 font-serif italic tracking-wider">${oc.keyword2 || 'Keyword 2'}</p>
                <p class="text-[20px] text-amber-300 font-serif italic tracking-wider">${oc.keyword3 || 'Keyword 3'}</p>
            </div>
        </div>

        <style>
            .mask-image-bottom { -webkit-mask-image: linear-gradient(to top, transparent 0%, black 20%); mask-image: linear-gradient(to top, transparent 0%, black 20%); }
            .animate-slide-up { animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
            @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
            @keyframes loadDot { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
            .loading-dot-1 { animation: loadDot 1.2s infinite; animation-delay: 0s; }
            .loading-dot-2 { animation: loadDot 1.2s infinite; animation-delay: 0.2s; }
            .loading-dot-3 { animation: loadDot 1.2s infinite; animation-delay: 0.4s; }
        </style>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
        function renderMail() {
    const myLoginId = state.userAccount.loginId;
    
    // 1. 방 목록 정렬 (최신순)
    const myRooms = state.chatRooms
        .filter(r => r.members.includes(myLoginId))
        .sort((a, b) => {
            const timeA = a.lastMessageTimestamp?.seconds || 0;
            const timeB = b.lastMessageTimestamp?.seconds || 0;
            return timeB - timeA;
        });

    const selectedRoom = state.selectedRoomId ? state.chatRooms.find(r => r.id === state.selectedRoomId) : null;

    // 2. 기본 레이아웃 (최초 1회만 생성)
    const contentArea = document.getElementById('content-area');
    if (!document.getElementById('mail-view-root')) {
        contentArea.innerHTML = `
            <div id="mail-view-root" class="flex-1 flex flex-col md:flex-row h-full bg-black/20 overflow-hidden">
                <div class="w-full md:w-80 border-r border-white/5 flex flex-col bg-neutral-950/40 h-full shrink-0">
                    <div class="p-6 border-b border-white/5 flex items-center justify-between">
                        <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2"><i data-lucide="message-square" class="w-4 h-4"></i> Transmissions</h3>
                        <button onclick="showCreateGroupModal()" class="p-2 bg-white/5 rounded-lg hover:bg-white/10 text-neutral-400 transition-all"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="mail-sidebar-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar relative"></div>
                </div>
                <div id="mail-chat-panel" class="flex-1 flex flex-col overflow-hidden h-full relative"></div>
            </div>
            
            <div id="group-modal" class="hidden fixed inset-0 z-[110] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
                 <div class="w-full max-w-md bg-neutral-900 border border-white/10 rounded-[3rem] p-10 shadow-2xl modal-enter">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter">Initialize Group</h3>
                        <button onclick="document.getElementById('group-modal').classList.add('hidden')" class="text-neutral-500 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <input id="group-name-input" type="text" placeholder="Group Codename" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white mb-6">
                    <div class="space-y-2 mb-6">
                        <p class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest">Selected Personnel</p>
                        <div class="bg-neutral-950 border border-white/5 rounded-xl p-3 min-h-[3rem] flex flex-wrap gap-2" id="selected-member-tags"></div>
                        <div class="relative mt-2">
                            <input id="member-search-input" type="text" onkeyup="filterGroupMembers()" placeholder="Search Name..." class="w-full bg-neutral-950 border border-white/5 rounded-xl px-4 py-3 text-xs outline-none focus:border-amber-500 text-white pl-10">
                            <i data-lucide="search" class="w-4 h-4 text-neutral-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        </div>
                    </div>
                    <div id="member-select-list" class="max-h-48 overflow-y-auto space-y-2 mb-8 custom-scrollbar"></div>
                    <button onclick="handleCreateGroup()" class="w-full py-5 bg-amber-600 text-white font-bold rounded-2xl uppercase tracking-widest text-xs active:scale-95 shadow-xl">Deploy Signal Room</button>
                </div>
            </div>

            <div id="room-members-modal" class="hidden fixed inset-0 z-[120] bg-black/80 flex items-center justify-center p-6 backdrop-blur-md" onclick="if(event.target === this) this.classList.add('hidden')">
                <div class="w-full max-w-sm bg-neutral-900 border border-amber-600/30 rounded-[2.5rem] p-8 shadow-2xl modal-enter relative">
                    <h3 class="text-lg font-serif font-black text-white uppercase tracking-tighter mb-6 border-b border-white/10 pb-4">Linked Personnel</h3>
                    <button onclick="document.getElementById('room-members-modal').classList.add('hidden')" class="absolute top-8 right-8 text-neutral-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div id="room-members-list" class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </div>
            <style>.member-checkbox:checked + .check-icon { opacity: 1; }</style>
        `;
    }

    // 3. [핵심 수정] 사이드바 스마트 업데이트 (디자인 복구 버전)
    const sidebarList = document.getElementById('mail-sidebar-list');
    if (sidebarList) {
        if (myRooms.length === 0) {
            sidebarList.innerHTML = '<p class="text-center text-[10px] text-neutral-700 mt-20 uppercase tracking-widest font-mono">No active signals.</p>';
        } else {
            // 삭제된 방 제거
            const currentIds = myRooms.map(r => r.id);
            Array.from(sidebarList.children).forEach(child => {
                if (child.tagName === 'BUTTON' && !currentIds.includes(child.getAttribute('data-room-id'))) {
                    child.remove();
                }
            });

            // 순서대로 요소 배치
            myRooms.forEach((r, index) => {
                let el = document.getElementById(`room-item-${r.id}`);
                
                // [수정됨] 현재 선택된 방인지 확인
                const isSelected = selectedRoom?.id === r.id;
                const isMuted = r.muted && r.muted[myLoginId];

                // [수정됨] "현재 선택된 방"이라면, 데이터상 안 읽은 메시지가 있어도 읽은 것으로 간주 (!isSelected 조건 추가)
                const hasNew = !isSelected && r.lastMessageTimestamp && (!r.lastRead || !r.lastRead[myLoginId] || r.lastRead[myLoginId].seconds < r.lastMessageTimestamp.seconds);

                const innerHTML = `
                    <div class="relative shrink-0">
                        <div class="w-12 h-12 rounded-xl bg-black border border-white/10 flex items-center justify-center overflow-hidden transition-all group-hover:border-white/30">
                            ${getRoomIconHTML(r)}
                        </div>
                        ${hasNew ? `<div class="absolute -top-2 -right-2 bg-red-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded-full border border-black shadow-md animate-bounce">NEW</div>` : ''}
                    </div>
                    <div class="flex-1 text-left overflow-hidden">
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-1">
                                <p class="text-xs font-bold uppercase truncate ${hasNew ? 'text-white' : ''}">${r.name}</p>
                                ${isMuted ? `<i data-lucide="bell-off" class="w-3 h-3 text-neutral-600 ml-1"></i>` : ''}
                            </div>
                        </div>
                        <p class="text-[10px] truncate transition-colors ${hasNew ? 'text-amber-500 font-bold' : 'text-neutral-500 group-hover:text-neutral-400'}">${r.lastMessageBody || 'No signals transmitted.'}</p>
                    </div>
                `;

                const baseClasses = "w-full p-4 rounded-2xl flex items-center gap-4 transition-all duration-500 border cursor-pointer group relative overflow-hidden";
                const activeClasses = isSelected 
                    ? "bg-amber-600/10 border-amber-500 text-white shadow-[0_0_15px_rgba(217,119,6,0.1)]" 
                    : "bg-neutral-900/40 border-white/5 text-neutral-400 hover:bg-neutral-800 hover:border-white/10";

                if (!el) {
                    // [신규 생성]
                    el = document.createElement('button');
                    el.id = `room-item-${r.id}`;
                    el.setAttribute('data-room-id', r.id);
                    el.onclick = () => enterRoom(r.id);
                    el.className = `${baseClasses} ${activeClasses} animate-fade-in-up`;
                    el.innerHTML = innerHTML;
                    sidebarList.appendChild(el); 
                } else {
                    // [업데이트]
                    if(el.innerHTML !== innerHTML) el.innerHTML = innerHTML;
                    el.className = `${baseClasses} ${activeClasses}`;
                }

                // [위치 강제 조정] 부드러운 순서 변경
                const currentChildAtIndex = sidebarList.children[index];
                if (currentChildAtIndex !== el) {
                    if (currentChildAtIndex) {
                        sidebarList.insertBefore(el, currentChildAtIndex);
                    } else {
                        sidebarList.appendChild(el);
                    }
                    // 1등으로 올라갈 때 살짝 반짝임
                    if (index === 0) {
                        el.classList.add('bg-white/10');
                        setTimeout(() => el.classList.remove('bg-white/10'), 500);
                    }
                }
            });
        }
    }

    // 4. 채팅방 패널 (기존 유지)
    const chatPanel = document.getElementById('mail-chat-panel');
    if (!selectedRoom) {
        chatPanel.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center opacity-10 h-full"><i data-lucide="mail" class="w-24 h-24 mb-6"></i><p class="text-sm font-mono uppercase tracking-[0.5em]">Secure Signal Hub</p></div>`;
    } else {
        const msgs = state.messages.filter(m => m.roomId === selectedRoom.id).sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
        const headerIcon = getRoomIconHTML(selectedRoom);
        const currentRoomIdInput = document.getElementById('current-room-id-hidden');
        const isMuted = selectedRoom.muted && selectedRoom.muted[myLoginId];
        const isSameRoom = currentRoomIdInput && currentRoomIdInput.value === selectedRoom.id;

        const generateMessageHTML = (m, showDate) => {
            if (m.fromId === 'system') return `<div id="msg-${m.id}" class="flex justify-center my-2 animate-fade-in"><span class="text-[10px] text-amber-500/50 font-mono uppercase tracking-widest border border-amber-500/10 px-3 py-1 rounded-full bg-black/20"><i data-lucide="alert-circle" class="w-3 h-3 inline-block mr-1 -mt-0.5"></i> ${m.body}</span></div>`;
            const isMine = m.fromId === myLoginId;
            const senderAcc = state.accounts.find(a => a.loginId === m.fromId);
            const senderImg = senderAcc ? senderAcc.profile : '';
            const isDeleted = m.isDeleted === true;
            const displayBody = isDeleted ? "-삭제된 메시지입니다-" : m.body;
            const bubbleStyle = isDeleted ? "bg-neutral-800 border border-white/5 text-white/50 italic" : (isMine ? "chat-bubble-mine" : "chat-bubble-theirs");
            const deleteBtn = (isMine && !isDeleted) ? `<button onclick="deleteMessage('${m.id}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-neutral-600 hover:text-red-500 p-1" title="Delete"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : '';
            const timeStr = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';

            let dateDivider = '';
            if (showDate) {
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                const dateStr = new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', dateOptions);
                dateDivider = `<div class="flex items-center justify-center my-6 opacity-60"><div class="h-px w-12 bg-gradient-to-r from-transparent to-white/20"></div><span class="px-4 text-[10px] font-mono text-neutral-500 uppercase tracking-widest border border-white/10 rounded-full py-1 bg-black/30 backdrop-blur-sm">${dateStr}</span><div class="h-px w-12 bg-gradient-to-l from-transparent to-white/20"></div></div>`;
            }

            return `${dateDivider}<div id="msg-${m.id}" class="flex ${isMine ? 'justify-end' : 'justify-start'} animate-fade-in items-end gap-3 group mb-4">${!isMine ? `<div class="w-8 h-8 rounded-lg bg-black overflow-hidden shrink-0 border border-white/10 shadow-lg"><img src="${senderImg}" class="w-full h-full object-cover"></div>` : ''}<div class="max-w-[70%] flex flex-col ${isMine ? 'items-end' : 'items-start'}">${!isMine ? `<p class="text-[9px] text-amber-500 font-bold mb-1 uppercase tracking-tighter ml-1">${m.fromName}</p>` : ''}<div class="flex items-end gap-2 ${isMine ? 'flex-row-reverse' : 'flex-row'}"><div class="p-4 rounded-2xl text-sm leading-relaxed shadow-lg ${bubbleStyle}"><p class="whitespace-pre-wrap break-words">${displayBody}</p></div><div class="flex flex-col gap-1 justify-end h-full">${deleteBtn}<p class="text-[8px] opacity-40 font-mono whitespace-nowrap">${timeStr}</p></div></div></div></div>`;
        };

        if (isSameRoom) {
            const msgContainer = document.getElementById('chat-messages-container');
            if (msgContainer) {
                msgs.forEach((m, idx) => {
                    const existingEl = document.getElementById(`msg-${m.id}`);
                    let showDate = false;
                    const currDate = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                    if(idx > 0) {
                         const prevM = msgs[idx-1];
                         const prevD = prevM.timestamp ? new Date(prevM.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                         if(currDate !== prevD) showDate = true;
                    } else showDate = true;

                    if (existingEl) {
                        if (m.isDeleted && !existingEl.innerHTML.includes("-삭제된 메시지입니다-")) existingEl.outerHTML = generateMessageHTML(m, false);
                    } else {
                         const allDates = msgContainer.querySelectorAll('.font-mono');
                         if(allDates.length > 0 && allDates[allDates.length-1].innerText === currDate) showDate = false;
                        msgContainer.insertAdjacentHTML('beforeend', generateMessageHTML(m, showDate));
                        msgContainer.scrollTop = msgContainer.scrollHeight;
                    }
                });
                const muteBtn = document.getElementById('chat-mute-btn');
                if(muteBtn) muteBtn.innerHTML = isMuted ? `<i data-lucide="bell-off" class="w-5 h-5 text-red-500"></i>` : `<i data-lucide="bell" class="w-5 h-5"></i>`;
            }
        } else {
            let lastDateStr = null;
            const fullHTML = msgs.map(m => {
                let showDate = false;
                const currDate = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                if (currDate && currDate !== lastDateStr) { showDate = true; lastDateStr = currDate; }
                return generateMessageHTML(m, showDate);
            }).join('');

            chatPanel.innerHTML = `
                <div class="flex-1 flex flex-col relative h-full overflow-hidden bg-neutral-900/10">
                    <input type="hidden" id="current-room-id-hidden" value="${selectedRoom.id}">
                    <div class="p-6 border-b border-white/5 flex items-center justify-between bg-black/40 backdrop-blur-md shrink-0">
                        <div class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="showRoomMembers('${selectedRoom.id}')">
                            <div class="w-12 h-12 rounded-xl bg-amber-600/20 border border-amber-600/30 flex items-center justify-center shrink-0 overflow-hidden">${headerIcon}</div>
                            <div>
                                <h4 class="text-sm font-bold text-white uppercase tracking-widest flex items-center gap-2">${selectedRoom.name || 'Private Signal'} <i data-lucide="chevron-down" class="w-3 h-3 text-neutral-500"></i></h4>
                                <p class="text-[9px] text-neutral-500 font-mono italic uppercase">${selectedRoom.members.length} Personnel Linked</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="chat-mute-btn" onclick="toggleRoomMute('${selectedRoom.id}')" class="p-2 text-neutral-600 hover:text-amber-500 transition-all" title="${isMuted ? "Unmute" : "Mute"}">
                                ${isMuted ? `<i data-lucide="bell-off" class="w-5 h-5 text-red-500"></i>` : `<i data-lucide="bell" class="w-5 h-5"></i>`}
                            </button>
                            <button onclick="handleLeaveRoom('${selectedRoom.id}')" class="p-2 text-neutral-600 hover:text-red-500 transition-all" title="Leave Signal"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                            <button onclick="state.selectedRoomId = null; renderMail();" class="p-2 text-neutral-600 hover:text-white transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="chat-messages-container" class="flex-1 overflow-y-auto p-8 flex flex-col">${fullHTML}</div>
                    <div class="p-6 border-t border-white/5 bg-black/40">
                        <div class="flex gap-4 items-end">
                            <textarea id="chat-input" rows="1" placeholder="Transmit signal..." class="flex-1 bg-neutral-900 border border-white/10 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white transition-all resize-none custom-scrollbar" style="min-height: 56px; max-height: 120px;" oninput="autoResize(this)" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleSendChat(); }"></textarea>
                            <button onclick="handleSendChat()" class="bg-amber-600 hover:bg-amber-700 text-white p-4 rounded-2xl shadow-xl active:scale-90 h-[56px] w-[56px] flex items-center justify-center shrink-0"><i data-lucide="send" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </div>
            `;
            const container = document.getElementById('chat-messages-container');
            if (container) container.scrollTop = container.scrollHeight;
        }
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// 전역 변수: 현재 모달에서 선택된 멤버들의 ID 집합
// 전역 변수: 선택된 멤버 ID 저장
// 전역 변수: 선택된 멤버 ID 저장
window.selectedMemberSet = new Set();

// 1. 모달 열기 (초기화 및 유저 목록 생성)
window.showCreateGroupModal = () => {
    window.selectedMemberSet.clear(); // 선택 초기화
    
    // 선택된 태그 화면 비우기
    const tagContainer = document.getElementById('selected-member-tags');
    if(tagContainer) tagContainer.innerHTML = '';
    
    // 검색창 초기화
    const searchInput = document.getElementById('member-search-input');
    if(searchInput) searchInput.value = '';

    // [핵심] 유저 목록 생성하기 (이 부분이 빠져있어서 목록이 안 떴던 것입니다!)
    const listContainer = document.getElementById('member-select-list');
    if (listContainer) {
        // 나 자신을 제외한 승인된 유저들만 필터링
        const users = state.accounts.filter(a => a.loginId !== state.userAccount.loginId && a.status === 'approved');
        
        if (users.length === 0) {
            listContainer.innerHTML = '<p class="text-neutral-500 text-xs p-4 text-center">No other personnel available.</p>';
        } else {
            listContainer.innerHTML = users.map(u => `
                <div class="member-item flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 hover:border-amber-500/50 cursor-pointer group transition-all" onclick="toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-black overflow-hidden border border-white/10">
                            <img src="${u.profile}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <p class="member-name-text text-xs font-bold text-white group-hover:text-amber-500 transition-colors">${u.ocName}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${u.loginId}</p>
                        </div>
                    </div>
                    <div class="relative w-5 h-5 rounded-full border border-white/20 flex items-center justify-center">
                        <input type="checkbox" id="cb-${u.loginId}" class="member-checkbox appearance-none absolute inset-0 cursor-pointer" onclick="event.stopPropagation(); toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                        <div class="check-icon opacity-0 w-3 h-3 bg-amber-500 rounded-full transition-opacity"></div>
                    </div>
                </div>
            `).join('');
        }
    }

    // 모달 표시
    document.getElementById('group-modal').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 2. 멤버 선택 토글 (체크박스 및 태그 연동)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // 이미 선택됨 -> 해제
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-100');
            checkIcon.classList.add('opacity-0');
        }
    } else {
        // 미선택 -> 선택
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-0');
            checkIcon.classList.add('opacity-100');
        }
    }
    renderSelectedTags();
};

// 3. 선택된 멤버 태그 그리기
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. 검색 필터링
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. 그룹 생성 완료 (DB 전송)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // 멤버 목록: 나 + 선택된 사람들
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};

// 2. 멤버 선택 토글 (체크박스 및 태그 연동)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // 이미 선택됨 -> 해제
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) checkIcon.classList.remove('opacity-100');
        if(checkIcon) checkIcon.classList.add('opacity-0');
    } else {
        // 미선택 -> 선택
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) checkIcon.classList.remove('opacity-0');
        if(checkIcon) checkIcon.classList.add('opacity-100');
    }
    renderSelectedTags();
};

// 3. 선택된 멤버 태그 그리기
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. 검색 필터링
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. 그룹 생성 완료 (DB 전송)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // 멤버 목록: 나 + 선택된 사람들
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};
        // [수정] 채팅방 입장 함수
window.enterRoom = async (roomId) => {
    // 1. 상태 변경 (화면 먼저 전환)
    state.selectedRoomId = roomId;
    renderMail();

    // 2. [핵심] 서버에 "나 이 방 읽었음" 보고 (DB 업데이트)
    try {
        if (state.userAccount) {
            const myId = state.userAccount.loginId;
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
            
            // lastRead 맵에 내 아이디 키로 현재 서버 시간 저장
            await updateDoc(roomRef, {
                [`lastRead.${myId}`]: serverTimestamp()
            });
        }
    } catch (e) {
        console.error("Failed to mark room as read:", e);
    }
};
window.selectedMemberSet = new Set();

// 1. 모달 열기 (이때 유저 목록을 만들어 넣습니다)
window.showCreateGroupModal = () => {
    window.selectedMemberSet.clear(); // 선택 초기화
    
    // 선택된 태그 화면 비우기
    const tagContainer = document.getElementById('selected-member-tags');
    if(tagContainer) tagContainer.innerHTML = '';
    
    // 검색창 초기화
    const searchInput = document.getElementById('member-search-input');
    if(searchInput) searchInput.value = '';

    // [핵심] 유저 목록 생성하기
    const listContainer = document.getElementById('member-select-list');
    if (listContainer) {
        // 나 자신을 제외한 승인된 유저들만 필터링
        const users = state.accounts.filter(a => a.loginId !== state.userAccount.loginId && a.status === 'approved');
        
        if (users.length === 0) {
            listContainer.innerHTML = '<p class="text-neutral-500 text-xs p-4 text-center">No other personnel available.</p>';
        } else {
            listContainer.innerHTML = users.map(u => `
                <div class="member-item flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 hover:border-amber-500/50 cursor-pointer group transition-all" onclick="toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-black overflow-hidden border border-white/10">
                            <img src="${u.profile}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <p class="member-name-text text-xs font-bold text-white group-hover:text-amber-500 transition-colors">${u.ocName}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${u.loginId}</p>
                        </div>
                    </div>
                    <div class="relative w-5 h-5 rounded-full border border-white/20 flex items-center justify-center">
                        <input type="checkbox" id="cb-${u.loginId}" class="member-checkbox appearance-none absolute inset-0 cursor-pointer" onclick="event.stopPropagation(); toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                        <div class="check-icon opacity-0 w-3 h-3 bg-amber-500 rounded-full transition-opacity"></div>
                    </div>
                </div>
            `).join('');
        }
    }

    // 모달 표시 (표준 문법 사용)
    document.getElementById('group-modal').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 2. 멤버 선택 토글 (클릭하면 체크/해제)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // 이미 선택됨 -> 해제
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-100');
            checkIcon.classList.add('opacity-0');
        }
    } else {
        // 미선택 -> 선택
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-0');
            checkIcon.classList.add('opacity-100');
        }
    }
    renderSelectedTags();
};

// 3. 선택된 멤버 태그 그리기 (상단에 이름 표시)
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. 검색 필터링 (이름으로 찾기)
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. [중요] 그룹 생성 버튼 클릭 시 (이것도 같이 덮어씌워야 작동합니다)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // 멤버 목록: 나 + 선택된 사람들
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};

        window.handleSendChat = async () => {
    const input = $('chat-input');
    const body = input.value.trim();
    if (!body || !state.selectedRoomId) return;
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
            roomId: state.selectedRoomId,
            fromId: state.userAccount.loginId,
            fromName: state.userAccount.ocName,
            body: body,
            timestamp: serverTimestamp()
        });
        
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', state.selectedRoomId);
        const lastReadUpdate = {
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: body
        };
        lastReadUpdate[`lastRead.${state.userAccount.loginId}`] = serverTimestamp();
        await updateDoc(roomRef, lastReadUpdate);
        
        input.value = '';
        input.style.height = '56px'; // [추가됨] 전송 후 높이 초기화
        input.focus(); // [추가됨] 전송 후 포커스 유지
        
    } catch(e) { console.error(e); }
};
        window.handleLeaveRoom = async (roomId) => {
    if (!confirm("정말 이 채팅방(Signal) 연결을 끊으시겠습니까?")) return;

    try {
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
        const currentRoom = state.chatRooms.find(r => r.id === roomId);
        
        if (!currentRoom) return;

        // [추가된 부분] 퇴장 시스템 메시지 전송
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
            roomId: roomId,
            fromId: 'system', // 식별자를 'system'으로 설정
            fromName: 'System',
            body: `${state.userAccount.ocName} 님이 연결을 종료했습니다.`, // 메시지 내용
            timestamp: serverTimestamp()
        });

        // 현재 내 ID를 멤버 목록에서 제외
        const newMembers = currentRoom.members.filter(id => id !== state.userAccount.loginId);

        if (newMembers.length === 0) {
             await updateDoc(roomRef, { members: newMembers });
        } else {
            await updateDoc(roomRef, { members: newMembers });
        }

        state.selectedRoomId = null;
        renderMail();
        showToast("Signal Disconnected.");
        
    } catch (e) {
        console.error("Error leaving room:", e);
        showToast("Error: Cannot disconnect.");
    }
};

        function renderMembers() {
    const approved = state.accounts.filter(a => a.status === 'approved');
    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-neutral-950 p-8 lg:p-20 overflow-y-auto">
            
            <div class="mb-12 border-b border-white/5 pb-6">
                <h2 class="text-6xl font-serif font-black text-white tracking-tighter uppercase leading-none">Authorized Gallery</h2>
                <p class="text-[11px] text-neutral-500 font-bold mt-3 ml-1 tracking-[0.1em] uppercase">커뮤니티 멤버목록</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8">
                ${approved.map(m => `
                    <div onclick="visitProfile('${m.loginId}')" class="cursor-pointer group relative aspect-[2/3] bg-neutral-900 border border-white/5 rounded-3xl overflow-hidden hover:border-amber-500 transition-all hover:-translate-y-3 shadow-2xl">
                        <img src="${m.profile}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-all duration-1000 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-neutral-950 via-transparent"></div>
                        <div class="absolute bottom-0 inset-x-0 p-8 text-center">
                            <p class="text-lg font-black text-white uppercase tracking-widest truncate drop-shadow-md">${m.ocName}</p>
                            <p class="text-[10px] text-amber-500/60 font-mono mt-1 uppercase">ID: ${m.loginId}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

        function renderProfile() {
    const oc = state.userAccount || {};
    $('content-area').innerHTML = `
        <div class="max-w-2xl mx-auto py-24 px-10 w-full animate-slide-up pb-40">
            <h2 class="text-4xl font-serif font-black mb-12 tracking-tighter uppercase leading-none text-white">Personnel Dossier</h2>
            <div class="bg-neutral-900 border border-white/5 rounded-[3rem] p-10 space-y-10 shadow-2xl backdrop-blur-xl">
                
                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Basic Info</h3>
                    
                    <div><label class="text-[10px] font-bold text-amber-500 uppercase block mb-2 ml-1">Top Badge Text</label><input id="edit-badge" value="${oc.badgeText || ''}" placeholder="Dossier: Authorized" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-amber-500 font-black tracking-widest uppercase"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Personnel Name</label><input id="edit-name" value="${oc.ocName || ''}" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-bold"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Visual Resource (URL)</label><input id="edit-profile" value="${oc.profile || ''}" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Slogan (Big Title)</label><input id="edit-slogan" value="${oc.slogan || ''}" class="w-full bg-black border border-amber-600/30 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-black italic"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Short Description (Subtitle)</label><input id="edit-shortDesc" value="${oc.shortDesc || ''}" placeholder="시간의 소용돌이 속에서..." class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white"></div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Left Ticket Button</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Ticket Name</label><input id="edit-linkText" value="${oc.linkText || ''}" placeholder="ENTER" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-black"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Ticket URL</label><input id="edit-linkUrl" value="${oc.linkUrl || ''}" placeholder="https://..." class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-amber-500"></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Personality Keywords</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 1</label><input id="edit-kw1" value="${oc.keyword1 || ''}" placeholder="Basiom" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-500 font-serif italic text-center"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 2</label><input id="edit-kw2" value="${oc.keyword2 || ''}" placeholder="Barbarus" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-400 font-serif italic text-center"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 3</label><input id="edit-kw3" value="${oc.keyword3 || ''}" placeholder="Beatrice" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-300 font-serif italic text-center"></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Background Description</h3>
                    <div>
                        <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Personnel Notes</label>
                        <textarea id="edit-stats" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-5 text-sm outline-none focus:border-amber-500 h-40 resize-none text-neutral-300 leading-relaxed custom-scrollbar">${oc.stats || ''}</textarea>
                    </div>
                </div>

                <div class="pt-6">
                    <button onclick="handleUpdateProfile()" class="w-full py-6 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all">Authorize Update</button>
                </div>
            </div>
        </div>
    `;
}
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const list = document.getElementById('member-select-list');
    const items = list.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden'); // 검색어 포함되면 보임
            } else {
                items[i].classList.add('hidden');    // 포함 안되면 숨김
            }
        }
    }
};
        window.handleUpdateProfile = async () => {
    const data = { 
        ocName: $('edit-name').value, 
        profile: $('edit-profile').value, 
        slogan: $('edit-slogan').value,
        shortDesc: $('edit-shortDesc').value,
        stats: $('edit-stats').value, 
        badgeText: $('edit-badge').value,
        // 티켓 링크 (개인)
        linkText: $('edit-linkText').value,
        linkUrl: $('edit-linkUrl').value,
        // 키워드
        keyword1: $('edit-kw1').value,
        keyword2: $('edit-kw2').value,
        keyword3: $('edit-kw3').value
    };
    
    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', state.userAccount.loginId), data, { merge: true });
        Object.assign(state.userAccount, data);
        showToast("Record Synchronized.");
    } catch(e) { console.error(e); }
};
        function renderAdmin() {
    // 1. 관리자 권한 확인
    if (!state.isAdmin) {
        $('content-area').innerHTML = `
            <div class="flex-1 flex items-center justify-center p-6 h-full">
                <div class="max-w-md w-full bg-neutral-900 border border-amber-600/20 p-12 rounded-[3.5rem] space-y-10 animate-fade-in shadow-2xl">
                    <div class="text-center space-y-4 mb-10"><i data-lucide="shield" class="w-16 h-16 text-amber-500 mx-auto mb-4 drop-shadow-[0_0_15px_rgba(217,119,6,0.5)]"></i><h3 class="text-2xl font-black text-white uppercase tracking-widest">Administrator</h3></div>
                    <input id="admin-pw-input" type="password" placeholder="••••••••" class="w-full bg-black border border-white/10 rounded-2xl px-6 py-5 text-center text-xl tracking-[1em] outline-none focus:border-amber-500 text-white transition-all">
                    <button onclick="handleAdminAuth()" class="w-full py-6 bg-amber-600 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all">Authorize Over-ride</button>
                </div>
            </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
        return;
    }

    const pendings = state.accounts.filter(a => a.status === 'pending');
    const approveds = state.accounts.filter(a => a.status === 'approved');
    const w = state.world || {};
    
    // 2. 관리자 화면 렌더링
    $('content-area').innerHTML = `
        <div class="max-w-6xl mx-auto py-20 px-10 w-full space-y-24 pb-60 animate-fade-in">
            <div class="flex justify-between items-end border-b border-amber-900/30 pb-12">
                <h2 class="text-5xl font-black text-amber-500 uppercase tracking-tighter">Command Center</h2>
                <button onclick="state.isAdmin = false; renderView('admin');" class="px-6 py-3 bg-neutral-900 border border-white/10 rounded-xl text-[10px] text-neutral-500 hover:text-white uppercase font-bold">Logout Session</button>
            </div>
<div class="space-y-1">
    <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase">Login Background URL</label>
    <input id="sys-login-bg" type="text" value="${w.login_bg || ''}" 
           class="w-full bg-neutral-900 border border-neutral-800 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-amber-600 transition-colors" 
           placeholder="https://...">
    <p class="text-[9px] text-neutral-600 mt-1">로그인 화면에 블러 처리되어 나타날 배경 이미지입니다.</p>
</div>
            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">System Interface Control</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 01</p>
                        <input id="sys-btn1-text" value="${w.banner1_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn1-url" value="${w.banner1_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn1-img" value="${w.banner1_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 02</p>
                        <input id="sys-btn2-text" value="${w.banner2_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn2-url" value="${w.banner2_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn2-img" value="${w.banner2_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 03</p>
                        <input id="sys-btn3-text" value="${w.banner3_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn3-url" value="${w.banner3_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn3-img" value="${w.banner3_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                </div>
                <button onclick="handleSystemUpdate()" class="w-full py-4 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl transition-all">Update System Interface</button>
            </section>

            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-red-500 border-l-8 border-red-600 pl-6 tracking-[0.5em]">User Reports (Incoming)</h3>
                <div class="bg-neutral-900 border border-red-900/30 rounded-[2rem] p-8 min-h-[150px]" id="admin-reports-list">
                    <p class="text-neutral-500 text-xs italic text-center py-10">Accessing secure logs...</p>
                </div>
            </section>
            
            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">Recruitment Queue</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    ${pendings.map(a => `
                        <div class="p-8 bg-neutral-900 border border-white/5 rounded-[3rem] flex flex-col gap-8 shadow-2xl">
                            <div class="flex items-center gap-6"><div class="w-16 h-16 rounded-[1.5rem] bg-black overflow-hidden shadow-inner"><img src="${a.profile}" class="w-full h-full object-cover"></div><div class="flex-1 overflow-hidden"><p class="text-2xl font-black text-white uppercase truncate">${a.ocName}</p><p class="text-[10px] text-neutral-500 font-mono mt-1">ID: ${a.loginId}</p></div></div>
                            <div class="grid grid-cols-2 gap-4"><button onclick="approveUser('${a.loginId}')" class="py-4 bg-green-600 text-white text-[11px] font-black rounded-2xl uppercase tracking-widest shadow-lg shadow-green-900/20 active:scale-95 transition-all">Authorize</button><button onclick="rejectUser('${a.loginId}')" class="py-4 bg-neutral-800 text-neutral-400 text-[11px] font-black rounded-2xl uppercase active:scale-95 transition-all">Decline</button></div>
                        </div>`).join('')}
                    ${pendings.length === 0 ? '<p class="text-neutral-700 italic font-mono uppercase tracking-widest text-sm text-center col-span-full py-10">All signals clear.</p>' : ''}
                </div>
            </section>

            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">Personnel Files (Edit)</h3>
                <div class="grid grid-cols-1 gap-4">
                    ${approveds.map(a => `
                        <div class="p-6 bg-neutral-900/50 border border-white/5 rounded-3xl flex items-center justify-between group hover:border-amber-500/30 transition-all">
                            <div class="flex items-center gap-6">
                                <div class="w-14 h-14 rounded-2xl bg-black overflow-hidden"><img src="${a.profile}" class="w-full h-full object-cover"></div>
                                <div>
                                    <p class="text-lg font-black text-white uppercase">${a.ocName}</p>
                                    <p class="text-[10px] text-neutral-600 font-mono italic uppercase">ERA ID: ${a.loginId}</p>
                                </div>
                            </div>
                            <button onclick="showAdminEditModal('${a.loginId}')" class="px-6 py-3 bg-neutral-800 hover:bg-amber-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">Over-ride Record</button>
                        </div>
                    `).join('')}
                </div>
            </section>
        </div>

        <div id="admin-edit-modal" class="hidden fixed inset-0 z-[120] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div id="admin-edit-container" class="w-full max-w-2xl bg-neutral-900 border border-amber-600/30 rounded-[4rem] p-12 shadow-2xl modal-enter"></div>
        </div>
        <div id="admin-reply-modal" class="hidden fixed inset-0 z-[130] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div class="w-full max-w-md bg-neutral-900 border border-amber-600/30 rounded-[3rem] p-10 shadow-2xl modal-enter">
                <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-4 text-center">Confirm & Reply</h3>
                <p class="text-xs text-neutral-500 text-center mb-6">This action will resolve the report and notify the user.</p>
                
                <textarea id="admin-reply-memo" class="w-full h-32 bg-black border border-white/10 rounded-2xl p-4 text-sm text-white resize-none outline-none focus:border-amber-500 mb-6" placeholder="Leave a message for the user..."></textarea>
                
                <div class="flex gap-4">
                    <button onclick="$('admin-reply-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button onclick="submitAdminResolution()" class="flex-1 py-4 bg-amber-600 text-white font-bold rounded-xl uppercase text-xs hover:bg-amber-700 shadow-lg">Confirm</button>
                </div>
            </div>
        </div>
        <section class="space-y-12 mt-20">
    <h3 class="text-xs font-black uppercase text-amber-500 border-l-8 border-amber-600 pl-6 tracking-[0.5em]">User Investigation Registry</h3>
    <div class="bg-neutral-900 border border-white/5 rounded-[2.5rem] overflow-hidden shadow-2xl">
        <table class="w-full text-left">
            <thead>
                <tr class="bg-white/5 border-b border-white/10 text-neutral-500 text-[9px] uppercase font-black tracking-widest">
                    <th class="p-6">Investigator</th>
                    <th class="p-6">Progress</th>
                    <th class="p-6 text-center">Clues</th>
                </tr>
            </thead>
            <tbody id="admin-user-investigation-list">
                <tr><td colspan="3" class="p-10 text-center text-neutral-600 italic">Syncing records...</td></tr>
            </tbody>
        </table>
    </div>
</section>
    `;
    
    // 만약 이미 데이터가 로드되어 있다면 즉시 UI 업데이트
    if (state.reports) window.updateAdminReportsUI();
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// [추가] 관리자 페이지에 신고 목록 그리기
window.updateAdminReportsUI = () => {
    const container = document.getElementById('admin-reports-list');
    if (!container) return;
    
    if (!state.reports || state.reports.length === 0) {
        container.innerHTML = '<p class="text-neutral-500 text-xs italic text-center py-10">No active reports.</p>';
        return;
    }
    
    container.innerHTML = state.reports
        .sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0))
        .map(r => `
            <div class="border-b border-white/5 pb-4 mb-4 last:border-0 last:mb-0 relative group">
                <div class="flex justify-between items-start mb-2 pr-16">
                    <span class="text-red-500 font-bold text-xs uppercase tracking-wider">TARGET ID: ${r.targetId}</span>
                    <span class="text-neutral-600 text-[10px] font-mono">${r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleString() : ''}</span>
                </div>
                <div class="text-white text-sm bg-black/50 p-4 rounded-xl mb-2 border border-white/5">
                    ${r.reason}
                </div>
                <p class="text-[10px] text-neutral-500 uppercase">
                    Reported by: <span class="text-amber-500 font-bold">${r.reporterName}</span> (${r.reporterId})
                </p>

                <div class="absolute bottom-4 right-0 flex gap-2">
                    <button onclick="openAdminReplyModal('${r.id}', '${r.reporterId}')" class="w-8 h-8 rounded-full bg-amber-600/20 text-amber-500 flex items-center justify-center hover:bg-amber-600 hover:text-white transition-all shadow-lg border border-amber-600/30" title="Confirm & Notify">
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteReport('${r.id}')" class="w-8 h-8 rounded-full bg-red-900/20 text-red-700 flex items-center justify-center hover:bg-red-600 hover:text-white transition-all border border-red-900/30" title="Ignore & Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `).join('');
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
// [추가됨] 채팅방 아이콘 생성 함수 (최대 4명 프사 표시)
function getRoomIconHTML(room) {
    const myId = state.userAccount.loginId;
    
    // 나를 제외한 멤버 ID 목록 추출
    let targets = room.members.filter(id => id !== myId);
    
    // 만약 나 혼자 있는 방이면(또는 대화상대가 없으면) 내 프사 표시
    if (targets.length === 0) targets = [myId];

    // 최대 4명까지만 선택
    const displayIds = targets.slice(0, 4);

    // ID에 해당하는 프로필 이미지 URL 찾기
    const images = displayIds.map(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        return acc ? acc.profile : null;
    }).filter(img => img); // 이미지가 유효한 것만 남김

    // Case 1: 이미지가 하나도 없으면 기본 아이콘
    if (images.length === 0) {
        return `<div class="w-full h-full flex items-center justify-center bg-black"><i data-lucide="${room.type === 'group' ? 'users' : 'user'}" class="w-5 h-5 opacity-40"></i></div>`;
    }

    // Case 2: 1명일 때 (꽉 찬 이미지)
    if (images.length === 1) {
        return `<img src="${images[0]}" class="w-full h-full object-cover">`;
    }

    // Case 3: 2~4명일 때 (2x2 그리드)
    // 3명일 때는 마지막 칸이 빈칸으로 나옵니다.
    return `
        <div class="grid grid-cols-2 w-full h-full bg-neutral-800">
            ${images.map(img => `<img src="${img}" class="w-full h-full object-cover">`).join('')}
        </div>
    `;
}
        // [수정] 수정 모달 띄우기 (등급 선택 추가)
window.showAdminEditModal = (loginId) => {
    const acc = state.accounts.find(a => a.loginId === loginId);
    if (!acc) return;
    
    const modal = document.getElementById('admin-edit-modal');
    modal.classList.remove('hidden');
    
    const container = document.getElementById('admin-edit-container');
    const currentRole = acc.role || 'runner';

    container.innerHTML = `
        <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-6">
            <div>
                <h3 class="text-3xl font-serif font-black text-white uppercase tracking-tighter">Over-ride Record</h3>
                <p class="text-[10px] text-amber-500 font-mono mt-1">Target ID: ${acc.loginId}</p>
            </div>
            <button onclick="document.getElementById('admin-edit-modal').classList.add('hidden')" class="text-neutral-500 hover:text-white transition-colors">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>

        <div class="space-y-8 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
            
            <div class="bg-amber-900/10 border border-amber-500/30 p-6 rounded-2xl">
                <h4 class="text-xs font-black text-amber-500 uppercase tracking-widest mb-4">Security Clearance (Role)</h4>
                <div class="relative">
                    <select id="admin-role" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white font-bold uppercase outline-none focus:border-amber-500 appearance-none">
                        <option value="runner" ${currentRole === 'runner' ? 'selected' : ''}>RUNNER (Standard User)</option>
                        <option value="staff" ${currentRole === 'staff' ? 'selected' : ''}>STAFF (Administrator)</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 pointer-events-none"></i>
                </div>
            </div>

            <div class="bg-neutral-900/50 border border-white/10 p-4 rounded-2xl flex items-center justify-between">
                <div>
                    <h4 class="text-[10px] font-black text-neutral-500 uppercase tracking-widest mb-1">Account Security</h4>
                    <p class="text-xs text-neutral-400 font-mono">${acc.email || 'No Email Registered'}</p>
                </div>
                <button onclick="handleSendPasswordReset('${acc.email}')" class="flex items-center gap-2 px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 rounded-xl border border-white/5 transition-colors text-xs font-bold uppercase">
                    <i data-lucide="key" class="w-4 h-4"></i> Reset PW
                </button>
            </div>

            <div class="space-y-4">
    <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Basic Info</h4>
    
    <div>
        <label class="text-[10px] font-bold text-amber-500 uppercase block mb-1">Email Address</label>
        <input id="admin-email" value="${acc.email || ''}" 
               class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white outline-none focus:border-amber-500"
               placeholder="personnel@example.com">
    </div>

    <div>
        <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Badge</label>
        <input id="admin-badge" value="${acc.badgeText || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-amber-500 font-bold">
    </div>
    
    <div>
        <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Name</label>
        <input id="admin-ocname" value="${acc.ocName || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white font-bold">
    </div>

    <div>
        <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Visual Resource (Image URL)</label>
        <input id="admin-profile" value="${acc.profile || ''}" 
               class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400 outline-none focus:border-amber-500"
               placeholder="https://...">
    </div>
</div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Texts</h4>
                <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Slogan</label>
                <input id="admin-slogan" value="${acc.slogan || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white italic"></div>
                <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Short Desc</label>
                <input id="admin-shortDesc" value="${acc.shortDesc || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white"></div>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Link Button</h4>
                <div class="grid grid-cols-2 gap-4">
                    <input id="admin-linkText" value="${acc.linkText || ''}" placeholder="Name" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                    <input id="admin-linkUrl" value="${acc.linkUrl || ''}" placeholder="URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-amber-500">
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Keywords</h4>
                <div class="grid grid-cols-3 gap-4">
                    <input id="admin-kw1" value="${acc.keyword1 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-500">
                    <input id="admin-kw2" value="${acc.keyword2 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-400">
                    <input id="admin-kw3" value="${acc.keyword3 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-300">
                </div>
            </div>

            <div>
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3 mb-4">Details</h4>
                <textarea id="admin-stats" class="w-full bg-black border border-white/10 rounded-xl px-6 py-4 text-xs text-white h-32 resize-none custom-scrollbar leading-relaxed">${acc.stats || ''}</textarea>
            </div>
        </div>
        
        <div class="mt-8 space-y-3">
            <button onclick="handleAdminUpdate('${acc.loginId}')" class="w-full py-5 bg-amber-600 text-white font-black rounded-2xl uppercase tracking-[0.2em] text-xs shadow-2xl active:scale-95 transition-all hover:bg-amber-700">Confirm Over-ride</button>
            
            <button onclick="deleteUserAccount('${acc.loginId}')" class="w-full py-4 bg-red-900/20 border border-red-500/30 text-red-500 font-bold rounded-2xl uppercase tracking-[0.2em] text-[10px] hover:bg-red-900/80 hover:text-white transition-all flex items-center justify-center gap-2">
                <i data-lucide="skull" class="w-4 h-4"></i> Terminate Account
            </button>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.changeMapImage = async (sectorIdx) => {
    if (!state.isAdmin) return;
    
    const sector = state.investigation.sectors[sectorIdx];
    const newUrl = prompt("새로운 맵 이미지 URL을 입력하세요:", sector.map);
    
    if (newUrl && newUrl.trim() !== "") {
        // 로컬 상태 반영
        state.investigation.sectors[sectorIdx].map = newUrl;
        
        // 중요: 서버 저장 시 investigation 전체 객체를 넘겨야 합니다.
        await window.handleSystemUpdate(); 
        renderInvestigation(); // 화면 갱신
        showToast(`${sector.name} 지도가 업데이트되었습니다.`);
    }
};

// 2. 포인트 수정 함수 (globalIdx 사용)
window.editPOI = async (globalIdx) => {
    if (!state.isAdmin) return;
    
    const p = state.investigation.points[globalIdx];
    const newTitle = prompt("수정할 지점 이름:", p.title);
    if (!newTitle) return;
    
    const newClue = prompt("수정할 단서 내용:", p.clue);
    if (!newClue) return;

    state.investigation.points[globalIdx].title = newTitle;
    state.investigation.points[globalIdx].clue = newClue;
    
    if (window.handleSystemUpdate) {
        await window.handleSystemUpdate();
        showToast("Point updated & saved.");
    }
    renderInvestigation();
};
window.handleMapClick = async (event) => {
    if (!state.isAdmin) return;
    
    // 클릭 타겟이 포인트 자체라면 중단
    if (event.target.closest('[onclick^="handleDiscovery"]')) return;

    const container = document.getElementById('map-container');
    const rect = container.getBoundingClientRect();

    const x = ((event.clientX - rect.left) / rect.width) * 100;
    const y = ((event.clientY - rect.top) / rect.height) * 100;

    const title = prompt("조사 지점 이름:", "New Signal");
    if (!title) return;

    const clue = prompt("발견될 단서 내용:");
    if (!clue) return;

    // 새로운 포인트 객체 생성
    const newPoint = {
        id: 'p' + Date.now(),
        sector: state.investigation.selectedSector, // [중요] 현재 접속 중인 섹터 ID를 반드시 저장
        x: parseFloat(x.toFixed(2)),
        y: parseFloat(y.toFixed(2)),
        title: title,
        clue: clue || "조사된 내용이 없습니다."
    };

    // 로컬 데이터에 추가
    state.investigation.points.push(newPoint);
    
    // 서버에 즉시 저장
    await window.handleSystemUpdate(); 

    // 화면 갱신 (점이 즉시 나타남)
    renderInvestigation(); 
    showToast("새로운 조사 지점이 서버에 기록되었습니다.");
};

// 2. 포인트 우클릭 시 삭제 (관리자 전용)
window.handlePointRightClick = (event, idx) => {
    if (!state.isAdmin) return;
    event.preventDefault();
    event.stopPropagation();

    if (confirm(`'${state.investigation.points[idx].title}' 지점을 삭제하시겠습니까?`)) {
        state.investigation.points.splice(idx, 1);
        
        if (window.handleSystemUpdate) {
            window.handleSystemUpdate();
        }
        
        renderInvestigation();
        showToast("지점이 삭제되었습니다.");
    }
};
window.loadUserInvestigationProgress = async () => {
    const listBody = document.getElementById('admin-user-investigation-list');
    if (!listBody) return;

    try {
        // 1. 모든 유저 계정 정보를 가져옵니다 (기존 accounts 배열 활용 가능)
        // 만약 최신 데이터를 서버에서 가져와야 한다면 아래 로직 사용
        const usersRef = collection(db, 'artifacts', appId, 'accounts');
        const q = query(usersRef, orderBy('name', 'asc'));
        const querySnapshot = await getDocs(q);
        
        let html = '';
        const totalPoints = state.investigation.points.length; // 전체 단서 개수

        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const foundClues = userData.investigation?.foundClueIds || []; // 유저 문서 내 저장된 조사 데이터
            const count = foundClues.length;
            const percentage = totalPoints > 0 ? Math.round((count / totalPoints) * 100) : 0;

            html += `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-neutral-800 border border-white/10 overflow-hidden flex-shrink-0">
                                ${userData.img ? `<img src="${userData.img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-neutral-600"><i data-lucide="user" class="w-4 h-4"></i></div>`}
                            </div>
                            <div>
                                <p class="text-sm font-black text-white">${userData.name || 'Unknown'}</p>
                                <p class="text-[9px] text-neutral-600 font-mono">${userData.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-6 w-64">
                        <div class="flex items-center gap-4">
                            <div class="flex-1 h-1.5 bg-neutral-800 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-600 shadow-[0_0_10px_rgba(217,119,6,0.5)]" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-[10px] font-black text-amber-500 w-10 text-right">${percentage}%</span>
                        </div>
                    </td>
                    <td class="p-6 text-center">
                        <span class="px-3 py-1 bg-neutral-800 border border-white/10 rounded-full text-[10px] font-mono text-neutral-300">
                            ${count} / ${totalPoints}
                        </span>
                    </td>
                </tr>
            `;
        });

        listBody.innerHTML = html || '<tr><td colspan="3" class="p-20 text-center text-neutral-600 italic">No users registered.</td></tr>';
        if (typeof lucide !== 'undefined') lucide.createIcons();

    } catch (e) {
        console.error("명단 로딩 실패:", e);
        listBody.innerHTML = '<tr><td colspan="3" class="p-20 text-center text-red-900/50 italic">Failed to load data.</td></tr>';
    }
};

// 관리자 페이지 진입 시 자동으로 데이터 로드하도록 renderAdmin 하단에 추가
// window.loadUserInvestigationProgress();
window.handleAdminUpdate = async (loginId) => {
    try {
        const getVal = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : "";
        };

        const data = { 
            role: getVal('admin-role'),
            email: getVal('admin-email'),
            badgeText: getVal('admin-badge'),
            ocName: getVal('admin-ocname'), 
            profile: getVal('admin-profile'), // 이 부분의 ID가 'admin-profile'이어야 합니다.
            slogan: getVal('admin-slogan'), 
            shortDesc: getVal('admin-shortDesc'),
            linkText: getVal('admin-linkText'),
            linkUrl: getVal('admin-linkUrl'),
            keyword1: getVal('admin-kw1'),
            keyword2: getVal('admin-kw2'),
            keyword3: getVal('admin-kw3'),
            stats: getVal('admin-stats') 
        };

        const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
        await setDoc(accountRef, data, { merge: true });

        document.getElementById('admin-edit-modal').classList.add('hidden');
        showToast("Record Synchronized.");
        
        const idx = state.accounts.findIndex(a => a.loginId === loginId);
        if (idx !== -1) state.accounts[idx] = { ...state.accounts[idx], ...data };

    } catch (e) {
        console.error("저장 중 에러 발생:", e);
        showToast("Update Failed.");
    }
};


window.returnToSectors = () => {
    if (!state.investigation) return;
    state.investigation.selectedSector = null; // 선택된 섹터 초기화
    renderInvestigation(); // 다시 그리면 selectedSector가 null이라 섹터 선택창이 뜹니다.
};

// 2. 관리자용 유저 조사 진척도 명단 로드 함수
window.loadUserInvestigationProgress = async () => {
    const listBody = document.getElementById('admin-user-investigation-list');
    if (!listBody) return;

    try {
        const usersRef = collection(db, 'artifacts', appId, 'accounts');
        const q = query(usersRef, orderBy('name', 'asc'));
        const querySnapshot = await getDocs(q);
        
        let html = '';
        const totalPoints = state.investigation.points.length;

        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const foundClues = userData.investigation?.foundClueIds || [];
            const count = foundClues.length;
            const percentage = totalPoints > 0 ? Math.round((count / totalPoints) * 100) : 0;

            html += `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-4 text-left">
                            <div class="w-10 h-10 rounded-full bg-neutral-800 border border-white/10 overflow-hidden">
                                ${userData.img ? `<img src="${userData.img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-neutral-600"><i data-lucide="user" class="w-4 h-4"></i></div>`}
                            </div>
                            <div>
                                <p class="text-sm font-black text-white">${userData.name || 'Unknown'}</p>
                                <p class="text-[9px] text-neutral-600 font-mono">${userData.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-6 w-64">
                        <div class="flex items-center gap-4">
                            <div class="flex-1 h-1.5 bg-neutral-800 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-600 shadow-[0_0_10px_rgba(217,119,6,0.5)]" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-[10px] font-black text-amber-500 w-10 text-right">${percentage}%</span>
                        </div>
                    </td>
                    <td class="p-6 text-center text-[10px] font-mono text-neutral-300">
                        ${count} / ${totalPoints}
                    </td>
                </tr>
            `;
        });

        listBody.innerHTML = html || '<tr><td colspan="3" class="p-20 text-center text-neutral-600">No data.</td></tr>';
        if (typeof lucide !== 'undefined') lucide.createIcons();

    } catch (e) {
        console.error("명단 로딩 실패:", e);
    }
};

// 3. handleDiscovery 수정 (발견 시 우측 리스트 자동 갱신 포함)
const originalDiscovery = window.handleDiscovery;
window.handleDiscovery = async (id) => {
    await originalDiscovery(id); // 기존 로직(저장, 팝업) 실행
    updateInvestigationSideList(); // 우측 리스트 새로고침
};
window.handleDiscovery = async (id) => {
    const point = state.investigation.points.find(p => p.id === id);
    if (!point) return;

    // 발견 목록 초기화 확인
    if (!state.investigation.foundClueIds) state.investigation.foundClueIds = [];
    
    // 처음 발견하는 경우만 저장 로직 실행
    if (!state.investigation.foundClueIds.includes(id)) {
        state.investigation.foundClueIds.push(id);
        
        try {
            // [핵심] world 문서의 investigation 필드만 부분 업데이트
            const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
            await updateDoc(worldRef, {
                "investigation.foundClueIds": state.investigation.foundClueIds
            });
            showToast("New Evidence Archived.");
        } catch (e) {
            console.error("Save Error:", e);
        }
    }

    window.playNotificationSound();

    // 팝업 표시 (요소가 있는지 재확인 후 텍스트 삽입)
    const panel = document.getElementById('discovery-panel');
    if (panel) {
        document.getElementById('discovery-title').innerText = `Signal: ${point.title}`;
        document.getElementById('discovery-clue').innerText = `"${point.clue}"`;
        panel.classList.remove('hidden');
        panel.classList.add('modal-enter');
    }
    
    renderInvestigation(); // UI 갱신 (반짝임 끄기 등)
};

// [수정] 관리자용 포인트 조작 시 전체 저장
window.saveInvestigationToDB = async () => {
    try {
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await updateDoc(worldRef, {
            "investigation.points": state.investigation.points,
            "investigation.currentMap": state.investigation.currentMap
        });
    } catch (e) {
        console.error("DB Sync Error:", e);
    }
};
window.toggleArchive = () => {
    const modal = document.getElementById('archive-modal');
    const list = document.getElementById('archive-list');
    if (!modal || !list) return;

    modal.classList.toggle('hidden');

    if (!modal.classList.contains('hidden')) {
        const inv = state.investigation;
        const foundClues = inv.points.filter(p => inv.foundClueIds.includes(p.id));

        if (foundClues.length === 0) {
            list.innerHTML = '<p class="text-center text-neutral-600 py-10 italic text-sm font-mono">NO SIGNALS ARCHIVED.</p>';
        } else {
            list.innerHTML = foundClues.map(c => {
                const isNew = !inv.viewedClueIds.includes(c.id);
                return `
                    <div onclick="showFullClue('${c.id}')" 
                         class="p-6 bg-black/40 border border-white/5 rounded-2xl mb-4 cursor-pointer hover:border-amber-500/40 transition-all group relative">
                        <div class="flex justify-between items-center mb-2 pointer-events-none">
                            <p class="text-amber-500 text-[10px] font-black uppercase tracking-[0.2em]">${c.title}</p>
                            ${isNew ? '<span class="bg-red-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded shadow-lg animate-pulse">NEW</span>' : ''}
                        </div>
                        <p class="text-xs text-neutral-400 line-clamp-1 group-hover:text-neutral-200 transition-colors pointer-events-none italic">"${c.clue}"</p>
                    </div>`;
            }).join('');
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
};

window.showFullClue = async (id) => {
    const inv = state.investigation;
    const clue = inv.points.find(p => p.id === id);
    if (!clue) return;

    // 읽음 처리 (NEW 제거)
    if (!inv.viewedClueIds.includes(id)) {
        inv.viewedClueIds.push(id);
        if (window.handleSystemUpdate) await window.handleSystemUpdate();
    }

    const panel = document.getElementById('discovery-panel');
    $('discovery-title').innerText = `Archive: ${clue.title}`;
    $('discovery-clue').innerText = `"${clue.clue}"`;
    panel.classList.remove('hidden');
    
    // 리스트 실시간 갱신 (모달 닫지 않고 그리기)
    window.toggleArchive(); window.toggleArchive(); 
};

// 단서 전문 보기 함수
window.showFullClue = async (id) => {
    const inv = state.investigation;
    const clue = inv.points.find(p => p.id === id);
    if (!clue) return;

    // 1. 읽음 처리 (NEW 제거)
    if (!inv.viewedClueIds) inv.viewedClueIds = [];
    if (!inv.viewedClueIds.includes(id)) {
        inv.viewedClueIds.push(id);
        // 서버 상태 저장
        if (window.handleSystemUpdate) await window.handleSystemUpdate();
    }

    // 2. 전문을 보여줄 팝업 (discovery-panel 재활용)
    const panel = document.getElementById('discovery-panel');
    const title = document.getElementById('discovery-title');
    const clueText = document.getElementById('discovery-clue');

    if (panel && title && clueText) {
        title.innerText = `Archive: ${clue.title}`;
        clueText.innerText = `"${clue.clue}"`;
        panel.classList.remove('hidden');
    }
    
    // 3. 아카이브 리스트 실시간 갱신 (NEW 배지 즉시 제거)
    // 모달을 닫지 않고 내용만 다시 그립니다.
    const list = document.getElementById('archive-list');
    if (list) {
        const foundIds = inv.foundClueIds || [];
        const viewedIds = inv.viewedClueIds || [];
        const foundClues = inv.points.filter(p => foundIds.includes(p.id));
        
        list.innerHTML = foundClues.map(c => {
            const isNew = !viewedIds.includes(c.id);
            return `
                <div onclick="showFullClue('${c.id}')" 
                     class="p-5 bg-black/40 border border-white/5 rounded-2xl mb-4 cursor-pointer hover:border-amber-500/50 transition-all group relative">
                    <div class="flex justify-between items-center mb-2 pointer-events-none">
                        <p class="text-amber-500 text-[10px] font-black uppercase tracking-widest">${c.title}</p>
                        ${isNew ? '<span class="new-badge">NEW</span>' : ''}
                    </div>
                    <p class="text-xs text-neutral-500 line-clamp-1 group-hover:text-neutral-300 transition-colors pointer-events-none">${c.clue}</p>
                </div>`;
        }).join('');
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
        // [추가] 시스템 배너(관리자 전용) 저장 함수
window.handleSystemUpdate = async () => {
    // 1. 데이터 모으기 (입력 필드가 없을 경우 기존 state 값을 사용하도록 방어 코드 추가)
    const updateData = {
        // 배너 및 배경 설정 (화면에 입력창이 있을 때만 가져오고, 없으면 현재 값을 유지)
        login_bg: document.getElementById('sys-login-bg')?.value || state.world.login_bg || "",
        
        banner1_text: document.getElementById('sys-btn1-text')?.value || state.world.banner1_text || "",
        banner1_url: document.getElementById('sys-btn1-url')?.value || state.world.banner1_url || "",
        banner1_img: document.getElementById('sys-btn1-img')?.value || state.world.banner1_img || "",
        
        banner2_text: document.getElementById('sys-btn2-text')?.value || state.world.banner2_text || "",
        banner2_url: document.getElementById('sys-btn2-url')?.value || state.world.banner2_url || "",
        banner2_img: document.getElementById('sys-btn2-img')?.value || state.world.banner2_img || "",
        
        banner3_text: document.getElementById('sys-btn3-text')?.value || state.world.banner3_text || "",
        banner3_url: document.getElementById('sys-btn3-url')?.value || state.world.banner3_url || "",
        banner3_img: document.getElementById('sys-btn3-img')?.value || state.world.banner3_img || "",

        // [중요] 조사 시스템 전체 데이터 포함
        investigation: state.investigation
    };
    
    try {
        // 2. Firebase 경로 설정
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        
        // 3. 서버에 데이터 전송 (data 대신 updateData로 변수명 일치)
        await setDoc(worldRef, updateData, { merge: true });
        
        // 로컬 데이터도 최신화
        state.world = { ...state.world, ...updateData };
        
        console.log("서버 저장 성공:", updateData);
        showToast("데이터가 서버에 동기화되었습니다.");
    } catch (e) {
        console.error("서버 저장 에러 상세:", e);
        showToast("저장에 실패했습니다. F12 콘솔을 확인하세요.");
    }
};

        window.handleAdminAuth = () => { if ($('admin-pw-input').value === ADMIN_PW) { state.isAdmin = true; renderView('admin'); } else showToast("Access Denied."); };
        window.approveUser = async (id) => { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { status: 'approved' }, { merge: true }); showToast("Authorized."); };
        window.rejectUser = async (id) => { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { status: 'rejected' }, { merge: true }); };

        function showAuthGate() {
    const gate = $('auth-view');
    const dynamicBg = $('auth-dynamic-bg');
    
    // 관리자가 설정한 전용 배경이 있으면 사용하고, 없으면 기본값(Banner 01 등)을 사용합니다.
    const bgUrl = state.world.login_bg || state.world.banner1_img || '';
    
    if (dynamicBg && bgUrl) {
        dynamicBg.style.backgroundImage = `url('${bgUrl}')`;
    }

    gate.classList.remove('hidden');
    
    if (state.authMode === 'login') {
        $('signup-extra').classList.add('hidden');
        $('auth-submit-btn').innerText = "Initialize Session";
        $('auth-toggle-btn').innerText = "Request New Identity";
    } else {
        $('signup-extra').classList.remove('hidden');
        $('auth-submit-btn').innerText = "Submit Application";
        $('auth-toggle-btn').innerText = "Already have an ID?";
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

        function setupAuthEvents() {
            $('auth-toggle-btn').onclick = () => { state.authMode = state.authMode === 'login' ? 'signup' : 'login'; showAuthGate(); };
            $('auth-submit-btn').onclick = async () => {
                const id = $('auth-id').value.trim();
                const pw = $('auth-pw').value.trim();
                if (!id || !pw) return showToast("Enter credentials.");
                if (state.authMode === 'signup') {
                    const ocName = $('auth-oc-name').value.trim();
                    if (!ocName) return showToast("Enter OC Name.");
                    const exists = state.accounts.find(a => a.loginId === id);
                    if (exists) return showToast("ID already exists.");
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), {
                            uid: state.user.uid, loginId: id, password: pw, ocName: ocName,
                            profile: "https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png",
                            slogan: "캐치프레이즈를 입력하세요", status: 'pending', level: 30, createdAt: serverTimestamp(),
                            stats: "이곳에 캐릭터의 설명을 적습니다."
                        });
                        showPendingGateUI();
                    } catch(e) { console.error(e); }
                } else {
                    const target = state.accounts.find(a => a.loginId === id && a.password === pw);
                    if (target) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { uid: state.user.uid }, { merge: true });
                        showToast("Link established.");
                    } else { showToast("Unauthorized signal."); }
                }
            };
        }

        function showPendingGateUI() {
            $('auth-view').classList.add('hidden');
            $('content-area').innerHTML = `<div class="flex-1 flex flex-col items-center justify-center text-center p-12 h-full"><i data-lucide="clock" class="w-20 h-20 text-amber-500/20 animate-spin-slow"></i><h2 class="text-4xl font-serif font-black text-white uppercase mt-12 tracking-widest leading-none">Wait for Authorization</h2><p class="text-sm text-neutral-500 mt-6 max-w-xs leading-relaxed italic">관리자의 승인이 완료될 때까지 신호가 차단되었습니다.</p><button onclick="handleLogout()" class="text-[10px] text-red-900 font-bold mt-16 uppercase underline decoration-red-950 tracking-widest">Disconnect Transmission</button></div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderSidebarUI() {
    const v = state.currentView;
    const isMobile = window.innerWidth < 768;
    
    // 모바일이면 하단, PC면 좌측
    const container = isMobile ? $('mobile-nav-bar') : $('sidebar-nav');
    if (!container) return;

    // [수정됨] 읽지 않은 채팅방이 있는지 계산 (메일박스용 레드닷)
    const myId = state.userAccount?.loginId;
    const hasUnreadChat = state.chatRooms.some(r => {
        // 내가 속한 방이고 + 마지막 메시지가 있고 + (안 읽었거나 || 읽은 시간이 메시지 시간보다 이전일 때)
        return r.members.includes(myId) && 
               r.lastMessageTimestamp && 
               (!r.lastRead || !r.lastRead[myId] || r.lastRead[myId].seconds < r.lastMessageTimestamp.seconds);
    });

    // 메뉴 아이템 정의
    // [수정됨] PC 버전일 때 'pl-8' (왼쪽 여백) 추가하여 벽에서 띄움
    const navHTML = `
        <div class="flex ${isMobile ? 'flex-row justify-around w-full' : 'flex-col gap-8 pl-8'}">
            
            <button onclick="switchView('home')" class="group flex items-center gap-4 transition-all ${v === 'home' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'home' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'home' ? 'text-white' : ''}">Dashboard</span>` : ''}
            </button>

            <button onclick="switchView('mail')" class="group flex items-center gap-4 transition-all ${v === 'mail' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="mail" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'mail' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                    
                    ${hasUnreadChat ? `<span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>` : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'mail' ? 'text-white' : ''}">Mailbox</span>` : ''}
            </button>

            <button onclick="switchView('operation')" class="group flex items-center gap-4 transition-all ${v === 'operation' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="crosshair" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'operation' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'operation' ? 'text-white' : ''}">Operation</span>` : ''}
            </button>

            <button onclick="switchView('members')" class="group flex items-center gap-4 transition-all ${v === 'members' || v === 'visit' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="users" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'members' || v === 'visit' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'members' || v === 'visit' ? 'text-white' : ''}">Gallery</span>` : ''}
            </button>

            <button onclick="switchView('profile')" class="group flex items-center gap-4 transition-all ${v === 'profile' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="eye" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'profile' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'profile' ? 'text-white' : ''}">Personnel</span>` : ''}
            </button>

            <button onclick="switchView('admin')" class="group flex items-center gap-4 transition-all ${v === 'admin' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="shield" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'admin' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'admin' ? 'text-white' : ''}">System</span>` : ''}
            </button>
        </div>
    `;

    container.innerHTML = navHTML;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

        function updateSidebarUI() {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            const active = $(`nav-${state.currentView}`);
            if (active) active.classList.add('active');
        }

        function updateProfileBarUI() {
            const acc = state.userAccount;
            if (!acc || acc.status === 'new') return;
            $('user-name-display').innerText = acc.ocName || 'Personnel';
            $('user-id-display').innerText = `ID: ${acc.loginId || 'Guest'}`;
            if (acc.profile) {
                $('user-avatar').src = acc.profile;
                $('user-avatar').classList.remove('hidden');
                $('user-avatar-placeholder').classList.add('hidden');
            }
        }
        window.autoResize = (textarea) => {
    textarea.style.height = 'auto'; // 높이 초기화
    textarea.style.height = textarea.scrollHeight + 'px'; // 내용만큼 늘림
};

        window.handleLogout = async () => { try { await signOut(auth); window.location.reload(); } catch(e) { console.error(e); } };

        function showToast(msg) {
            const t = $('toast');
            $('toast-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
        // [추가] 메시지 삭제 함수 (Soft Delete)
window.deleteMessage = async (msgId) => {
    if (!confirm("이 메시지를 삭제하시겠습니까?")) return;
    
    try {
        const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'messages', msgId);
        // 메시지를 실제로 지우지 않고, '삭제됨' 상태로만 변경
        await updateDoc(msgRef, {
            isDeleted: true
        });
    } catch(e) {
        console.error("Delete failed:", e);
        showToast("Error deleting message.");
    }
};
function renderVisitProfile() {
    const targetId = state.visitTargetId; // 방문할 대상 ID
    if (!targetId) return switchView('members');

    const targetUser = state.accounts.find(a => a.loginId === targetId);
    if (!targetUser) return switchView('members');

    $('content-area').innerHTML = `
        <div class="relative h-full w-full flex flex-col overflow-hidden bg-[#0a0a0a] animate-fade-in">
            
            <div class="absolute inset-0 z-0">
                <img src="${targetUser.profile}" class="w-full h-full object-cover opacity-80 blur-[10px] scale-110 grayscale brightness-50">
                <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0a] via-[#0a0a0a]/80 to-transparent"></div>
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMDUpIiAvPgo8L3N2Zz4=')] opacity-20"></div>
            </div>

            <div class="absolute inset-y-0 right-[2%] lg:right-[8%] w-[80%] lg:w-[55%] z-10 pointer-events-none flex items-end justify-end">
                <img src="${targetUser.profile}" class="h-[90%] w-full object-contain object-bottom drop-shadow-2xl opacity-100 mask-image-bottom">
            </div>

            <div class="relative z-20 h-full flex flex-col justify-center pl-12 lg:pl-24 max-w-[65%] pointer-events-none">
                <div class="mb-6 flex items-center gap-4 animate-slide-up" style="animation-delay: 0.1s;">
                    <div class="bg-amber-600/20 text-amber-500 px-4 py-1.5 border border-amber-500/30 rounded-full text-[10px] font-black tracking-[0.3em] uppercase backdrop-blur-md">
                        ${targetUser.badgeText || 'Level: ' + (targetUser.level || 'Unknown')}
                    </div>
                </div>

                <h1 class="font-serif font-black text-white tracking-tighter uppercase whitespace-nowrap leading-none mb-8 drop-shadow-xl animate-slide-up" 
                    style="font-size: clamp(3rem, 6vw, 8rem); animation-delay: 0.2s;">
                    ${targetUser.ocName}
                </h1>

                <div class="border-l-4 border-amber-600 pl-6 animate-slide-up" style="animation-delay: 0.3s;">
                    <h3 class="text-2xl lg:text-4xl font-serif font-bold text-white mb-4 leading-tight tracking-tight">
                        ${targetUser.slogan || 'No slogan registered.'}
                    </h3>
                    <p class="text-xs text-neutral-400 tracking-wide font-mono leading-relaxed max-w-md opacity-70">
                        ${targetUser.shortDesc || targetUser.stats || 'No detailed records found.'}
                    </p>
                </div>
                
                <div class="mt-10 pointer-events-auto w-fit animate-slide-up" style="animation-delay: 0.4s;">
                    ${targetUser.linkUrl ? `
                    <a href="${targetUser.linkUrl}" target="_blank" class="group cursor-pointer hover:scale-105 transition-transform block">
                        <div class="bg-amber-600/10 backdrop-blur-md border border-amber-500/30 p-1 rounded-lg">
                            <div class="bg-amber-600 w-32 h-12 rounded-md relative overflow-hidden flex flex-col items-center justify-center border border-amber-400/50 shadow-[0_0_20px_rgba(217,119,6,0.4)]">
                                <p class="text-[6px] text-black/60 font-black uppercase tracking-widest mb-0.5">External Link</p>
                                <h3 class="text-xs text-white font-serif font-black uppercase tracking-tighter italic drop-shadow-md flex items-center gap-1">
                                    ${targetUser.linkText || 'ENTER'} <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </h3>
                            </div>
                        </div>
                    </a>
                    ` : ''}
                </div>
            </div>

            <div class="absolute right-8 top-1/2 -translate-y-1/2 z-30 flex flex-col gap-6 pointer-events-auto">
                <button onclick="startOneOnOneChat('${targetUser.loginId}')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-white/10 flex items-center justify-center shadow-2xl group-hover:border-amber-500 group-hover:bg-amber-600/20 transition-all">
                        <i data-lucide="mail" class="w-6 h-6 text-white group-hover:text-amber-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-white bg-black/50 px-2 py-1 rounded">1:1 Message</span>
                </button>

                <button onclick="showToast('Gift System: Not Available Yet.')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-white/10 flex items-center justify-center shadow-2xl group-hover:border-amber-500 group-hover:bg-amber-600/20 transition-all">
                        <i data-lucide="gift" class="w-6 h-6 text-white group-hover:text-amber-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-white bg-black/50 px-2 py-1 rounded">Send Gift</span>
                </button>

                <button onclick="openReportModal('${targetUser.loginId}', '${targetUser.ocName}')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-red-900/30 flex items-center justify-center shadow-2xl group-hover:border-red-500 group-hover:bg-red-600/20 transition-all">
                        <i data-lucide="siren" class="w-6 h-6 text-red-700 group-hover:text-red-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-red-500 bg-black/50 px-2 py-1 rounded">Report User</span>
                </button>
            </div>

            <div class="absolute bottom-12 left-[30%] flex gap-12 opacity-60 pointer-events-none hidden lg:flex">
                <p class="text-[20px] text-amber-500 font-serif italic tracking-wider">${targetUser.keyword1 || ''}</p>
                <p class="text-[20px] text-amber-400 font-serif italic tracking-wider">${targetUser.keyword2 || ''}</p>
                <p class="text-[20px] text-amber-300 font-serif italic tracking-wider">${targetUser.keyword3 || ''}</p>
            </div>
            
            <button onclick="switchView('members')" class="absolute top-8 left-8 z-50 flex items-center gap-2 text-neutral-500 hover:text-white transition-colors pointer-events-auto">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                <span class="text-xs font-bold uppercase tracking-widest">Back to Gallery</span>
            </button>
        </div>

        <div id="report-modal" class="hidden fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-neutral-900 border border-red-900/30 rounded-[2.5rem] p-10 shadow-2xl modal-enter relative">
                
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="absolute top-8 right-8 text-neutral-600 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-2 text-red-500">Report User</h3>
                <p class="text-xs text-neutral-500 mb-6">Reporting: <span id="report-target-name" class="text-white font-bold"></span></p>
                
                <textarea id="report-reason" class="w-full h-32 bg-black border border-white/10 rounded-2xl p-4 text-sm text-white resize-none outline-none focus:border-red-500 mb-6 custom-scrollbar" placeholder="Please describe the reason..."></textarea>
                
                <div class="flex gap-4">
                    <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button onclick="submitReport()" class="flex-1 py-4 bg-red-700 text-white font-bold rounded-xl uppercase text-xs hover:bg-red-600 shadow-lg shadow-red-900/20">Submit Report</button>
                </div>
            </div>
        </div>
        
        <style>.mask-image-bottom { -webkit-mask-image: linear-gradient(to top, transparent 0%, black 20%); mask-image: linear-gradient(to top, transparent 0%, black 20%); }</style>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// [기능 1] 프로필 방문 (페이지 이동)
window.visitProfile = (targetId) => {
    if (targetId === state.userAccount.loginId) {
        return switchView('home'); // 나 자신이면 내 홈으로
    }
    state.visitTargetId = targetId;
    switchView('visit');
};

// [기능 2] 1:1 채팅방 연결 (없으면 생성, 있으면 이동)
window.startOneOnOneChat = async (targetId) => {
    const myId = state.userAccount.loginId;
    
    // 이미 존재하는 1:1 방 찾기
    const existingRoom = state.chatRooms.find(r => 
        r.type === 'private' && 
        r.members.includes(myId) && 
        r.members.includes(targetId)
    );

    if (existingRoom) {
        state.selectedRoomId = existingRoom.id;
        switchView('mail'); // 메일함으로 이동
    } else {
        // 새 방 생성
        const targetUser = state.accounts.find(a => a.loginId === targetId);
        const roomName = targetUser ? targetUser.ocName : targetId;
        
        try {
            const newRoomRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'));
            await setDoc(newRoomRef, {
                name: roomName, // 개인방이라 이름은 크게 중요치 않음
                members: [myId, targetId],
                type: 'private',
                createdAt: serverTimestamp(),
                lastMessageTimestamp: serverTimestamp(),
                lastMessageBody: "Signal Link Established.",
                lastRead: {}
            });
            state.selectedRoomId = newRoomRef.id;
            switchView('mail'); // 메일함으로 이동
        } catch(e) {
            console.error(e);
            showToast("Connection Failed.");
        }
    }
};

// [기능 3] 신고 모달 열기
let currentReportTargetId = null;
window.openReportModal = (targetId, targetName) => {
    currentReportTargetId = targetId;
    $('report-target-name').innerText = targetName;
    $('report-reason').value = '';
    $('report-modal').classList.remove('hidden');
};

// [기능 3-1] 신고 접수 (DB 저장)
window.submitReport = async () => {
    const reason = $('report-reason').value.trim();
    if (!reason) return showToast("Please enter a reason.");
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), {
            reporterId: state.userAccount.loginId,
            reporterName: state.userAccount.ocName,
            targetId: currentReportTargetId,
            reason: reason,
            timestamp: serverTimestamp(),
            status: 'pending' // 처리 대기중
        });
        $('report-modal').classList.add('hidden');
        showToast("Report Submitted to Admin.");
    } catch(e) {
        console.error(e);
        showToast("Report Failed.");
    }
};
// [기능 1] 알림창 토글
window.toggleNotificationModal = () => {
    const el = document.getElementById('noti-dropdown');
    el.classList.toggle('hidden');
};

// [기능 2] 알림 삭제
window.deleteNotification = async (id) => {
    try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', id));
    } catch(e) { console.error(e); }
};

// [기능 3] 알림 전체 삭제
window.clearAllNotifications = async () => {
    if (!confirm("Clear all alerts?")) return;
    try {
        const batch = state.notifications.map(n => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', n.id)));
        await Promise.all(batch);
    } catch(e) { console.error(e); }
};

// [기능 4] 관리자: 신고 삭제 (무시)
window.deleteReport = async (reportId) => {
    if (!confirm("Delete this report permanently?")) return;
    try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId));
        showToast("Report Deleted.");
    } catch(e) { console.error(e); }
};

// [기능 5] 관리자: 답장 모달 열기
let currentResolvingReportId = null;
let currentResolvingReporterId = null;

window.openAdminReplyModal = (reportId, reporterId) => {
    currentResolvingReportId = reportId;
    currentResolvingReporterId = reporterId;
    $('admin-reply-memo').value = '';
    $('admin-reply-modal').classList.remove('hidden');
};

// [수정] 관리자: 해결 처리 (안전장치 추가)
window.submitAdminResolution = async () => {
    const memo = $('admin-reply-memo').value.trim();
    
    // 안전장치: ID가 없으면 오류 출력
    if (!currentResolvingReportId || !currentResolvingReporterId) {
        console.error("Missing Report ID or Reporter ID");
        showToast("Error: Target not found.");
        return;
    }

    try {
        // 1. 유저에게 알림 전송
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
            targetUserId: currentResolvingReporterId,
            title: "Report Resolved",
            message: "관리자가 당신의 신고를 확인했습니다.",
            memo: memo,
            timestamp: serverTimestamp(),
            isRead: false
        });

        // 2. 신고 내역 삭제
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', currentResolvingReportId));

        $('admin-reply-modal').classList.add('hidden');
        showToast("User Notified & Report Closed.");
    } catch(e) {
        console.error("Resolution Failed:", e); // 콘솔에 상세 에러 출력
        showToast("Action Failed. Check Console.");
    }
};
// [수정됨] 알림 데이터 동기화 및 소리 재생
function updateMyNotifications() {
    // 아직 원본 데이터나 유저 정보가 없으면 중단
    if (!state.rawNotifications || !state.userAccount) return;

    // 현재 저장된 알림 (이전 상태)
    const prevCount = state.notifications ? state.notifications.length : 0;

    // 내 아이디(targetUserId)와 일치하는 알림만 필터링
    const myNewNotis = state.rawNotifications.filter(n => n.targetUserId === state.userAccount.loginId);
    
    // state 업데이트
    state.notifications = myNewNotis;
    if (state.initDone && myNewNotis.length > prevCount) {
        window.playNotificationSound(); // 띠롱~!
        
    }
    
    if (state.currentView === 'home') renderHome();
}
// [추가] 알림 소리 재생 함수
window.playNotificationSound = () => {
    const audio = document.getElementById('noti-sound');
    if (audio) {
        audio.volume = 0.3; // 소리 크기 조절 (0.0 ~ 1.0)
        audio.currentTime = 0; // 연속 재생을 위해 재생 위치 초기화
        // 브라우저 정책상 사용자가 화면을 클릭한 적이 없으면 소리가 막힐 수 있음 (catch로 에러 방지)
        audio.play().catch(e => console.log("Audio play blocked: interact with document first."));
    }
};
// [추가] 채팅방 알림 켜기/끄기 토글 함수
window.toggleRoomMute = async (roomId) => {
    const myId = state.userAccount.loginId;
    const room = state.chatRooms.find(r => r.id === roomId);
    if (!room) return;

    // 현재 상태 확인 (없으면 켜진 것, true면 꺼진 것)
    const currentMuteState = room.muted ? room.muted[myId] : false;
    const newMuteState = !currentMuteState; // 반대로 전환

    try {
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
        
        // 내 ID의 뮤트 설정만 업데이트
        // (Firestore의 점 표기법을 사용하여 객체 내부의 특정 필드만 수정)
        await updateDoc(roomRef, {
            [`muted.${myId}`]: newMuteState
        });

        const statusMsg = newMuteState ? "Notifications Muted." : "Notifications Enabled.";
        showToast(statusMsg);
        
    } catch(e) {
        console.error(e);
        showToast("Error updating settings.");
    }
};
// [추가] 작전/조사/스토리 화면 렌더링
function renderOperation() {
    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] p-8 lg:p-20 overflow-y-auto animate-fade-in relative">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-5 pointer-events-none"></div>
            
            <div class="mb-16 border-b border-white/5 pb-6 relative z-10">
                <h2 class="text-6xl font-serif font-black text-white tracking-tighter uppercase leading-none">Operations</h2>
                <div class="flex justify-between items-end mt-4">
                    <p class="text-[11px] text-amber-500 font-bold tracking-[0.2em] uppercase">Active Missions & Investigations</p>
                    <p class="text-[10px] text-neutral-600 font-mono">SECURE CHANNEL ESTABLISHED</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 relative z-10">
                
                <div onclick="renderStoryTimeline()" class="group relative bg-neutral-900 border border-white/10 rounded-[2rem] overflow-hidden h-96 cursor-pointer hover:border-amber-500 transition-all hover:-translate-y-2 shadow-2xl">
                    <div class="absolute inset-0">
                        <img src="https://images.unsplash.com/photo-1519608487953-e999c86e7455?q=80&w=1000" class="w-full h-full object-cover opacity-40 group-hover:opacity-60 group-hover:scale-110 transition-all duration-700 grayscale">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                    </div>
                    <div class="absolute bottom-0 left-0 p-8 w-full">
                        <div class="w-12 h-12 rounded-full bg-amber-600 flex items-center justify-center mb-4 text-white shadow-[0_0_15px_rgba(217,119,6,0.6)]">
                            <i data-lucide="book-open" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-2xl font-black text-white uppercase italic mb-2">Main Story</h3>
                        <p class="text-xs text-neutral-400 leading-relaxed line-clamp-2">The unraveling truth of Elysium. Begin your investigation into the core anomalies.</p>
                        <div class="mt-6 flex items-center gap-2 text-[10px] text-amber-500 font-bold tracking-widest uppercase">
                            <span>Proceed</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>

                <div onclick="switchView('investigation')" class="group relative bg-neutral-900 border border-white/10 rounded-[2rem] overflow-hidden h-96 cursor-pointer hover:border-amber-500 transition-all hover:-translate-y-2 shadow-2xl">
                    <div class="absolute inset-0">
                        <img src="https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?q=80&w=1000" class="w-full h-full object-cover opacity-40 group-hover:opacity-60 group-hover:scale-110 transition-all duration-700 grayscale">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                    </div>
                    <div class="absolute bottom-0 left-0 p-8 w-full">
                         <div class="w-12 h-12 rounded-full bg-neutral-800 border border-white/20 flex items-center justify-center mb-4 text-white group-hover:bg-amber-600 transition-colors">
                            <i data-lucide="map" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-2xl font-black text-white uppercase italic mb-2">Field Work</h3>
                        <p class="text-xs text-neutral-400 leading-relaxed line-clamp-2">Search for clues in specific sectors.</p>
                        <div class="mt-6 flex items-center gap-2 text-[10px] text-amber-500 font-bold tracking-widest uppercase transition-colors">
                            <span>Deploy</span> <i data-lucide="crosshair" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>

                <div class="group relative bg-neutral-950 border border-white/5 rounded-[2rem] overflow-hidden h-96 opacity-60">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                        <i data-lucide="lock" class="w-12 h-12 text-neutral-600 mb-4"></i>
                        <h3 class="text-2xl font-black text-neutral-500 uppercase italic">Sector Locked</h3>
                    </div>
                </div>
            </div>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
window.renderOperation = renderOperation;

window.renderStoryTimeline = () => {
    const chapters = state.storyData?.chapters || [];
    const isAdmin = state.isAdmin;

    $('content-area').innerHTML = `
        <div id="story-timeline-root" class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full select-none">
            
            <div class="p-12 pb-6 flex justify-between items-start z-20 bg-[#0a0a0a]/90 backdrop-blur-sm border-b border-white/5">
                <div>
                    <h2 class="text-5xl font-serif font-black text-white uppercase tracking-tighter">Main Story Timeline</h2>
                    <p class="text-[10px] text-amber-500 font-bold tracking-[0.3em] mt-2 uppercase">Chronological Records</p>
                </div>
                <div class="flex gap-4">
                    ${isAdmin ? `<button onclick="openStoryEditor('chapter', null)" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold rounded-lg uppercase tracking-wider">+ Add Chapter</button>` : ''}
                    <button
  onclick="renderOperation();"
  class="flex items-center gap-2 text-neutral-500 hover:text-white transition-colors uppercase text-xs font-bold tracking-widest border border-white/10 px-4 py-2 rounded-lg hover:bg-white/5 relative z-[100]">
  <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
</button>


                </div>
            </div>

            <div id="timeline-container" class="flex-1 overflow-x-auto custom-scrollbar w-full flex items-center cursor-grab active:cursor-grabbing relative bg-black">
                <div class="flex items-stretch h-full min-w-max pointer-events-none"> 
                    
                    ${chapters.map((chapter, cIndex) => `
                        <div class="relative flex flex-col justify-center h-full group/chapter pointer-events-auto border-r border-white/5">
                            
                            ${chapter.bgImage ? `
                                <div class="absolute inset-0 z-0 overflow-hidden">
                                    <img src="${chapter.bgImage}" class="w-full h-full object-cover opacity-20 grayscale hover:grayscale-0 transition-all duration-700 scale-105 group-hover/chapter:scale-100">
                                    <div class="absolute inset-0 bg-gradient-to-r from-black via-black/50 to-black"></div>
                                </div>
                            ` : ''}

                            <div class="relative z-10 px-12 py-20 flex flex-col h-full justify-center">
                                <div class="mb-40 border-l-4 border-amber-600 pl-4 relative">
                                    <h3 class="text-4xl font-black text-white uppercase italic tracking-tighter drop-shadow-lg">${chapter.title}</h3>
                                    <p class="text-xs text-neutral-400 font-mono mt-1 uppercase tracking-widest drop-shadow-md">${chapter.subtitle || ''}</p>
                                    
                                    ${isAdmin ? `
                                    <div class="absolute -right-2 -top-8 flex gap-2 opacity-0 group-hover/chapter:opacity-100 transition-opacity bg-black/80 px-2 py-1 rounded-lg border border-white/10 backdrop-blur-md">
                                        <button onclick="openStoryEditor('chapter', {cIdx:${cIndex}})" class="text-neutral-400 hover:text-amber-500" title="Edit Chapter"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                        <button onclick="deleteStoryChapter(${cIndex})" class="text-neutral-400 hover:text-red-500" title="Delete Chapter"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                    </div>` : ''}
                                </div>

                                <div class="flex items-center gap-0 relative">
                                    <div class="absolute top-1/2 left-0 w-full h-[2px] bg-neutral-800/80 -translate-y-1/2 z-0"></div>

                                    ${chapter.events ? chapter.events.map((evt, eIndex) => `
                                        <div class="relative z-10 flex flex-col items-center w-64 group h-16 justify-center">
                                            
                                            <div class="absolute w-60 text-center transition-all duration-300 ${eIndex % 2 === 0 ? 'bottom-full mb-1' : 'top-full mt-1'}">
                                                <p class="text-amber-500 font-bold font-mono text-xs mb-1 drop-shadow-md">${evt.year}</p>
                                                <h4 class="text-white font-black text-lg uppercase italic break-keep leading-tight drop-shadow-md">${evt.title}</h4>
                                                <p class="text-neutral-400 text-[10px] mt-2 px-2 leading-relaxed line-clamp-2 opacity-60 group-hover:opacity-100 transition-opacity drop-shadow-md">${evt.desc}</p>
                                                <div class="absolute left-1/2 -translate-x-1/2 w-px h-1 bg-neutral-600 ${eIndex % 2 === 0 ? '-bottom-1' : '-top-1'}"></div>
                                            </div>

                                            <div class="absolute w-72 p-4 rounded-xl bg-neutral-900 border border-white/20 shadow-[0_10px_40px_rgba(0,0,0,0.8)] opacity-0 group-hover:opacity-100 transition-all duration-300 z-50 pointer-events-none scale-95 group-hover:scale-100
                                                ${eIndex % 2 === 0 ? 'top-full mt-6 translate-y-2 group-hover:translate-y-0' : 'bottom-full mb-6 -translate-y-2 group-hover:translate-y-0'}">
                                                <div class="flex items-center gap-2 mb-2 border-b border-white/10 pb-2">
                                                    <i data-lucide="file-text" class="w-3 h-3 text-amber-500"></i>
                                                    <span class="text-[10px] font-bold text-white uppercase tracking-widest">Plot Summary</span>
                                                </div>
                                                <p class="text-neutral-300 text-xs leading-relaxed text-justify font-sans whitespace-pre-line">
                                                    ${evt.summary ? evt.summary : '<span class="text-neutral-600 italic">No summary details registered.</span>'}
                                                </p>
                                                <div class="absolute left-1/2 -translate-x-1/2 w-3 h-3 bg-neutral-900 border-l border-t border-white/20 transform rotate-45 ${eIndex % 2 === 0 ? '-top-1.5' : '-bottom-1.5 border-l-0 border-t-0 border-r border-b'}"></div>
                                            </div>

                                            <div onclick="${isAdmin ? `openStoryEditor('event', {cIdx:${cIndex}, eIdx:${eIndex}})` : ''}" 
                                                 class="w-12 h-12 rounded-full bg-[#0a0a0a] border-2 border-neutral-600 group-hover:border-amber-500 group-hover:scale-110 transition-all duration-300 flex items-center justify-center relative z-20 shadow-lg cursor-pointer hover:bg-neutral-800">
                                                <i data-lucide="${evt.icon || 'circle'}" class="w-5 h-5 text-neutral-400 group-hover:text-white transition-colors"></i>
                                            </div>

                                            ${eIndex !== chapter.events.length - 1 ? `<div class="absolute top-1/2 -right-[50%] -translate-y-1/2 w-1.5 h-1.5 rounded-full bg-neutral-800 z-10"></div>` : ''}
                                        </div>
                                        <div class="w-16 h-1 bg-transparent"></div>
                                    `).join('') : ''}

                                    ${isAdmin ? `<button onclick="openStoryEditor('event', {cIdx:${cIndex}, eIdx:null})" class="relative z-10 w-10 h-10 rounded-full bg-neutral-900 border border-white/20 hover:bg-amber-600 hover:text-white hover:border-amber-600 flex items-center justify-center transition-all ml-4"><i data-lucide="plus" class="w-4 h-4"></i></button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <div id="story-editor-modal" class="hidden fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-neutral-900 border border-amber-600/30 rounded-[2.5rem] p-10 shadow-2xl modal-enter">
                <h3 id="story-editor-title" class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-6 text-center">Edit Timeline</h3>
                
                <div id="story-editor-content" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"></div>

                <div class="flex gap-4 mt-8">
                    <button onclick="document.getElementById('story-editor-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button id="story-save-btn" class="flex-1 py-4 bg-amber-600 text-white font-bold rounded-xl uppercase text-xs hover:bg-amber-700 shadow-lg">Save</button>
                    <button id="story-delete-btn" class="hidden w-12 py-4 bg-red-900/50 text-red-500 font-bold rounded-xl uppercase text-xs hover:bg-red-600 hover:text-white"><i data-lucide="trash-2" class="w-4 h-4 mx-auto"></i></button>
                </div>
            </div>
        </div>
    `;

    // 드래그 스크롤
    const slider = document.getElementById('timeline-container');
    let isDown = false;
    let startX;
    let scrollLeft;
    slider.addEventListener('mousedown', (e) => { if (e.target.closest('button')) return;isDown = true; slider.classList.add('active'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
    slider.addEventListener('mouseleave', () => { isDown = false; });
    slider.addEventListener('mouseup', () => { isDown = false; });
    slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 1.5; slider.scrollLeft = scrollLeft - walk; });
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.openStoryEditor = (type, target) => {
    const modal = document.getElementById('story-editor-modal');
    const content = document.getElementById('story-editor-content');
    const title = document.getElementById('story-editor-title');
    const saveBtn = document.getElementById('story-save-btn');
    const delBtn = document.getElementById('story-delete-btn');
    
    modal.classList.remove('hidden');
    delBtn.classList.add('hidden');

    if (type === 'chapter') {
        // [수정됨] 챕터 추가 또는 수정
        const chapters = state.storyData?.chapters || [];
        const isEdit = target && target.cIdx !== undefined && target.cIdx !== null;
        const ch = isEdit ? chapters[target.cIdx] : {};

        title.innerText = isEdit ? "Edit Chapter" : "New Chapter";
        content.innerHTML = `
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Chapter Title</label>
            <input id="edit-ch-title" value="${ch.title || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-amber-500" placeholder="e.g. Chapter 1"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Subtitle</label>
            <input id="edit-ch-sub" value="${ch.subtitle || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-amber-500" placeholder="e.g. The Beginning"></div>
            
            <div><label class="text-[10px] text-amber-500 font-bold uppercase">Background Image URL</label>
            <input id="edit-ch-bg" value="${ch.bgImage || ''}" class="w-full bg-black border border-amber-500/30 rounded-xl px-4 py-3 text-sm text-amber-500 font-mono" placeholder="https://..."></div>
        `;
        // 저장 함수에 인덱스 전달 (수정이면 인덱스, 추가면 null)
        saveBtn.onclick = () => saveStoryChapter(isEdit ? target.cIdx : null);

    } else if (type === 'event') {
        const { cIdx, eIdx } = target;
        const chapters = state.storyData.chapters;
        const isEdit = eIdx !== null;
        const evt = isEdit ? chapters[cIdx].events[eIdx] : {};

        title.innerText = isEdit ? "Edit Event" : "Add Event";
        content.innerHTML = `
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Year / Date</label>
            <input id="edit-ev-year" value="${evt.year || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-amber-500 font-bold" placeholder="2024.01"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Title</label>
            <input id="edit-ev-title" value="${evt.title || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white font-bold" placeholder="Title"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Short Desc (Always Visible)</label>
            <input id="edit-ev-desc" value="${evt.desc || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-neutral-400" placeholder="Brief description..."></div>

            <div><label class="text-[10px] text-amber-500 font-bold uppercase">Plot Summary (Hover Popup)</label>
            <textarea id="edit-ev-summary" class="w-full bg-black border border-amber-500/30 rounded-xl px-4 py-3 text-sm text-white resize-none h-24 custom-scrollbar leading-relaxed" placeholder="Enter detailed story plot here...">${evt.summary || ''}</textarea></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Icon (Lucide)</label>
            <input id="edit-ev-icon" value="${evt.icon || 'circle'}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-neutral-500 font-mono" placeholder="anchor, star..."></div>
        `;
        
        saveBtn.onclick = () => saveStoryEvent(cIdx, eIdx);
        
        if (isEdit) {
            delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteStoryEvent(cIdx, eIdx);
        }
    }
};

// [로직] 챕터 저장
window.saveStoryChapter = async (cIdx) => {
    const title = document.getElementById('edit-ch-title').value;
    const sub = document.getElementById('edit-ch-sub').value;
    const bgImage = document.getElementById('edit-ch-bg').value; // [추가] 이미지

    if (!title) return showToast("Title required.");

    const currentChapters = state.storyData?.chapters || [];
    let updatedChapters = [...currentChapters];

    if (cIdx === null) {
        // [추가 모드]
        const newChapter = { title, subtitle: sub, bgImage, events: [] };
        updatedChapters.push(newChapter);
    } else {
        // [수정 모드] 기존 이벤트는 유지하고 정보만 업데이트
        updatedChapters[cIdx] = { 
            ...updatedChapters[cIdx], 
            title, 
            subtitle: sub, 
            bgImage 
        };
    }
    
    await updateStoryDB(updatedChapters);
    document.getElementById('story-editor-modal').classList.add('hidden');
};
// [로직] 챕터 삭제
window.deleteStoryChapter = async (cIdx) => {
    if(!confirm("Delete this entire chapter?")) return;
    const chapters = [...state.storyData.chapters];
    chapters.splice(cIdx, 1);
    await updateStoryDB(chapters);
};

// [로직] 이벤트 저장 (추가/수정)
window.saveStoryEvent = async (cIdx, eIdx) => {
    const year = document.getElementById('edit-ev-year').value;
    const title = document.getElementById('edit-ev-title').value;
    const desc = document.getElementById('edit-ev-desc').value;
    const summary = document.getElementById('edit-ev-summary').value; // [필수] 줄거리
    const icon = document.getElementById('edit-ev-icon').value;

    if (!title) return showToast("Title required.");

    const chapters = [...state.storyData.chapters];
    const newEvent = { year, title, desc, summary, icon };

    if (eIdx === null) {
        chapters[cIdx].events.push(newEvent);
    } else {
        chapters[cIdx].events[eIdx] = newEvent;
    }

    await updateStoryDB(chapters);
    document.getElementById('story-editor-modal').classList.add('hidden');
};

// [로직] 이벤트 삭제
window.deleteStoryEvent = async (cIdx, eIdx) => {
    if(!confirm("Delete this event?")) return;
    const chapters = [...state.storyData.chapters];
    chapters[cIdx].events.splice(eIdx, 1);
    await updateStoryDB(chapters);
    $('story-editor-modal').classList.add('hidden');
};

// [공통] DB 업데이트 함수
window.updateStoryDB = async (chapters) => {
    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'story'), {
            chapters: chapters
        });
        showToast("Timeline Updated.");
    } catch(e) {
        console.error(e);
        showToast("Save Failed.");
    }
};
// [추가] 유저 계정 강제 삭제 (관리자용)
window.deleteUserAccount = async (loginId) => {
    // 1. 안전장치: 정말 삭제할 것인지 확인
    if (!confirm(`WARNING: You are about to DELETE user [${loginId}].\nThis action cannot be undone.\n\nAre you sure?`)) {
        return;
    }

    try {
        // 2. DB에서 계정 문서 삭제
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId));
        
        // 3. 모달 닫기 및 알림
        document.getElementById('admin-edit-modal').classList.add('hidden');
        showToast("User Account Terminated.");
        
        // (참고: 리스트는 onSnapshot에 의해 자동으로 갱신됩니다)
    } catch(e) {
        console.error(e);
        showToast("Termination Failed.");
    }
};
// [복구됨] 채팅방 멤버 목록 보여주기 (그룹 이름 클릭 시)
window.showRoomMembers = (roomId) => {
    const room = state.chatRooms.find(r => r.id === roomId);
    if (!room) return;

    const list = document.getElementById('room-members-list');
    if (list) {
        list.innerHTML = room.members.map(mid => {
            const acc = state.accounts.find(a => a.loginId === mid);
            // 유저 정보가 없으면(탈퇴 등) 기본값 표시
            const name = acc ? acc.ocName : 'Unknown User';
            const img = acc ? acc.profile : '';
            const id = mid;
            
            return `
                <div class="flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 mb-2 last:mb-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-black overflow-hidden border border-white/10 shrink-0">
                            ${img ? `<img src="${img}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-neutral-800 flex items-center justify-center"><i data-lucide="user" class="w-5 h-5 text-neutral-500"></i></div>`}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white">${name}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${id}</p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // 모달 띄우기
    const modal = document.getElementById('room-members-modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
// [추가] 비밀번호 재설정 이메일 발송 함수
window.handleSendPasswordReset = async (email) => {
    if (!email) {
        return showToast("Error: No email address found for this user.");
    }

    if (!confirm(`Send password reset email to [${email}]?`)) return;

    try {
        await sendPasswordResetEmail(auth, email);
        showToast(`Reset email sent to ${email}`);
    } catch (error) {
        console.error("Password Reset Error:", error);
        if (error.code === 'auth/user-not-found') {
            showToast("Error: User not found in Authentication.");
        } else {
            showToast("Failed to send email: " + error.message);
        }
    }
};
function renderInvestigation() {
    const inv = state.investigation;
    if (!inv.selectedSector) {
        renderSectorSelection();
        return;
    }

    const sectorIdx = inv.sectors.findIndex(s => s.id === inv.selectedSector);
    const sector = inv.sectors[sectorIdx];
    const sectorPoints = inv.points.filter(p => p.sector === inv.selectedSector);

    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-black overflow-hidden animate-fade-in relative h-full">
            <div class="absolute inset-0 z-10 pointer-events-none shadow-[inset_0_0_300px_rgba(0,0,0,1)]"></div>
            <div class="absolute inset-0 z-10 pointer-events-none bg-gradient-to-b from-black/90 via-transparent to-black/95"></div>

            <div class="p-8 flex justify-between items-center z-20 bg-black/20 backdrop-blur-sm border-b border-white/5">
    <div>
        <h2 class="text-3xl font-serif font-black text-white uppercase tracking-tighter">${sector.name}</h2>
        <button onclick="window.returnToSectors()" class="text-[10px] text-amber-500 font-bold hover:underline uppercase tracking-widest mt-1">◀ Return to Sector Selection</button>
    </div>
    <div class="flex gap-3">
        ${state.isAdmin ? `<button onclick="changeMapImage(${sectorIdx})" class="px-6 py-2 border border-amber-500/30 text-amber-500 hover:bg-amber-500 hover:text-white rounded-lg text-xs font-bold uppercase transition-all">Change Map</button>` : ''}
        <button onclick="switchView('operation')" class="px-6 py-2 border border-white/10 text-neutral-400 hover:text-white rounded-lg text-xs font-bold uppercase transition-all">Withdraw</button>
    </div>
</div>

            <div class="flex-1 relative flex flex-row overflow-hidden">
                <div class="flex-1 relative overflow-hidden flex items-center justify-center cursor-crosshair" onclick="handleMapClick(event)">
                    <div class="absolute inset-0 flex items-center justify-center" id="map-container">
                        <img src="${sector.map}" class="w-full h-full object-cover opacity-40 grayscale hover:grayscale-0 transition-all duration-[2000ms]">
                        <div class="absolute inset-0 pointer-events-none">
                            ${sectorPoints.map((p) => {
                                const isFound = inv.foundClueIds && inv.foundClueIds.includes(p.id);
                                // 전역 points 배열에서의 실제 인덱스를 찾습니다 (수정용)
                                const globalIdx = inv.points.findIndex(gp => gp.id === p.id);
                                
                                return `
                                    <div class="absolute w-10 h-10 -ml-5 -mt-5 flex items-center justify-center group pointer-events-auto" style="left: ${p.x}%; top: ${p.y}%;">
                                        ${!isFound ? '<div class="absolute inset-0 bg-amber-500 rounded-full animate-ping opacity-20"></div>' : ''}
                                        <div onclick="handleDiscovery('${p.id}'); event.stopPropagation();" 
                                             class="w-3 h-3 ${isFound ? 'bg-neutral-600' : 'bg-amber-600 border-amber-400'} border rounded-full transition-all cursor-pointer group-hover:scale-150">
                                        </div>
                                        
                                        <div class="absolute bottom-full mb-4 opacity-0 group-hover:opacity-100 transition-all pointer-events-none z-50 translate-y-2 group-hover:translate-y-0">
                                            <div class="bg-neutral-900/90 backdrop-blur-md text-white text-[10px] font-black px-4 py-2 rounded-xl border border-amber-500/30 shadow-2xl flex items-center gap-3 pointer-events-auto">
                                                <span class="tracking-widest">${p.title}</span>
                                                ${state.isAdmin ? `
                                                    <div class="flex gap-2 ml-2 border-l border-white/10 pl-2 text-[9px]">
                                                        <button onclick="event.stopPropagation(); editPOI(${globalIdx})" class="text-amber-500 hover:text-white">EDIT</button>
                                                        <button onclick="event.stopPropagation(); handlePointRightClick(event, ${globalIdx})" class="text-red-500 hover:text-white">DEL</button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <div class="w-80 border-l border-white/5 bg-black/40 backdrop-blur-xl z-20 flex flex-col p-6 overflow-hidden">
                    <h3 class="text-[10px] font-black text-neutral-500 uppercase tracking-[0.3em] mb-6 border-b border-white/5 pb-4">Recent Archive Logs</h3>
                    <div id="investigation-side-list" class="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2"></div>
                    <button onclick="toggleArchive()" class="mt-6 py-4 bg-white/5 border border-white/10 rounded-xl text-[9px] font-bold text-neutral-400 uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all">
                        Open Full Archive
                    </button>
                </div>
            </div>
            ... 
        </div>
    `;
    updateInvestigationSideList();
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function renderSectorSelection() {
    const inv = state.investigation;
    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] p-12 lg:p-24 overflow-y-auto animate-fade-in relative h-full">
            <div class="mb-8">
                <h2 class="text-7xl font-serif font-black text-white uppercase tracking-tighter">Select Sector</h2>
                <p class="text-amber-500 font-bold tracking-[0.4em] mt-3 uppercase text-[11px]">탐사할 구역을 선택하십시오</p>
            </div>

            <div class="mb-12">
    <button onclick="event.stopPropagation(); window.switchView('operation')" 
            class="relative z-[100] pointer-events-auto flex items-center gap-2 text-neutral-500 hover:text-white transition-colors text-xs font-bold uppercase tracking-widest py-2 rounded-lg hover:bg-white/5 w-fit">
        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Operations
    </button>
</div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12 max-w-7xl">
                ${inv.sectors.map((s, idx) => {
                    const available = s.isAvailable;
                    const canEnter = available || state.isAdmin; // 관리자는 무조건 진입 가능
                    
                    return `
                    <div class="flex flex-col gap-6 group">
                        <div onclick="handleSectorClick('${s.id}', ${available})" 
                             class="relative aspect-[3/4] rounded-[2.5rem] overflow-hidden border border-white/5 transition-all duration-700 
                                    ${canEnter ? 'cursor-pointer hover:border-amber-500 hover:-translate-y-4 shadow-2xl' : 'opacity-40 grayscale cursor-not-allowed'}">
                            
                            <img src="${s.map}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110">
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                            
                            <div class="absolute bottom-0 p-10">
                                <h3 class="text-3xl font-black text-white uppercase italic mb-2 tracking-tighter">${s.name}</h3>
                                <p class="text-[10px] text-neutral-400 uppercase tracking-widest font-bold">${s.desc}</p>
                            </div>
                            
                            ${(!available && !state.isAdmin) ? `<div class="absolute inset-0 flex items-center justify-center bg-black/40"><i data-lucide="lock" class="w-12 h-12 text-white/20"></i></div>` : ''}
                        </div>

                        <div class="px-4 border-t border-white/10 pt-6">
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-neutral-500 text-[11px] font-mono uppercase tracking-widest mb-1">${s.unlockDate}</p>
                                    <p class="status-text ${available ? 'text-amber-500' : 'text-neutral-700'}">
                                        ${available ? '조사 가능' : '조사 해금 대기'}
                                    </p>
                                </div>
                                ${state.isAdmin ? `
                                    <button onclick="toggleSectorStatus(${idx})" class="mb-1 p-3 bg-neutral-900 border border-white/10 rounded-xl hover:bg-amber-600 transition-all shadow-lg">
                                        <i data-lucide="${available ? 'unlock' : 'lock'}" class="w-5 h-5 text-white"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

// 구역 클릭 처리 함수 (이동 버그 수정)
window.handleSectorClick = (sectorId, isAvailable) => {
    // 관리자이거나, 해금된 구역일 경우에만 진입
    if (state.isAdmin || isAvailable) {
        state.investigation.selectedSector = sectorId;
        renderInvestigation(); // 실제 지도 화면으로 전환
    } else {
        showToast('현재 진입이 불가능한 구역입니다.');
    }
};

window.toggleSectorStatus = async (idx) => {
    if (!state.isAdmin) return;

    // 1. 데이터 상태 반전 (true -> false / false -> true)
    state.investigation.sectors[idx].isAvailable = !state.investigation.sectors[idx].isAvailable;

    // 2. 서버 DB에 변경된 상태 저장
    if (window.handleSystemUpdate) {
        await window.handleSystemUpdate();
    }

    // 3. UI 갱신: 섹터 선택 화면(자물쇠 버튼이 있는 곳)을 다시 그립니다.
    renderSectorSelection();
    
    const statusMsg = state.investigation.sectors[idx].isAvailable ? '해금' : '잠금';
    showToast(`구역이 ${statusMsg}되었습니다.`);
};
window.updateInvestigationSideList = () => {
    const sideList = document.getElementById('investigation-side-list');
    if (!sideList) return;

    const inv = state.investigation;
    // 내가 발견한(foundClueIds) 단서들만 필터링
    const foundClues = inv.points.filter(p => inv.foundClueIds.includes(p.id));

    if (foundClues.length === 0) {
        sideList.innerHTML = '<p class="text-[10px] text-neutral-700 italic text-center py-10">NO LOGS FOUND.</p>';
        return;
    }

    // 최신 발견 순으로 상단에 노출
    sideList.innerHTML = foundClues.reverse().map(c => `
        <div class="p-4 bg-white/5 border border-white/5 rounded-xl animate-fade-in group hover:border-amber-500/30 transition-all cursor-help" onclick="showFullClue('${c.id}')">
            <p class="text-[9px] text-amber-500 font-black uppercase mb-1 tracking-widest">${c.title}</p>
            <p class="text-[11px] text-neutral-400 line-clamp-2 leading-relaxed italic group-hover:text-neutral-200">"${c.clue}"</p>
        </div>
    `).join('');
};
    </script>
</body>
</html>

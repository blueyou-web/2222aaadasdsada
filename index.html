<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysium: OC Community</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #0a0a0a;
            color: #e5e5e5;
            font-family: 'ui-sans-serif', system-ui, sans-serif;
            overflow: hidden;
        }
        .font-serif { font-family: 'Noto Serif KR', serif; }
        
        /* Ïä§ÌÅ¨Î°§Î∞î Ïª§Ïä§ÌÖÄ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1a1a1a; border-radius: 10px; }
        
        /* Transitions */
        @keyframes viewEnter {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes viewExit {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-15px); }
        }
        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .view-enter { animation: viewEnter 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .view-exit { animation: viewExit 0.3s ease-in forwards; }
        .modal-enter { animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        .sidebar-btn.active {
            background-color: #d97706;
            color: white;
            box-shadow: 0 10px 20px -5px rgba(146, 64, 14, 0.5);
            transform: translateX(5px);
        }

        .chat-bubble-mine {
            background: linear-gradient(135deg, #d97706, #b45309);
            color: white;
            border-bottom-right-radius: 0;
        }
        .chat-bubble-theirs {
            background-color: #1f1f1f;
            color: #d4d4d4;
            border-bottom-left-radius: 0;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #oc-large-image {
            mask-image: linear-gradient(to left, black 70%, transparent 100%);
            filter: drop-shadow(0 0 100px rgba(0,0,0,1));
        }

        .new-badge {
            background-color: #ef4444;
            color: white;
            font-size: 8px;
            font-weight: 900;
            padding: 2px 5px;
            border-radius: 4px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        #auth-view {
    background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
    background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); /* Î≥ÑÍ∞ÄÎ£® Ìö®Í≥º */
}

.auth-card {
    background: rgba(15, 15, 15, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 2rem;
}

.auth-input {
    background: #050505 !important;
    border: 1px solid #1a1a1a !important;
    color: white !important;
    transition: all 0.3s ease;
}

.auth-input:focus {
    border-color: #d97706 !important;
    box-shadow: 0 0 15px rgba(217, 119, 6, 0.2);
}

.btn-initialize {
    background: #d97706 !important;
    color: white !important;
    font-weight: 800 !important;
    letter-spacing: 0.1em;
    box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
}

.btn-initialize:hover {
    background: #b45309 !important;
    transform: translateY(-1px);
}
.auth-bg-overlay {
    position: fixed;
    inset: 0;
    z-index: -1; /* Î°úÍ∑∏Ïù∏Ï∞ΩÎ≥¥Îã§ Îí§Ïóê ÏúÑÏπò */
    background-size: cover;
    background-position: center;
    filter: grayscale(100%) blur(10px) brightness(0.3); /* Í∑∏Î†àÏù¥ + Î∏îÎü¨ + Ïñ¥Îë°Í≤å */
    transition: background-image 0.5s ease;
}
.new-badge {
    background: #d97706; /* amber-600 */
    color: white;
    font-size: 8px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    letter-spacing: 0.05em;
    box-shadow: 0 0 10px rgba(217, 119, 6, 0.5);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}
/* Ï°∞ÏÇ¨ Í∞ÄÎä• Ïó¨Î∂Ä ÌÖçÏä§Ìä∏ Í∞ïÏ°∞ */
.status-text {
    font-size: 1.25rem; /* 20px Ï†ïÎèÑÎ°ú ÌÅ¨Í≤å ÏÑ§Ï†ï */
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -0.02em;
}

.new-badge {
    background: #ef4444;
    color: white;
    font-size: 9px;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    animation: pulse 2s infinite;
}
    </style>
</head>
<body>

    <!-- Ï¥àÍ∏∞ Î°úÎî© Ïä§ÌÅ¨Î¶∞ -->
    <div id="loading-overlay" class="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center space-y-4 transition-opacity duration-1000">
        <div class="w-16 h-[2px] bg-amber-500 animate-pulse"></div>
        <p class="text-amber-500 font-mono text-[10px] tracking-[0.5em] uppercase">Connecting to Elysium</p>
    </div>

    <div id="app-container" class="flex h-screen w-full opacity-0 transition-opacity duration-1000">
        
        <!-- Authentication Gate -->
        <div id="auth-view" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center p-6">
    
    <div id="auth-dynamic-bg" class="auth-bg-overlay"></div>
    
    <div class="text-center mb-10 animate-fade-in relative z-10">
        <div class="w-16 h-16 bg-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-[0_0_30px_rgba(217,119,6,0.4)]">
            <i data-lucide="layers" class="w-8 h-8 text-white"></i>
        </div>
        <h1 class="text-4xl font-serif font-black text-white tracking-[0.2em] uppercase mb-1">ELYSIUM</h1>
        <p class="text-[9px] text-amber-500/60 font-mono tracking-[0.4em] uppercase">Secure Archive System</p>
    </div>

    <div class="w-full max-w-[400px] auth-card p-10 space-y-8 modal-enter">
        <div class="space-y-6">
            <div class="space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Identify</label>
                <div class="relative">
                    <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-600"></i>
                    <input id="auth-id" type="text" placeholder="ERA ID" class="auth-input w-full rounded-xl pl-12 pr-6 py-4 text-sm outline-none">
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Access Key</label>
                <div class="relative">
                    <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-600"></i>
                    <input id="auth-pw" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="auth-input w-full rounded-xl pl-12 pr-6 py-4 text-sm outline-none">
                </div>
            </div>

            <div id="signup-extra" class="hidden space-y-2">
                <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase ml-1">Personnel Name</label>
                <input id="auth-oc-name" type="text" placeholder="CHARACTER NAME" class="auth-input w-full rounded-xl px-6 py-4 text-sm outline-none">
            </div>
        </div>

        <button id="auth-submit-btn" class="btn-initialize w-full py-4 rounded-xl text-xs uppercase transition-all active:scale-95">
            Initialize Session
        </button>

        <div class="text-center">
            <button id="auth-toggle-btn" class="text-[9px] text-neutral-600 hover:text-amber-500 transition-colors uppercase tracking-[0.2em]">
                Request New Identity
            </button>
        </div>
    </div>

    <div class="mt-12 text-center opacity-30">
        <p class="text-[8px] text-neutral-500 font-mono tracking-widest uppercase">Secure Connection Established</p>
        <p class="text-[8px] text-neutral-600 font-mono mt-1">Ver 2.5.0 // ELYSIUM SYSTEM</p>
    </div>
</div>

        <!-- Sidebar -->
        <nav class="w-20 lg:w-64 border-r border-white/5 flex flex-col bg-neutral-950 z-50">
            <div class="p-8 flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-amber-600 rounded-xl flex items-center justify-center shrink-0 shadow-lg shadow-amber-900/30">
                    <i data-lucide="layers" class="w-6 h-6 text-white"></i>
                </div>
                <h1 class="text-sm font-black tracking-[0.4em] text-white hidden lg:block uppercase">Elysium</h1>
            </div>
            
            <div class="flex-1 px-4 py-4 space-y-2 overflow-y-auto" id="sidebar-nav"></div>

            <div class="p-6 border-t border-white/5 bg-black/20 space-y-3">
                <!-- ÏΩîÏù∏ & Ïù∏Î≤§ÌÜ†Î¶¨ -->
                <div class="flex gap-2">
                    <button onclick="openInventory()" class="flex-1 bg-neutral-900/50 border border-white/5 rounded-xl py-2 px-3 flex items-center justify-center gap-2 hover:border-amber-500/30 transition-all group">
                        <i data-lucide="package" class="w-4 h-4 text-amber-500 group-hover:scale-110 transition-transform"></i>
                        <span class="text-[10px] text-neutral-400 group-hover:text-white font-bold uppercase">Bag</span>
                    </button>
                    <div class="flex-1 bg-neutral-900/50 border border-white/5 rounded-xl py-2 px-3 flex items-center justify-center gap-2">
                        <i data-lucide="coins" class="w-4 h-4 text-amber-500"></i>
                        <span id="user-coins-display" class="text-[10px] text-white font-bold font-mono">0</span>
                    </div>
                </div>
                
                <!-- ÌîÑÎ°úÌïÑ -->
                <div class="bg-neutral-900/50 p-4 rounded-3xl flex items-center gap-3 border border-white/5 hover:border-amber-500/30 transition-all">
                    <div class="w-10 h-10 rounded-xl bg-black overflow-hidden border border-white/10 shrink-0 shadow-lg cursor-pointer transition-transform active:scale-90" onclick="switchView('profile')">
                        <img id="user-avatar" src="" class="w-full h-full object-cover hidden">
                        <div id="user-avatar-placeholder" class="w-full h-full flex items-center justify-center bg-neutral-800"><i data-lucide="user" class="w-5 h-5 text-neutral-500"></i></div>
                    </div>
                    <div class="hidden lg:block overflow-hidden flex-1">
                        <p id="user-name-display" class="text-[11px] font-black text-white truncate">Personnel</p>
                        <p id="user-id-display" class="text-[9px] text-amber-500 font-mono uppercase truncate">Guest</p>
                    </div>
                    <button onclick="handleLogout()" class="p-2 text-neutral-600 hover:text-red-500 transition-all" title="Logout">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col relative bg-neutral-950 overflow-hidden">
            <div id="content-area" class="flex-1 relative flex flex-col h-full overflow-y-auto"></div>
        </main>
<div id="discovery-panel" class="hidden fixed inset-0 z-[160] flex flex-col justify-end pointer-events-none transition-all duration-500">
    
    <div class="absolute inset-0 flex justify-center items-end pointer-events-none overflow-hidden">
        <img id="discovery-npc" src="" class="h-[90vh] w-auto object-contain transition-all duration-1000 opacity-0 transform translate-y-20 scale-105">
    </div>

    <div class="w-full h-2/3 bg-gradient-to-t from-black via-black/40 to-transparent absolute bottom-0"></div>
    
    <div class="relative z-10 w-full max-w-6xl mx-auto px-12 pb-16 pointer-events-auto">
        <div class="space-y-6">
            <div id="discovery-name-box" class="inline-flex items-center gap-3">
                <span class="w-1 h-6 bg-amber-500"></span>
                <p id="discovery-name" class="text-amber-500 text-lg font-black tracking-widest uppercase italic drop-shadow-md">Name</p>
            </div>
            
            <div class="relative group">
                <p id="discovery-clue" class="text-white text-2xl md:text-3xl font-serif leading-relaxed break-keep drop-shadow-2xl max-w-4xl transition-all duration-300">
                    ÎåÄÏÇ¨ ÎÇ¥Ïö©Ïù¥ ÌëúÏãúÎê©ÎãàÎã§.
                </p>
            </div>

            <div id="discovery-options" class="flex flex-col gap-3 mt-10 w-fit"></div>

            <div class="flex justify-between items-center pt-8 border-t border-white/10 mt-6">
                <div class="text-white/20 text-[10px] tracking-[0.8em] font-bold uppercase">Investigation System v3.0</div>
                <button id="discovery-next-btn" class="group flex items-center gap-4 text-white hover:text-amber-500 transition-all">
                    <span class="text-[10px] font-black tracking-widest uppercase opacity-40 group-hover:opacity-100">Click to Continue</span>
                    <i data-lucide="chevron-right" class="w-5 h-5 animate-pulse"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="poi-editor-modal" class="hidden fixed inset-0 z-[170] bg-black/95 flex items-center justify-center p-6 backdrop-blur-md">
    <div class="w-full max-w-2xl bg-neutral-900 border border-white/10 rounded-[2.5rem] p-8 shadow-2xl flex flex-col max-h-[90vh]">
        <h3 class="text-xl font-black text-white mb-6 uppercase tracking-widest border-b border-white/5 pb-4 flex justify-between items-center">
            Scenario Builder
            <span class="text-[10px] text-amber-500 font-normal">Î∏îÎ°ùÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ ÌùêÎ¶ÑÏùÑ ÎßåÎìúÏÑ∏Ïöî</span>
        </h3>
        
        <div class="mb-4">
            <label class="text-[10px] text-neutral-500 font-bold uppercase ml-1">ÏßÄÏ†ê ÌÉÄÏù¥ÌãÄ</label>
            <input id="edit-poi-title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-white text-sm mt-1 outline-none focus:border-amber-500">
        </div>

        <div id="timeline-container" class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-3 min-h-[300px]">
            </div>

        <div class="grid grid-cols-3 gap-2 mt-6 p-4 bg-white/5 rounded-2xl border border-white/5">
            <button onclick="addTimelineBlock('npc')" class="py-3 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 text-[10px] font-black rounded-xl border border-blue-600/30 transition-all">+ NPC ÎåÄÏÇ¨ Ï∂îÍ∞Ä</button>
            <button onclick="addTimelineBlock('monologue')" class="py-3 bg-purple-600/20 hover:bg-purple-600/40 text-purple-400 text-[10px] font-black rounded-xl border border-purple-600/30 transition-all">+ ÎÇòÏùò ÎèÖÎ∞± Ï∂îÍ∞Ä</button>
            <button onclick="addTimelineBlock('choice')" class="py-3 bg-amber-600/20 hover:bg-amber-600/40 text-amber-400 text-[10px] font-black rounded-xl border border-amber-600/30 transition-all">+ ÏÑ†ÌÉùÏßÄ Ï∂îÍ∞Ä</button>
        </div>

        <div class="flex gap-3 mt-6">
            <button onclick="savePOITimeline()" class="flex-1 py-4 bg-amber-600 text-white font-black rounded-xl text-[10px] uppercase shadow-xl hover:bg-amber-700">Save Scenario</button>
            <button onclick="document.getElementById('poi-editor-modal').classList.add('hidden')" class="px-8 py-4 bg-neutral-800 text-neutral-500 font-bold rounded-xl text-[10px] uppercase">Cancel</button>
        </div>
    </div>
</div>
        <!-- Toast -->
        <div id="toast" class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 z-[150]">
            <div class="bg-amber-600 text-white px-8 py-4 rounded-2xl shadow-2xl font-black text-[10px] tracking-widest uppercase flex items-center gap-3 border border-amber-400/20 modal-enter">
                <i data-lucide="shield" class="w-4 h-4"></i>
                <span id="toast-message">Notification</span>
            </div>
        </div>
        
        <!-- Ïù∏Î≤§ÌÜ†Î¶¨ Î™®Îã¨ -->
        <div id="inventory-modal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center backdrop-blur-md p-6">
            <div class="w-full max-w-4xl bg-neutral-900 border border-amber-500/30 rounded-3xl shadow-2xl overflow-hidden modal-enter">
                <div class="p-8 border-b border-white/5 flex justify-between items-center bg-black/40">
                    <div>
                        <h3 class="text-2xl font-black text-white uppercase italic tracking-tighter">Inventory</h3>
                        <p class="text-[10px] text-amber-500 uppercase tracking-widest mt-1">Your Items</p>
                    </div>
                    <button onclick="closeInventory()" class="text-neutral-500 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="inventory-content" class="p-8 max-h-[60vh] overflow-y-auto custom-scrollbar">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- ÏïÑÏù¥ÌÖúÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê® -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
<audio id="noti-sound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc, deleteDoc, writeBatch, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7XJPpZzfDbdDCsbzMVO9HTZqrpUlMX-Y",
            authDomain: "macol-acead.firebaseapp.com",
            projectId: "macol-acead",
            storageBucket: "macol-acead.firebasestorage.app",
            messagingSenderId: "231346298031",
            appId: "1:231346298031:web:3982e3b72e7214d177485a"
        };
        const appId = "oc-community-html-v6";
        const ADMIN_PW = "admin1234";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // db, auth, appIdÎ•º Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂ú (Combat Skills Ìé∏ÏßëÍ∏∞ Î∞è Í¥ÄÎ¶¨Ïûê Í∏∞Îä•ÏóêÏÑú ÏÇ¨Ïö©)
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        
        // Firestore Ìï®ÏàòÎì§ÎèÑ Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂ú
        window.collection = collection;
        window.doc = doc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.writeBatch = writeBatch;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.onSnapshot = onSnapshot;
        window.query = query;
window.where = where;
window.orderBy = orderBy;
window.limit = limit;

        const $ = (id) => document.getElementById(id);

        // --- Global State ---
        let state = {
            user: null,
            userAccount: null,
            accounts: [],
            chatRooms: [],
            messages: [],
            currentView: 'home',
            authMode: 'login',
            isAdmin: false,
            selectedRoomId: null,
            initDone: false,
            world: {
                title: "REVERSE: 1999 STYLE HUB",
                description: "Keep moving forward."
            },
            investigation: {
    selectedSector: null, // ÌòÑÏû¨ Ïú†Ï†ÄÍ∞Ä Îì§Ïñ¥Í∞Ñ Íµ¨Ïó≠ ID
        foundClueIds: [],      // Ïú†Ï†ÄÍ∞Ä Î∞úÍ≤¨Ìïú Îã®ÏÑúÎì§
        logs: [],
        viewedClueIds: [],     // Ï†ÑÎ¨∏ÏùÑ ÌôïÏù∏Ìïú Îã®ÏÑúÎì§ (NEW ÌëúÏãú Ï†úÍ±∞Ïö©)
        sectors: [
            { id: 'academy', name: 'ÏïÑÏπ¥Îç∞ÎØ∏', map: 'https://images.unsplash.com/photo-1523050853061-80e8a4ff147e?q=80&w=2000', desc: 'Í∏àÏßÄÎêú ÏßÄÏãùÏù¥ Ïû†Îì† Í≥≥', unlockDate: '11Ïõî 12Ïùº', isAvailable: true },
            { id: 'forest', name: 'Ïà≤', map: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2000', desc: 'Í∏∞Ï≤ôÏù¥ ÏÇ¨ÎùºÏßÑ ÌÉúÍ≥†Ïùò Ïà≤', unlockDate: '11Ïõî 14Ïùº', isAvailable: false },
            { id: 'lake', name: 'Ìò∏Ïàò', map: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2000', desc: 'ÎπÑÎ™ÖÏùÑ ÏÇºÌÇ® Í≥†ÏöîÌïú ÏàòÎ©¥', unlockDate: '11Ïõî 15Ïùº', isAvailable: false }
        ],
        points: [
            // sector ÌïÑÎìúÎ•º Ï∂îÍ∞ÄÌïòÏó¨ Í∞Å Íµ¨Ïó≠Ïóê ÎßûÍ≤å Î∞∞ÏπòÌï©ÎãàÎã§.
            { id: 'p1', sector: 'academy', x: 25, y: 40, title: 'Old Harbor', clue: 'Ìï≠Íµ¨ Ï∞ΩÍ≥† Îí§ÏóêÏÑú Ï†ñÏùÄ Ï™ΩÏßÄÎ•º Î∞úÍ≤¨ÌñàÏäµÎãàÎã§.' },
            { id: 'p2', sector: 'forest', x: 60, y: 30, title: 'Central Tower', clue: 'ÌÉÄÏõå ÌÜµÏ†úÏã§ Îã®ÎßêÍ∏∞ÏóêÏÑú Î°úÍ∑∏Î•º Ï∂îÏ∂úÌñàÏäµÎãàÎã§.' }
        ]
    }
};
window.state = state;

        // --- App Lifecycle ---
        window.addEventListener('DOMContentLoaded', () => {
    initAuth();
    setupAuthEvents();
    
    // ÏïàÏ†ÑÌïòÍ≤å ÏöîÏÜåÎ•º Ï∞æÏïÑÏÑú ÏûàÏùÑ ÎïåÎßå Ïù¥Î≤§Ìä∏Î•º Ïó∞Í≤∞Ìï©ÎãàÎã§.
    const adminTrigger = document.getElementById('admin-mode-trigger');
    if (adminTrigger) {
        adminTrigger.onclick = () => {
            const authView = document.getElementById('auth-view');
            if (authView) authView.classList.add('hidden');
            switchView('admin');
        };
    }
});
function getURLParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        userId: params.get('userId'),
        fromHomepage: params.get('fromHomepage') === 'true'
    };
}

const urlParams = getURLParams();
        async function initAuth() {
            onAuthStateChanged(auth, async (user) => {
                state.user = user;
                if (user) {
                    subscribeToData();
                } else {
                    hideLoading();
                    showAuthGate();
                }
            });

            if (!auth.currentUser) {
                try { await signInAnonymously(auth); } catch(e) { hideLoading(); showAuthGate(); }
            }
        }

        function hideLoading() {
            const overlay = $('loading-overlay');
            if (overlay) { overlay.style.opacity = '0'; setTimeout(() => overlay.classList.add('hidden'), 1000); }
            $('app-container').classList.remove('opacity-0');
        }

function subscribeToData() {
    const accountsRef = collection(db, 'artifacts', appId, 'public', 'data', 'accounts');
    const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms');
    const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
    const reportsRef = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
    const notiRef = collection(db, 'artifacts', appId, 'public', 'data', 'notifications');

    const loadTime = Date.now() / 1000;

    // 1. ÏõîÎìú & Ïä§ÌÜ†Î¶¨
    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world'), (docSnap) => {
    if (docSnap.exists()) {
        const fetchedData = docSnap.data();
        
        // [ÌïµÏã¨] ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞Î•º Î°úÏª¨ stateÏóê Î≥µÏÇ¨
        state.world = { ...state.world, ...fetchedData };
        
        // [Ï§ëÏöî] Ï°∞ÏÇ¨ Îç∞Ïù¥ÌÑ∞(Ìè¨Ïù∏Ìä∏, Î∞∞Í≤Ω, ÏûêÎ¨ºÏá†)Í∞Ä ÏÑúÎ≤ÑÏóê ÏûàÏúºÎ©¥ ÎçÆÏñ¥ÏîåÏõÄ
        if (fetchedData.investigation) {
            state.investigation = { 
                ...state.investigation, 
                ...fetchedData.investigation 
            };
        }
        
        console.log("‚úÖ ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å:", state.investigation);
    }
    if (!state.world.classes) {
    state.world.classes = [
        { code: 'VANGUARD', name: 'VANGUARD', color: '#dc2626' }, // Îπ®Í∞ï
        { code: 'SNIPER', name: 'SNIPER', color: '#ea580c' },   // Ï£ºÌô©
        { code: 'CASTER', name: 'CASTER', color: '#7c3aed' },   // Î≥¥Îùº
        { code: 'MEDIC', name: 'MEDIC', color: '#16a34a' },     // Ï¥àÎ°ù
        { code: 'GUARD', name: 'GUARD', color: '#2563eb' },     // ÌååÎûë
        { code: 'SPECIALIST', name: 'SPECIALIST', color: '#db2777' } // ÌïëÌÅ¨
    ];
}
    
    // ÌòÑÏû¨ Î≥¥Í≥† ÏûàÎäî ÌôîÎ©¥Ïù¥ 'home'Ïù¥ÎÇò 'investigation'Ïù¥Î©¥ Ï¶âÏãú Îã§Ïãú Í∑∏Î¶¨Í∏∞
    if (state.currentView === 'home') renderView('home');
    if (state.currentView === 'investigation') renderView('investigation');
});
    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'story'), (docSnap) => {
        state.storyData = docSnap.exists() ? docSnap.data() : { chapters: [] };
        if (state.currentView === 'operation' && document.getElementById('story-timeline-root')) window.renderStoryTimeline();
    });

    // 2. Í≥ÑÏ†ï
    onSnapshot(accountsRef, (snapshot) => {
        state.accounts = snapshot.docs.map(d => d.data());
        updateUserSession();
        if (['members', 'admin', 'mail'].includes(state.currentView)) renderView(state.currentView);
    });
    
    // 2-1. ÎÇ¥ Í≥ÑÏ†ï Î¨∏ÏÑú Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà (HP/MP/inventory Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ)
    let myAccountUnsubscribe = null;
    const setupMyAccountListener = () => {
        if (myAccountUnsubscribe) myAccountUnsubscribe();
        
        if (state.userAccount?.loginId) {
            const myAccountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', state.userAccount.loginId);
            myAccountUnsubscribe = onSnapshot(myAccountRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // currentHP/currentMP ÏóÖÎç∞Ïù¥Ìä∏
                    if (data.currentHP !== undefined) {
                        state.userAccount.currentHP = data.currentHP;
                    }
                    if (data.currentMP !== undefined) {
                        state.userAccount.currentMP = data.currentMP;
                    }
                    
                    // inventory ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑ†Î¨º Î∞õÏùÄ Í≤ΩÏö∞ Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ)
                    if (data.inventory !== undefined) {
                        state.userAccount.inventory = data.inventory;
                        console.log("üì¶ Ïù∏Î≤§ÌÜ†Î¶¨ Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏:", data.inventory.length, "Í∞ú ÏïÑÏù¥ÌÖú");
                    }
                    
                    // ‚≠ê state.accounts Î∞∞Ïó¥ÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏ (Î©§Î≤Ñ Í∞§Îü¨Î¶¨Ïö©)
                    const accountIndex = state.accounts.findIndex(a => a.loginId === state.userAccount.loginId);
                    if (accountIndex !== -1) {
                        if (data.currentHP !== undefined) {
                            state.accounts[accountIndex].currentHP = data.currentHP;
                        }
                        if (data.currentMP !== undefined) {
                            state.accounts[accountIndex].currentMP = data.currentMP;
                        }
                        if (data.inventory !== undefined) {
                            state.accounts[accountIndex].inventory = data.inventory;
                        }
                    }
                    
                    // ÌòÑÏû¨ ÌîÑÎ°úÌïÑ ÌôîÎ©¥Ïù¥Î©¥ Ïû¨Î†åÎçîÎßÅ
                    if (state.currentView === 'profile') {
                        renderProfile();
                    }
                    
                    // Î©§Î≤Ñ Í∞§Îü¨Î¶¨ ÌôîÎ©¥Ïù¥Î©¥ Ïû¨Î†åÎçîÎßÅ
                    if (state.currentView === 'members') {
                        renderMembers();
                    }
                    
                    console.log("üîÑ HP/MP Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏:", data.currentHP, "/", data.stat_hp, ",", data.currentMP, "/", data.stat_mp);
                }
            });
        }
    };

    // 3. Ï±ÑÌåÖÎ∞© (Î™©Î°ù Í∞±Ïã†)
    onSnapshot(roomsRef, (snapshot) => {
        state.chatRooms = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        if (state.currentView === 'mail') renderMail();
        renderSidebarUI();
    });

    // 4. [ÌïµÏã¨ ÏàòÏ†ï] Î©îÏãúÏßÄ Í∞êÏßÄ & Ïã§ÏãúÍ∞Ñ ÏùΩÏùå Ï≤òÎ¶¨
    onSnapshot(messagesRef, (snapshot) => {
        state.messages = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        
        // ÌôîÎ©¥ Í∞±Ïã†
        if (state.currentView === 'mail' || state.isAdmin) renderView(state.currentView);
        renderSidebarUI();

        snapshot.docChanges().forEach(async (change) => {
            if (change.type === 'added') {
                const msg = change.doc.data();
                const myId = state.userAccount?.loginId;
                
                if (!state.initDone || !myId || msg.fromId === myId || msg.fromId === 'system') return;
                if (msg.timestamp && msg.timestamp.seconds <= loadTime) return;

                const room = state.chatRooms.find(r => r.id === msg.roomId);
                if (!room || !room.members.includes(myId)) return;

                // [Ï∂îÍ∞ÄÎê®] ÎßåÏïΩ ÎÇ¥Í∞Ä ÌòÑÏû¨ Ïù¥ Î∞©ÏùÑ Î≥¥Í≥† ÏûàÎã§Î©¥? -> Ï¶âÏãú ÏùΩÏùå Ï≤òÎ¶¨ (DB ÏóÖÎç∞Ïù¥Ìä∏)
                // Ïù¥Î†áÍ≤å Ìï¥Ïïº Îã§Î•∏ Î∞© Í∞îÎã§ ÏôÄÎèÑ NEWÍ∞Ä Ïïà ÎúπÎãàÎã§.
                if (state.currentView === 'mail' && state.selectedRoomId === msg.roomId) {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', msg.roomId);
                    // lastRead ÌïÑÎìúÏóê ÎÇ¥ ÏïÑÏù¥ÎîîÏôÄ ÌòÑÏû¨ ÏãúÍ∞Ñ Í∏∞Î°ù
                    updateDoc(roomRef, {
                        [`lastRead.${myId}`]: serverTimestamp()
                    }).catch(console.error);
                }

                // ÏïåÎ¶º ÏÉùÏÑ± Î°úÏßÅ (Î≥¥Í≥† ÏûàÎäî Î∞©Ïù¥Î©¥ ÏïåÎ¶º ÏÉùÎûµ Í∞ÄÎä•ÌïòÏßÄÎßå, ÏùºÎã® Í∏∞Î°ùÏùÄ ÎÇ®ÍπÄ)
                const isMuted = room.muted && room.muted[myId];
                if (isMuted) return;

                const newBody = `${msg.fromName}: ${msg.body.substring(0, 30)}${msg.body.length>30?'...':''}`;
                const existingNoti = state.notifications ? state.notifications.find(n => n.roomId === msg.roomId) : null;

                try {
                    if (existingNoti) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', existingNoti.id), {
                            message: newBody, timestamp: serverTimestamp(), isRead: false
                        });
                    } else {
                        await addDoc(notiRef, {
                            targetUserId: myId, roomId: msg.roomId, title: `Message from [${room.name}]`,
                            message: newBody, memo: "Unread Message", timestamp: serverTimestamp(), isRead: false
                        });
                    }
                } catch(e) { console.error(e); }
            }
        });
    });

    // 5. Í∏∞ÌÉÄ Î¶¨Ïä§ÎÑà
    onSnapshot(reportsRef, (snapshot) => {
        state.reports = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        if (state.isAdmin && state.currentView === 'admin') window.updateAdminReportsUI(); 
    });
    onSnapshot(notiRef, (snapshot) => {
        state.rawNotifications = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        updateMyNotifications();
    });
}
        async function updateUserSession() {
    console.log("üîÑ updateUserSession Ìò∏Ï∂úÎê®");
    if (!state.user) {
        console.log("‚ùå state.user ÏóÜÏùå");
        return;
    }
    
    const myAcc = state.accounts.find(a => a.uid === state.user.uid);
    console.log("üë§ ÎÇ¥ Í≥ÑÏ†ï Ï†ïÎ≥¥:", myAcc);
    console.log("üéØ combatSkills:", myAcc?.combatSkills);
    state.userAccount = myAcc || { status: 'new' };
    
    // inventoryÏôÄ currentHP/currentMP Î°úÎìú (users Ïª¨Î†âÏÖòÏóêÏÑú)
    if (state.user.uid && myAcc?.loginId) {
        try {
            const userRef = doc(db, 'artifacts', appId, 'users', state.user.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const userData = userSnap.data();
                if (userData.inventory) {
                    state.userAccount.inventory = userData.inventory;
                    console.log("üì¶ Ïù∏Î≤§ÌÜ†Î¶¨ Î°úÎìú ÏôÑÎ£å:", userData.inventory.length, "Í∞ú ÏïÑÏù¥ÌÖú");
                }
            }
            
            // accountsÏóêÏÑú currentHP/currentMP Î°úÎìú
            const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', myAcc.loginId);
            const accountSnap = await getDoc(accountRef);
            if (accountSnap.exists()) {
                const accountData = accountSnap.data();
                
                // inventoryÎèÑ accountsÏóêÏÑú Î°úÎìú (accountsÍ∞Ä Îçî ÏµúÏã†Ïùº Ïàò ÏûàÏùå)
                if (accountData.inventory !== undefined) {
                    state.userAccount.inventory = accountData.inventory;
                    console.log("üì¶ accountsÏóêÏÑú Ïù∏Î≤§ÌÜ†Î¶¨ Î°úÎìú:", accountData.inventory.length, "Í∞ú ÏïÑÏù¥ÌÖú");
                }
                
                // HP/MP Ï¥àÍ∏∞Ìôî (Í∏∞Ï°¥ Ïú†Ï†ÄÎ•º ÏúÑÌï¥)
                let needsUpdate = false;
                const updates = {};
                
                if (accountData.currentHP !== undefined) {
                    state.userAccount.currentHP = accountData.currentHP;
                    console.log("‚ù§Ô∏è ÌòÑÏû¨ HP Î°úÎìú:", accountData.currentHP);
                } else {
                    // HPÍ∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                    state.userAccount.currentHP = accountData.stat_hp || 100;
                    updates.currentHP = state.userAccount.currentHP;
                    needsUpdate = true;
                    console.log("‚ù§Ô∏è Ï¥àÍ∏∞ HP ÏÑ§Ï†ï:", state.userAccount.currentHP);
                }
                
                if (accountData.currentMP !== undefined) {
                    state.userAccount.currentMP = accountData.currentMP;
                    console.log("üíß ÌòÑÏû¨ MP Î°úÎìú:", accountData.currentMP);
                } else {
                    // MPÍ∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                    state.userAccount.currentMP = accountData.stat_mp || 50;
                    updates.currentMP = state.userAccount.currentMP;
                    needsUpdate = true;
                    console.log("üíß Ï¥àÍ∏∞ MP ÏÑ§Ï†ï:", state.userAccount.currentMP);
                }
                
                // ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÌïÑÏöîÌïòÎ©¥ FirestoreÏóê Ï†ÄÏû•
                if (needsUpdate) {
                    await setDoc(accountRef, updates, { merge: true });
                    console.log("‚úÖ Ï¥àÍ∏∞ HP/MP FirestoreÏóê Ï†ÄÏû• ÏôÑÎ£å");
                }
            }
        } catch(e) {
            console.error("‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:", e);
        }
    }
    
    if (myAcc && myAcc.status === 'approved') {
        console.log("‚úÖ ÏäπÏù∏Îêú Í≥ÑÏ†ï - Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô");
        // [Ï∂îÍ∞ÄÎê®] Í∂åÌïú Ï≤¥ÌÅ¨: 'staff' Îì±Í∏âÏù¥Î©¥ Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÏûêÎèô Î∂ÄÏó¨
        if (myAcc.role === 'staff') {
            state.isAdmin = true;
            console.log("üîë Í¥ÄÎ¶¨Ïûê Í∂åÌïú Î∂ÄÏó¨Îê®");
        }

        // [Ï∂îÍ∞ÄÎê®] users Ïª¨Î†âÏÖòÏóê Î¨∏ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏûêÎèô ÏÉùÏÑ± (ÏΩîÏù∏ Ï†ïÎ≥¥ Ìè¨Ìï®)
        try {
            const userRef = doc(db, 'artifacts', appId, 'users', state.user.uid);
            await setDoc(userRef, {
                loginId: myAcc.loginId,
                coins: myAcc.coins || 0,
                lastLogin: serverTimestamp()
            }, { merge: true });
            console.log("‚úÖ users Î¨∏ÏÑú ÎèôÍ∏∞Ìôî ÏôÑÎ£å");
        } catch(e) {
            console.error("‚ùå users Î¨∏ÏÑú ÏÉùÏÑ± Ïã§Ìå®:", e);
        }

        hideLoading();
        $('auth-view').classList.add('hidden');
        updateProfileBarUI();
        
        // HP/MP Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        if (typeof setupMyAccountListener === 'function') {
            setupMyAccountListener();
        }
        
        // Î°úÍ∑∏Ïù∏ ÏôÑÎ£å Ïãú ÏïåÎ¶º Î™©Î°ù Í∞±Ïã†
        if (typeof updateMyNotifications === 'function') updateMyNotifications();

        if (!state.initDone) {
            console.log("üé¨ Ï≤´ Î°úÍ∑∏Ïù∏ - ÏÇ¨Ïù¥ÎìúÎ∞î Î†åÎçîÎßÅ Î∞è Ìôà ÌôîÎ©¥ Ï†ÑÌôò");
            renderSidebarUI();
            switchView('home');
            state.initDone = true;
        }
    } else if (myAcc && myAcc.status === 'pending') {
        console.log("‚è≥ ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ë");
        hideLoading();
        showPendingGateUI();
    } else {
        console.log("üÜï Ïã†Í∑ú ÏÇ¨Ïö©Ïûê");
        hideLoading();
        showAuthGate();
    }
}

      window.switchView = (viewId) => {
    if (state.currentView === viewId && state.initDone) return;

    // ‚úÖ [Ï∂îÍ∞ÄÌï† Î∂ÄÎ∂Ñ] Ï°∞ÏÇ¨(investigation) ÌÉ≠ÏúºÎ°ú Ïù¥ÎèôÌï† ÎïåÎßàÎã§ Ïû•ÏÜå Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
    // Ïù¥Î†áÍ≤å ÌïòÎ©¥ Ìï≠ÏÉÅ 'Î™©Î°ù ÌôîÎ©¥'Î∂ÄÌÑ∞ ÏãúÏûëÌïòÍ≤å Îê©ÎãàÎã§.
    if (viewId === 'investigation' && state.investigation) {
        state.investigation.currentPoi = null;
    }

    const area = $('content-area');
    area.classList.add('view-exit');
    setTimeout(() => {
        state.currentView = viewId;
        area.classList.remove('view-exit');
        area.classList.add('view-enter');
        
        renderView(viewId); // Ïù¥Ï†ú Ï¥àÍ∏∞ÌôîÎêú ÏÉÅÌÉú(Î™©Î°ù)Î°ú Î†åÎçîÎßÅÎê©ÎãàÎã§.
        
        updateSidebarUI();
        setTimeout(() => area.classList.remove('view-enter'), 500);
    }, 300);
};

        function renderView(viewId) {
    const area = $('content-area');
    
    // Î©îÏùº ÌôîÎ©¥ Ïú†ÏßÄ Î°úÏßÅ
    const isMailUpdate = (viewId === 'mail' && document.getElementById('mail-view-root'));
    if (!isMailUpdate) {
        area.innerHTML = '';
    }
    
    switch(viewId) {
    case 'home': renderHome(); break;
    case 'mail': renderMail(); break;
    case 'operation': renderOperation(); break;
    case 'investigation': renderInvestigation(); break; 
    case 'members': renderMembers(); break; 
    case 'profile': renderProfile(); break;
    case 'admin': renderAdmin(); break;
    case 'visit': renderVisitProfile(); break;
}
    
    // ÏÇ¨Ïù¥ÎìúÎ∞î UIÎèÑ ÏÉÅÌÉúÏóê ÎßûÏ∂∞ Í∞±Ïã† (ÌôúÏÑ±Ìôî Î≤ÑÌäº ÏÉâÏÉÅ Î≥ÄÍ≤Ω Îì±)
    renderSidebarUI();
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
        // --- View Content Creators ---
        function renderHome() {
    const oc = state.userAccount || {};
    const world = state.world || {};
    
    // ÏïåÎ¶º ÌôïÏù∏
    const myNotis = state.notifications || [];
    const hasNoti = myNotis.length > 0;

    // Ïù¥Î¶Ñ Í∏∏Ïù¥ Ï°∞Ï†à
    const nameLen = (oc.ocName || '').length;
    let nameSize;
    if (nameLen > 12) nameSize = "clamp(2rem, 4vw, 4rem)";
    else if (nameLen > 7) nameSize = "clamp(2.5rem, 5vw, 6rem)";
    else nameSize = "clamp(3rem, 6vw, 8rem)";

    $('content-area').innerHTML = `
        <div class="relative h-full w-full flex flex-col overflow-hidden bg-[#0a0a0a]">
            
            <div class="absolute inset-0 z-0">
                <img src="${oc.profile || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png'}" 
                     class="w-full h-full object-cover opacity-80 blur-[10px] scale-110 grayscale brightness-50">
                <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0a] via-[#0a0a0a]/80 to-transparent"></div>
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMDUpIiAvPgo8L3N2Zz4=')] opacity-20"></div>
            </div>

            <div class="absolute inset-y-0 right-[2%] lg:right-[8%] w-[80%] lg:w-[55%] z-10 pointer-events-none flex items-end justify-end">
                <img src="${oc.profile || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png'}" 
                     class="h-[90%] w-full object-contain object-bottom drop-shadow-2xl opacity-100 mask-image-bottom">
            </div>

            <div class="absolute top-8 right-8 z-50 pointer-events-auto">
                <button onclick="toggleNotificationModal()" class="relative group p-3 bg-neutral-900/50 rounded-full border border-white/10 hover:border-amber-500 hover:bg-amber-600/20 transition-all">
                    <i data-lucide="bell" class="w-6 h-6 text-neutral-400 group-hover:text-amber-500 transition-colors"></i>
                    ${hasNoti ? `<span class="absolute top-0 right-0 w-3 h-3 bg-red-600 rounded-full border-2 border-black animate-pulse"></span>` : ''}
                </button>
                
                <div id="noti-dropdown" class="hidden absolute top-14 right-0 w-80 bg-neutral-900 border border-amber-600/30 rounded-2xl shadow-2xl overflow-hidden backdrop-blur-xl animate-fade-in">
                    <div class="p-4 border-b border-white/5 flex justify-between items-center">
                        <span class="text-xs font-bold text-amber-500 uppercase tracking-widest">System Alerts</span>
                        <button onclick="clearAllNotifications()" class="text-[9px] text-neutral-500 hover:text-white uppercase underline">Clear All</button>
                    </div>
                    <div class="max-h-64 overflow-y-auto custom-scrollbar p-2 space-y-2">
                        ${myNotis.length === 0 ? `<p class="text-center text-[10px] text-neutral-600 py-6 italic">No new signals.</p>` : 
                            myNotis.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0)).map(n => `
                            <div class="p-3 bg-black/40 rounded-xl border border-white/5 flex gap-3 relative group">
                                <div class="w-8 h-8 rounded-full bg-amber-600/20 flex items-center justify-center shrink-0 text-amber-500"><i data-lucide="info" class="w-4 h-4"></i></div>
                                <div>
                                    <p class="text-xs text-white font-bold mb-1">${n.title}</p>
                                    <p class="text-[10px] text-neutral-400 leading-relaxed">${n.message}</p>
                                    ${n.memo ? `<p class="text-[10px] text-amber-500/80 mt-1 pl-2 border-l-2 border-amber-500/30 italic">" ${n.memo} "</p>` : ''}
                                    <p class="text-[8px] text-neutral-600 font-mono mt-1">${n.timestamp ? new Date(n.timestamp.seconds*1000).toLocaleString() : ''}</p>
                                </div>
                                <button onclick="deleteNotification('${n.id}')" class="absolute top-2 right-2 text-neutral-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>

            <div class="relative z-20 h-full flex flex-col justify-center pl-12 lg:pl-24 max-w-[65%] pointer-events-none">
                
                <div class="mb-6 flex items-center gap-4 animate-slide-up" style="animation-delay: 0.1s;">
                    <div class="bg-amber-600/20 text-amber-500 px-4 py-1.5 border border-amber-500/30 rounded-full text-[10px] font-black tracking-[0.3em] uppercase backdrop-blur-md">
                        ${oc.badgeText || 'Dossier: Authorized'}
                    </div>
                </div>

                <h1 class="font-serif font-black text-white tracking-tighter uppercase whitespace-nowrap leading-none mb-8 drop-shadow-xl animate-slide-up" 
                    style="font-size: ${nameSize}; animation-delay: 0.2s;">
                    ${oc.ocName || 'Personnel'}
                </h1>

                <div class="border-l-4 border-amber-600 pl-6 animate-slide-up" style="animation-delay: 0.3s;">
                    <h3 class="text-2xl lg:text-4xl font-serif font-bold text-white mb-4 leading-tight tracking-tight">
                        ${oc.slogan || 'ÏãúÎåÄÏóê ÌöçÏùÑ Í∑∏ÏùÑ Ïä§ÌÉÄÏùº'}
                    </h3>
                    <p class="text-xs text-neutral-400 tracking-wide font-mono leading-relaxed max-w-md opacity-70">
                        ${oc.shortDesc || world.description}
                    </p>
                </div>

                <div class="mt-12 hidden lg:block animate-pulse max-w-md">
                    <p class="text-[10px] text-amber-500/60 font-mono tracking-[0.1em] leading-loose uppercase text-justify break-words whitespace-pre-line">
                        ${(oc.stats || 'No authorized records found.').substring(0, 300)}
                    </p>
                </div>

                <div class="mt-10 pointer-events-auto w-fit animate-slide-up" style="animation-delay: 0.4s;">
                    ${oc.linkUrl ? `
                    <a href="${oc.linkUrl}" target="_blank" class="group cursor-pointer hover:scale-105 transition-transform block">
                        <div class="bg-amber-600/10 backdrop-blur-md border border-amber-500/30 p-1 rounded-lg">
                            <div class="bg-amber-600 w-32 h-12 rounded-md relative overflow-hidden flex flex-col items-center justify-center border border-amber-400/50 shadow-[0_0_20px_rgba(217,119,6,0.4)]">
                                <div class="absolute top-0 left-0 w-full h-[1px] bg-amber-400/50"></div>
                                <div class="absolute bottom-0 left-0 w-full h-[1px] bg-amber-400/50"></div>
                                <div class="absolute -left-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-[#0a0a0a] rounded-full"></div>
                                <div class="absolute -right-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-[#0a0a0a] rounded-full"></div>
                                <p class="text-[6px] text-black/60 font-black uppercase tracking-widest mb-0.5">External Link</p>
                                <h3 class="text-xs text-white font-serif font-black uppercase tracking-tighter italic drop-shadow-md flex items-center gap-1">
                                    ${oc.linkText || 'ENTER'} <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </h3>
                            </div>
                        </div>
                    </a>` : ''}
                </div>
            </div>

            <div class="absolute right-6 lg:right-12 top-1/2 -translate-y-1/2 z-30 flex flex-col gap-4 pointer-events-auto">
                <a href="${world.banner1_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner1_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 01</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner1_text || 'NOTICE'}</h4></div>
                </a>
                <a href="${world.banner2_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner2_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 02</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner2_text || 'MISSION'}</h4></div>
                </a>
                <a href="${world.banner3_url || '#'}" target="_blank" class="block w-48 h-24 bg-neutral-900/80 border border-white/10 rounded-xl overflow-hidden relative group hover:border-amber-500 transition-all hover:scale-105 shadow-2xl">
                    <img src="${world.banner3_img || ''}" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-all duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                    <div class="absolute bottom-3 right-4 text-right"><p class="text-[10px] text-amber-500 font-mono uppercase tracking-widest">System 03</p><h4 class="text-lg font-black text-white uppercase italic leading-none">${world.banner3_text || 'SCHEDULE'}</h4></div>
                </a>
            </div>

            <div class="absolute bottom-10 right-12 z-20 text-right pointer-events-none hidden lg:block">
                <h2 class="text-6xl font-black text-amber-600/20 tracking-tighter uppercase font-mono transform rotate-0">ABCD EASO</h2>
                <div class="flex justify-end gap-3 mt-3 pr-1"><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-1"></div><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-2"></div><div class="w-2 h-2 rounded-full bg-amber-600 loading-dot-3"></div></div>
            </div>
            <div class="absolute bottom-12 left-[30%] flex gap-12 opacity-60 pointer-events-none hidden lg:flex">
                <p class="text-[20px] text-amber-500 font-serif italic tracking-wider">${oc.keyword1 || 'Keyword 1'}</p>
                <p class="text-[20px] text-amber-400 font-serif italic tracking-wider">${oc.keyword2 || 'Keyword 2'}</p>
                <p class="text-[20px] text-amber-300 font-serif italic tracking-wider">${oc.keyword3 || 'Keyword 3'}</p>
            </div>
        </div>

        <style>
            .mask-image-bottom { -webkit-mask-image: linear-gradient(to top, transparent 0%, black 20%); mask-image: linear-gradient(to top, transparent 0%, black 20%); }
            .animate-slide-up { animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
            @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
            @keyframes loadDot { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
            .loading-dot-1 { animation: loadDot 1.2s infinite; animation-delay: 0s; }
            .loading-dot-2 { animation: loadDot 1.2s infinite; animation-delay: 0.2s; }
            .loading-dot-3 { animation: loadDot 1.2s infinite; animation-delay: 0.4s; }
        </style>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
        function renderMail() {
    const myLoginId = state.userAccount.loginId;
    
    // 1. Î∞© Î™©Î°ù Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
    const myRooms = state.chatRooms
        .filter(r => r.members.includes(myLoginId))
        .sort((a, b) => {
            const timeA = a.lastMessageTimestamp?.seconds || 0;
            const timeB = b.lastMessageTimestamp?.seconds || 0;
            return timeB - timeA;
        });

    const selectedRoom = state.selectedRoomId ? state.chatRooms.find(r => r.id === state.selectedRoomId) : null;

    // 2. Í∏∞Î≥∏ Î†àÏù¥ÏïÑÏõÉ (ÏµúÏ¥à 1ÌöåÎßå ÏÉùÏÑ±)
    const contentArea = document.getElementById('content-area');
    if (!document.getElementById('mail-view-root')) {
        contentArea.innerHTML = `
            <div id="mail-view-root" class="flex-1 flex flex-col md:flex-row h-full bg-black/20 overflow-hidden">
                <div class="w-full md:w-80 border-r border-white/5 flex flex-col bg-neutral-950/40 h-full shrink-0">
                    <div class="p-6 border-b border-white/5 flex items-center justify-between">
                        <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2"><i data-lucide="message-square" class="w-4 h-4"></i> Transmissions</h3>
                        <button onclick="showCreateGroupModal()" class="p-2 bg-white/5 rounded-lg hover:bg-white/10 text-neutral-400 transition-all"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="mail-sidebar-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar relative"></div>
                </div>
                <div id="mail-chat-panel" class="flex-1 flex flex-col overflow-hidden h-full relative"></div>
            </div>
            
            <div id="group-modal" class="hidden fixed inset-0 z-[110] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
                 <div class="w-full max-w-md bg-neutral-900 border border-white/10 rounded-[3rem] p-10 shadow-2xl modal-enter">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter">Initialize Group</h3>
                        <button onclick="document.getElementById('group-modal').classList.add('hidden')" class="text-neutral-500 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <input id="group-name-input" type="text" placeholder="Group Codename" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white mb-6">
                    <div class="space-y-2 mb-6">
                        <p class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest">Selected Personnel</p>
                        <div class="bg-neutral-950 border border-white/5 rounded-xl p-3 min-h-[3rem] flex flex-wrap gap-2" id="selected-member-tags"></div>
                        <div class="relative mt-2">
                            <input id="member-search-input" type="text" onkeyup="filterGroupMembers()" placeholder="Search Name..." class="w-full bg-neutral-950 border border-white/5 rounded-xl px-4 py-3 text-xs outline-none focus:border-amber-500 text-white pl-10">
                            <i data-lucide="search" class="w-4 h-4 text-neutral-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        </div>
                    </div>
                    <div id="member-select-list" class="max-h-48 overflow-y-auto space-y-2 mb-8 custom-scrollbar"></div>
                    <button onclick="handleCreateGroup()" class="w-full py-5 bg-amber-600 text-white font-bold rounded-2xl uppercase tracking-widest text-xs active:scale-95 shadow-xl">Deploy Signal Room</button>
                </div>
            </div>

            <div id="room-members-modal" class="hidden fixed inset-0 z-[120] bg-black/80 flex items-center justify-center p-6 backdrop-blur-md" onclick="if(event.target === this) this.classList.add('hidden')">
                <div class="w-full max-w-sm bg-neutral-900 border border-amber-600/30 rounded-[2.5rem] p-8 shadow-2xl modal-enter relative">
                    <h3 class="text-lg font-serif font-black text-white uppercase tracking-tighter mb-6 border-b border-white/10 pb-4">Linked Personnel</h3>
                    <button onclick="document.getElementById('room-members-modal').classList.add('hidden')" class="absolute top-8 right-8 text-neutral-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div id="room-members-list" class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </div>
            <style>.member-checkbox:checked + .check-icon { opacity: 1; }</style>
        `;
    }

    // 3. [ÌïµÏã¨ ÏàòÏ†ï] ÏÇ¨Ïù¥ÎìúÎ∞î Ïä§ÎßàÌä∏ ÏóÖÎç∞Ïù¥Ìä∏ (ÎîîÏûêÏù∏ Î≥µÍµ¨ Î≤ÑÏ†Ñ)
    const sidebarList = document.getElementById('mail-sidebar-list');
    if (sidebarList) {
        if (myRooms.length === 0) {
            sidebarList.innerHTML = '<p class="text-center text-[10px] text-neutral-700 mt-20 uppercase tracking-widest font-mono">No active signals.</p>';
        } else {
            // ÏÇ≠Ï†úÎêú Î∞© Ï†úÍ±∞
            const currentIds = myRooms.map(r => r.id);
            Array.from(sidebarList.children).forEach(child => {
                if (child.tagName === 'BUTTON' && !currentIds.includes(child.getAttribute('data-room-id'))) {
                    child.remove();
                }
            });

            // ÏàúÏÑúÎåÄÎ°ú ÏöîÏÜå Î∞∞Ïπò
            myRooms.forEach((r, index) => {
                let el = document.getElementById(`room-item-${r.id}`);
                
                // [ÏàòÏ†ïÎê®] ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î∞©Ïù∏ÏßÄ ÌôïÏù∏
                const isSelected = selectedRoom?.id === r.id;
                const isMuted = r.muted && r.muted[myLoginId];

                // [ÏàòÏ†ïÎê®] "ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î∞©"Ïù¥ÎùºÎ©¥, Îç∞Ïù¥ÌÑ∞ÏÉÅ Ïïà ÏùΩÏùÄ Î©îÏãúÏßÄÍ∞Ä ÏûàÏñ¥ÎèÑ ÏùΩÏùÄ Í≤ÉÏúºÎ°ú Í∞ÑÏ£º (!isSelected Ï°∞Í±¥ Ï∂îÍ∞Ä)
                const hasNew = !isSelected && r.lastMessageTimestamp && (!r.lastRead || !r.lastRead[myLoginId] || r.lastRead[myLoginId].seconds < r.lastMessageTimestamp.seconds);

                const innerHTML = `
                    <div class="relative shrink-0">
                        <div class="w-12 h-12 rounded-xl bg-black border border-white/10 flex items-center justify-center overflow-hidden transition-all group-hover:border-white/30">
                            ${getRoomIconHTML(r)}
                        </div>
                        ${hasNew ? `<div class="absolute -top-2 -right-2 bg-red-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded-full border border-black shadow-md animate-bounce">NEW</div>` : ''}
                    </div>
                    <div class="flex-1 text-left overflow-hidden">
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-1">
                                <p class="text-xs font-bold uppercase truncate ${hasNew ? 'text-white' : ''}">${r.name}</p>
                                ${isMuted ? `<i data-lucide="bell-off" class="w-3 h-3 text-neutral-600 ml-1"></i>` : ''}
                            </div>
                        </div>
                        <p class="text-[10px] truncate transition-colors ${hasNew ? 'text-amber-500 font-bold' : 'text-neutral-500 group-hover:text-neutral-400'}">${r.lastMessageBody || 'No signals transmitted.'}</p>
                    </div>
                `;

                const baseClasses = "w-full p-4 rounded-2xl flex items-center gap-4 transition-all duration-500 border cursor-pointer group relative overflow-hidden";
                const activeClasses = isSelected 
                    ? "bg-amber-600/10 border-amber-500 text-white shadow-[0_0_15px_rgba(217,119,6,0.1)]" 
                    : "bg-neutral-900/40 border-white/5 text-neutral-400 hover:bg-neutral-800 hover:border-white/10";

                if (!el) {
                    // [Ïã†Í∑ú ÏÉùÏÑ±]
                    el = document.createElement('button');
                    el.id = `room-item-${r.id}`;
                    el.setAttribute('data-room-id', r.id);
                    el.onclick = () => enterRoom(r.id);
                    el.className = `${baseClasses} ${activeClasses} animate-fade-in-up`;
                    el.innerHTML = innerHTML;
                    sidebarList.appendChild(el); 
                } else {
                    // [ÏóÖÎç∞Ïù¥Ìä∏]
                    if(el.innerHTML !== innerHTML) el.innerHTML = innerHTML;
                    el.className = `${baseClasses} ${activeClasses}`;
                }

                // [ÏúÑÏπò Í∞ïÏ†ú Ï°∞Ï†ï] Î∂ÄÎìúÎü¨Ïö¥ ÏàúÏÑú Î≥ÄÍ≤Ω
                const currentChildAtIndex = sidebarList.children[index];
                if (currentChildAtIndex !== el) {
                    if (currentChildAtIndex) {
                        sidebarList.insertBefore(el, currentChildAtIndex);
                    } else {
                        sidebarList.appendChild(el);
                    }
                    // 1Îì±ÏúºÎ°ú Ïò¨ÎùºÍ∞à Îïå ÏÇ¥Ïßù Î∞òÏßùÏûÑ
                    if (index === 0) {
                        el.classList.add('bg-white/10');
                        setTimeout(() => el.classList.remove('bg-white/10'), 500);
                    }
                }
            });
        }
    }

    // 4. Ï±ÑÌåÖÎ∞© Ìå®ÎÑê (Í∏∞Ï°¥ Ïú†ÏßÄ)
    const chatPanel = document.getElementById('mail-chat-panel');
    if (!selectedRoom) {
        chatPanel.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center opacity-10 h-full"><i data-lucide="mail" class="w-24 h-24 mb-6"></i><p class="text-sm font-mono uppercase tracking-[0.5em]">Secure Signal Hub</p></div>`;
    } else {
        const msgs = state.messages.filter(m => m.roomId === selectedRoom.id).sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
        const headerIcon = getRoomIconHTML(selectedRoom);
        const currentRoomIdInput = document.getElementById('current-room-id-hidden');
        const isMuted = selectedRoom.muted && selectedRoom.muted[myLoginId];
        const isSameRoom = currentRoomIdInput && currentRoomIdInput.value === selectedRoom.id;

        const generateMessageHTML = (m, showDate) => {
            if (m.fromId === 'system') return `<div id="msg-${m.id}" class="flex justify-center my-2 animate-fade-in"><span class="text-[10px] text-amber-500/50 font-mono uppercase tracking-widest border border-amber-500/10 px-3 py-1 rounded-full bg-black/20"><i data-lucide="alert-circle" class="w-3 h-3 inline-block mr-1 -mt-0.5"></i> ${m.body}</span></div>`;
            const isMine = m.fromId === myLoginId;
            const senderAcc = state.accounts.find(a => a.loginId === m.fromId);
            const senderImg = senderAcc ? senderAcc.profile : '';
            const isDeleted = m.isDeleted === true;
            const displayBody = isDeleted ? "-ÏÇ≠Ï†úÎêú Î©îÏãúÏßÄÏûÖÎãàÎã§-" : m.body;
            const bubbleStyle = isDeleted ? "bg-neutral-800 border border-white/5 text-white/50 italic" : (isMine ? "chat-bubble-mine" : "chat-bubble-theirs");
            const deleteBtn = (isMine && !isDeleted) ? `<button onclick="deleteMessage('${m.id}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-neutral-600 hover:text-red-500 p-1" title="Delete"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : '';
            const timeStr = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';

            let dateDivider = '';
            if (showDate && m.timestamp) {
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                const dateStr = new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', dateOptions);
                dateDivider = `<div class="flex items-center justify-center my-6 opacity-60"><div class="h-px w-12 bg-gradient-to-r from-transparent to-white/20"></div><span class="px-4 text-[10px] font-mono text-neutral-500 uppercase tracking-widest border border-white/10 rounded-full py-1 bg-black/30 backdrop-blur-sm">${dateStr}</span><div class="h-px w-12 bg-gradient-to-l from-transparent to-white/20"></div></div>`;
            }

            return `${dateDivider}<div id="msg-${m.id}" class="flex ${isMine ? 'justify-end' : 'justify-start'} animate-fade-in items-end gap-3 group mb-4">${!isMine ? `<div class="w-8 h-8 rounded-lg bg-black overflow-hidden shrink-0 border border-white/10 shadow-lg"><img src="${senderImg}" class="w-full h-full object-cover"></div>` : ''}<div class="max-w-[70%] flex flex-col ${isMine ? 'items-end' : 'items-start'}">${!isMine ? `<p class="text-[9px] text-amber-500 font-bold mb-1 uppercase tracking-tighter ml-1">${m.fromName}</p>` : ''}<div class="flex items-end gap-2 ${isMine ? 'flex-row-reverse' : 'flex-row'}"><div class="p-4 rounded-2xl text-sm leading-relaxed shadow-lg ${bubbleStyle}"><p class="whitespace-pre-wrap break-words">${displayBody}</p></div><div class="flex flex-col gap-1 justify-end h-full">${deleteBtn}<p class="text-[8px] opacity-40 font-mono whitespace-nowrap">${timeStr}</p></div></div></div></div>`;
        };

        if (isSameRoom) {
            const msgContainer = document.getElementById('chat-messages-container');
            if (msgContainer) {
                msgs.forEach((m, idx) => {
                    const existingEl = document.getElementById(`msg-${m.id}`);
                    let showDate = false;
                    const currDate = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                    if(idx > 0) {
                         const prevM = msgs[idx-1];
                         const prevD = prevM.timestamp ? new Date(prevM.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                         if(currDate !== prevD) showDate = true;
                    } else showDate = true;

                    if (existingEl) {
                        if (m.isDeleted && !existingEl.innerHTML.includes("-ÏÇ≠Ï†úÎêú Î©îÏãúÏßÄÏûÖÎãàÎã§-")) existingEl.outerHTML = generateMessageHTML(m, false);
                    } else {
                         const allDates = msgContainer.querySelectorAll('.font-mono');
                         if(allDates.length > 0 && allDates[allDates.length-1].innerText === currDate) showDate = false;
                        msgContainer.insertAdjacentHTML('beforeend', generateMessageHTML(m, showDate));
                        msgContainer.scrollTop = msgContainer.scrollHeight;
                    }
                });
                const muteBtn = document.getElementById('chat-mute-btn');
                if(muteBtn) muteBtn.innerHTML = isMuted ? `<i data-lucide="bell-off" class="w-5 h-5 text-red-500"></i>` : `<i data-lucide="bell" class="w-5 h-5"></i>`;
            }
        } else {
            let lastDateStr = null;
            const fullHTML = msgs.map(m => {
                let showDate = false;
                const currDate = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : null;
                if (currDate && currDate !== lastDateStr) { showDate = true; lastDateStr = currDate; }
                return generateMessageHTML(m, showDate);
            }).join('');

            chatPanel.innerHTML = `
                <div class="flex-1 flex flex-col relative h-full overflow-hidden bg-neutral-900/10">
                    <input type="hidden" id="current-room-id-hidden" value="${selectedRoom.id}">
                    <div class="p-6 border-b border-white/5 flex items-center justify-between bg-black/40 backdrop-blur-md shrink-0">
                        <div class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="showRoomMembers('${selectedRoom.id}')">
                            <div class="w-12 h-12 rounded-xl bg-amber-600/20 border border-amber-600/30 flex items-center justify-center shrink-0 overflow-hidden">${headerIcon}</div>
                            <div>
                                <h4 class="text-sm font-bold text-white uppercase tracking-widest flex items-center gap-2">${selectedRoom.name || 'Private Signal'} <i data-lucide="chevron-down" class="w-3 h-3 text-neutral-500"></i></h4>
                                <p class="text-[9px] text-neutral-500 font-mono italic uppercase">${selectedRoom.members.length} Personnel Linked</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="chat-mute-btn" onclick="toggleRoomMute('${selectedRoom.id}')" class="p-2 text-neutral-600 hover:text-amber-500 transition-all" title="${isMuted ? "Unmute" : "Mute"}">
                                ${isMuted ? `<i data-lucide="bell-off" class="w-5 h-5 text-red-500"></i>` : `<i data-lucide="bell" class="w-5 h-5"></i>`}
                            </button>
                            <button onclick="handleLeaveRoom('${selectedRoom.id}')" class="p-2 text-neutral-600 hover:text-red-500 transition-all" title="Leave Signal"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                            <button onclick="state.selectedRoomId = null; renderMail();" class="p-2 text-neutral-600 hover:text-white transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="chat-messages-container" class="flex-1 overflow-y-auto p-8 flex flex-col">${fullHTML}</div>
                    <div class="p-6 border-t border-white/5 bg-black/40">
                        <div class="flex gap-4 items-end">
                            <textarea id="chat-input" rows="1" placeholder="Transmit signal..." class="flex-1 bg-neutral-900 border border-white/10 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white transition-all resize-none custom-scrollbar" style="min-height: 56px; max-height: 120px;" oninput="autoResize(this)" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleSendChat(); }"></textarea>
                            <button onclick="handleSendChat()" class="bg-amber-600 hover:bg-amber-700 text-white p-4 rounded-2xl shadow-xl active:scale-90 h-[56px] w-[56px] flex items-center justify-center shrink-0"><i data-lucide="send" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </div>
            `;
            const container = document.getElementById('chat-messages-container');
            if (container) container.scrollTop = container.scrollHeight;
        }
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// Ï†ÑÏó≠ Î≥ÄÏàò: ÌòÑÏû¨ Î™®Îã¨ÏóêÏÑú ÏÑ†ÌÉùÎêú Î©§Î≤ÑÎì§Ïùò ID ÏßëÌï©
// Ï†ÑÏó≠ Î≥ÄÏàò: ÏÑ†ÌÉùÎêú Î©§Î≤Ñ ID Ï†ÄÏû•
// Ï†ÑÏó≠ Î≥ÄÏàò: ÏÑ†ÌÉùÎêú Î©§Î≤Ñ ID Ï†ÄÏû•
window.selectedMemberSet = new Set();

// 1. Î™®Îã¨ Ïó¥Í∏∞ (Ï¥àÍ∏∞Ìôî Î∞è Ïú†Ï†Ä Î™©Î°ù ÏÉùÏÑ±)
window.showCreateGroupModal = () => {
    window.selectedMemberSet.clear(); // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
    
    // ÏÑ†ÌÉùÎêú ÌÉúÍ∑∏ ÌôîÎ©¥ ÎπÑÏö∞Í∏∞
    const tagContainer = document.getElementById('selected-member-tags');
    if(tagContainer) tagContainer.innerHTML = '';
    
    // Í≤ÄÏÉâÏ∞Ω Ï¥àÍ∏∞Ìôî
    const searchInput = document.getElementById('member-search-input');
    if(searchInput) searchInput.value = '';

    // [ÌïµÏã¨] Ïú†Ï†Ä Î™©Î°ù ÏÉùÏÑ±ÌïòÍ∏∞ (Ïù¥ Î∂ÄÎ∂ÑÏù¥ Îπ†Ï†∏ÏûàÏñ¥ÏÑú Î™©Î°ùÏù¥ Ïïà Îñ¥Îçò Í≤ÉÏûÖÎãàÎã§!)
    const listContainer = document.getElementById('member-select-list');
    if (listContainer) {
        // ÎÇò ÏûêÏã†ÏùÑ Ï†úÏô∏Ìïú ÏäπÏù∏Îêú Ïú†Ï†ÄÎì§Îßå ÌïÑÌÑ∞ÎßÅ
        const users = state.accounts.filter(a => a.loginId !== state.userAccount.loginId && a.status === 'approved');
        
        if (users.length === 0) {
            listContainer.innerHTML = '<p class="text-neutral-500 text-xs p-4 text-center">No other personnel available.</p>';
        } else {
            listContainer.innerHTML = users.map(u => `
                <div class="member-item flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 hover:border-amber-500/50 cursor-pointer group transition-all" onclick="toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-black overflow-hidden border border-white/10">
                            <img src="${u.profile}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <p class="member-name-text text-xs font-bold text-white group-hover:text-amber-500 transition-colors">${u.ocName}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${u.loginId}</p>
                        </div>
                    </div>
                    <div class="relative w-5 h-5 rounded-full border border-white/20 flex items-center justify-center">
                        <input type="checkbox" id="cb-${u.loginId}" class="member-checkbox appearance-none absolute inset-0 cursor-pointer" onclick="event.stopPropagation(); toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                        <div class="check-icon opacity-0 w-3 h-3 bg-amber-500 rounded-full transition-opacity"></div>
                    </div>
                </div>
            `).join('');
        }
    }

    // Î™®Îã¨ ÌëúÏãú
    document.getElementById('group-modal').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 2. Î©§Î≤Ñ ÏÑ†ÌÉù ÌÜ†Í∏Ä (Ï≤¥ÌÅ¨Î∞ïÏä§ Î∞è ÌÉúÍ∑∏ Ïó∞Îèô)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎê® -> Ìï¥Ï†ú
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-100');
            checkIcon.classList.add('opacity-0');
        }
    } else {
        // ÎØ∏ÏÑ†ÌÉù -> ÏÑ†ÌÉù
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-0');
            checkIcon.classList.add('opacity-100');
        }
    }
    renderSelectedTags();
};

// 3. ÏÑ†ÌÉùÎêú Î©§Î≤Ñ ÌÉúÍ∑∏ Í∑∏Î¶¨Í∏∞
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. Í∑∏Î£π ÏÉùÏÑ± ÏôÑÎ£å (DB Ï†ÑÏÜ°)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // Î©§Î≤Ñ Î™©Î°ù: ÎÇò + ÏÑ†ÌÉùÎêú ÏÇ¨ÎûåÎì§
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};

// 2. Î©§Î≤Ñ ÏÑ†ÌÉù ÌÜ†Í∏Ä (Ï≤¥ÌÅ¨Î∞ïÏä§ Î∞è ÌÉúÍ∑∏ Ïó∞Îèô)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎê® -> Ìï¥Ï†ú
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) checkIcon.classList.remove('opacity-100');
        if(checkIcon) checkIcon.classList.add('opacity-0');
    } else {
        // ÎØ∏ÏÑ†ÌÉù -> ÏÑ†ÌÉù
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) checkIcon.classList.remove('opacity-0');
        if(checkIcon) checkIcon.classList.add('opacity-100');
    }
    renderSelectedTags();
};

// 3. ÏÑ†ÌÉùÎêú Î©§Î≤Ñ ÌÉúÍ∑∏ Í∑∏Î¶¨Í∏∞
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. Í∑∏Î£π ÏÉùÏÑ± ÏôÑÎ£å (DB Ï†ÑÏÜ°)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // Î©§Î≤Ñ Î™©Î°ù: ÎÇò + ÏÑ†ÌÉùÎêú ÏÇ¨ÎûåÎì§
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};
        // [ÏàòÏ†ï] Ï±ÑÌåÖÎ∞© ÏûÖÏû• Ìï®Ïàò
window.enterRoom = async (roomId) => {
    // 1. ÏÉÅÌÉú Î≥ÄÍ≤Ω (ÌôîÎ©¥ Î®ºÏ†Ä Ï†ÑÌôò)
    state.selectedRoomId = roomId;
    renderMail();

    // 2. [ÌïµÏã¨] ÏÑúÎ≤ÑÏóê "ÎÇò Ïù¥ Î∞© ÏùΩÏóàÏùå" Î≥¥Í≥† (DB ÏóÖÎç∞Ïù¥Ìä∏)
    try {
        if (state.userAccount) {
            const myId = state.userAccount.loginId;
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
            
            // lastRead ÎßµÏóê ÎÇ¥ ÏïÑÏù¥Îîî ÌÇ§Î°ú ÌòÑÏû¨ ÏÑúÎ≤Ñ ÏãúÍ∞Ñ Ï†ÄÏû•
            await updateDoc(roomRef, {
                [`lastRead.${myId}`]: serverTimestamp()
            });
        }
    } catch (e) {
        console.error("Failed to mark room as read:", e);
    }
};
window.selectedMemberSet = new Set();

// 1. Î™®Îã¨ Ïó¥Í∏∞ (Ïù¥Îïå Ïú†Ï†Ä Î™©Î°ùÏùÑ ÎßåÎì§Ïñ¥ ÎÑ£ÏäµÎãàÎã§)
window.showCreateGroupModal = () => {
    window.selectedMemberSet.clear(); // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
    
    // ÏÑ†ÌÉùÎêú ÌÉúÍ∑∏ ÌôîÎ©¥ ÎπÑÏö∞Í∏∞
    const tagContainer = document.getElementById('selected-member-tags');
    if(tagContainer) tagContainer.innerHTML = '';
    
    // Í≤ÄÏÉâÏ∞Ω Ï¥àÍ∏∞Ìôî
    const searchInput = document.getElementById('member-search-input');
    if(searchInput) searchInput.value = '';

    // [ÌïµÏã¨] Ïú†Ï†Ä Î™©Î°ù ÏÉùÏÑ±ÌïòÍ∏∞
    const listContainer = document.getElementById('member-select-list');
    if (listContainer) {
        // ÎÇò ÏûêÏã†ÏùÑ Ï†úÏô∏Ìïú ÏäπÏù∏Îêú Ïú†Ï†ÄÎì§Îßå ÌïÑÌÑ∞ÎßÅ
        const users = state.accounts.filter(a => a.loginId !== state.userAccount.loginId && a.status === 'approved');
        
        if (users.length === 0) {
            listContainer.innerHTML = '<p class="text-neutral-500 text-xs p-4 text-center">No other personnel available.</p>';
        } else {
            listContainer.innerHTML = users.map(u => `
                <div class="member-item flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 hover:border-amber-500/50 cursor-pointer group transition-all" onclick="toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-black overflow-hidden border border-white/10">
                            <img src="${u.profile}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <p class="member-name-text text-xs font-bold text-white group-hover:text-amber-500 transition-colors">${u.ocName}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${u.loginId}</p>
                        </div>
                    </div>
                    <div class="relative w-5 h-5 rounded-full border border-white/20 flex items-center justify-center">
                        <input type="checkbox" id="cb-${u.loginId}" class="member-checkbox appearance-none absolute inset-0 cursor-pointer" onclick="event.stopPropagation(); toggleMemberSelection('${u.loginId}', '${u.ocName}')">
                        <div class="check-icon opacity-0 w-3 h-3 bg-amber-500 rounded-full transition-opacity"></div>
                    </div>
                </div>
            `).join('');
        }
    }

    // Î™®Îã¨ ÌëúÏãú (ÌëúÏ§Ä Î¨∏Î≤ï ÏÇ¨Ïö©)
    document.getElementById('group-modal').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 2. Î©§Î≤Ñ ÏÑ†ÌÉù ÌÜ†Í∏Ä (ÌÅ¥Î¶≠ÌïòÎ©¥ Ï≤¥ÌÅ¨/Ìï¥Ï†ú)
window.toggleMemberSelection = (id, name) => {
    const checkbox = document.getElementById(`cb-${id}`);
    const checkIcon = checkbox ? checkbox.nextElementSibling : null;
    
    if (window.selectedMemberSet.has(id)) {
        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎê® -> Ìï¥Ï†ú
        window.selectedMemberSet.delete(id);
        if(checkbox) checkbox.checked = false;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-100');
            checkIcon.classList.add('opacity-0');
        }
    } else {
        // ÎØ∏ÏÑ†ÌÉù -> ÏÑ†ÌÉù
        window.selectedMemberSet.add(id);
        if(checkbox) checkbox.checked = true;
        if(checkIcon) {
            checkIcon.classList.remove('opacity-0');
            checkIcon.classList.add('opacity-100');
        }
    }
    renderSelectedTags();
};

// 3. ÏÑ†ÌÉùÎêú Î©§Î≤Ñ ÌÉúÍ∑∏ Í∑∏Î¶¨Í∏∞ (ÏÉÅÎã®Ïóê Ïù¥Î¶Ñ ÌëúÏãú)
window.renderSelectedTags = () => {
    const container = document.getElementById('selected-member-tags');
    if (!container) return;
    
    container.innerHTML = '';

    window.selectedMemberSet.forEach(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        if (acc) {
            const tag = document.createElement('div');
            tag.className = 'bg-amber-600/20 text-amber-500 border border-amber-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 animate-fade-in';
            tag.innerHTML = `
                <span>${acc.ocName}</span>
                <button onclick="toggleMemberSelection('${id}', '${acc.ocName}'); event.stopPropagation();" class="hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(tag);
        }
    });
    
    if (window.selectedMemberSet.size === 0) {
        container.innerHTML = `<span class="text-neutral-600 text-[10px] italic">No personnel selected.</span>`;
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// 4. Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ (Ïù¥Î¶ÑÏúºÎ°ú Ï∞æÍ∏∞)
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const items = document.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden');
            } else {
                items[i].classList.add('hidden');
            }
        }
    }
};

// 5. [Ï§ëÏöî] Í∑∏Î£π ÏÉùÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú (Ïù¥Í≤ÉÎèÑ Í∞ôÏù¥ ÎçÆÏñ¥ÏîåÏõåÏïº ÏûëÎèôÌï©ÎãàÎã§)
window.handleCreateGroup = async () => {
    const name = document.getElementById('group-name-input').value.trim();
    const selectedIds = Array.from(window.selectedMemberSet);
    
    if (!name || selectedIds.length === 0) return showToast("Name and members required.");

    // Î©§Î≤Ñ Î™©Î°ù: ÎÇò + ÏÑ†ÌÉùÎêú ÏÇ¨ÎûåÎì§
    const members = [state.userAccount.loginId, ...selectedIds];
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'), {
            name: name,
            members: members,
            type: 'group',
            createdAt: serverTimestamp(),
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: "Signal Initialized.",
            lastRead: {}
        });
        
        document.getElementById('group-modal').classList.add('hidden');
        showToast("Group Created Successfully.");
    } catch(e) {
        console.error(e);
        showToast("Failed to create group.");
    }
};

        window.handleSendChat = async () => {
    const input = $('chat-input');
    const body = input.value.trim();
    if (!body || !state.selectedRoomId) return;
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
            roomId: state.selectedRoomId,
            fromId: state.userAccount.loginId,
            fromName: state.userAccount.ocName,
            body: body,
            timestamp: serverTimestamp()
        });
        
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', state.selectedRoomId);
        const lastReadUpdate = {
            lastMessageTimestamp: serverTimestamp(),
            lastMessageBody: body
        };
        lastReadUpdate[`lastRead.${state.userAccount.loginId}`] = serverTimestamp();
        await updateDoc(roomRef, lastReadUpdate);
        
        input.value = '';
        input.style.height = '56px'; // [Ï∂îÍ∞ÄÎê®] Ï†ÑÏÜ° ÌõÑ ÎÜíÏù¥ Ï¥àÍ∏∞Ìôî
        input.focus(); // [Ï∂îÍ∞ÄÎê®] Ï†ÑÏÜ° ÌõÑ Ìè¨Ïª§Ïä§ Ïú†ÏßÄ
        
    } catch(e) { console.error(e); }
};
        window.handleLeaveRoom = async (roomId) => {
    if (!confirm("Ï†ïÎßê Ïù¥ Ï±ÑÌåÖÎ∞©(Signal) Ïó∞Í≤∞ÏùÑ ÎÅäÏúºÏãúÍ≤†ÏäµÎãàÍπå?")) return;

    try {
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
        const currentRoom = state.chatRooms.find(r => r.id === roomId);
        
        if (!currentRoom) return;

        // [Ï∂îÍ∞ÄÎêú Î∂ÄÎ∂Ñ] Ìá¥Ïû• ÏãúÏä§ÌÖú Î©îÏãúÏßÄ Ï†ÑÏÜ°
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
            roomId: roomId,
            fromId: 'system', // ÏãùÎ≥ÑÏûêÎ•º 'system'ÏúºÎ°ú ÏÑ§Ï†ï
            fromName: 'System',
            body: `${state.userAccount.ocName} ÎãòÏù¥ Ïó∞Í≤∞ÏùÑ Ï¢ÖÎ£åÌñàÏäµÎãàÎã§.`, // Î©îÏãúÏßÄ ÎÇ¥Ïö©
            timestamp: serverTimestamp()
        });

        // ÌòÑÏû¨ ÎÇ¥ IDÎ•º Î©§Î≤Ñ Î™©Î°ùÏóêÏÑú Ï†úÏô∏
        const newMembers = currentRoom.members.filter(id => id !== state.userAccount.loginId);

        if (newMembers.length === 0) {
             await updateDoc(roomRef, { members: newMembers });
        } else {
            await updateDoc(roomRef, { members: newMembers });
        }

        state.selectedRoomId = null;
        renderMail();
        showToast("Signal Disconnected.");
        
    } catch (e) {
        console.error("Error leaving room:", e);
        showToast("Error: Cannot disconnect.");
    }
};

        function renderProfile() {
    const oc = state.userAccount || {};
    $('content-area').innerHTML = `
        <div class="max-w-2xl mx-auto py-24 px-10 w-full animate-slide-up pb-40">
            <h2 class="text-4xl font-serif font-black mb-12 tracking-tighter uppercase leading-none text-white">Personnel Dossier</h2>
            <div class="bg-neutral-900 border border-white/5 rounded-[3rem] p-10 space-y-10 shadow-2xl backdrop-blur-xl">
                
                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Basic Info</h3>
                    
                    <div><label class="text-[10px] font-bold text-amber-500 uppercase block mb-2 ml-1">Top Badge Text</label><input id="edit-badge" value="${oc.badgeText || ''}" placeholder="Dossier: Authorized" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-amber-500 font-black tracking-widest uppercase"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Personnel Name</label><input id="edit-name" value="${oc.ocName || ''}" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-bold"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Visual Resource (URL)</label><input id="edit-profile" value="${oc.profile || ''}" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Slogan (Big Title)</label><input id="edit-slogan" value="${oc.slogan || ''}" class="w-full bg-black border border-amber-600/30 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-black italic"></div>
                    <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Short Description (Subtitle)</label><input id="edit-shortDesc" value="${oc.shortDesc || ''}" placeholder="ÏãúÍ∞ÑÏùò ÏÜåÏö©ÎèåÏù¥ ÏÜçÏóêÏÑú..." class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white"></div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Left Ticket Button</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Ticket Name</label><input id="edit-linkText" value="${oc.linkText || ''}" placeholder="ENTER" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-white font-black"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Ticket URL</label><input id="edit-linkUrl" value="${oc.linkUrl || ''}" placeholder="https://..." class="w-full bg-black border border-white/5 rounded-2xl px-6 py-4 text-sm outline-none focus:border-amber-500 text-amber-500"></div>
                    </div>
                </div>
<div class="space-y-6">
    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Combat Stats</h3>
    
    <!-- ÌòÑÏû¨ HP/MP ÌëúÏãú -->
    <div class="bg-black/50 border border-white/10 rounded-xl p-4 space-y-3">
        <div>
            <div class="flex justify-between items-center mb-1">
                <span class="text-[9px] font-bold text-red-500 uppercase">Current HP</span>
                <span class="text-[9px] text-neutral-400 font-mono">${oc.currentHP || oc.stat_hp || 100}/${oc.stat_hp || 100}</span>
            </div>
            <div class="w-full h-2 bg-neutral-800 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-red-600 to-red-500 transition-all duration-300" 
                     style="width: ${((oc.currentHP || oc.stat_hp || 100) / (oc.stat_hp || 100)) * 100}%"></div>
            </div>
        </div>
        <div>
            <div class="flex justify-between items-center mb-1">
                <span class="text-[9px] font-bold text-blue-500 uppercase">Current MP</span>
                <span class="text-[9px] text-neutral-400 font-mono">${oc.currentMP || oc.stat_mp || 50}/${oc.stat_mp || 50}</span>
            </div>
            <div class="w-full h-2 bg-neutral-800 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-blue-600 to-blue-500 transition-all duration-300" 
                     style="width: ${((oc.currentMP || oc.stat_mp || 50) / (oc.stat_mp || 50)) * 100}%"></div>
            </div>
        </div>
    </div>
    
    <!-- ÏµúÎåÄ Ïä§ÌÉØ ÏÑ§Ï†ï -->
    <div class="grid grid-cols-5 gap-3">
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">Max HP</label>
            <input id="edit-stat-hp" value="${oc.stat_hp || '100'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-red-500 outline-none" placeholder="100">
        </div>
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">Max MP</label>
            <input id="edit-stat-mp" value="${oc.stat_mp || '50'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-blue-500 outline-none" placeholder="50">
        </div>
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">ATK</label>
            <input id="edit-stat-atk" value="${oc.stat_atk || '10-15'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-amber-500 outline-none" placeholder="12-18">
        </div>
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">DEF</label>
            <input id="edit-stat-def" value="${oc.stat_def || '3-5'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-green-500 outline-none" placeholder="3-7">
        </div>
        <div>
            <label class="text-[9px] font-bold text-neutral-500 uppercase block mb-1 text-center">MOVE</label>
            <input id="edit-stat-move" value="${oc.stat_move || '1'}" class="w-full bg-black border border-white/10 rounded-xl px-2 py-3 text-xs text-white text-center font-mono focus:border-purple-500 outline-none" placeholder="1">
        </div>
    </div>
</div>
<div class="space-y-6 mt-6">
    <div class="flex justify-between items-end border-b border-white/5 pb-2">
        <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest">Combat Skills</h3>
        <button onclick="openSkillEditor()" class="text-[10px] font-bold text-neutral-500 hover:text-amber-500 transition-colors flex items-center gap-1">
            <span>EDIT</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
        </button>
    </div>
    
    <div id="profile-equipped-skills" class="grid grid-cols-5 gap-3 min-h-[42px]">
        <div class="col-span-5 text-center py-3 border border-dashed border-white/10 rounded-xl">
            <span class="text-[10px] text-neutral-600">No skills equipped</span>
        </div>
    </div>
</div>
                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Personality Keywords</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 1</label><input id="edit-kw1" value="${oc.keyword1 || ''}" placeholder="Basiom" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-500 font-serif italic text-center"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 2</label><input id="edit-kw2" value="${oc.keyword2 || ''}" placeholder="Barbarus" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-400 font-serif italic text-center"></div>
                        <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Keyword 3</label><input id="edit-kw3" value="${oc.keyword3 || ''}" placeholder="Beatrice" class="w-full bg-black border border-white/5 rounded-2xl px-4 py-4 text-sm outline-none focus:border-amber-500 text-amber-300 font-serif italic text-center"></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xs font-black text-amber-500 uppercase tracking-widest border-b border-white/5 pb-2">Background Description</h3>
                    <div>
                        <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-2 ml-1">Personnel Notes</label>
                        <textarea id="edit-stats" class="w-full bg-black border border-white/5 rounded-2xl px-6 py-5 text-sm outline-none focus:border-amber-500 h-40 resize-none text-neutral-300 leading-relaxed custom-scrollbar">${oc.stats || ''}</textarea>
                    </div>
                </div>

                <div class="pt-6">
                    <button onclick="handleUpdateProfile()" class="w-full py-6 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all">Authorize Update</button>
                </div>
            </div>
        </div>
    `;
    
    // ÌîÑÎ°úÌïÑ Î†åÎçîÎßÅ ÌõÑ Ïä§ÌÇ¨ ÌëúÏãú
    const skills = oc.combatSkills || [];
    console.log("üìã ÌîÑÎ°úÌïÑ Î†åÎçîÎßÅ - ÏµúÏã† Ïä§ÌÇ¨ Î™©Î°ù:", skills);
    
    if (typeof window.renderProfileSkills === 'function') {
        window.renderProfileSkills(skills);
    } else {
        console.warn("‚ö†Ô∏è renderProfileSkills Ìï®ÏàòÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏùå");
    }
}
window.filterGroupMembers = () => {
    const input = document.getElementById('member-search-input');
    const filter = input.value.toUpperCase();
    const list = document.getElementById('member-select-list');
    const items = list.getElementsByClassName('member-item');

    for (let i = 0; i < items.length; i++) {
        const nameSpan = items[i].getElementsByClassName('member-name-text')[0];
        if (nameSpan) {
            const txtValue = nameSpan.textContent || nameSpan.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].classList.remove('hidden'); // Í≤ÄÏÉâÏñ¥ Ìè¨Ìï®ÎêòÎ©¥ Î≥¥ÏûÑ
            } else {
                items[i].classList.add('hidden');    // Ìè¨Ìï® ÏïàÎêòÎ©¥ Ïà®ÍπÄ
            }
        }
    }
};
        window.handleUpdateProfile = async function() {
    const user = auth.currentUser;
    if (!user) { alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."); return; }

    // 1. ÏûÖÎ†•Ï∞ΩÏóêÏÑú Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
    };

    // 2. Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞ Í∞ùÏ≤¥ ÎßåÎì§Í∏∞
    // (Ïó¨Í∏∞ÏÑú skillsÎäî Ï†úÏô∏ÌïòÏó¨ Í∏∞Ï°¥ Ïä§ÌÇ¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎÇ†ÏïÑÍ∞ÄÏßÄ ÏïäÍ≤å Î≥¥Ìò∏Ìï©ÎãàÎã§)
    // currentHP/currentMPÎäî Í≤åÏûÑÎ≥¥ÎìúÏôÄ Í¥ÄÎ¶¨ÏûêÎßå ÏàòÏ†ï Í∞ÄÎä•ÌïòÎØÄÎ°ú Ï†úÏô∏
    const updateData = {
        badgeText: getVal('edit-badge'),
        ocName: getVal('edit-name'),
        profile: getVal('edit-profile'),
        slogan: getVal('edit-slogan'),
        shortDesc: getVal('edit-shortDesc'),
        linkText: getVal('edit-linkText'),
        linkUrl: getVal('edit-linkUrl'),
        stat_hp: getVal('edit-stat-hp'),
        stat_mp: getVal('edit-stat-mp'),
        stat_atk: getVal('edit-stat-atk'),
        stat_def: getVal('edit-stat-def'),
        stat_move: getVal('edit-stat-move'),
        keyword1: getVal('edit-kw1'),
        keyword2: getVal('edit-kw2'),
        keyword3: getVal('edit-kw3'),
        stats: getVal('edit-stats'),
        updatedAt: new Date()
    };

    if (!updateData.ocName) {
        alert("Personnel NameÏùÄ ÌïÑÏàò ÏûÖÎ†•Í∞íÏûÖÎãàÎã§.");
        return;
    }

    try {
        // 3. [ÌïµÏã¨ ÏàòÏ†ï] Ï†ÄÏû• Í≤ΩÎ°úÎ•º ÌôàÌéòÏù¥ÏßÄÍ∞Ä ÏùΩÎäî artifacts Í≤ΩÎ°úÎ°ú Î≥ÄÍ≤Ω
        // state.userAccount.loginIdÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏Ìï©ÎãàÎã§.
        const loginId = window.state?.userAccount?.loginId || user.uid;
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
        
        const btn = document.querySelector('button[onclick="handleUpdateProfile()"]');
        if(btn) btn.innerText = "UPDATING...";

        // 4. [ÌïµÏã¨ ÏàòÏ†ï] updateDoc ÎåÄÏã† setDoc(merge: true) ÏÇ¨Ïö©
        // Ïù¥Î†áÍ≤å ÌïòÎ©¥ Î¨∏ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±ÌïòÍ≥†, ÏûàÏúºÎ©¥ Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞(Ïä§ÌÇ¨ Îì±)Î•º Ïú†ÏßÄÌïòÎ©∞ ÎçÆÏñ¥ÏîÅÎãàÎã§.
        await setDoc(userRef, updateData, { merge: true });
        
        // 5. Î°úÏª¨ state ÏóÖÎç∞Ïù¥Ìä∏
        if (window.state && window.state.userAccount) {
            window.state.userAccount = { ...window.state.userAccount, ...updateData };
        }

        alert("ÌîÑÎ°úÌïÑÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.");
        
        if (typeof renderProfile === 'function') {
            renderProfile(); 
        }

    } catch (e) {
        console.error("ÌîÑÎ°úÌïÑ Ï†ÄÏû• Ïã§Ìå®:", e);
        alert("Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message);
    } finally {
        const btn = document.querySelector('button[onclick="handleUpdateProfile()"]');
        if(btn) btn.innerText = "Authorize Update";
    }
}
        function renderAdmin() {
    // 1. Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ (Í∂åÌïú ÏóÜÏùÑ Ïãú)
    if (!state.isAdmin) {
        $('content-area').innerHTML = `
            <div class="flex-1 flex items-center justify-center p-6 h-full select-none">
                <div class="max-w-md w-full bg-neutral-900 border border-amber-600/20 p-12 rounded-[3.5rem] space-y-10 animate-fade-in shadow-2xl">
                    <div class="text-center space-y-4 mb-10">
                        <i data-lucide="shield" class="w-16 h-16 text-amber-500 mx-auto mb-4 drop-shadow-[0_0_15px_rgba(217,119,6,0.5)]"></i>
                        <h3 class="text-2xl font-black text-white uppercase tracking-widest">Administrator</h3>
                    </div>
                    <input id="admin-pw-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-black border border-white/10 rounded-2xl px-6 py-5 text-center text-xl tracking-[1em] outline-none focus:border-amber-500 text-white transition-all">
                    <button onclick="handleAdminAuth()" class="w-full py-6 bg-amber-600 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all">Authorize Over-ride</button>
                </div>
            </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
        return;
    }

    // 2. Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
    const pendings = state.accounts.filter(a => a.status === 'pending');
    const approveds = state.accounts.filter(a => a.status === 'approved');
    const w = state.world || {};
    const classes = w.classes || []; // ÏßÅÏóÖÍµ∞ Îç∞Ïù¥ÌÑ∞

    // 3. Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú Î†åÎçîÎßÅ
    $('content-area').innerHTML = `
        <div class="max-w-6xl mx-auto py-20 px-10 w-full space-y-24 pb-60 animate-fade-in select-none">
            
            <div class="flex justify-between items-end border-b border-amber-900/30 pb-12">
                <h2 class="text-5xl font-black text-amber-500 uppercase tracking-tighter">Command Center</h2>
                <button onclick="state.isAdmin = false; renderView('admin');" class="px-6 py-3 bg-neutral-900 border border-white/10 rounded-xl text-[10px] text-neutral-500 hover:text-white uppercase font-bold">Logout Session</button>
            </div>

            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">System Interface Control</h3>
                
                <div class="space-y-1">
                    <label class="text-[10px] text-neutral-500 font-bold tracking-widest uppercase">Login Background URL</label>
                    <input id="sys-login-bg" type="text" value="${w.login_bg || ''}" 
                           class="w-full bg-neutral-900 border border-neutral-800 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-amber-600 transition-colors" 
                           placeholder="https://...">
                    <p class="text-[9px] text-neutral-600 mt-1">Î°úÍ∑∏Ïù∏ ÌôîÎ©¥Ïóê Î∏îÎü¨ Ï≤òÎ¶¨ÎêòÏñ¥ ÎÇòÌÉÄÎÇ† Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÏûÖÎãàÎã§.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 01</p>
                        <input id="sys-btn1-text" value="${w.banner1_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn1-url" value="${w.banner1_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn1-img" value="${w.banner1_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 02</p>
                        <input id="sys-btn2-text" value="${w.banner2_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn2-url" value="${w.banner2_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn2-img" value="${w.banner2_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                    <div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
                        <p class="text-amber-500 font-bold uppercase text-xs">Banner 03</p>
                        <input id="sys-btn3-text" value="${w.banner3_text || ''}" placeholder="Title" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                        <input id="sys-btn3-url" value="${w.banner3_url || ''}" placeholder="Link URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                        <input id="sys-btn3-img" value="${w.banner3_img || ''}" placeholder="Image URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400">
                    </div>
                </div>
                <button onclick="handleSystemUpdate()" class="w-full py-4 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl transition-all">Update System Interface</button>
            </section>
<div class="p-6 bg-neutral-900 border border-white/5 rounded-3xl space-y-4">
    <p class="text-amber-500 font-bold uppercase text-xs">Skill Synchronization</p>
    <input type="file" id="skill-file-input" class="hidden" accept=".json" onchange="importSkillsFromFile(event)">
    <button onclick="document.getElementById('skill-file-input').click()" 
            class="w-full py-3 bg-neutral-800 text-white text-[10px] font-black uppercase rounded-xl">
        Upload Skill Backup (.json)
    </button>
</div>
            <section class="space-y-8">
                <div class="flex justify-between items-end">
                    <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-purple-500 pl-6 tracking-[0.5em]">Class / Position Settings</h3>
                    <button onclick="addNewClass()" class="px-4 py-2 bg-purple-900/30 text-purple-400 border border-purple-500/30 rounded-lg text-[10px] font-bold uppercase hover:bg-purple-600 hover:text-white transition-all">+ Add Position</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${classes.map((cls, idx) => `
                        <div class="p-4 bg-neutral-900 border border-white/5 rounded-2xl flex items-center gap-4 relative group hover:border-purple-500/50 transition-colors">
                            <input type="color" id="cls-color-${idx}" value="${cls.color}" 
                                   class="w-12 h-12 rounded-xl border-none cursor-pointer bg-transparent" title="Change Color">
                            
                            <div class="flex-1 space-y-2">
                                <div>
                                    <input id="cls-name-${idx}" type="text" value="${cls.name}" 
                                           class="w-full bg-black border border-white/10 rounded-lg px-3 py-2 text-xs text-white font-bold uppercase focus:border-purple-500 outline-none placeholder-neutral-700"
                                           placeholder="DISPLAY NAME">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] font-bold text-neutral-600 uppercase w-8">CODE</span>
                                    <input id="cls-code-${idx}" type="text" value="${cls.code}" 
                                           class="flex-1 bg-black/50 border border-white/5 rounded px-2 py-1 text-[10px] text-neutral-400 font-mono uppercase focus:border-purple-500 outline-none"
                                           placeholder="ID (e.g. TANK)">
                                </div>
                            </div>

                            <button onclick="deleteClass(${idx})" class="absolute top-2 right-2 p-2 text-neutral-600 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100" title="Delete Class">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
                
                <button onclick="saveClassSettings()" class="w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-xl transition-all">
                    Save Class Configurations
                </button>
            </section>

            <!-- ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑπÏÖò -->
            <section class="space-y-12">
                <div class="flex justify-between items-end">
                    <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-green-500 pl-6 tracking-[0.5em]">Item Master Database</h3>
                    <div class="flex gap-2">
                        <button onclick="initializeDefaultItems()" class="px-4 py-2 bg-purple-900/30 text-purple-400 border border-purple-500/30 rounded-lg text-[10px] font-bold uppercase hover:bg-purple-600 hover:text-white transition-all">‚ö° Init Defaults</button>
                        <button onclick="openItemMasterModal()" class="px-4 py-2 bg-green-900/30 text-green-400 border border-green-500/30 rounded-lg text-[10px] font-bold uppercase hover:bg-green-600 hover:text-white transition-all">+ Add Item</button>
                    </div>
                </div>
                <p class="text-[9px] text-neutral-500 italic">Í∏∞Î≥∏ Í∞ÄÏ±† ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏúºÎ©¥ "Init Defaults"Î•º ÌÅ¥Î¶≠ÌïòÏó¨ Golden Fleece, Silver Sword, Ration PackÏùÑ ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.</p>
                
                <div id="item-master-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-neutral-500 text-xs italic text-center col-span-full py-10">Loading items...</p>
                </div>
            </section>

            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-red-500 border-l-8 border-red-600 pl-6 tracking-[0.5em]">User Reports (Incoming)</h3>
                <div class="bg-neutral-900 border border-red-900/30 rounded-[2rem] p-8 min-h-[150px]" id="admin-reports-list">
                    <p class="text-neutral-500 text-xs italic text-center py-10">Accessing secure logs...</p>
                </div>
            </section>
            
            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">Recruitment Queue</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    ${pendings.map(a => `
                        <div class="p-8 bg-neutral-900 border border-white/5 rounded-[3rem] flex flex-col gap-8 shadow-2xl">
                            <div class="flex items-center gap-6">
                                <div class="w-16 h-16 rounded-[1.5rem] bg-black overflow-hidden shadow-inner">
                                    <img src="${a.profile}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 overflow-hidden">
                                    <p class="text-2xl font-black text-white uppercase truncate">${a.ocName}</p>
                                    <p class="text-[10px] text-neutral-500 font-mono mt-1">ID: ${a.loginId}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="approveUser('${a.loginId}')" class="py-4 bg-green-600 text-white text-[11px] font-black rounded-2xl uppercase tracking-widest shadow-lg shadow-green-900/20 active:scale-95 transition-all">Authorize</button>
                                <button onclick="rejectUser('${a.loginId}')" class="py-4 bg-neutral-800 text-neutral-400 text-[11px] font-black rounded-2xl uppercase active:scale-95 transition-all">Decline</button>
                            </div>
                        </div>`).join('')}
                    ${pendings.length === 0 ? '<p class="text-neutral-700 italic font-mono uppercase tracking-widest text-sm text-center col-span-full py-10">All signals clear.</p>' : ''}
                </div>
            </section>

            <!-- HP/MP Í¥ÄÎ¶¨ ÏÑπÏÖò -->
            <section class="space-y-12">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleHPMPSection()">
                    <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-red-500 pl-6 tracking-[0.5em]">HP/MP Management Center</h3>
                    <i data-lucide="chevron-down" id="hpmp-toggle-icon" class="w-5 h-5 text-neutral-400 transition-transform"></i>
                </div>
                <p class="text-[10px] text-neutral-500 italic">Ïù¥Í≥≥ÏóêÏÑú ÏàòÏ†ïÌïú HP/MPÍ∞Ä Î™®Îì† ÏãúÏä§ÌÖú(ÌôàÌéòÏù¥ÏßÄ, Í≤åÏûÑÎ≥¥Îìú)Ïóê Ï¶âÏãú Î∞òÏòÅÎê©ÎãàÎã§.</p>
                
                <div id="hpmp-content" class="space-y-8">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="border-b border-white/10">
                                    <th class="text-left py-4 px-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest">Personnel</th>
                                    <th class="text-center py-4 px-4 text-[10px] font-black text-red-400 uppercase tracking-widest">Current HP</th>
                                    <th class="text-center py-4 px-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest">Max HP</th>
                                    <th class="text-center py-4 px-4 text-[10px] font-black text-blue-400 uppercase tracking-widest">Current MP</th>
                                    <th class="text-center py-4 px-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest">Max MP</th>
                                    <th class="text-center py-4 px-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${approveds.map(a => `
                                    <tr class="border-b border-white/5 hover:bg-neutral-800/50 transition-colors">
                                        <td class="py-4 px-4">
                                            <div class="flex items-center gap-3">
                                                <img src="${a.profile}" class="w-10 h-10 rounded-xl object-cover">
                                                <div>
                                                    <p class="text-sm font-bold text-white">${a.ocName}</p>
                                                    <p class="text-[9px] text-neutral-500 font-mono">${a.loginId}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center py-4 px-4">
                                            <input type="number" 
                                                   id="hp-current-${a.loginId}" 
                                                   value="${a.currentHP || a.stat_hp || 100}" 
                                                   min="0" 
                                                   max="${a.stat_hp || 100}"
                                                   class="w-20 bg-black border border-red-500/30 rounded-lg px-3 py-2 text-center text-sm text-red-400 font-mono outline-none focus:border-red-500">
                                        </td>
                                        <td class="text-center py-4 px-4">
                                            <span class="text-sm text-neutral-400 font-mono">${a.stat_hp || 100}</span>
                                        </td>
                                        <td class="text-center py-4 px-4">
                                            <input type="number" 
                                                   id="mp-current-${a.loginId}" 
                                                   value="${a.currentMP || a.stat_mp || 50}" 
                                                   min="0" 
                                                   max="${a.stat_mp || 50}"
                                                   class="w-20 bg-black border border-blue-500/30 rounded-lg px-3 py-2 text-center text-sm text-blue-400 font-mono outline-none focus:border-blue-500">
                                        </td>
                                        <td class="text-center py-4 px-4">
                                            <span class="text-sm text-neutral-400 font-mono">${a.stat_mp || 50}</span>
                                        </td>
                                        <td class="text-center py-4 px-4">
                                            <button onclick="updateUserHPMP('${a.loginId}')" 
                                                    class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-[10px] font-black uppercase tracking-wider transition-all">
                                                Update
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="resetAllHP()" 
                                class="flex-1 py-4 bg-red-900/30 hover:bg-red-600 border border-red-500/30 text-red-400 hover:text-white rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all">
                            Reset All HP to Max
                        </button>
                        <button onclick="resetAllMP()" 
                                class="flex-1 py-4 bg-blue-900/30 hover:bg-blue-600 border border-blue-500/30 text-blue-400 hover:text-white rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all">
                            Reset All MP to Max
                        </button>
                    </div>
                </div>
            </section>

            <section class="space-y-12">
                <h3 class="text-xs font-black uppercase text-neutral-400 border-l-8 border-amber-500 pl-6 tracking-[0.5em]">Personnel Files (Edit)</h3>
                <div class="grid grid-cols-1 gap-4">
                    ${approveds.map(a => `
                        <div class="p-6 bg-neutral-900/50 border border-white/5 rounded-3xl flex items-center justify-between group hover:border-amber-500/30 transition-all">
                            <div class="flex items-center gap-6">
                                <div class="w-14 h-14 rounded-2xl bg-black overflow-hidden"><img src="${a.profile}" class="w-full h-full object-cover"></div>
                                <div>
                                    <p class="text-lg font-black text-white uppercase">${a.ocName}</p>
                                    <p class="text-[10px] text-neutral-600 font-mono italic uppercase">ERA ID: ${a.loginId}</p>
                                </div>
                            </div>
                            <button onclick="showAdminEditModal('${a.loginId}')" class="px-6 py-3 bg-neutral-800 hover:bg-amber-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">Over-ride Record</button>
                        </div>
                    `).join('')}
                </div>
            </section>

            <div id="admin-edit-modal" class="hidden fixed inset-0 z-[120] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div id="admin-edit-container" class="w-full max-w-2xl bg-neutral-900 border border-amber-600/30 rounded-[4rem] p-12 shadow-2xl modal-enter"></div>
        </div>
        
        <!-- ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Ìé∏Ïßë Î™®Îã¨ -->
        <div id="item-master-modal" class="hidden fixed inset-0 z-[120] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div class="w-full max-w-2xl bg-neutral-900 border border-green-600/30 rounded-[3rem] p-10 shadow-2xl modal-enter max-h-[90vh] overflow-y-auto custom-scrollbar">
                <h3 class="text-2xl font-black text-white uppercase tracking-tighter mb-6 text-center">Item Master Editor</h3>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase">Item ID</label>
                            <input id="item-id" type="text" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500" placeholder="potion_hp_small">
                        </div>
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase">Item Name</label>
                            <input id="item-name" type="text" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500" placeholder="Small HP Potion">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase">Type</label>
                            <select id="item-type" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
                                <option value="consumable">Consumable</option>
                                <option value="equipment">Equipment</option>
                                <option value="quest">Quest Item</option>
                                <option value="material">Material</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase">Rarity (1-5)</label>
                            <input id="item-rarity" type="number" min="1" max="5" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500" value="3">
                        </div>
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase">Price (Coins)</label>
                            <input id="item-price" type="number" min="0" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500" value="50">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-neutral-500 font-bold uppercase">Icon (Emoji)</label>
                        <input id="item-icon" type="text" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500" placeholder="üß™" maxlength="2">
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-neutral-500 font-bold uppercase">Description</label>
                        <textarea id="item-description" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500 resize-none h-20" placeholder="Restores 50 HP"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase">Effect Type</label>
                            <select id="item-effect-type" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
                                <option value="">None</option>
                                <option value="heal_hp">Heal HP</option>
                                <option value="heal_mp">Heal MP</option>
                                <option value="boost_atk">Boost Attack</option>
                                <option value="boost_def">Boost Defense</option>
                                <option value="boost_move">Boost Movement</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase">Effect Value</label>
                            <input id="item-effect-value" type="number" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500" value="0">
                        </div>
                    </div>
                    
                    <!-- Í∞ÄÏ±†/ÏÉÅÏ†ê ÏÑ§Ï†ï -->
                    <div class="border-t border-white/10 pt-6 mt-6">
                        <h4 class="text-sm font-black text-purple-400 uppercase mb-4">üíé Availability Settings</h4>
                        
                        <div class="space-y-4">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="item-in-gacha" class="w-4 h-4 rounded bg-black border-white/20">
                                <label for="item-in-gacha" class="text-sm text-white">Include in Gacha</label>
                            </div>
                            
                            <div id="gacha-settings" class="ml-7 space-y-3 hidden">
                                <div>
                                    <label class="text-[10px] text-neutral-500 font-bold uppercase">Gacha Drop Rate (%)</label>
                                    <input id="item-gacha-chance" type="number" min="0" max="100" step="0.1" class="w-full bg-black border border-purple-500/30 rounded-xl px-4 py-3 text-sm text-purple-400 outline-none focus:border-purple-500" value="5">
                                    <p class="text-[9px] text-neutral-600 mt-1">Ï¥ù ÌôïÎ•†Ïù¥ 100%Í∞Ä ÎêòÎèÑÎ°ù Ï°∞Ï†ïÌïòÏÑ∏Ïöî</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="item-in-shop" class="w-4 h-4 rounded bg-black border-white/20">
                                <label for="item-in-shop" class="text-sm text-white">Available in Shop</label>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="item-unavailable" class="w-4 h-4 rounded bg-black border-white/20">
                                <label for="item-unavailable" class="text-sm text-neutral-500">Currently Unavailable (ÎØ∏ÌåêÎß§)</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-8">
                    <button onclick="closeItemMasterModal()" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button onclick="saveItemMaster()" class="flex-1 py-4 bg-green-600 text-white font-bold rounded-xl uppercase text-xs hover:bg-green-700 shadow-lg">Save Item</button>
                </div>
            </div>
        </div>
        
        <!-- Í¥ÄÎ¶¨Ïûê Ïù∏Î≤§ÌÜ†Î¶¨ Í¥ÄÎ¶¨ Î™®Îã¨ -->
        <div id="admin-inventory-modal" class="hidden fixed inset-0 z-[130] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div class="w-full max-w-4xl bg-neutral-900 border border-green-600/30 rounded-[3rem] p-10 shadow-2xl modal-enter max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-black text-white uppercase tracking-tighter">User Inventory Manager</h3>
                    <button onclick="closeAdminInventoryModal()" class="text-neutral-500 hover:text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div id="admin-inventory-content" class="space-y-6">
                    <p class="text-neutral-500 text-sm text-center py-10">Loading...</p>
                </div>
            </div>
        </div>
        
        <div id="admin-reply-modal" class="hidden fixed inset-0 z-[130] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div class="w-full max-w-md bg-neutral-900 border border-amber-600/30 rounded-[3rem] p-10 shadow-2xl modal-enter">
                <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-4 text-center">Confirm & Reply</h3>
                <p class="text-xs text-neutral-500 text-center mb-6">This action will resolve the report and notify the user.</p>
                
                <textarea id="admin-reply-memo" class="w-full h-32 bg-black border border-white/10 rounded-2xl p-4 text-sm text-white resize-none outline-none focus:border-amber-500 mb-6" placeholder="Leave a message for the user..."></textarea>
                
                <div class="flex gap-4">
                    <button onclick="$('admin-reply-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button onclick="submitAdminResolution()" class="flex-1 py-4 bg-amber-600 text-white font-bold rounded-xl uppercase text-xs hover:bg-amber-700 shadow-lg">Confirm</button>
                </div>
            </div>
        </div>
        <section class="space-y-12 mt-20">
    <h3 class="text-xs font-black uppercase text-amber-500 border-l-8 border-amber-600 pl-6 tracking-[0.5em]">User Investigation Registry</h3>
    <div class="bg-neutral-900 border border-white/5 rounded-[2.5rem] overflow-hidden shadow-2xl">
        <table class="w-full text-left">
            <thead>
                <tr class="bg-white/5 border-b border-white/10 text-neutral-500 text-[9px] uppercase font-black tracking-widest">
                    <th class="p-6">Investigator</th>
                    <th class="p-6">Progress</th>
                    <th class="p-6 text-center">Clues</th>
                </tr>
            </thead>
            <tbody id="admin-user-investigation-list">
                <tr><td colspan="3" class="p-10 text-center text-neutral-600 italic">Syncing records...</td></tr>
            </tbody>
        </table>
    </div>
</section>

        </div>
        
        `;
    
    // 4. ÌõÑÏ≤òÎ¶¨: ÏÑúÎ∏å Ïª¥Ìè¨ÎÑåÌä∏ Î†åÎçîÎßÅ Î∞è ÏïÑÏù¥ÏΩò Î°úÎìú
    if (window.updateAdminReportsUI) window.updateAdminReportsUI();
    if (window.loadUserInvestigationProgress) window.loadUserInvestigationProgress();
    if (window.loadItemMasterList) window.loadItemMasterList(); // ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Î™©Î°ù Î°úÎìú
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// [Ï∂îÍ∞Ä] Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄÏóê Ïã†Í≥† Î™©Î°ù Í∑∏Î¶¨Í∏∞
window.updateAdminReportsUI = () => {
    const container = document.getElementById('admin-reports-list');
    if (!container) return;
    
    if (!state.reports || state.reports.length === 0) {
        container.innerHTML = '<p class="text-neutral-500 text-xs italic text-center py-10">No active reports.</p>';
        return;
    }
    
    container.innerHTML = state.reports
        .sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0))
        .map(r => `
            <div class="border-b border-white/5 pb-4 mb-4 last:border-0 last:mb-0 relative group">
                <div class="flex justify-between items-start mb-2 pr-16">
                    <span class="text-red-500 font-bold text-xs uppercase tracking-wider">TARGET ID: ${r.targetId}</span>
                    <span class="text-neutral-600 text-[10px] font-mono">${r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleString() : ''}</span>
                </div>
                <div class="text-white text-sm bg-black/50 p-4 rounded-xl mb-2 border border-white/5">
                    ${r.reason}
                </div>
                <p class="text-[10px] text-neutral-500 uppercase">
                    Reported by: <span class="text-amber-500 font-bold">${r.reporterName}</span> (${r.reporterId})
                </p>

                <div class="absolute bottom-4 right-0 flex gap-2">
                    <button onclick="openAdminReplyModal('${r.id}', '${r.reporterId}')" class="w-8 h-8 rounded-full bg-amber-600/20 text-amber-500 flex items-center justify-center hover:bg-amber-600 hover:text-white transition-all shadow-lg border border-amber-600/30" title="Confirm & Notify">
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteReport('${r.id}')" class="w-8 h-8 rounded-full bg-red-900/20 text-red-700 flex items-center justify-center hover:bg-red-600 hover:text-white transition-all border border-red-900/30" title="Ignore & Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `).join('');
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

/* ============================================
   ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú
   ============================================ */

// ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Î™©Î°ù Î°úÎìú
window.loadItemMasterList = async () => {
    try {
        const itemsRef = collection(db, 'artifacts', appId, 'public', 'data', 'item_master');
        const snapshot = await getDocs(itemsRef);
        
        const container = document.getElementById('item-master-list');
        if (!container) return;
        
        if (snapshot.empty) {
            container.innerHTML = '<p class="text-neutral-500 text-xs italic text-center col-span-full py-10">No items in database. Click "+ Add Item" to create one.</p>';
            return;
        }
        
        const itemsHtml = snapshot.docs.map(doc => {
            const item = doc.data();
            const rarityColor = item.rarity >= 5 ? 'text-amber-400 border-amber-500/50 bg-amber-900/20' : 
                               (item.rarity === 4 ? 'text-purple-400 border-purple-500/50 bg-purple-900/20' : 
                               (item.rarity === 3 ? 'text-blue-400 border-blue-500/50 bg-blue-900/20' : 'text-neutral-400 border-white/10 bg-white/5'));
            
            return `
                <div class="p-4 ${rarityColor} border-2 rounded-2xl group hover:scale-105 transition-all">
                    <div class="flex items-start justify-between mb-3">
                        <span class="text-4xl">${item.icon || 'üì¶'}</span>
                        <div class="flex gap-1">
                            <button onclick="editItemMaster('${doc.id}')" class="w-6 h-6 rounded bg-white/10 flex items-center justify-center hover:bg-amber-600 text-white/50 hover:text-white transition-all">
                                <i data-lucide="edit-2" class="w-3 h-3"></i>
                            </button>
                            <button onclick="deleteItemMaster('${doc.id}')" class="w-6 h-6 rounded bg-white/10 flex items-center justify-center hover:bg-red-600 text-white/50 hover:text-white transition-all">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                    <h4 class="text-sm font-bold mb-1">${item.name}</h4>
                    <p class="text-[9px] opacity-60 mb-2">${item.description || ''}</p>
                    <div class="flex justify-between items-center text-[8px] uppercase font-mono">
                        <span class="opacity-60">${item.type}</span>
                        <span class="font-bold">${item.price} coins</span>
                    </div>
                    <div class="mt-2 text-[8px] opacity-60">
                        ${"‚òÖ".repeat(item.rarity)}
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = itemsHtml;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    } catch(e) {
        console.error("Failed to load item master list:", e);
    }
};

// ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Î™®Îã¨ Ïó¥Í∏∞
window.openItemMasterModal = (itemId = null) => {
    const modal = document.getElementById('item-master-modal');
    modal.classList.remove('hidden');
    
    // Ìé∏Ïßë Î™®ÎìúÏù∏ Í≤ΩÏö∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    if (itemId) {
        loadItemMasterData(itemId);
    } else {
        // ÏÉàÎ°ú ÎßåÎì§Í∏∞ Î™®Îìú - ÌïÑÎìú Ï¥àÍ∏∞Ìôî
        document.getElementById('item-id').value = '';
        document.getElementById('item-name').value = '';
        document.getElementById('item-type').value = 'consumable';
        document.getElementById('item-rarity').value = '3';
        document.getElementById('item-price').value = '50';
        document.getElementById('item-icon').value = '';
        document.getElementById('item-description').value = '';
        document.getElementById('item-effect-type').value = '';
        document.getElementById('item-effect-value').value = '0';
        document.getElementById('item-in-gacha').checked = false;
        document.getElementById('item-in-shop').checked = false;
        document.getElementById('item-unavailable').checked = false;
        document.getElementById('item-gacha-chance').value = '5';
        document.getElementById('gacha-settings').classList.add('hidden');
    }
    
    // Í∞ÄÏ±† Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà (Îß§Î≤à ÏÉàÎ°ú Ï∂îÍ∞Ä)
    const gachaCheckbox = document.getElementById('item-in-gacha');
    const gachaSettings = document.getElementById('gacha-settings');
    gachaCheckbox.onchange = () => {
        if (gachaCheckbox.checked) {
            gachaSettings.classList.remove('hidden');
        } else {
            gachaSettings.classList.add('hidden');
        }
    };
};

// ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Ìé∏ÏßëÏö©)
async function loadItemMasterData(itemId) {
    try {
        const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'item_master', itemId);
        const itemSnap = await getDoc(itemRef);
        
        if (!itemSnap.exists()) {
            showToast("Item not found!");
            return;
        }
        
        const item = itemSnap.data();
        document.getElementById('item-id').value = itemId;
        document.getElementById('item-name').value = item.name || '';
        document.getElementById('item-type').value = item.type || 'consumable';
        document.getElementById('item-rarity').value = item.rarity || 3;
        document.getElementById('item-price').value = item.price || 50;
        document.getElementById('item-icon').value = item.icon || '';
        document.getElementById('item-description').value = item.description || '';
        document.getElementById('item-effect-type').value = item.effect?.type || '';
        document.getElementById('item-effect-value').value = item.effect?.value || 0;
        
        // Í∞ÄÏ±†/ÏÉÅÏ†ê ÏÑ§Ï†ï Î°úÎìú
        document.getElementById('item-in-gacha').checked = item.availability?.inGacha || false;
        document.getElementById('item-in-shop').checked = item.availability?.inShop || false;
        document.getElementById('item-unavailable').checked = item.availability?.unavailable || false;
        document.getElementById('item-gacha-chance').value = item.gachaChance || 5;
        
        // Í∞ÄÏ±† ÏÑ§Ï†ï ÌëúÏãú/Ïà®ÍπÄ
        const gachaSettings = document.getElementById('gacha-settings');
        if (item.availability?.inGacha) {
            gachaSettings.classList.remove('hidden');
        } else {
            gachaSettings.classList.add('hidden');
        }
    } catch(e) {
        console.error("Failed to load item data:", e);
        showToast("Error loading item!");
    }
}

// ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Ï†ÄÏû•
window.saveItemMaster = async () => {
    const itemId = document.getElementById('item-id').value.trim();
    const itemName = document.getElementById('item-name').value.trim();
    
    if (!itemId || !itemName) {
        showToast("Item ID and Name are required!");
        return;
    }
    
    const inGacha = document.getElementById('item-in-gacha').checked;
    const inShop = document.getElementById('item-in-shop').checked;
    const unavailable = document.getElementById('item-unavailable').checked;
    
    const itemData = {
        id: itemId,
        name: itemName,
        type: document.getElementById('item-type').value,
        rarity: parseInt(document.getElementById('item-rarity').value) || 3,
        price: parseInt(document.getElementById('item-price').value) || 0,
        icon: document.getElementById('item-icon').value.trim() || 'üì¶',
        description: document.getElementById('item-description').value.trim(),
        effect: {
            type: document.getElementById('item-effect-type').value,
            value: parseInt(document.getElementById('item-effect-value').value) || 0
        },
        availability: {
            inGacha: inGacha,
            inShop: inShop,
            unavailable: unavailable
        },
        gachaChance: inGacha ? parseFloat(document.getElementById('item-gacha-chance').value) || 5 : 0,
        updatedAt: serverTimestamp()
    };
    
    try {
        const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'item_master', itemId);
        await setDoc(itemRef, itemData);
        
        showToast("Item saved successfully!");
        closeItemMasterModal();
        loadItemMasterList();
    } catch(e) {
        console.error("Failed to save item:", e);
        showToast("Error saving item!");
    }
};

// ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Ìé∏Ïßë
window.editItemMaster = (itemId) => {
    openItemMasterModal(itemId);
};

// ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ ÏÇ≠Ï†ú
window.deleteItemMaster = async (itemId) => {
    if (!confirm("Are you sure you want to delete this item?")) return;
    
    try {
        const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'item_master', itemId);
        await deleteDoc(itemRef);
        
        showToast("Item deleted successfully!");
        loadItemMasterList();
    } catch(e) {
        console.error("Failed to delete item:", e);
        showToast("Error deleting item!");
    }
};

// Í∏∞Î≥∏ Í∞ÄÏ±† ÏïÑÏù¥ÌÖú Ï¥àÍ∏∞Ìôî
window.initializeDefaultItems = async () => {
    if (!confirm("Í∏∞Î≥∏ Í∞ÄÏ±† ÏïÑÏù¥ÌÖú 3Í∞úÎ•º ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Golden Fleece, Silver Sword, Ration Pack)")) return;
    
    const defaultItems = [
        {
            id: "gacha_golden_fleece",
            name: "5‚òÖ Golden Fleece",
            type: "quest",
            rarity: 5,
            price: 0,
            icon: "üèÜ",
            description: "Ï†ÑÏÑ§Ï†ÅÏù∏ Ìô©Í∏à ÏñëÌÑ∏. Í∑πÎèÑÎ°ú Ìù¨Í∑ÄÌïú ÏïÑÏù¥ÌÖúÏûÖÎãàÎã§.",
            effect: { type: "", value: 0 },
            availability: {
                inGacha: true,
                inShop: false,
                unavailable: false
            },
            gachaChance: 5,
            updatedAt: serverTimestamp()
        },
        {
            id: "gacha_silver_sword",
            name: "4‚òÖ Silver Sword",
            type: "equipment",
            rarity: 4,
            price: 500,
            icon: "‚öîÔ∏è",
            description: "ÏùÄÏúºÎ°ú ÎßåÎì§Ïñ¥ÏßÑ Í≤Ä. Ïö∞ÏàòÌïú ÌíàÏßàÏùò Î¨¥Í∏∞ÏûÖÎãàÎã§.",
            effect: { type: "boost_atk", value: 10 },
            availability: {
                inGacha: true,
                inShop: true,
                unavailable: false
            },
            gachaChance: 20,
            updatedAt: serverTimestamp()
        },
        {
            id: "gacha_ration_pack",
            name: "3‚òÖ Ration Pack",
            type: "consumable",
            rarity: 3,
            price: 50,
            icon: "üçû",
            description: "Í∏∞Î≥∏ ÏãùÎüâ Ìå©. ÌùîÌïòÍ≤å ÏñªÏùÑ Ïàò ÏûàÏäµÎãàÎã§.",
            effect: { type: "heal_hp", value: 30 },
            availability: {
                inGacha: true,
                inShop: true,
                unavailable: false
            },
            gachaChance: 75,
            updatedAt: serverTimestamp()
        }
    ];
    
    try {
        let created = 0;
        let skipped = 0;
        
        for (const item of defaultItems) {
            const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'item_master', item.id);
            const itemSnap = await getDoc(itemRef);
            
            if (!itemSnap.exists()) {
                await setDoc(itemRef, item);
                created++;
            } else {
                skipped++;
            }
        }
        
        showToast(`‚úÖ ÏÉùÏÑ±: ${created}Í∞ú, Ïä§ÌÇµ: ${skipped}Í∞ú (Ïù¥ÎØ∏ Ï°¥Ïû¨)`);
        loadItemMasterList();
    } catch(e) {
        console.error("Failed to initialize default items:", e);
        showToast("Error initializing items!");
    }
};

// Î™®Îã¨ Îã´Í∏∞
window.closeItemMasterModal = () => {
    document.getElementById('item-master-modal').classList.add('hidden');
};

// [Ï∂îÍ∞ÄÎê®] Ï±ÑÌåÖÎ∞© ÏïÑÏù¥ÏΩò ÏÉùÏÑ± Ìï®Ïàò (ÏµúÎåÄ 4Î™Ö ÌîÑÏÇ¨ ÌëúÏãú)
function getRoomIconHTML(room) {
    const myId = state.userAccount.loginId;
    
    // ÎÇòÎ•º Ï†úÏô∏Ìïú Î©§Î≤Ñ ID Î™©Î°ù Ï∂îÏ∂ú
    let targets = room.members.filter(id => id !== myId);
    
    // ÎßåÏïΩ ÎÇò ÌòºÏûê ÏûàÎäî Î∞©Ïù¥Î©¥(ÎòêÎäî ÎåÄÌôîÏÉÅÎåÄÍ∞Ä ÏóÜÏúºÎ©¥) ÎÇ¥ ÌîÑÏÇ¨ ÌëúÏãú
    if (targets.length === 0) targets = [myId];

    // ÏµúÎåÄ 4Î™ÖÍπåÏßÄÎßå ÏÑ†ÌÉù
    const displayIds = targets.slice(0, 4);

    // IDÏóê Ìï¥ÎãπÌïòÎäî ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ URL Ï∞æÍ∏∞
    const images = displayIds.map(id => {
        const acc = state.accounts.find(a => a.loginId === id);
        return acc ? acc.profile : null;
    }).filter(img => img); // Ïù¥ÎØ∏ÏßÄÍ∞Ä Ïú†Ìö®Ìïú Í≤ÉÎßå ÎÇ®ÍπÄ

    // Case 1: Ïù¥ÎØ∏ÏßÄÍ∞Ä ÌïòÎÇòÎèÑ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÏïÑÏù¥ÏΩò
    if (images.length === 0) {
        return `<div class="w-full h-full flex items-center justify-center bg-black"><i data-lucide="${room.type === 'group' ? 'users' : 'user'}" class="w-5 h-5 opacity-40"></i></div>`;
    }

    // Case 2: 1Î™ÖÏùº Îïå (ÍΩâ Ï∞¨ Ïù¥ÎØ∏ÏßÄ)
    if (images.length === 1) {
        return `<img src="${images[0]}" class="w-full h-full object-cover">`;
    }

    // Case 3: 2~4Î™ÖÏùº Îïå (2x2 Í∑∏Î¶¨Îìú)
    // 3Î™ÖÏùº ÎïåÎäî ÎßàÏßÄÎßâ Ïπ∏Ïù¥ ÎπàÏπ∏ÏúºÎ°ú ÎÇòÏòµÎãàÎã§.
    return `
        <div class="grid grid-cols-2 w-full h-full bg-neutral-800">
            ${images.map(img => `<img src="${img}" class="w-full h-full object-cover">`).join('')}
        </div>
    `;
}
        window.showAdminEditModal = (loginId) => {
    // 1. Ïú†Ï†Ä Îç∞Ïù¥ÌÑ∞ Ï∞æÍ∏∞
    const acc = state.accounts.find(a => a.loginId === loginId);
    if (!acc) return alert("User not found.");
    
    // 2. ÌÅ¥ÎûòÏä§(ÏßÅÏóÖÍµ∞) Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö© (Ïò§Î•ò Î∞©ÏßÄ)
    const classes = state.world.classes || [];

    // 3. Î™®Îã¨ ÏöîÏÜå Ï∞æÍ∏∞
    const modal = document.getElementById('admin-edit-modal');
    const container = document.getElementById('admin-edit-container');
    
    if (!modal || !container) {
        console.error("Admin modal elements not found!");
        return;
    }

    // 4. Î™®Îã¨ ÎÇ¥Ïö© ÏÉùÏÑ±
    const currentRole = acc.role || 'runner';

    container.innerHTML = `
        <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-6">
            <div>
                <h3 class="text-3xl font-serif font-black text-white uppercase tracking-tighter">Over-ride Record</h3>
                <p class="text-[10px] text-amber-500 font-mono mt-1">Target ID: ${acc.loginId}</p>
            </div>
            <button onclick="document.getElementById('admin-edit-modal').classList.add('hidden')" class="text-neutral-500 hover:text-white transition-colors">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>

        <div class="space-y-8 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
            
            <div class="bg-amber-900/10 border border-amber-500/30 p-6 rounded-2xl">
                <h4 class="text-xs font-black text-amber-500 uppercase tracking-widest mb-4">Security Clearance (Role)</h4>
                <div class="relative">
                    <select id="admin-role" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white font-bold uppercase outline-none focus:border-amber-500 appearance-none">
                        <option value="runner" ${currentRole === 'runner' ? 'selected' : ''}>RUNNER (Standard User)</option>
                        <option value="staff" ${currentRole === 'staff' ? 'selected' : ''}>STAFF (Administrator)</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 pointer-events-none"></i>
                </div>
            </div>

            <div class="bg-neutral-800/30 border border-white/10 p-6 rounded-2xl mb-4">
                <h4 class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-3">Combat Position (Class)</h4>
                <div class="relative">
                    <select id="admin-position" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white font-bold uppercase outline-none focus:border-amber-500 appearance-none cursor-pointer hover:border-white/30 transition-colors">
                        <option value="UNASSIGNED">UNASSIGNED (ÎØ∏ÏßÄÏ†ï)</option>
                        ${classes.map(cls => `
                            <option value="${cls.code}" ${acc.position === cls.code ? 'selected' : ''}>
                                ${cls.name}
                            </option>
                        `).join('')}
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 pointer-events-none"></i>
                </div>
                <p class="text-[9px] text-neutral-600 mt-2 ml-1">* Ïù¥ ÏÑ§Ï†ïÏùÄ Í∞§Îü¨Î¶¨ ÌïÑÌÑ∞ÎßÅÏóê ÏÇ¨Ïö©Îê©ÎãàÎã§.</p>
            </div>

            <div class="bg-neutral-900/50 border border-white/10 p-4 rounded-2xl flex items-center justify-between">
                <div>
                    <h4 class="text-[10px] font-black text-neutral-500 uppercase tracking-widest mb-1">Account Security</h4>
                    <p class="text-xs text-neutral-400 font-mono">${acc.email || 'No Email Registered'}</p>
                </div>
                <button onclick="handleSendPasswordReset('${acc.email}')" class="flex items-center gap-2 px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 rounded-xl border border-white/5 transition-colors text-xs font-bold uppercase">
                    <i data-lucide="key" class="w-4 h-4"></i> Reset PW
                </button>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Basic Info</h4>
                
                <div>
                    <label class="text-[10px] font-bold text-amber-500 uppercase block mb-1">Email Address</label>
                    <input id="admin-email" value="${acc.email || ''}" 
                           class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white outline-none focus:border-amber-500"
                           placeholder="personnel@example.com">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Badge</label>
                    <input id="admin-badge" value="${acc.badgeText || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-amber-500 font-bold">
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-amber-500 uppercase block mb-1">üí∞ Coins</label>
                    <input id="admin-coins" type="number" value="${acc.coins || 0}" class="w-full bg-black border border-amber-500/30 rounded-xl px-4 py-3 text-xs text-amber-500 font-bold font-mono">
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Name</label>
                    <input id="admin-ocname" value="${acc.ocName || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white font-bold">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Visual Resource (Image URL)</label>
                    <input id="admin-profile" value="${acc.profile || ''}" 
                           class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-neutral-400 outline-none focus:border-amber-500"
                           placeholder="https://...">
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Texts</h4>
                <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Slogan</label>
                <input id="admin-slogan" value="${acc.slogan || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white italic"></div>
                <div><label class="text-[10px] font-bold text-neutral-500 uppercase block mb-1">Short Desc</label>
                <input id="admin-shortDesc" value="${acc.shortDesc || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white"></div>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Link Button</h4>
                <div class="grid grid-cols-2 gap-4">
                    <input id="admin-linkText" value="${acc.linkText || ''}" placeholder="Name" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-white">
                    <input id="admin-linkUrl" value="${acc.linkUrl || ''}" placeholder="URL" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-amber-500">
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3">Keywords</h4>
                <div class="grid grid-cols-3 gap-4">
                    <input id="admin-kw1" value="${acc.keyword1 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-500">
                    <input id="admin-kw2" value="${acc.keyword2 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-400">
                    <input id="admin-kw3" value="${acc.keyword3 || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-xs text-center text-amber-300">
                </div>
            </div>

            <div>
                <h4 class="text-xs font-black text-neutral-500 uppercase tracking-widest border-l-4 border-neutral-600 pl-3 mb-4">Details</h4>
                <textarea id="admin-stats" class="w-full bg-black border border-white/10 rounded-xl px-6 py-4 text-xs text-white h-32 resize-none custom-scrollbar leading-relaxed">${acc.stats || ''}</textarea>
            </div>
            
            <!-- Ïù∏Î≤§ÌÜ†Î¶¨ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h4 class="text-xs font-black text-green-500 uppercase tracking-widest border-l-4 border-green-600 pl-3">Inventory Management</h4>
                    <button onclick="openAdminInventoryManager('${acc.loginId}')" class="px-4 py-2 bg-green-900/30 text-green-400 border border-green-500/30 rounded-lg text-[9px] font-bold uppercase hover:bg-green-600 hover:text-white transition-all">
                        <i data-lucide="package" class="w-3 h-3 inline mr-1"></i> Manage Items
                    </button>
                </div>
                <div id="admin-inventory-preview-${acc.loginId}" class="bg-black/50 border border-white/5 rounded-xl p-4 min-h-[60px]">
                    <p class="text-neutral-600 text-[10px] italic">Click "Manage Items" to view and edit inventory</p>
                </div>
            </div>
        </div>
        
        <div class="mt-8 space-y-3">
            <button onclick="handleAdminUpdate('${acc.loginId}')" class="w-full py-5 bg-amber-600 text-white font-black rounded-2xl uppercase tracking-[0.2em] text-xs shadow-2xl active:scale-95 transition-all hover:bg-amber-700">Confirm Over-ride</button>
            
            <button onclick="deleteUserAccount('${acc.loginId}')" class="w-full py-4 bg-red-900/20 border border-red-500/30 text-red-500 font-bold rounded-2xl uppercase tracking-[0.2em] text-[10px] hover:bg-red-900/80 hover:text-white transition-all flex items-center justify-center gap-2">
                <i data-lucide="skull" class="w-4 h-4"></i> Terminate Account
            </button>
        </div>
    `;
    
    // 5. Î™®Îã¨ ÌëúÏãú Î∞è ÏïÑÏù¥ÏΩò Î°úÎìú
    modal.classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.changeMapImage = async (sectorIdx) => {
    if (!state.isAdmin) return;
    
    const sector = state.investigation.sectors[sectorIdx];
    const newUrl = prompt("ÏÉàÎ°úÏö¥ Îßµ Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", sector.map);
    
    if (newUrl && newUrl.trim() !== "") {
        // Î°úÏª¨ ÏÉÅÌÉú Î∞òÏòÅ
        state.investigation.sectors[sectorIdx].map = newUrl;
        
        // Ï§ëÏöî: ÏÑúÎ≤Ñ Ï†ÄÏû• Ïãú investigation Ï†ÑÏ≤¥ Í∞ùÏ≤¥Î•º ÎÑòÍ≤®Ïïº Ìï©ÎãàÎã§.
        await window.handleSystemUpdate(); 
        renderInvestigation(); // ÌôîÎ©¥ Í∞±Ïã†
        showToast(`${sector.name} ÏßÄÎèÑÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`);
    }
};
// --- ÌïµÏã¨ Í¥ÄÎ¶¨ Î≥ÄÏàò ---
let currentEditingIdx = null;
let playIndex = 0;
let activeTimeline = [];

// --- [Ìï¥Í≤∞] Î∏îÎ°ù Ï∂îÍ∞Ä Ìï®ÏàòÎ•º Ï†ÑÏó≠(window)Ïóê ÌôïÏã§Ìûà Îì±Î°ù ---
window.addTimelineBlock = function(type, data = {}) {
    const container = document.getElementById('timeline-container');
    if (!container) {
        console.error("ÏóêÎîîÌÑ∞ Ïª®ÌÖåÏù¥ÎÑà(timeline-container)Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
        return;
    }

    const block = document.createElement('div');
    block.className = `p-4 rounded-2xl border timeline-block animate-fade-in relative bg-white/5 mb-3`;
    block.dataset.type = type;

    let inner = `<button onclick="this.parentElement.remove()" class="absolute top-2 right-3 text-white/20 hover:text-red-500 text-lg">√ó</button>`;

    if (type === 'npc') {
        inner += `
            <div class="space-y-2">
                <span class="text-[9px] font-black text-blue-400 uppercase">NPC Dialogue</span>
                <input placeholder="ÌôîÏûê Ïù¥Î¶Ñ" class="blk-name w-full bg-black/40 border-none rounded-lg p-2 text-xs text-white" value="${data.name || ''}">
                <input placeholder="Ïù¥ÎØ∏ÏßÄ URL" class="blk-img w-full bg-black/40 border-none rounded-lg p-2 text-[10px] text-white/40" value="${data.img || ''}">
                <textarea placeholder="ÎåÄÏÇ¨ ÎÇ¥Ïö©" class="blk-text w-full bg-black/40 border-none rounded-lg p-2 text-xs text-white h-16 resize-none">${data.text || ''}</textarea>
            </div>`;
    } else if (type === 'monologue') {
        inner += `
            <div class="space-y-2">
                <span class="text-[9px] font-black text-purple-400 uppercase">Monologue</span>
                <textarea placeholder="ÎÇòÏùò ÎèÖÎ∞± ÎÇ¥Ïö©" class="blk-text w-full bg-black/40 border-none rounded-lg p-2 text-xs text-purple-200 h-16 resize-none">${data.text || ''}</textarea>
            </div>`;
    } else if (type === 'choice') {
        inner += `
            <div class="space-y-2">
                <span class="text-[9px] font-black text-amber-400 uppercase">Decision Point</span>
                <input placeholder="ÏÑ†ÌÉùÏßÄ 1" class="blk-opt1 w-full bg-black/40 border-none rounded-lg p-2 text-xs text-amber-500" value="${data.opt1 || ''}">
                <textarea placeholder="Í≤∞Í≥º ÎåÄÏÇ¨ 1" class="blk-res1 w-full bg-black/40 border-none rounded-lg p-2 text-[10px] text-white/60 h-10">${data.res1 || ''}</textarea>
                <input placeholder="ÏÑ†ÌÉùÏßÄ 2" class="blk-opt2 w-full bg-black/40 border-none rounded-lg p-2 text-xs text-amber-500" value="${data.opt2 || ''}">
                <textarea placeholder="Í≤∞Í≥º ÎåÄÏÇ¨ 2" class="blk-res2 w-full bg-black/40 border-none rounded-lg p-2 text-[10px] text-white/60 h-10">${data.res2 || ''}</textarea>
            </div>`;
    }

    block.innerHTML = inner;
    container.appendChild(block);
    container.scrollTop = container.scrollHeight;
};
window.editPOI = (globalIdx) => {
    if (!state.isAdmin) return;
    currentEditingIdx = globalIdx;
    const p = state.investigation.points[globalIdx];
    
    document.getElementById('edit-poi-title').value = p.title || "";
    const container = document.getElementById('timeline-container');
    container.innerHTML = ''; // Ï¥àÍ∏∞Ìôî
    
    if (p.timeline && p.timeline.length > 0) {
        p.timeline.forEach(item => addTimelineBlock(item.type, item));
    }
    
    document.getElementById('poi-editor-modal').classList.remove('hidden');
};
window.savePOITimeline = async () => {
    if (currentEditingIdx === null) return;
    
    const blocks = document.querySelectorAll('.timeline-block');
    const timeline = Array.from(blocks).map(blk => {
        const type = blk.dataset.type;
        const d = { type };
        if (type === 'npc') {
            d.name = blk.querySelector('.blk-name').value;
            d.img = blk.querySelector('.blk-img').value;
            d.text = blk.querySelector('.blk-text').value;
        } else if (type === 'monologue') {
            d.text = blk.querySelector('.blk-text').value;
        } else if (type === 'choice') {
            d.opt1 = blk.querySelector('.blk-opt1').value;
            d.res1 = blk.querySelector('.blk-res1').value;
            d.opt2 = blk.querySelector('.blk-opt2').value;
            d.res2 = blk.querySelector('.blk-res2').value;
        }
        return d;
    });

    state.investigation.points[currentEditingIdx].title = document.getElementById('edit-poi-title').value;
    state.investigation.points[currentEditingIdx].timeline = timeline;
    
    if (window.handleSystemUpdate) {
        await window.handleSystemUpdate();
    }
    
    document.getElementById('poi-editor-modal').classList.add('hidden');
    renderInvestigation();
    showToast("ÏãúÎÇòÎ¶¨Ïò§Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
};

window.savePOIEasy = async () => {
    if (currentEditingIdx === null) return;
    
    // 1. ÏûÖÎ†•Ï∞ΩÏóêÏÑú Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
    const title = document.getElementById('edit-poi-title').value;
    const clue = document.getElementById('edit-poi-clue').value;
    const isInteractive = document.getElementById('edit-poi-interactive').checked;
    const npcName = document.getElementById('edit-poi-npc-name').value;
    const npcImage = document.getElementById('edit-poi-npc-image').value;

    // 2. ÏÑ†ÌÉùÏßÄ Î∞∞Ïó¥ Íµ¨ÏÑ±
    const options = [];
    const opt1Text = document.getElementById('edit-opt1-text').value;
    if(opt1Text) {
        options.push({ text: opt1Text, result: document.getElementById('edit-opt1-res').value });
    }
    const opt2Text = document.getElementById('edit-opt2-text').value;
    if(opt2Text) {
        options.push({ text: opt2Text, result: document.getElementById('edit-opt2-res').value });
    }

    // 3. Î°úÏª¨ state ÏóÖÎç∞Ïù¥Ìä∏
    state.investigation.points[currentEditingIdx] = {
        ...state.investigation.points[currentEditingIdx], // Í∏∞Ï°¥ ID, Ï¢åÌëú, ÏÑπÏÖò Ïú†ÏßÄ
        title: title,
        clue: clue,
        isInteractive: isInteractive,
        npcName: npcName,
        npcImage: npcImage,
        options: options
    };
    
    // 4. ÏÑúÎ≤Ñ ÎèôÍ∏∞Ìôî Î∞è UI Í∞±Ïã†
    try {
        if (window.handleSystemUpdate) {
            await window.handleSystemUpdate(); // Ïó¨Í∏∞ÏÑú ÏÑúÎ≤ÑÎ°ú Ïã§Ï†ú Ï†ÄÏû•Ïù¥ ÏùºÏñ¥ÎÇ©ÎãàÎã§.
        }
        document.getElementById('poi-editor-modal').classList.add('hidden');
        renderInvestigation(); // Îßµ ÏúÑÏùò Ï†êÎì§ Îã§Ïãú Í∑∏Î¶¨Í∏∞
        showToast("ÏßÄÏ†ê Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.");
    } catch (e) {
        console.error("Update Error:", e);
        alert("Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
};

window.savePOIJson = async () => {
    try {
        const newData = JSON.parse(document.getElementById('poi-json-input').value);
        state.investigation.points[currentEditingIdx] = {
            ...state.investigation.points[currentEditingIdx],
            ...newData
        };
        await handleSystemUpdate();
        document.getElementById('poi-editor-modal').classList.add('hidden');
        renderInvestigation();
        showToast("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑúÎ≤ÑÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
    } catch (e) {
        alert("JSON ÌòïÏãùÏù¥ ÏûòÎ™ªÎêòÏóàÏäµÎãàÎã§.");
    }
};
window.handleMapClick = async (event) => {
    if (!state.isAdmin) return;
    if (event.target.closest('.clue-point')) return;

    const container = document.getElementById('map-container');
    const rect = container.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 100;
    const y = ((event.clientY - rect.top) / rect.height) * 100;

    const newPoint = {
        id: 'p' + Date.now(),
        sector: state.investigation.selectedSector,
        x: parseFloat(x.toFixed(2)),
        y: parseFloat(y.toFixed(2)),
        title: "ÏÉà Ï°∞ÏÇ¨ ÏßÄÏ†ê",
        clue: "ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.",
        isInteractive: false,
        options: []
    };

    state.investigation.points.push(newPoint);
    await handleSystemUpdate();
    renderInvestigation();
    showToast("ÏßÄÏ†êÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. EDITÏùÑ ÎàåÎü¨ ÎÇ¥Ïö©ÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî.");
};
// 2. Ìè¨Ïù∏Ìä∏ Ïö∞ÌÅ¥Î¶≠ Ïãú ÏÇ≠Ï†ú (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©)
window.handlePointRightClick = (event, idx) => {
    if (!state.isAdmin) return;
    event.preventDefault();
    event.stopPropagation();

    if (confirm(`'${state.investigation.points[idx].title}' ÏßÄÏ†êÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        state.investigation.points.splice(idx, 1);
        
        if (window.handleSystemUpdate) {
            window.handleSystemUpdate();
        }
        
        renderInvestigation();
        showToast("ÏßÄÏ†êÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
    }
};
window.loadUserInvestigationProgress = async () => {
    const listBody = document.getElementById('admin-user-investigation-list');
    if (!listBody) return;

    try {
        // 1. Î™®Îì† Ïú†Ï†Ä Í≥ÑÏ†ï Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏ÏòµÎãàÎã§ (Í∏∞Ï°¥ accounts Î∞∞Ïó¥ ÌôúÏö© Í∞ÄÎä•)
        // ÎßåÏïΩ ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î•º ÏÑúÎ≤ÑÏóêÏÑú Í∞ÄÏ†∏ÏôÄÏïº ÌïúÎã§Î©¥ ÏïÑÎûò Î°úÏßÅ ÏÇ¨Ïö©
        const usersRef = collection(db, 'artifacts', appId, 'accounts');
        const q = query(usersRef, orderBy('name', 'asc'));
        const querySnapshot = await getDocs(q);
        
        let html = '';
        const totalPoints = state.investigation.points.length; // Ï†ÑÏ≤¥ Îã®ÏÑú Í∞úÏàò

        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const foundClues = userData.investigation?.foundClueIds || []; // Ïú†Ï†Ä Î¨∏ÏÑú ÎÇ¥ Ï†ÄÏû•Îêú Ï°∞ÏÇ¨ Îç∞Ïù¥ÌÑ∞
            const count = foundClues.length;
            const percentage = totalPoints > 0 ? Math.round((count / totalPoints) * 100) : 0;

            html += `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-neutral-800 border border-white/10 overflow-hidden flex-shrink-0">
                                ${userData.img ? `<img src="${userData.img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-neutral-600"><i data-lucide="user" class="w-4 h-4"></i></div>`}
                            </div>
                            <div>
                                <p class="text-sm font-black text-white">${userData.name || 'Unknown'}</p>
                                <p class="text-[9px] text-neutral-600 font-mono">${userData.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-6 w-64">
                        <div class="flex items-center gap-4">
                            <div class="flex-1 h-1.5 bg-neutral-800 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-600 shadow-[0_0_10px_rgba(217,119,6,0.5)]" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-[10px] font-black text-amber-500 w-10 text-right">${percentage}%</span>
                        </div>
                    </td>
                    <td class="p-6 text-center">
                        <span class="px-3 py-1 bg-neutral-800 border border-white/10 rounded-full text-[10px] font-mono text-neutral-300">
                            ${count} / ${totalPoints}
                        </span>
                    </td>
                </tr>
            `;
        });

        listBody.innerHTML = html || '<tr><td colspan="3" class="p-20 text-center text-neutral-600 italic">No users registered.</td></tr>';
        if (typeof lucide !== 'undefined') lucide.createIcons();

    } catch (e) {
        console.error("Î™ÖÎã® Î°úÎî© Ïã§Ìå®:", e);
        listBody.innerHTML = '<tr><td colspan="3" class="p-20 text-center text-red-900/50 italic">Failed to load data.</td></tr>';
    }
};

// Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ ÏßÑÏûÖ Ïãú ÏûêÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Î°úÎìúÌïòÎèÑÎ°ù renderAdmin ÌïòÎã®Ïóê Ï∂îÍ∞Ä
// window.loadUserInvestigationProgress();
window.handleAdminUpdate = async (loginId) => {
    try {
        const getVal = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : "";
        };

        const data = { 
            role: getVal('admin-role'),
            position: getVal('admin-position'), 
            email: getVal('admin-email'),
            badgeText: getVal('admin-badge'),
            ocName: getVal('admin-ocname'),
            profile: getVal('admin-profile'),
            slogan: getVal('admin-slogan'), 
            shortDesc: getVal('admin-shortDesc'),
            linkText: getVal('admin-linkText'),
            linkUrl: getVal('admin-linkUrl'),
            keyword1: getVal('admin-kw1'),
            keyword2: getVal('admin-kw2'),
            keyword3: getVal('admin-kw3'),
            stats: getVal('admin-stats'),
            coins: parseInt(getVal('admin-coins')) || 0
        };

        // accounts Ïª¨Î†âÏÖòÏóê Ï†ÄÏû•
        const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
        await setDoc(accountRef, data, { merge: true });
        
        // users Ïª¨Î†âÏÖòÏóêÎèÑ ÏΩîÏù∏ ÏóÖÎç∞Ïù¥Ìä∏ (uidÎ°ú Ï∞æÏïÑÏÑú)
        const targetAccount = state.accounts.find(a => a.loginId === loginId);
        if (targetAccount && targetAccount.uid) {
            const userRef = doc(db, 'artifacts', appId, 'users', targetAccount.uid);
            await setDoc(userRef, { 
                loginId: loginId,
                coins: data.coins 
            }, { merge: true });
        }

        document.getElementById('admin-edit-modal').classList.add('hidden');
        showToast("Record Synchronized.");
        
        const idx = state.accounts.findIndex(a => a.loginId === loginId);
        if (idx !== -1) {
            state.accounts[idx] = { ...state.accounts[idx], ...data };
            // ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÍ∞Ä Ìé∏ÏßëÎêú Í≤ΩÏö∞ Î°úÏª¨ stateÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            if (loginId === state.userAccount?.loginId) {
                state.userAccount = state.accounts[idx];
                updateProfileBarUI();
            }
        }

    } catch (e) {
        console.error("Ï†ÄÏû• Ï§ë ÏóêÎü¨ Î∞úÏÉù:", e);
        showToast("Update Failed.");
    }
};


window.returnToSectors = () => {
    if (!state.investigation) return;
    state.investigation.selectedSector = null; // ÏÑ†ÌÉùÎêú ÏÑπÌÑ∞ Ï¥àÍ∏∞Ìôî
    renderInvestigation(); // Îã§Ïãú Í∑∏Î¶¨Î©¥ selectedSectorÍ∞Ä nullÏù¥Îùº ÏÑπÌÑ∞ ÏÑ†ÌÉùÏ∞ΩÏù¥ ÎúπÎãàÎã§.
};

// 2. Í¥ÄÎ¶¨ÏûêÏö© Ïú†Ï†Ä Ï°∞ÏÇ¨ ÏßÑÏ≤ôÎèÑ Î™ÖÎã® Î°úÎìú Ìï®Ïàò
window.loadUserInvestigationProgress = async () => {
    const listBody = document.getElementById('admin-user-investigation-list');
    if (!listBody) return;

    try {
        const usersRef = collection(db, 'artifacts', appId, 'accounts');
        const q = query(usersRef, orderBy('name', 'asc'));
        const querySnapshot = await getDocs(q);
        
        let html = '';
        const totalPoints = state.investigation.points.length;

        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const foundClues = userData.investigation?.foundClueIds || [];
            const count = foundClues.length;
            const percentage = totalPoints > 0 ? Math.round((count / totalPoints) * 100) : 0;

            html += `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-4 text-left">
                            <div class="w-10 h-10 rounded-full bg-neutral-800 border border-white/10 overflow-hidden">
                                ${userData.img ? `<img src="${userData.img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-neutral-600"><i data-lucide="user" class="w-4 h-4"></i></div>`}
                            </div>
                            <div>
                                <p class="text-sm font-black text-white">${userData.name || 'Unknown'}</p>
                                <p class="text-[9px] text-neutral-600 font-mono">${userData.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-6 w-64">
                        <div class="flex items-center gap-4">
                            <div class="flex-1 h-1.5 bg-neutral-800 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-600 shadow-[0_0_10px_rgba(217,119,6,0.5)]" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-[10px] font-black text-amber-500 w-10 text-right">${percentage}%</span>
                        </div>
                    </td>
                    <td class="p-6 text-center text-[10px] font-mono text-neutral-300">
                        ${count} / ${totalPoints}
                    </td>
                </tr>
            `;
        });

        listBody.innerHTML = html || '<tr><td colspan="3" class="p-20 text-center text-neutral-600">No data.</td></tr>';
        if (typeof lucide !== 'undefined') lucide.createIcons();

    } catch (e) {
        console.error("Î™ÖÎã® Î°úÎî© Ïã§Ìå®:", e);
    }
};

window.handleDiscovery = (id) => {
    const point = state.investigation.points.find(p => p.id === id);
    if (!point) return;

    // ÌÉÄÏûÑÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥)
    activeTimeline = point.timeline || [];
    playIndex = 0;
    
    const panel = document.getElementById('discovery-panel');
    if (panel) {
        panel.classList.remove('hidden');
        
        // Î∏îÎ°ùÏù¥ ÌïòÎÇòÎèÑ ÏóÜÏùÑ Í≤ΩÏö∞ Ï≤òÎ¶¨
        if (activeTimeline.length === 0) {
            document.getElementById('discovery-name').innerText = "ÏãúÏä§ÌÖú";
            document.getElementById('discovery-clue').innerText = "ÏïÑÏßÅ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏûëÏÑ±ÎêòÏßÄ ÏïäÏùÄ ÏßÄÏ†êÏûÖÎãàÎã§.";
            document.getElementById('discovery-next-btn').onclick = () => panel.classList.add('hidden');
        } else {
            playNextStep();
        }
    }
};

function playNextStep() {
    if (playIndex >= activeTimeline.length) {
        const panel = document.getElementById('discovery-panel');
        if (panel) panel.classList.add('hidden');
        return;
    }

    const step = activeTimeline[playIndex];
    const nameEl = document.getElementById('discovery-name');
    const clueEl = document.getElementById('discovery-clue');
    const npcImg = document.getElementById('discovery-npc');
    const optionsEl = document.getElementById('discovery-options');
    const nextBtn = document.getElementById('discovery-next-btn');

    if (optionsEl) optionsEl.innerHTML = '';
    if (nextBtn) nextBtn.classList.remove('hidden');

    const triggerFadeIn = () => {
        if (!clueEl) return;
        clueEl.classList.remove('animate-fade-in');
        void clueEl.offsetWidth;
        clueEl.classList.add('animate-fade-in');
    };

    // --- [Ï∂îÍ∞Ä] Î°úÍ∑∏ Í∏∞Î°ù Ìï®Ïàò ---
    const recordToLog = (speaker, text) => {
        if (!text) return;
        // Í∏∞Ï°¥Ïóê ÎßåÎì§Ïñ¥Îëî addInvestigationLog Ìï®ÏàòÎ•º Ìò∏Ï∂úÌï©ÎãàÎã§.
        if (typeof addInvestigationLog === 'function') {
            addInvestigationLog(speaker, text);
            // Ïö∞Ï∏° UI Î¶¨Ïä§Ìä∏Î•º Ï¶âÏãú Í∞±Ïã†Ìï©ÎãàÎã§.
            if (window.updateInvestigationSideList) window.updateInvestigationSideList();
        }
    };

    if (step.type === 'npc' || step.type === 'monologue') {
        const speakerName = step.name || (step.type === 'monologue' ? "ÎÇò" : "???");
        const message = step.text || "";

        if (nameEl) nameEl.innerText = speakerName;
        if (clueEl) {
            clueEl.innerText = message;
            triggerFadeIn();
        }

        // NPC Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨
        if (npcImg) {
            if (step.type === 'npc' && step.img) {
                npcImg.src = step.img;
                npcImg.style.opacity = "1";
                npcImg.style.transform = "translateY(0)";
            } else {
                npcImg.style.opacity = "0";
                npcImg.style.transform = "translateY(20px)";
            }
        }

        // --- Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ Í∏∞Î°ù ---
        recordToLog(speakerName, message);

        if (nextBtn) nextBtn.onclick = playNextStep;

    } else if (step.type === 'choice') {
        if (nextBtn) nextBtn.classList.add('hidden');
        if (nameEl) nameEl.innerText = "ÏÑ†ÌÉùÏßÄ";
        if (clueEl) clueEl.innerText = "ÏÑ†ÌÉùÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§...";

        [1, 2].forEach(i => {
            const optText = step['opt' + i];
            const resText = step['res' + i];
            
            if (optText) {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 mb-3 bg-white/5 border border-white/10 rounded-xl text-left text-white text-sm hover:bg-white hover:text-black transition-all flex items-center gap-3 group";
                btn.innerHTML = `<span class="w-1.5 h-1.5 bg-amber-500 rounded-full group-hover:scale-150 transition-transform"></span> ${optText}`;
                
                btn.onclick = () => {
                    if (clueEl) {
                        clueEl.innerText = resText || "";
                        triggerFadeIn();
                    }
                    
                    // --- ÏÑ†ÌÉù Í≤∞Í≥º Î°úÍ∑∏ Í∏∞Î°ù ---
                    recordToLog(`ÏÑ†ÌÉù: ${optText}`, resText);

                    if (optionsEl) optionsEl.innerHTML = '';
                    if (nextBtn) {
                        nextBtn.classList.remove('hidden');
                        nextBtn.onclick = playNextStep;
                    }
                };
                if (optionsEl) optionsEl.appendChild(btn);
            }
        });
    }

    playIndex++;
}

// ÏÑ†ÌÉùÏßÄ ÌëúÏãú (ÏÑ∏Î†®Îêú Ïï†ÎãàÎ©îÏù¥ÏÖò Î≤ÑÌäº)
function showOptions(point) {
    const optionsEl = document.getElementById('discovery-options');
    optionsEl.innerHTML = '';
    
    point.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "group relative px-10 py-4 bg-white/5 hover:bg-white text-white hover:text-black border border-white/20 rounded-full text-sm font-bold transition-all duration-300 transform hover:translate-x-4 flex items-center gap-4";
        btn.innerHTML = `
            <span class="w-2 h-2 bg-amber-500 rounded-full group-hover:scale-150 transition-transform"></span>
            ${opt.text}
        `;
        btn.onclick = () => {
            // ÏÑ†ÌÉù Í≤∞Í≥ºÎèÑ ÎåÄÌôîÏ∞ΩÏóê ÌëúÏãú
            document.getElementById('discovery-clue').innerText = opt.result;
            optionsEl.innerHTML = '';
            setTimeout(() => finishInvestigation(point), 2000);
        };
        optionsEl.appendChild(btn);
    });
}

function finishInvestigation(point) {
    // Í∏∞Î°ù Ï†ÄÏû• Î∞è Ï¢ÖÎ£å Î°úÏßÅ
    let localFoundIds = JSON.parse(localStorage.getItem('my_found_clues') || "[]");
    if (!localFoundIds.includes(point.id)) {
        localFoundIds.push(point.id);
        localStorage.setItem('my_found_clues', JSON.stringify(localFoundIds));
    }
    // "Close" Î≤ÑÌäº ÎÖ∏Ï∂ú ÌòπÏùÄ ÏûêÎèô Îã´Í∏∞
    document.getElementById('discovery-next-btn').innerHTML = "Close Signal";
    document.getElementById('discovery-next-btn').classList.remove('hidden');
    document.getElementById('discovery-next-btn').onclick = () => {
        document.getElementById('discovery-panel').classList.add('hidden');
    };
}

function addInvestigationLog(title, text) {
    if (!state.investigation.logs) state.investigation.logs = []; 
    
    state.investigation.logs.push({
        title: title,
        text: text,
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    });
}
window.saveInvestigationToDB = async () => {
    try {
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await updateDoc(worldRef, {
            "investigation.points": state.investigation.points,
            "investigation.currentMap": state.investigation.currentMap
        });
    } catch (e) {
        console.error("DB Sync Error:", e);
    }
};
window.toggleArchive = () => {
    const modal = document.getElementById('archive-modal');
    const list = document.getElementById('archive-list');
    if (!modal || !list) return;

    modal.classList.toggle('hidden');

    if (!modal.classList.contains('hidden')) {
        const inv = state.investigation;
        const foundClues = inv.points.filter(p => inv.foundClueIds.includes(p.id));

        if (foundClues.length === 0) {
            list.innerHTML = '<p class="text-center text-neutral-600 py-10 italic text-sm font-mono">NO SIGNALS ARCHIVED.</p>';
        } else {
            list.innerHTML = foundClues.map(c => {
                const isNew = !inv.viewedClueIds.includes(c.id);
                return `
                    <div onclick="showFullClue('${c.id}')" 
                         class="p-6 bg-black/40 border border-white/5 rounded-2xl mb-4 cursor-pointer hover:border-amber-500/40 transition-all group relative">
                        <div class="flex justify-between items-center mb-2 pointer-events-none">
                            <p class="text-amber-500 text-[10px] font-black uppercase tracking-[0.2em]">${c.title}</p>
                            ${isNew ? '<span class="bg-red-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded shadow-lg animate-pulse">NEW</span>' : ''}
                        </div>
                        <p class="text-xs text-neutral-400 line-clamp-1 group-hover:text-neutral-200 transition-colors pointer-events-none italic">"${c.clue}"</p>
                    </div>`;
            }).join('');
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
};

window.showFullClue = async (id) => {
    const inv = state.investigation;
    const clue = inv.points.find(p => p.id === id);
    if (!clue) return;

    // ÏùΩÏùå Ï≤òÎ¶¨ (NEW Ï†úÍ±∞)
    if (!inv.viewedClueIds.includes(id)) {
        inv.viewedClueIds.push(id);
        if (window.handleSystemUpdate) await window.handleSystemUpdate();
    }

    const panel = document.getElementById('discovery-panel');
    $('discovery-title').innerText = `Archive: ${clue.title}`;
    $('discovery-clue').innerText = `"${clue.clue}"`;
    panel.classList.remove('hidden');
    
    // Î¶¨Ïä§Ìä∏ Ïã§ÏãúÍ∞Ñ Í∞±Ïã† (Î™®Îã¨ Îã´ÏßÄ ÏïäÍ≥† Í∑∏Î¶¨Í∏∞)
    window.toggleArchive(); window.toggleArchive(); 
};

// Îã®ÏÑú Ï†ÑÎ¨∏ Î≥¥Í∏∞ Ìï®Ïàò
window.showFullClue = async (id) => {
    const inv = state.investigation;
    const clue = inv.points.find(p => p.id === id);
    if (!clue) return;

    // 1. ÏùΩÏùå Ï≤òÎ¶¨ (NEW Ï†úÍ±∞)
    if (!inv.viewedClueIds) inv.viewedClueIds = [];
    if (!inv.viewedClueIds.includes(id)) {
        inv.viewedClueIds.push(id);
        // ÏÑúÎ≤Ñ ÏÉÅÌÉú Ï†ÄÏû•
        if (window.handleSystemUpdate) await window.handleSystemUpdate();
    }

    // 2. Ï†ÑÎ¨∏ÏùÑ Î≥¥Ïó¨Ï§Ñ ÌåùÏóÖ (discovery-panel Ïû¨ÌôúÏö©)
    const panel = document.getElementById('discovery-panel');
    const title = document.getElementById('discovery-title');
    const clueText = document.getElementById('discovery-clue');

    if (panel && title && clueText) {
        title.innerText = `Archive: ${clue.title}`;
        clueText.innerText = `"${clue.clue}"`;
        panel.classList.remove('hidden');
    }
    
    // 3. ÏïÑÏπ¥Ïù¥Î∏å Î¶¨Ïä§Ìä∏ Ïã§ÏãúÍ∞Ñ Í∞±Ïã† (NEW Î∞∞ÏßÄ Ï¶âÏãú Ï†úÍ±∞)
    // Î™®Îã¨ÏùÑ Îã´ÏßÄ ÏïäÍ≥† ÎÇ¥Ïö©Îßå Îã§Ïãú Í∑∏Î¶ΩÎãàÎã§.
    const list = document.getElementById('archive-list');
    if (list) {
        const foundIds = inv.foundClueIds || [];
        const viewedIds = inv.viewedClueIds || [];
        const foundClues = inv.points.filter(p => foundIds.includes(p.id));
        
        list.innerHTML = foundClues.map(c => {
            const isNew = !viewedIds.includes(c.id);
            return `
                <div onclick="showFullClue('${c.id}')" 
                     class="p-5 bg-black/40 border border-white/5 rounded-2xl mb-4 cursor-pointer hover:border-amber-500/50 transition-all group relative">
                    <div class="flex justify-between items-center mb-2 pointer-events-none">
                        <p class="text-amber-500 text-[10px] font-black uppercase tracking-widest">${c.title}</p>
                        ${isNew ? '<span class="new-badge">NEW</span>' : ''}
                    </div>
                    <p class="text-xs text-neutral-500 line-clamp-1 group-hover:text-neutral-300 transition-colors pointer-events-none">${c.clue}</p>
                </div>`;
        }).join('');
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
        // [Ï∂îÍ∞Ä] ÏãúÏä§ÌÖú Î∞∞ÎÑà(Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©) Ï†ÄÏû• Ìï®Ïàò
window.handleSystemUpdate = async () => {
    // 1. Îç∞Ïù¥ÌÑ∞ Î™®ÏúºÍ∏∞ (ÏûÖÎ†• ÌïÑÎìúÍ∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ Í∏∞Ï°¥ state Í∞íÏùÑ ÏÇ¨Ïö©ÌïòÎèÑÎ°ù Î∞©Ïñ¥ ÏΩîÎìú Ï∂îÍ∞Ä)
    const updateData = {
        // Î∞∞ÎÑà Î∞è Î∞∞Í≤Ω ÏÑ§Ï†ï (ÌôîÎ©¥Ïóê ÏûÖÎ†•Ï∞ΩÏù¥ ÏûàÏùÑ ÎïåÎßå Í∞ÄÏ†∏Ïò§Í≥†, ÏóÜÏúºÎ©¥ ÌòÑÏû¨ Í∞íÏùÑ Ïú†ÏßÄ)
        login_bg: document.getElementById('sys-login-bg')?.value || state.world.login_bg || "",
        
        banner1_text: document.getElementById('sys-btn1-text')?.value || state.world.banner1_text || "",
        banner1_url: document.getElementById('sys-btn1-url')?.value || state.world.banner1_url || "",
        banner1_img: document.getElementById('sys-btn1-img')?.value || state.world.banner1_img || "",
        
        banner2_text: document.getElementById('sys-btn2-text')?.value || state.world.banner2_text || "",
        banner2_url: document.getElementById('sys-btn2-url')?.value || state.world.banner2_url || "",
        banner2_img: document.getElementById('sys-btn2-img')?.value || state.world.banner2_img || "",
        
        banner3_text: document.getElementById('sys-btn3-text')?.value || state.world.banner3_text || "",
        banner3_url: document.getElementById('sys-btn3-url')?.value || state.world.banner3_url || "",
        banner3_img: document.getElementById('sys-btn3-img')?.value || state.world.banner3_img || "",

        // [Ï§ëÏöî] Ï°∞ÏÇ¨ ÏãúÏä§ÌÖú Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®
        investigation: state.investigation
    };
    
    try {
        // 2. Firebase Í≤ΩÎ°ú ÏÑ§Ï†ï
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        
        // 3. ÏÑúÎ≤ÑÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° (data ÎåÄÏã† updateDataÎ°ú Î≥ÄÏàòÎ™Ö ÏùºÏπò)
        await setDoc(worldRef, updateData, { merge: true });
        
        // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ÎèÑ ÏµúÏã†Ìôî
        state.world = { ...state.world, ...updateData };
        
        console.log("ÏÑúÎ≤Ñ Ï†ÄÏû• ÏÑ±Í≥µ:", updateData);
        showToast("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑúÎ≤ÑÏóê ÎèôÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.");
    } catch (e) {
        console.error("ÏÑúÎ≤Ñ Ï†ÄÏû• ÏóêÎü¨ ÏÉÅÏÑ∏:", e);
        showToast("Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. F12 ÏΩòÏÜîÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
    }
};

        window.handleAdminAuth = () => { if ($('admin-pw-input').value === ADMIN_PW) { state.isAdmin = true; renderView('admin'); } else showToast("Access Denied."); };
        window.approveUser = async (id) => { 
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { 
                status: 'approved',
                currentHP: 100,  // Ï¥àÍ∏∞ HP ÏÑ§Ï†ï
                currentMP: 50    // Ï¥àÍ∏∞ MP ÏÑ§Ï†ï
            }, { merge: true }); 
            showToast("Authorized."); 
        };
        window.rejectUser = async (id) => { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { status: 'rejected' }, { merge: true }); };

        // HP/MP Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        window.updateUserHPMP = async (loginId) => {
            try {
                const currentHP = parseInt(document.getElementById(`hp-current-${loginId}`).value);
                const currentMP = parseInt(document.getElementById(`mp-current-${loginId}`).value);
                
                if (isNaN(currentHP) || isNaN(currentMP)) {
                    showToast("Invalid HP/MP values!");
                    return;
                }
                
                const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
                await setDoc(accountRef, {
                    currentHP: currentHP,
                    currentMP: currentMP,
                    lastBattleAt: serverTimestamp()
                }, { merge: true });
                
                showToast(`‚úÖ ${loginId} HP/MP updated!`);
                console.log(`‚úÖ Í¥ÄÎ¶¨ÏûêÍ∞Ä ${loginId}Ïùò HP/MP ÏóÖÎç∞Ïù¥Ìä∏: HP=${currentHP}, MP=${currentMP}`);
            } catch(e) {
                console.error("HP/MP ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:", e);
                showToast("Update failed!");
            }
        };

        window.resetAllHP = async () => {
            if (!confirm("Î™®Îì† Ïú†Ï†ÄÏùò HPÎ•º ÏµúÎåÄÏπòÎ°ú Î≥µÍµ¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
            
            try {
                const approveds = state.accounts.filter(a => a.status === 'approved');
                const promises = approveds.map(async (a) => {
                    const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', a.loginId);
                    await setDoc(accountRef, {
                        currentHP: parseInt(a.stat_hp) || 100,
                        lastBattleAt: serverTimestamp()
                    }, { merge: true });
                });
                
                await Promise.all(promises);
                showToast("‚úÖ All HP reset to max!");
                renderAdmin(); // ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ®
            } catch(e) {
                console.error("HP Î¶¨ÏÖã Ïã§Ìå®:", e);
                showToast("Reset failed!");
            }
        };

        window.resetAllMP = async () => {
            if (!confirm("Î™®Îì† Ïú†Ï†ÄÏùò MPÎ•º ÏµúÎåÄÏπòÎ°ú Î≥µÍµ¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
            
            try {
                const approveds = state.accounts.filter(a => a.status === 'approved');
                const promises = approveds.map(async (a) => {
                    const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', a.loginId);
                    await setDoc(accountRef, {
                        currentMP: parseInt(a.stat_mp) || 50,
                        lastBattleAt: serverTimestamp()
                    }, { merge: true });
                });
                
                await Promise.all(promises);
                showToast("‚úÖ All MP reset to max!");
                renderAdmin(); // ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ®
            } catch(e) {
                console.error("MP Î¶¨ÏÖã Ïã§Ìå®:", e);
                showToast("Reset failed!");
            }
        };

        // HP/MP ÏÑπÏÖò ÌÜ†Í∏Ä
        window.toggleHPMPSection = () => {
            const content = document.getElementById('hpmp-content');
            const icon = document.getElementById('hpmp-toggle-icon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(-90deg)';
            }
        };

        function showAuthGate() {
    const gate = $('auth-view');
    const dynamicBg = $('auth-dynamic-bg');
    
    // Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏÑ§Ï†ïÌïú Ï†ÑÏö© Î∞∞Í≤ΩÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©ÌïòÍ≥†, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í(Banner 01 Îì±)ÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.
    const bgUrl = state.world.login_bg || state.world.banner1_img || '';
    
    if (dynamicBg && bgUrl) {
        dynamicBg.style.backgroundImage = `url('${bgUrl}')`;
    }

    gate.classList.remove('hidden');
    
    if (state.authMode === 'login') {
        $('signup-extra').classList.add('hidden');
        $('auth-submit-btn').innerText = "Initialize Session";
        $('auth-toggle-btn').innerText = "Request New Identity";
    } else {
        $('signup-extra').classList.remove('hidden');
        $('auth-submit-btn').innerText = "Submit Application";
        $('auth-toggle-btn').innerText = "Already have an ID?";
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

        function setupAuthEvents() {
            $('auth-toggle-btn').onclick = () => { state.authMode = state.authMode === 'login' ? 'signup' : 'login'; showAuthGate(); };
            $('auth-submit-btn').onclick = async () => {
                const id = $('auth-id').value.trim();
                const pw = $('auth-pw').value.trim();
                if (!id || !pw) return showToast("Enter credentials.");
                if (state.authMode === 'signup') {
                    const ocName = $('auth-oc-name').value.trim();
                    if (!ocName) return showToast("Enter OC Name.");
                    const exists = state.accounts.find(a => a.loginId === id);
                    if (exists) return showToast("ID already exists.");
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), {
                            uid: state.user.uid, loginId: id, password: pw, ocName: ocName,
                            profile: "https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png",
                            slogan: "Ï∫êÏπòÌîÑÎ†àÏù¥Ï¶àÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî", status: 'pending', level: 30, createdAt: serverTimestamp(),
                            stats: "Ïù¥Í≥≥Ïóê Ï∫êÎ¶≠ÌÑ∞Ïùò ÏÑ§Î™ÖÏùÑ Ï†ÅÏäµÎãàÎã§.",
                            currentHP: 100,  // Ï¥àÍ∏∞ HP
                            currentMP: 50    // Ï¥àÍ∏∞ MP
                        });
                        showPendingGateUI();
                    } catch(e) { console.error(e); }
                } else {
                    const target = state.accounts.find(a => a.loginId === id && a.password === pw);
                    if (target) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', id), { uid: state.user.uid }, { merge: true });
                        showToast("Link established.");
                    } else { showToast("Unauthorized signal."); }
                }
            };
        }

        function showPendingGateUI() {
            $('auth-view').classList.add('hidden');
            $('content-area').innerHTML = `<div class="flex-1 flex flex-col items-center justify-center text-center p-12 h-full"><i data-lucide="clock" class="w-20 h-20 text-amber-500/20 animate-spin-slow"></i><h2 class="text-4xl font-serif font-black text-white uppercase mt-12 tracking-widest leading-none">Wait for Authorization</h2><p class="text-sm text-neutral-500 mt-6 max-w-xs leading-relaxed italic">Í¥ÄÎ¶¨ÏûêÏùò ÏäπÏù∏Ïù¥ ÏôÑÎ£åÎê† ÎïåÍπåÏßÄ Ïã†Ìò∏Í∞Ä Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§.</p><button onclick="handleLogout()" class="text-[10px] text-red-900 font-bold mt-16 uppercase underline decoration-red-950 tracking-widest">Disconnect Transmission</button></div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderSidebarUI() {
    const v = state.currentView;
    const isMobile = window.innerWidth < 768;
    
    // Î™®Î∞îÏùºÏù¥Î©¥ ÌïòÎã®, PCÎ©¥ Ï¢åÏ∏°
    const container = isMobile ? $('mobile-nav-bar') : $('sidebar-nav');
    if (!container) return;

    // [ÏàòÏ†ïÎê®] ÏùΩÏßÄ ÏïäÏùÄ Ï±ÑÌåÖÎ∞©Ïù¥ ÏûàÎäîÏßÄ Í≥ÑÏÇ∞ (Î©îÏùºÎ∞ïÏä§Ïö© Î†àÎìúÎã∑)
    const myId = state.userAccount?.loginId;
    const hasUnreadChat = state.chatRooms.some(r => {
        // ÎÇ¥Í∞Ä ÏÜçÌïú Î∞©Ïù¥Í≥† + ÎßàÏßÄÎßâ Î©îÏãúÏßÄÍ∞Ä ÏûàÍ≥† + (Ïïà ÏùΩÏóàÍ±∞ÎÇò || ÏùΩÏùÄ ÏãúÍ∞ÑÏù¥ Î©îÏãúÏßÄ ÏãúÍ∞ÑÎ≥¥Îã§ Ïù¥Ï†ÑÏùº Îïå)
        return r.members.includes(myId) && 
               r.lastMessageTimestamp && 
               (!r.lastRead || !r.lastRead[myId] || r.lastRead[myId].seconds < r.lastMessageTimestamp.seconds);
    });

    // Î©îÎâ¥ ÏïÑÏù¥ÌÖú Ï†ïÏùò
    // [ÏàòÏ†ïÎê®] PC Î≤ÑÏ†ÑÏùº Îïå 'pl-8' (ÏôºÏ™Ω Ïó¨Î∞±) Ï∂îÍ∞ÄÌïòÏó¨ Î≤ΩÏóêÏÑú ÎùÑÏõÄ
    const navHTML = `
        <div class="flex ${isMobile ? 'flex-row justify-around w-full' : 'flex-col gap-8 pl-8'}">
            
            <button onclick="switchView('home')" class="group flex items-center gap-4 transition-all ${v === 'home' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'home' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'home' ? 'text-white' : ''}">Dashboard</span>` : ''}
            </button>

            <button onclick="switchView('mail')" class="group flex items-center gap-4 transition-all ${v === 'mail' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="mail" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'mail' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                    
                    ${hasUnreadChat ? `<span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>` : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'mail' ? 'text-white' : ''}">Mailbox</span>` : ''}
            </button>

            <button onclick="switchView('operation')" class="group flex items-center gap-4 transition-all ${v === 'operation' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="crosshair" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'operation' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'operation' ? 'text-white' : ''}">Operation</span>` : ''}
            </button>

            <button onclick="switchView('members')" class="group flex items-center gap-4 transition-all ${v === 'members' || v === 'visit' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="users" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'members' || v === 'visit' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'members' || v === 'visit' ? 'text-white' : ''}">Gallery</span>` : ''}
            </button>

            <button onclick="switchView('profile')" class="group flex items-center gap-4 transition-all ${v === 'profile' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="eye" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'profile' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'profile' ? 'text-white' : ''}">Personnel</span>` : ''}
            </button>

            <button onclick="switchView('admin')" class="group flex items-center gap-4 transition-all ${v === 'admin' ? 'text-amber-500' : 'text-neutral-500 hover:text-white'}">
                <div class="relative">
                    <i data-lucide="shield" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    ${v === 'admin' ? '<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-1 h-4 bg-amber-500 rounded-r-full shadow-[0_0_10px_#f59e0b]"></span>' : ''}
                </div>
                ${!isMobile ? `<span class="text-[10px] font-bold tracking-[0.2em] uppercase ${v === 'admin' ? 'text-white' : ''}">System</span>` : ''}
            </button>
        </div>
    `;

    container.innerHTML = navHTML;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

        function updateSidebarUI() {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            const active = $(`nav-${state.currentView}`);
            if (active) active.classList.add('active');
        }

        function updateProfileBarUI() {
            const acc = state.userAccount;
            if (!acc || acc.status === 'new') return;
            $('user-name-display').innerText = acc.ocName || 'Personnel';
            $('user-id-display').innerText = `ID: ${acc.loginId || 'Guest'}`;
            $('user-coins-display').innerText = acc.coins || 0;
            if (acc.profile) {
                $('user-avatar').src = acc.profile;
                $('user-avatar').classList.remove('hidden');
                $('user-avatar-placeholder').classList.add('hidden');
            }
        }
        
        // [Ï∂îÍ∞Ä] ÏΩîÏù∏ ÎèôÍ∏∞Ìôî Ìó¨Ìçº Ìï®Ïàò - usersÏôÄ accounts Ïª¨Î†âÏÖò ÏñëÏ™Ω ÏóÖÎç∞Ïù¥Ìä∏
        window.syncUserCoins = async (uid, loginId, newCoins) => {
            try {
                // 1. users Ïª¨Î†âÏÖò ÏóÖÎç∞Ïù¥Ìä∏ (uid Í∏∞Ï§Ä)
                const userRef = doc(db, 'artifacts', appId, 'users', uid);
                await setDoc(userRef, { coins: newCoins }, { merge: true });
                
                // 2. accounts Ïª¨Î†âÏÖò ÏóÖÎç∞Ïù¥Ìä∏ (loginId Í∏∞Ï§Ä)
                const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
                await setDoc(accountRef, { coins: newCoins }, { merge: true });
                
                // 3. Î°úÏª¨ state ÏóÖÎç∞Ïù¥Ìä∏
                state.userAccount.coins = newCoins;
                updateProfileBarUI();
                
                console.log(`‚úÖ ÏΩîÏù∏ ÎèôÍ∏∞Ìôî ÏôÑÎ£å: ${newCoins} coins`);
            } catch(e) {
                console.error("‚ùå ÏΩîÏù∏ ÎèôÍ∏∞Ìôî Ïã§Ìå®:", e);
                throw e;
            }
        };
        
        window.autoResize = (textarea) => {
    textarea.style.height = 'auto'; // ÎÜíÏù¥ Ï¥àÍ∏∞Ìôî
    textarea.style.height = textarea.scrollHeight + 'px'; // ÎÇ¥Ïö©ÎßåÌÅº ÎäòÎ¶º
};

        window.handleLogout = async () => { try { await signOut(auth); window.location.reload(); } catch(e) { console.error(e); } };

        function showToast(msg) {
            const t = $('toast');
            $('toast-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
        
        // showToastÎ•º Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂ú
        window.showToast = showToast;
        // [Ï∂îÍ∞Ä] Î©îÏãúÏßÄ ÏÇ≠Ï†ú Ìï®Ïàò (Soft Delete)
window.deleteMessage = async (msgId) => {
    if (!confirm("Ïù¥ Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
    
    try {
        const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'messages', msgId);
        // Î©îÏãúÏßÄÎ•º Ïã§Ï†úÎ°ú ÏßÄÏö∞ÏßÄ ÏïäÍ≥†, 'ÏÇ≠Ï†úÎê®' ÏÉÅÌÉúÎ°úÎßå Î≥ÄÍ≤Ω
        await updateDoc(msgRef, {
            isDeleted: true
        });
    } catch(e) {
        console.error("Delete failed:", e);
        showToast("Error deleting message.");
    }
};
function renderVisitProfile() {
    const targetId = state.visitTargetId; // Î∞©Î¨∏Ìï† ÎåÄÏÉÅ ID
    if (!targetId) return switchView('members');

    const targetUser = state.accounts.find(a => a.loginId === targetId);
    if (!targetUser) return switchView('members');

    $('content-area').innerHTML = `
        <div class="relative h-full w-full flex flex-col overflow-hidden bg-[#0a0a0a] animate-fade-in">
            
            <div class="absolute inset-0 z-0">
                <img src="${targetUser.profile}" class="w-full h-full object-cover opacity-80 blur-[10px] scale-110 grayscale brightness-50">
                <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0a] via-[#0a0a0a]/80 to-transparent"></div>
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMDUpIiAvPgo8L3N2Zz4=')] opacity-20"></div>
            </div>

            <div class="absolute inset-y-0 right-[2%] lg:right-[8%] w-[80%] lg:w-[55%] z-10 pointer-events-none flex items-end justify-end">
                <img src="${targetUser.profile}" class="h-[90%] w-full object-contain object-bottom drop-shadow-2xl opacity-100 mask-image-bottom">
            </div>

            <div class="relative z-20 h-full flex flex-col justify-center pl-12 lg:pl-24 max-w-[65%] pointer-events-none">
                <div class="mb-6 flex items-center gap-4 animate-slide-up" style="animation-delay: 0.1s;">
                    <div class="bg-amber-600/20 text-amber-500 px-4 py-1.5 border border-amber-500/30 rounded-full text-[10px] font-black tracking-[0.3em] uppercase backdrop-blur-md">
                        ${targetUser.badgeText || 'Level: ' + (targetUser.level || 'Unknown')}
                    </div>
                </div>

                <h1 class="font-serif font-black text-white tracking-tighter uppercase whitespace-nowrap leading-none mb-8 drop-shadow-xl animate-slide-up" 
                    style="font-size: clamp(3rem, 6vw, 8rem); animation-delay: 0.2s;">
                    ${targetUser.ocName}
                </h1>

                <div class="border-l-4 border-amber-600 pl-6 animate-slide-up" style="animation-delay: 0.3s;">
                    <h3 class="text-2xl lg:text-4xl font-serif font-bold text-white mb-4 leading-tight tracking-tight">
                        ${targetUser.slogan || 'No slogan registered.'}
                    </h3>
                    <p class="text-xs text-neutral-400 tracking-wide font-mono leading-relaxed max-w-md opacity-70">
                        ${targetUser.shortDesc || targetUser.stats || 'No detailed records found.'}
                    </p>
                </div>
                
                <div class="mt-10 pointer-events-auto w-fit animate-slide-up" style="animation-delay: 0.4s;">
                    ${targetUser.linkUrl ? `
                    <a href="${targetUser.linkUrl}" target="_blank" class="group cursor-pointer hover:scale-105 transition-transform block">
                        <div class="bg-amber-600/10 backdrop-blur-md border border-amber-500/30 p-1 rounded-lg">
                            <div class="bg-amber-600 w-32 h-12 rounded-md relative overflow-hidden flex flex-col items-center justify-center border border-amber-400/50 shadow-[0_0_20px_rgba(217,119,6,0.4)]">
                                <p class="text-[6px] text-black/60 font-black uppercase tracking-widest mb-0.5">External Link</p>
                                <h3 class="text-xs text-white font-serif font-black uppercase tracking-tighter italic drop-shadow-md flex items-center gap-1">
                                    ${targetUser.linkText || 'ENTER'} <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </h3>
                            </div>
                        </div>
                    </a>
                    ` : ''}
                </div>
            </div>

            <div class="absolute right-8 top-1/2 -translate-y-1/2 z-30 flex flex-col gap-6 pointer-events-auto">
                <button onclick="startOneOnOneChat('${targetUser.loginId}')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-white/10 flex items-center justify-center shadow-2xl group-hover:border-amber-500 group-hover:bg-amber-600/20 transition-all">
                        <i data-lucide="mail" class="w-6 h-6 text-white group-hover:text-amber-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-white bg-black/50 px-2 py-1 rounded">1:1 Message</span>
                </button>

                <button onclick="openGiftModal('${targetUser.loginId}')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-white/10 flex items-center justify-center shadow-2xl group-hover:border-purple-500 group-hover:bg-purple-600/20 transition-all">
                        <i data-lucide="gift" class="w-6 h-6 text-white group-hover:text-purple-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-white bg-black/50 px-2 py-1 rounded">Send Gift</span>
                </button>

                <button onclick="openReportModal('${targetUser.loginId}', '${targetUser.ocName}')" class="group flex flex-col items-end gap-2 transition-all hover:-translate-x-2">
                    <div class="w-14 h-14 rounded-full bg-neutral-900/80 border border-red-900/30 flex items-center justify-center shadow-2xl group-hover:border-red-500 group-hover:bg-red-600/20 transition-all">
                        <i data-lucide="siren" class="w-6 h-6 text-red-700 group-hover:text-red-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest group-hover:text-red-500 bg-black/50 px-2 py-1 rounded">Report User</span>
                </button>
            </div>

            <div class="absolute bottom-12 left-[30%] flex gap-12 opacity-60 pointer-events-none hidden lg:flex">
                <p class="text-[20px] text-amber-500 font-serif italic tracking-wider">${targetUser.keyword1 || ''}</p>
                <p class="text-[20px] text-amber-400 font-serif italic tracking-wider">${targetUser.keyword2 || ''}</p>
                <p class="text-[20px] text-amber-300 font-serif italic tracking-wider">${targetUser.keyword3 || ''}</p>
            </div>
            
            <button onclick="switchView('members')" class="absolute top-8 left-8 z-50 flex items-center gap-2 text-neutral-500 hover:text-white transition-colors pointer-events-auto">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                <span class="text-xs font-bold uppercase tracking-widest">Back to Gallery</span>
            </button>
        </div>

        <div id="report-modal" class="hidden fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-neutral-900 border border-red-900/30 rounded-[2.5rem] p-10 shadow-2xl modal-enter relative">
                
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="absolute top-8 right-8 text-neutral-600 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <h3 class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-2 text-red-500">Report User</h3>
                <p class="text-xs text-neutral-500 mb-6">Reporting: <span id="report-target-name" class="text-white font-bold"></span></p>
                
                <textarea id="report-reason" class="w-full h-32 bg-black border border-white/10 rounded-2xl p-4 text-sm text-white resize-none outline-none focus:border-red-500 mb-6 custom-scrollbar" placeholder="Please describe the reason..."></textarea>
                
                <div class="flex gap-4">
                    <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button onclick="submitReport()" class="flex-1 py-4 bg-red-700 text-white font-bold rounded-xl uppercase text-xs hover:bg-red-600 shadow-lg shadow-red-900/20">Submit Report</button>
                </div>
            </div>
        </div>
        
        <!-- ÏÑ†Î¨º Î™®Îã¨ -->
        <div id="gift-modal" class="hidden fixed inset-0 z-[150] bg-black/95 flex items-center justify-center p-6 backdrop-blur-xl">
            <div class="w-full max-w-3xl bg-neutral-900 border border-purple-600/30 rounded-3xl p-10 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-black text-white uppercase">Send Gift</h3>
                    <button onclick="closeGiftModal()" class="text-neutral-500 hover:text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <p class="text-sm text-neutral-400 mb-4">Select an item from your inventory to send as a gift:</p>
                
                <div id="gift-items-list" class="grid grid-cols-5 gap-3 mb-6 max-h-96 overflow-y-auto custom-scrollbar">
                </div>
                
                <button onclick="sendGift()" class="w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl uppercase">
                    Confirm & Send Gift
                </button>
            </div>
        </div>
        
        <style>.mask-image-bottom { -webkit-mask-image: linear-gradient(to top, transparent 0%, black 20%); mask-image: linear-gradient(to top, transparent 0%, black 20%); }</style>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// [Í∏∞Îä• 1] ÌîÑÎ°úÌïÑ Î∞©Î¨∏ (ÌéòÏù¥ÏßÄ Ïù¥Îèô)
window.visitProfile = (targetId) => {
    if (targetId === state.userAccount.loginId) {
        return switchView('home'); // ÎÇò ÏûêÏã†Ïù¥Î©¥ ÎÇ¥ ÌôàÏúºÎ°ú
    }
    state.visitTargetId = targetId;
    switchView('visit');
};

// [Í∏∞Îä• 2] 1:1 Ï±ÑÌåÖÎ∞© Ïó∞Í≤∞ (ÏóÜÏúºÎ©¥ ÏÉùÏÑ±, ÏûàÏúºÎ©¥ Ïù¥Îèô)
window.startOneOnOneChat = async (targetId) => {
    const myId = state.userAccount.loginId;
    
    // Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî 1:1 Î∞© Ï∞æÍ∏∞
    const existingRoom = state.chatRooms.find(r => 
        r.type === 'private' && 
        r.members.includes(myId) && 
        r.members.includes(targetId)
    );

    if (existingRoom) {
        state.selectedRoomId = existingRoom.id;
        switchView('mail'); // Î©îÏùºÌï®ÏúºÎ°ú Ïù¥Îèô
    } else {
        // ÏÉà Î∞© ÏÉùÏÑ±
        const targetUser = state.accounts.find(a => a.loginId === targetId);
        const roomName = targetUser ? targetUser.ocName : targetId;
        
        try {
            const newRoomRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'chatRooms'));
            await setDoc(newRoomRef, {
                name: roomName, // Í∞úÏù∏Î∞©Ïù¥Îùº Ïù¥Î¶ÑÏùÄ ÌÅ¨Í≤å Ï§ëÏöîÏπò ÏïäÏùå
                members: [myId, targetId],
                type: 'private',
                createdAt: serverTimestamp(),
                lastMessageTimestamp: serverTimestamp(),
                lastMessageBody: "Signal Link Established.",
                lastRead: {}
            });
            state.selectedRoomId = newRoomRef.id;
            switchView('mail'); // Î©îÏùºÌï®ÏúºÎ°ú Ïù¥Îèô
        } catch(e) {
            console.error(e);
            showToast("Connection Failed.");
        }
    }
};

// [Í∏∞Îä• 3] Ïã†Í≥† Î™®Îã¨ Ïó¥Í∏∞
let currentReportTargetId = null;
window.openReportModal = (targetId, targetName) => {
    currentReportTargetId = targetId;
    $('report-target-name').innerText = targetName;
    $('report-reason').value = '';
    $('report-modal').classList.remove('hidden');
};

// [Í∏∞Îä• 3-1] Ïã†Í≥† Ï†ëÏàò (DB Ï†ÄÏû•)
window.submitReport = async () => {
    const reason = $('report-reason').value.trim();
    if (!reason) return showToast("Please enter a reason.");
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), {
            reporterId: state.userAccount.loginId,
            reporterName: state.userAccount.ocName,
            targetId: currentReportTargetId,
            reason: reason,
            timestamp: serverTimestamp(),
            status: 'pending' // Ï≤òÎ¶¨ ÎåÄÍ∏∞Ï§ë
        });
        $('report-modal').classList.add('hidden');
        showToast("Report Submitted to Admin.");
    } catch(e) {
        console.error(e);
        showToast("Report Failed.");
    }
};
// [Í∏∞Îä• 1] ÏïåÎ¶ºÏ∞Ω ÌÜ†Í∏Ä
window.toggleNotificationModal = () => {
    const el = document.getElementById('noti-dropdown');
    el.classList.toggle('hidden');
};

// [Í∏∞Îä• 2] ÏïåÎ¶º ÏÇ≠Ï†ú
window.deleteNotification = async (id) => {
    try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', id));
    } catch(e) { console.error(e); }
};

// [Í∏∞Îä• 3] ÏïåÎ¶º Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
window.clearAllNotifications = async () => {
    if (!confirm("Clear all alerts?")) return;
    try {
        const batch = state.notifications.map(n => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', n.id)));
        await Promise.all(batch);
    } catch(e) { console.error(e); }
};

// [Í∏∞Îä• 4] Í¥ÄÎ¶¨Ïûê: Ïã†Í≥† ÏÇ≠Ï†ú (Î¨¥Ïãú)
window.deleteReport = async (reportId) => {
    if (!confirm("Delete this report permanently?")) return;
    try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId));
        showToast("Report Deleted.");
    } catch(e) { console.error(e); }
};

// [Í∏∞Îä• 5] Í¥ÄÎ¶¨Ïûê: ÎãµÏû• Î™®Îã¨ Ïó¥Í∏∞
let currentResolvingReportId = null;
let currentResolvingReporterId = null;

window.openAdminReplyModal = (reportId, reporterId) => {
    currentResolvingReportId = reportId;
    currentResolvingReporterId = reporterId;
    $('admin-reply-memo').value = '';
    $('admin-reply-modal').classList.remove('hidden');
};

// [ÏàòÏ†ï] Í¥ÄÎ¶¨Ïûê: Ìï¥Í≤∞ Ï≤òÎ¶¨ (ÏïàÏ†ÑÏû•Ïπò Ï∂îÍ∞Ä)
window.submitAdminResolution = async () => {
    const memo = $('admin-reply-memo').value.trim();
    
    // ÏïàÏ†ÑÏû•Ïπò: IDÍ∞Ä ÏóÜÏúºÎ©¥ Ïò§Î•ò Ï∂úÎ†•
    if (!currentResolvingReportId || !currentResolvingReporterId) {
        console.error("Missing Report ID or Reporter ID");
        showToast("Error: Target not found.");
        return;
    }

    try {
        // 1. Ïú†Ï†ÄÏóêÍ≤å ÏïåÎ¶º Ï†ÑÏÜ°
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
            targetUserId: currentResolvingReporterId,
            title: "Report Resolved",
            message: "Í¥ÄÎ¶¨ÏûêÍ∞Ä ÎãπÏã†Ïùò Ïã†Í≥†Î•º ÌôïÏù∏ÌñàÏäµÎãàÎã§.",
            memo: memo,
            timestamp: serverTimestamp(),
            isRead: false
        });

        // 2. Ïã†Í≥† ÎÇ¥Ïó≠ ÏÇ≠Ï†ú
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', currentResolvingReportId));

        $('admin-reply-modal').classList.add('hidden');
        showToast("User Notified & Report Closed.");
    } catch(e) {
        console.error("Resolution Failed:", e); // ÏΩòÏÜîÏóê ÏÉÅÏÑ∏ ÏóêÎü¨ Ï∂úÎ†•
        showToast("Action Failed. Check Console.");
    }
};
// [ÏàòÏ†ïÎê®] ÏïåÎ¶º Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Î∞è ÏÜåÎ¶¨ Ïû¨ÏÉù
function updateMyNotifications() {
    // ÏïÑÏßÅ ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ÎÇò Ïú†Ï†Ä Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ Ï§ëÎã®
    if (!state.rawNotifications || !state.userAccount) return;

    // ÌòÑÏû¨ Ï†ÄÏû•Îêú ÏïåÎ¶º (Ïù¥Ï†Ñ ÏÉÅÌÉú)
    const prevCount = state.notifications ? state.notifications.length : 0;

    // ÎÇ¥ ÏïÑÏù¥Îîî(targetUserId)ÏôÄ ÏùºÏπòÌïòÎäî ÏïåÎ¶ºÎßå ÌïÑÌÑ∞ÎßÅ
    const myNewNotis = state.rawNotifications.filter(n => n.targetUserId === state.userAccount.loginId);
    
    // state ÏóÖÎç∞Ïù¥Ìä∏
    state.notifications = myNewNotis;
    if (state.initDone && myNewNotis.length > prevCount) {
        window.playNotificationSound(); // Îù†Î°±~!
        
    }
    
    if (state.currentView === 'home') renderHome();
}
// [Ï∂îÍ∞Ä] ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù Ìï®Ïàò
window.playNotificationSound = () => {
    const audio = document.getElementById('noti-sound');
    if (audio) {
        audio.volume = 0.3; // ÏÜåÎ¶¨ ÌÅ¨Í∏∞ Ï°∞Ï†à (0.0 ~ 1.0)
        audio.currentTime = 0; // Ïó∞ÏÜç Ïû¨ÏÉùÏùÑ ÏúÑÌï¥ Ïû¨ÏÉù ÏúÑÏπò Ï¥àÍ∏∞Ìôî
        // Î∏åÎùºÏö∞Ï†Ä Ï†ïÏ±ÖÏÉÅ ÏÇ¨Ïö©ÏûêÍ∞Ä ÌôîÎ©¥ÏùÑ ÌÅ¥Î¶≠Ìïú Ï†ÅÏù¥ ÏóÜÏúºÎ©¥ ÏÜåÎ¶¨Í∞Ä ÎßâÌûê Ïàò ÏûàÏùå (catchÎ°ú ÏóêÎü¨ Î∞©ÏßÄ)
        audio.play().catch(e => console.log("Audio play blocked: interact with document first."));
    }
};
// [Ï∂îÍ∞Ä] Ï±ÑÌåÖÎ∞© ÏïåÎ¶º ÏºúÍ∏∞/ÎÅÑÍ∏∞ ÌÜ†Í∏Ä Ìï®Ïàò
window.toggleRoomMute = async (roomId) => {
    const myId = state.userAccount.loginId;
    const room = state.chatRooms.find(r => r.id === roomId);
    if (!room) return;

    // ÌòÑÏû¨ ÏÉÅÌÉú ÌôïÏù∏ (ÏóÜÏúºÎ©¥ ÏºúÏßÑ Í≤É, trueÎ©¥ Í∫ºÏßÑ Í≤É)
    const currentMuteState = room.muted ? room.muted[myId] : false;
    const newMuteState = !currentMuteState; // Î∞òÎåÄÎ°ú Ï†ÑÌôò

    try {
        const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'chatRooms', roomId);
        
        // ÎÇ¥ IDÏùò ÎÆ§Ìä∏ ÏÑ§Ï†ïÎßå ÏóÖÎç∞Ïù¥Ìä∏
        // (FirestoreÏùò Ï†ê ÌëúÍ∏∞Î≤ïÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Í∞ùÏ≤¥ ÎÇ¥Î∂ÄÏùò ÌäπÏ†ï ÌïÑÎìúÎßå ÏàòÏ†ï)
        await updateDoc(roomRef, {
            [`muted.${myId}`]: newMuteState
        });

        const statusMsg = newMuteState ? "Notifications Muted." : "Notifications Enabled.";
        showToast(statusMsg);
        
    } catch(e) {
        console.error(e);
        showToast("Error updating settings.");
    }
};
function renderOperation() {
    // 1. Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©)
    if (!state.world.operations) {
        state.world.operations = [
            {
                id: 'op_story',
                title: 'Main Story',
                desc: 'The unraveling truth of Elysium. Begin your investigation.',
                img: 'https://images.unsplash.com/photo-1519608487953-e999c86e7455?q=80&w=1000',
                icon: 'book-open',
                action: 'renderStoryTimeline()', // Ïã§ÌñâÌï† Ìï®Ïàò Î¨∏ÏûêÏó¥
                number: '01'
            },
            {
                id: 'op_field',
                title: 'Field Work',
                desc: 'Search for clues in specific sectors.',
                img: 'https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?q=80&w=1000',
                icon: 'map',
                action: "switchView('investigation')",
                number: '02'
            },
            {
                id: 'op_raid',
                title: 'Total War', // Î†àÏù¥Îìú (Raid)
                desc: 'Subjugate high-threat anomalies with your team.',
                img: 'https://images.unsplash.com/photo-1635322966219-b75ed372eb01?q=80&w=1000', // Î∂âÏùÄ ÌÜ§ Ïù¥ÎØ∏ÏßÄ Ï∂îÏ≤ú
                icon: 'swords',
                action: "openRaidBoard()",
                number: '03'
            },{
                id: 'op_minigame',
                title: 'Arcade',
                desc: 'Challenge others or test your luck in the void.',
                img: 'https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1000', // Í≤åÏûÑ/ÏïÑÏºÄÏù¥Îìú ÎäêÎÇå Ïù¥ÎØ∏ÏßÄ
                icon: 'dices', // Lucide ÏïÑÏù¥ÏΩò (ÏóÜÏúºÎ©¥ gamepad2 Îì± ÏÇ¨Ïö©)
                action: "openMiniGameHub()",
                number: '04'
            }
        ];
    }

    const ops = state.world.operations;
    const isAdmin = state.isAdmin;

    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full w-full select-none">
            
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none mix-blend-overlay"></div>
            <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-transparent to-black/90 pointer-events-none z-0"></div>

            <div class="relative z-10 px-12 pt-16 pb-8 flex justify-between items-end border-b border-white/5 mx-12">
                <div>
                    <h2 class="text-6xl md:text-7xl font-serif font-black text-white tracking-tighter uppercase leading-none italic drop-shadow-2xl">
                        Operations
                    </h2>
                    <div class="flex items-center gap-3 mt-4">
                        <span class="w-8 h-[2px] bg-amber-600"></span>
                        <p class="text-[10px] text-amber-500 font-bold tracking-[0.3em] uppercase">Active Missions & Arcade</p>
                    </div>
                </div>
                <div class="hidden md:block text-right opacity-50">
                    <p class="text-[9px] text-neutral-500 font-mono tracking-widest">SECURE CHANNEL ESTABLISHED</p>
                    <p class="text-[9px] text-neutral-600 font-mono mt-1">LAT: 37.5665 / LON: 126.9780</p>
                </div>
            </div>

            <div class="flex-1 relative z-10 flex items-center justify-center overflow-x-auto overflow-y-hidden custom-scrollbar px-12 pb-12">
                <div class="flex items-stretch gap-6 h-[500px]">
                    
                    ${ops.map((op, idx) => `
                    <div onclick="${op.action}" 
                         class="group relative w-[280px] hover:w-[380px] transition-all duration-500 ease-[cubic-bezier(0.25,1,0.5,1)] cursor-pointer">
                        
                        <div class="absolute inset-0 transform -skew-x-12 overflow-hidden border border-white/10 bg-neutral-900 group-hover:border-amber-500/50 transition-colors shadow-2xl">
                            <div class="absolute inset-0 transform skew-x-12 scale-125 origin-center transition-transform duration-700 group-hover:scale-110">
                                <img src="${op.img}" class="w-full h-full object-cover grayscale opacity-50 group-hover:opacity-100 group-hover:grayscale-0 transition-all duration-700">
                                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90 group-hover:opacity-60 transition-opacity"></div>
                            </div>
                        </div>

                        <div class="absolute inset-0 z-20 pointer-events-none">
                            
                            <div class="absolute top-6 left-8 opacity-30 group-hover:opacity-100 transition-opacity duration-500 transform -skew-x-12">
                                <span class="text-6xl font-black text-transparent stroke-text italic font-serif">${op.number}</span>
                            </div>

                            <div class="absolute bottom-0 left-0 w-full p-10 transform translate-y-4 group-hover:translate-y-0 transition-transform duration-500">
                                
                                <div class="transform -skew-x-12 origin-bottom-left">
                                    <div class="w-12 h-12 rounded-full bg-neutral-800 border border-white/20 flex items-center justify-center mb-4 text-white group-hover:bg-amber-600 group-hover:border-transparent transition-all shadow-[0_0_20px_rgba(0,0,0,0.5)]">
                                        <i data-lucide="${op.icon}" class="w-5 h-5"></i>
                                    </div>
                                    
                                    <h3 class="text-3xl font-black text-white uppercase italic tracking-tighter mb-2 drop-shadow-md whitespace-nowrap">
                                        ${op.title}
                                    </h3>
                                    
                                    <div class="w-full h-[1px] bg-white/20 mb-3 group-hover:bg-amber-500 transition-colors"></div>
                                    
                                    <p class="text-[10px] text-neutral-400 font-medium leading-relaxed line-clamp-2 h-8 mb-2 group-hover:text-neutral-200 transition-colors">
                                        ${op.desc}
                                    </p>
                                    
                                    <div class="flex items-center gap-2 text-[10px] text-amber-500 font-black tracking-widest uppercase opacity-0 group-hover:opacity-100 transition-all duration-500 translate-x-[-10px] group-hover:translate-x-0">
                                        <span>Initialize</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                    </div>
                                </div>
                            </div>

                            ${isAdmin ? `
                            <button onclick="event.stopPropagation(); openOperationEditor(${idx})" 
                                    class="absolute top-4 right-4 pointer-events-auto bg-black/50 hover:bg-amber-600 text-white p-2 rounded-full backdrop-blur-md border border-white/10 transition-colors z-50">
                                <i data-lucide="edit-2" class="w-3 h-3"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>

            <div class="absolute bottom-6 left-0 w-full flex justify-between px-12 pointer-events-none opacity-30">
                 <div class="flex gap-1">
                    <div class="w-2 h-2 bg-amber-600"></div>
                    <div class="w-2 h-2 bg-neutral-800"></div>
                    <div class="w-2 h-2 bg-neutral-800"></div>
                 </div>
                 <div class="text-[8px] text-white font-mono tracking-[0.5em]">SYSTEM READY</div>
            </div>

            <style>
                .stroke-text { -webkit-text-stroke: 1px rgba(255, 255, 255, 0.2); }
                .group:hover .stroke-text { -webkit-text-stroke: 1px rgba(217, 119, 6, 0.5); color: rgba(217, 119, 6, 0.1); }
            </style>
        </div>

        <div id="op-editor-modal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-[#0a0a0a] border border-amber-600/30 rounded-2xl p-8 shadow-2xl modal-enter relative">
                <h3 class="text-xl font-serif font-black text-white uppercase italic tracking-tighter mb-6 text-center">Edit Operation</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[9px] text-amber-500 font-bold uppercase tracking-widest">Title</label>
                        <input id="op-edit-title" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Description</label>
                        <textarea id="op-edit-desc" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none resize-none h-20"></textarea>
                    </div>
                    <div>
                        <label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Image URL</label>
                        <input id="op-edit-img" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-xs text-neutral-500 focus:border-amber-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Icon Name</label>
                            <input id="op-edit-icon" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-xs text-white focus:border-amber-500 outline-none" placeholder="lucide icon">
                        </div>
                        <div>
                            <label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Action (JS)</label>
                            <input id="op-edit-action" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-xs text-amber-500 focus:border-amber-500 outline-none">
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button onclick="document.getElementById('op-editor-modal').classList.add('hidden')" class="flex-1 py-3 bg-neutral-800 text-neutral-400 font-bold rounded-lg uppercase text-[10px] hover:text-white">Cancel</button>
                    <button id="op-save-btn" class="flex-1 py-3 bg-amber-600 text-white font-bold rounded-lg uppercase text-[10px] hover:bg-amber-700 shadow-lg transition-all">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.renderOperation = renderOperation;
window.openMiniGameHub = () => {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full select-none items-center justify-center">
            
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] opacity-5 pointer-events-none"></div>
            
            <div class="z-10 text-center mb-12">
                <h2 class="text-5xl font-serif font-black text-white uppercase tracking-tighter italic drop-shadow-[0_0_15px_rgba(217,119,6,0.5)]">
                    Arcade Center
                </h2>
                <p class="text-[10px] text-amber-500 font-bold tracking-[0.5em] mt-2 uppercase">Select Your Game</p>
            </div>

            <div class="flex flex-wrap gap-8 z-10 justify-center max-w-6xl">
                <!-- Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ -->
                <button onclick="renderRPS()" class="group relative w-64 h-80 bg-neutral-900 border border-white/10 rounded-2xl hover:border-amber-500/50 hover:-translate-y-2 transition-all duration-300 overflow-hidden shadow-2xl">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-10"></div>
                    <img src="https://images.unsplash.com/photo-1623934199716-dc28818a6ec7?q=80&w=1000" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:scale-110 transition-transform duration-700 grayscale group-hover:grayscale-0">
                    <div class="absolute bottom-0 left-0 w-full p-6 z-20 text-left">
                        <div class="w-12 h-12 bg-amber-600 rounded-full flex items-center justify-center mb-4 text-white shadow-lg">
                            <i data-lucide="hand" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-black text-white uppercase italic">Duel: RPS</h3>
                        <p class="text-[10px] text-neutral-400 mt-2">Challenge other personnel in a battle of wits.</p>
                        <div class="mt-3 text-[9px] text-amber-500 font-mono">Reward: 5 Coins</div>
                    </div>
                </button>

                <!-- Í∞ÄÏ±† -->
                <button onclick="renderGacha()" class="group relative w-64 h-80 bg-neutral-900 border border-white/10 rounded-2xl hover:border-purple-500/50 hover:-translate-y-2 transition-all duration-300 overflow-hidden shadow-2xl">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-10"></div>
                    <img src="https://images.unsplash.com/photo-1605218427306-635ba249f37c?q=80&w=1000" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:scale-110 transition-transform duration-700 grayscale group-hover:grayscale-0">
                    <div class="absolute bottom-0 left-0 w-full p-6 z-20 text-left">
                        <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center mb-4 text-white shadow-lg">
                            <i data-lucide="sparkles" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-black text-white uppercase italic">Wheel of Fate</h3>
                        <p class="text-[10px] text-neutral-400 mt-2">Spin the roulette. Admin managed rewards.</p>
                        <div class="mt-3 text-[9px] text-purple-500 font-mono">Cost: 10 Coins</div>
                    </div>
                </button>

                <!-- Ïä¨Î°ØÎ®∏Ïã† -->
                <button onclick="renderSlots()" class="group relative w-64 h-80 bg-neutral-900 border border-white/10 rounded-2xl hover:border-green-500/50 hover:-translate-y-2 transition-all duration-300 overflow-hidden shadow-2xl">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-10"></div>
                    <img src="https://images.unsplash.com/photo-1596838132731-3301c3fd4317?q=80&w=1000" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:scale-110 transition-transform duration-700 grayscale group-hover:grayscale-0">
                    <div class="absolute bottom-0 left-0 w-full p-6 z-20 text-left">
                        <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center mb-4 text-white shadow-lg">
                            <i data-lucide="cherry" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-black text-white uppercase italic">Lucky 777</h3>
                        <p class="text-[10px] text-neutral-400 mt-2">Spin the slots. Hit the jackpot!</p>
                        <div class="mt-3 text-[9px] text-green-500 font-mono">Cost: 10 Coins | Max: 3x</div>
                    </div>
                </button>
                
                <!-- ÏÉÅÏ†ê -->
                <button onclick="renderShop()" class="group relative w-64 h-80 bg-neutral-900 border border-white/10 rounded-2xl hover:border-amber-500/50 hover:-translate-y-2 transition-all duration-300 overflow-hidden shadow-2xl">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-10"></div>
                    <img src="https://images.unsplash.com/photo-1441986300917-64674bd600d8?q=80&w=1000" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:scale-110 transition-transform duration-700 grayscale group-hover:grayscale-0">
                    <div class="absolute bottom-0 left-0 w-full p-6 z-20 text-left">
                        <div class="w-12 h-12 bg-amber-600 rounded-full flex items-center justify-center mb-4 text-white shadow-lg">
                            <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-black text-white uppercase italic">Merchant's Shop</h3>
                        <p class="text-[10px] text-neutral-400 mt-2">Buy items with coins</p>
                        <div class="mt-3 text-[9px] text-amber-500 font-mono">Various Items Available</div>
                    </div>
                </button>
            </div>

            <button onclick="renderOperation()" class="absolute top-8 left-8 flex items-center gap-2 text-neutral-500 hover:text-white transition-colors z-50 px-4 py-2 border border-white/10 rounded-lg bg-black/50">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> <span class="text-xs font-bold uppercase">Back to Ops</span>
            </button>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

/* -----------------------------------------
   2. Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥ (RPS) - Ïã§ÏãúÍ∞Ñ HP Î∞∞ÌãÄ ÏãúÏä§ÌÖú
   ----------------------------------------- */
let rpsUnsub = null;
let rpsGameUnsub = null;

window.renderRPS = () => {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full">
            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-neutral-900/50 backdrop-blur-md z-10">
                <div>
                    <h2 class="text-3xl font-black text-amber-500 uppercase italic tracking-tighter">RPS Battle Arena</h2>
                    <p class="text-[10px] text-neutral-500 uppercase tracking-widest mt-1">Real-time HP Battle System</p>
                </div>
                <button onclick="openMiniGameHub()" class="px-4 py-2 border border-white/10 rounded-lg text-xs text-neutral-400 hover:text-white hover:bg-white/5 transition-all">EXIT</button>
            </div>

            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                <div class="w-full md:w-1/3 border-r border-white/5 bg-black/20 flex flex-col">
                    <div class="p-4 border-b border-white/5 flex justify-between items-center">
                        <span class="text-xs font-bold text-white uppercase">Active Battles</span>
                        <button onclick="createRPSBattle()" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-1.5 rounded text-[10px] font-bold uppercase transition-all shadow-lg">+ Create</button>
                    </div>
                    <div id="rps-lobby-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                        <p class="text-center text-[10px] text-neutral-600 py-10">Scanning...</p>
                    </div>
                </div>

                <div id="rps-stage" class="flex-1 flex flex-col items-center justify-center p-10 relative bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
                    <div class="text-center opacity-30">
                        <i data-lucide="swords" class="w-24 h-24 mx-auto text-neutral-500 mb-4"></i>
                        <p class="text-sm font-black text-neutral-600 uppercase tracking-widest">Select a battle to begin</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
    subscribeRPSLobby();
};

// Firestore Ïã§ÏãúÍ∞Ñ Î°úÎπÑ Íµ¨ÎèÖ
function subscribeRPSLobby() {
    if (rpsUnsub) rpsUnsub();
    
    const roomsRef = collection(db, 'minigames_rps_battles'); 
    rpsUnsub = onSnapshot(roomsRef, (snapshot) => {
        const listEl = document.getElementById('rps-lobby-list');
        if (!listEl) return;

        const rooms = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        const activeRooms = rooms.filter(r => r.status === 'waiting' || r.status === 'ready' || r.status === 'playing');

        if (activeRooms.length === 0) {
            listEl.innerHTML = `<p class="text-center text-[10px] text-neutral-600 py-10 italic">No active battles.</p>`;
        } else {
            listEl.innerHTML = activeRooms.map(r => {
                const isFull = r.player2Id;
                const canJoin = !isFull && r.hostId !== state.userAccount.loginId;
                
                return `
                <div class="p-4 bg-neutral-900 border border-white/5 rounded-xl hover:border-amber-500/50 transition-all group relative">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded bg-amber-800 flex items-center justify-center text-[10px] font-bold text-white">P1</div>
                            <span class="text-xs font-bold text-white">${r.hostName}</span>
                        </div>
                        ${isFull ? 
                            `<span class="text-[9px] text-green-500 font-mono">IN PROGRESS</span>` : 
                            `<span class="text-[9px] text-amber-500 font-mono animate-pulse">WAITING</span>`
                        }
                    </div>
                    ${isFull ? 
                        `<div class="flex items-center gap-2 mt-2">
                            <div class="w-6 h-6 rounded bg-red-800 flex items-center justify-center text-[10px] font-bold text-white">P2</div>
                            <span class="text-xs font-bold text-white">${r.player2Name}</span>
                        </div>` : ''
                    }
                    ${canJoin ? 
                        `<button onclick="joinRPSBattle('${r.id}')" class="absolute right-4 bottom-4 px-3 py-1 bg-white/5 hover:bg-amber-600 text-neutral-400 hover:text-white text-[9px] font-bold uppercase rounded border border-white/10 transition-all">Join</button>` : 
                        (r.hostId === state.userAccount.loginId || r.player2Id === state.userAccount.loginId) ?
                        `<button onclick="enterRPSBattle('${r.id}')" class="absolute right-4 bottom-4 px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-[9px] font-bold uppercase rounded transition-all">Enter</button>` :
                        `<div class="absolute right-4 bottom-4 text-[9px] text-neutral-600 italic">Full</div>`
                    }
                </div>
            `}).join('');
        }
    });
}

// Î∞∞ÌãÄ ÏÉùÏÑ±
window.createRPSBattle = async () => {
    // Ïù¥ÎØ∏ Ï∞∏Ïó¨ Ï§ëÏù∏ Î∞∞ÌãÄÏù¥ ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
    try {
        const battlesRef = collection(db, 'minigames_rps_battles');
        const q = query(battlesRef, where('status', 'in', ['waiting', 'ready', 'playing']));
        const snapshot = await getDocs(q);
        
        let alreadyInBattle = false;
        snapshot.forEach(doc => {
            const battle = doc.data();
            if (battle.hostId === state.userAccount.loginId || battle.player2Id === state.userAccount.loginId) {
                alreadyInBattle = true;
            }
        });
        
        if (alreadyInBattle) {
            showToast("You're already in a battle!");
            return;
        }
        
        const docRef = await addDoc(collection(db, 'minigames_rps_battles'), {
            hostId: state.userAccount.loginId,
            hostName: state.userAccount.ocName,
            hostImage: state.userAccount.profile || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png',
            hostHP: 100,
            hostReady: false,
            player2Id: null,
            player2Name: null,
            player2Image: null,
            player2HP: 100,
            player2Ready: false,
            status: 'waiting',
            round: 0,
            hostChoice: null,
            player2Choice: null,
            createdAt: serverTimestamp()
        });
        
        enterRPSBattle(docRef.id);
    } catch(e) { 
        console.error(e); 
        showToast("Failed to create battle.");
    }
};

// Î∞∞ÌãÄ Ï∞∏Í∞Ä
window.joinRPSBattle = async (battleId) => {
    // Ïù¥ÎØ∏ Ï∞∏Ïó¨ Ï§ëÏù∏ Î∞∞ÌãÄÏù¥ ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
    try {
        const battlesRef = collection(db, 'minigames_rps_battles');
        const q = query(battlesRef, where('status', 'in', ['waiting', 'ready', 'playing']));
        const snapshot = await getDocs(q);
        
        let alreadyInBattle = false;
        snapshot.forEach(doc => {
            const battle = doc.data();
            if (battle.hostId === state.userAccount.loginId || battle.player2Id === state.userAccount.loginId) {
                alreadyInBattle = true;
            }
        });
        
        if (alreadyInBattle) {
            showToast("You're already in a battle!");
            return;
        }
        
        const battleRef = doc(db, 'minigames_rps_battles', battleId);
        await setDoc(battleRef, {
            player2Id: state.userAccount.loginId,
            player2Name: state.userAccount.ocName,
            player2Image: state.userAccount.profile || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png',
            status: 'ready'
        }, { merge: true });
        
        enterRPSBattle(battleId);
    } catch(e) { 
        console.error(e); 
        showToast("Failed to join battle.");
    }
};

// Î∞∞ÌãÄ ÏûÖÏû• (Ïã§ÏãúÍ∞Ñ Í≤åÏûÑ ÌôîÎ©¥)
window.enterRPSBattle = (battleId) => {
    if (rpsGameUnsub) rpsGameUnsub();
    
    const battleRef = doc(db, 'minigames_rps_battles', battleId);
    
    rpsGameUnsub = onSnapshot(battleRef, (snapshot) => {
        if (!snapshot.exists()) {
            renderRPS();
            return;
        }
        
        const battle = snapshot.data();
        const isHost = battle.hostId === state.userAccount.loginId;
        const stage = document.getElementById('rps-stage');
        
        // HPÏôÄ ÏÉÅÌÉú ÌëúÏãú
        const myHP = isHost ? battle.hostHP : battle.player2HP;
        const enemyHP = isHost ? battle.player2HP : battle.hostHP;
        const myName = isHost ? battle.hostName : battle.player2Name;
        const enemyName = isHost ? battle.player2Name : battle.hostName;
        const myReady = isHost ? battle.hostReady : battle.player2Ready;
        const enemyReady = isHost ? battle.player2Ready : battle.hostReady;
        const myImage = isHost ? battle.hostImage : battle.player2Image;
        const enemyImage = isHost ? battle.player2Image : battle.hostImage;
        
        // Í≤åÏûÑ Ï¢ÖÎ£å Ï≤¥ÌÅ¨
        if (battle.status === 'finished') {
            const winner = battle.winnerId === state.userAccount.loginId;
            stage.innerHTML = `
                <div class="text-center animate-fade-in">
                    <h2 class="text-5xl font-black ${winner ? 'text-green-500' : 'text-red-500'} uppercase mb-8">
                        ${winner ? 'VICTORY!' : 'DEFEAT'}
                    </h2>
                    ${winner ? '<p class="text-amber-500 font-bold text-xl mb-4">+5 Coins Awarded!</p>' : ''}
                    <button onclick="renderRPS()" class="px-6 py-3 bg-neutral-800 hover:bg-neutral-700 text-white rounded-xl text-sm font-bold uppercase">Back to Lobby</button>
                </div>
            `;
            return;
        }
        
        // ÎåÄÍ∏∞ ÌôîÎ©¥ (ÌîåÎ†àÏù¥Ïñ¥ 2 Í∏∞Îã§Î¶¨Îäî Ï§ë)
        if (!battle.player2Id) {
            stage.innerHTML = `
                <div class="text-center animate-pulse">
                    <i data-lucide="loader" class="w-16 h-16 mx-auto text-amber-500 mb-6 animate-spin"></i>
                    <h3 class="text-2xl font-black text-white uppercase mb-4">Waiting for Opponent...</h3>
                    <p class="text-xs text-neutral-500">Battle ID: ${battleId.substring(0, 8)}</p>
                    <button onclick="cancelRPSBattle('${battleId}')" class="mt-8 px-4 py-2 bg-red-900/50 border border-red-500 text-red-400 rounded text-xs hover:bg-red-900 transition-all">Cancel Battle</button>
                </div>
            `;
            if (typeof lucide !== 'undefined') lucide.createIcons();
            return;
        }
        
        // Í≤åÏûÑ ÌôîÎ©¥ (HP Î∞î + ÏÑ†ÌÉù UI)
        const canChoose = battle.status === 'ready' || battle.status === 'playing';
        const bothReady = myReady && enemyReady;
        
        stage.innerHTML = `
            <div class="w-full max-w-5xl animate-fade-in">
                <!-- ÌîÑÎ°úÌïÑ VS ÌôîÎ©¥ (Í≤©Ìà¨Í≤åÏûÑ Ïä§ÌÉÄÏùº) -->
                <div class="flex justify-between items-center mb-8">
                    <!-- ÎÇ¥ ÌîÑÎ°úÌïÑ -->
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <img src="${myImage || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png'}" class="w-24 h-24 rounded-full object-cover border-4 border-amber-500 shadow-[0_0_30px_rgba(217,119,6,0.6)]">
                            <div class="absolute -bottom-2 -right-2 bg-amber-600 text-white text-xs font-bold px-2 py-1 rounded-full">YOU</div>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-white uppercase">${myName}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="w-32 h-2 bg-neutral-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-green-500 to-amber-500 transition-all duration-500" style="width: ${myHP}%"></div>
                                </div>
                                <span class="text-xs font-mono text-white">${myHP}/100</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-5xl font-black text-white italic opacity-50 animate-pulse">VS</div>
                    
                    <!-- Ï†Å ÌîÑÎ°úÌïÑ -->
                    <div class="flex items-center gap-4 flex-row-reverse">
                        <div class="relative">
                            <img src="${enemyImage || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png'}" class="w-24 h-24 rounded-full object-cover border-4 border-red-500 shadow-[0_0_30px_rgba(239,68,68,0.6)]">
                            <div class="absolute -bottom-2 -left-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full">OPP</div>
                        </div>
                        <div class="text-right">
                            <h3 class="text-2xl font-black text-white uppercase">${enemyName || 'Waiting...'}</h3>
                            <div class="flex items-center gap-2 mt-1 flex-row-reverse">
                                <div class="w-32 h-2 bg-neutral-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-l from-red-500 to-orange-500 transition-all duration-500" style="width: ${enemyHP}%"></div>
                                </div>
                                <span class="text-xs font-mono text-white">${enemyHP}/100</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÎùºÏö¥Îìú Ï†ïÎ≥¥ -->
                <div class="text-center mb-8">
                    <div class="text-xs text-neutral-500 uppercase tracking-widest mb-2">Round ${battle.round + 1}</div>
                    ${bothReady ? 
                        '<div class="text-sm text-green-500 font-bold animate-pulse">Both players ready! Calculating...</div>' : 
                        '<div class="text-sm text-amber-500">Waiting for selections...</div>'
                    }
                </div>
                
                <!-- ÏÑ†ÌÉù UI -->
                ${!myReady && canChoose ? `
                <div class="text-center">
                    <h3 class="text-xl font-black text-white uppercase mb-6">Choose Your Move</h3>
                    <div class="flex justify-center gap-6">
                        <button onclick="selectRPSMove('${battleId}', ${isHost}, 'rock')" class="group relative w-24 h-24 bg-neutral-900 border-2 border-white/20 rounded-2xl flex items-center justify-center hover:bg-amber-600 hover:border-amber-500 hover:scale-110 transition-all">
                            <span class="text-5xl">‚úä</span>
                            <div class="absolute -bottom-8 text-xs text-neutral-500 group-hover:text-white">Rock</div>
                        </button>
                        <button onclick="selectRPSMove('${battleId}', ${isHost}, 'paper')" class="group relative w-24 h-24 bg-neutral-900 border-2 border-white/20 rounded-2xl flex items-center justify-center hover:bg-amber-600 hover:border-amber-500 hover:scale-110 transition-all">
                            <span class="text-5xl">‚úã</span>
                            <div class="absolute -bottom-8 text-xs text-neutral-500 group-hover:text-white">Paper</div>
                        </button>
                        <button onclick="selectRPSMove('${battleId}', ${isHost}, 'scissors')" class="group relative w-24 h-24 bg-neutral-900 border-2 border-white/20 rounded-2xl flex items-center justify-center hover:bg-amber-600 hover:border-amber-500 hover:scale-110 transition-all">
                            <span class="text-5xl">‚úåÔ∏è</span>
                            <div class="absolute -bottom-8 text-xs text-neutral-500 group-hover:text-white">Scissors</div>
                        </button>
                    </div>
                </div>
                ` : `
                <div class="text-center py-12">
                    <div class="inline-block px-8 py-4 bg-green-900/30 border border-green-500 rounded-xl">
                        <i data-lucide="check-circle" class="w-12 h-12 mx-auto text-green-500 mb-3"></i>
                        <p class="text-green-400 font-bold">Your move is locked!</p>
                        <p class="text-xs text-neutral-500 mt-2">Waiting for opponent...</p>
                    </div>
                </div>
                `}
                
                <div class="text-center mt-8">
                    <button onclick="renderRPS()" class="text-xs text-neutral-600 hover:text-red-500 hover:underline">Leave Battle</button>
                </div>
            </div>
        `;
        
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });
};

// ÏÑ†ÌÉùÌïòÍ∏∞
window.selectRPSMove = async (battleId, isHost, choice) => {
    try {
        const battleRef = doc(db, 'minigames_rps_battles', battleId);
        const updateData = isHost ? 
            { hostChoice: choice, hostReady: true } : 
            { player2Choice: choice, player2Ready: true };
        
        await setDoc(battleRef, updateData, { merge: true });
        
        // ÏñëÏ™Ω Îã§ Ï§ÄÎπÑÎêòÏóàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Í≤∞Í≥º Í≥ÑÏÇ∞
        const snapshot = await getDoc(battleRef);
        const battle = snapshot.data();
        
        if (battle.hostReady && battle.player2Ready) {
            // Í≤∞Í≥º Í≥ÑÏÇ∞
            setTimeout(() => calculateRPSRound(battleId), 1000);
        }
    } catch(e) { 
        console.error(e); 
    }
};

// ÎùºÏö¥Îìú Í≤∞Í≥º Í≥ÑÏÇ∞
async function calculateRPSRound(battleId) {
    const battleRef = doc(db, 'minigames_rps_battles', battleId);
    const snapshot = await getDoc(battleRef);
    
    if (!snapshot.exists()) return;
    
    const battle = snapshot.data();
    const { hostChoice, player2Choice, hostHP, player2HP } = battle;
    
    let newHostHP = hostHP;
    let newPlayer2HP = player2HP;
    
    // ÏäπÌå® ÌåêÏ†ï
    if (hostChoice === player2Choice) {
        // Î¨¥ÏäπÎ∂Ä - HP Î≥ÄÌôî ÏóÜÏùå
    } else if (
        (hostChoice === 'rock' && player2Choice === 'scissors') ||
        (hostChoice === 'scissors' && player2Choice === 'paper') ||
        (hostChoice === 'paper' && player2Choice === 'rock')
    ) {
        // Host ÏäπÎ¶¨ - Player2 HP -25
        newPlayer2HP = Math.max(0, player2HP - 25);
    } else {
        // Player2 ÏäπÎ¶¨ - Host HP -25
        newHostHP = Math.max(0, hostHP - 25);
    }
    
    // Í≤åÏûÑ Ï¢ÖÎ£å Ï≤¥ÌÅ¨
    const isFinished = newHostHP <= 0 || newPlayer2HP <= 0;
    const winnerId = newHostHP <= 0 ? battle.player2Id : battle.hostId;
    
    // DB ÏóÖÎç∞Ïù¥Ìä∏
    const updateData = {
        hostHP: newHostHP,
        player2HP: newPlayer2HP,
        hostReady: false,
        player2Ready: false,
        hostChoice: null,
        player2Choice: null,
        round: battle.round + 1,
        status: isFinished ? 'finished' : 'playing'
    };
    
    if (isFinished) {
        updateData.winnerId = winnerId;
        
        // ÏäπÏûêÏóêÍ≤å ÏΩîÏù∏ ÏßÄÍ∏â - winnerIdÎäî loginIdÏù¥ÎØÄÎ°ú accountsÏóêÏÑú uidÎ•º Ï∞æÏùå
        const winnerAccount = state.accounts.find(a => a.loginId === winnerId);
        if (winnerAccount && winnerAccount.uid) {
            try {
                const winnerRef = doc(db, 'artifacts', appId, 'users', winnerAccount.uid);
                const winnerSnap = await getDoc(winnerRef);
                const currentCoins = winnerSnap.exists() ? (winnerSnap.data().coins || 0) : (winnerAccount.coins || 0);
                await syncUserCoins(winnerAccount.uid, winnerId, currentCoins + 5);
                
                // ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏäπÏûêÏù∏ Í≤ΩÏö∞ UI ÏóÖÎç∞Ïù¥Ìä∏
                if (winnerId === state.userAccount.loginId) {
                    showToast("+5 coins! Victory!");
                }
            } catch(e) {
                console.error("ÏÉÅÍ∏à ÏßÄÍ∏â Ïã§Ìå®:", e);
            }
        }
    }
    
    await setDoc(battleRef, updateData, { merge: true });
}

// Î∞∞ÌãÄ Ï∑®ÏÜå
window.cancelRPSBattle = async (battleId) => {
    try {
        await deleteDoc(doc(db, 'minigames_rps_battles', battleId));
        renderRPS();
    } catch(e) { 
        console.error(e); 
    }
};

/* -----------------------------------------
/* -----------------------------------------
   3. Í∞ÄÏ±† (Gacha) ÏãúÏä§ÌÖú
   ----------------------------------------- */
// Í∏∞Î≥∏ Í∞ÄÏ±† Î™©Î°ù (DBÍ∞Ä ÎπÑÏóàÏùÑ Îïå ÏÇ¨Ïö©)
let gachaPool = [
    { name: "5‚òÖ Golden Fleece", rarity: 5, chance: 5 },
    { name: "4‚òÖ Silver Sword", rarity: 4, chance: 20 },
    { name: "3‚òÖ Ration Pack", rarity: 3, chance: 75 }
];

window.renderGacha = async () => {
    // Item MasterÏóêÏÑú Í∞ÄÏ±† ÏïÑÏù¥ÌÖú Î∂àÎü¨Ïò§Í∏∞
    try {
        const itemsRef = collection(db, 'artifacts', appId, 'public', 'data', 'item_master');
        const itemsSnap = await getDocs(itemsRef);
        
        const gachaItems = [];
        itemsSnap.forEach(doc => {
            const item = doc.data();
            // inGachaÍ∞Ä trueÏù∏ ÏïÑÏù¥ÌÖúÎßå Í∞ÄÏ±† ÌíÄÏóê Ï∂îÍ∞Ä
            if (item.availability?.inGacha && !item.availability?.unavailable) {
                gachaItems.push({
                    id: item.id,
                    name: item.name,
                    rarity: item.rarity,
                    chance: item.gachaChance || 5,
                    icon: item.icon || 'üì¶',
                    description: item.description || ''
                });
            }
        });
        
        // Í∞ÄÏ±† ÏïÑÏù¥ÌÖúÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Î™©Î°ù ÏÇ¨Ïö©
        if (gachaItems.length > 0) {
            gachaPool = gachaItems;
            console.log("‚úÖ Item MasterÏóêÏÑú Í∞ÄÏ±† ÌíÄ Î°úÎìú:", gachaItems.length, "Í∞ú ÏïÑÏù¥ÌÖú");
        } else {
            console.log("‚ö†Ô∏è Í∞ÄÏ±† ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏñ¥ Í∏∞Î≥∏ ÌíÄ ÏÇ¨Ïö©");
        }
    } catch(e) { 
        console.log("Using default gacha pool:", e); 
    }

    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
            <div class="absolute inset-0 bg-gradient-to-r from-purple-900/20 via-black to-purple-900/20 pointer-events-none"></div>

            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-black/40 backdrop-blur-xl z-20">
                <div>
                    <h2 class="text-3xl font-black text-purple-400 uppercase italic tracking-tighter">Wheel of Fate</h2>
                    <p class="text-[10px] text-neutral-500 uppercase tracking-widest mt-1">Probability Generator</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="openMiniGameHub()" class="px-4 py-2 border border-white/10 rounded-lg text-xs text-neutral-400 hover:text-white hover:bg-white/5 transition-all">EXIT</button>
                </div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center relative overflow-hidden">
                <div id="gacha-result-area" class="hidden absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center" onclick="this.classList.add('hidden')">
                    <div id="gacha-result-content" class="text-center transform scale-0 transition-transform duration-500">
                        </div>
                    <p class="text-white/30 text-[10px] mt-12 animate-pulse uppercase tracking-[0.5em]">Click anywhere to close</p>
                </div>

                <div class="relative w-96 h-96 rounded-full border-4 border-purple-900/30 flex items-center justify-center mb-12 shadow-[0_0_100px_rgba(147,51,234,0.3)]">
                    <div class="absolute inset-0 rounded-full border border-white/10 animate-[spin_10s_linear_infinite]"></div>
                    <div class="absolute inset-4 rounded-full border border-white/5 animate-[spin_15s_linear_infinite_reverse]"></div>
                    
                    <div class="text-center z-10 space-y-6">
                        <div class="text-purple-500 mb-2 animate-bounce"><i data-lucide="sparkles" class="w-12 h-12 mx-auto"></i></div>
                        <h3 class="text-2xl font-serif font-black text-white uppercase tracking-widest">Summon</h3>
                        <div class="flex flex-col gap-3">
                            <button onclick="pullGacha(1)" class="w-48 py-4 bg-white text-black font-black uppercase rounded-full hover:bg-purple-400 hover:scale-105 transition-all shadow-xl text-xs tracking-widest">
                                Pull 1x
                            </button>
                            <button onclick="pullGacha(10)" class="w-48 py-4 bg-purple-900 border border-purple-500 text-white font-black uppercase rounded-full hover:bg-purple-700 hover:scale-105 transition-all shadow-xl text-xs tracking-widest">
                                Pull 10x
                            </button>
                        </div>
                    </div>
                </div>

                <div class="absolute bottom-8 right-8 text-right opacity-50 bg-black/50 p-4 rounded-xl backdrop-blur-md border border-white/5">
                    <h4 class="text-[10px] font-bold text-white uppercase mb-2 tracking-widest border-b border-white/10 pb-2">Drop Rates</h4>
                    <ul class="text-[9px] text-neutral-400 space-y-1 font-mono">
                        ${gachaPool.map(i => `<li>${i.name}: <span class="text-purple-400">${i.chance}%</span></li>`).join('')}
                    </ul>
                </div>
                
                <!-- ÏµúÍ∑º ÎΩëÍ∏∞ Í∏∞Î°ù -->
                <div class="absolute bottom-8 left-8 text-left bg-black/50 p-4 rounded-xl backdrop-blur-md border border-white/5 max-w-md">
                    <h4 class="text-[10px] font-bold text-white uppercase mb-3 tracking-widest border-b border-white/10 pb-2">Recent Pulls</h4>
                    <div id="gacha-recent-history" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                        <p class="text-[9px] text-neutral-600 italic">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="gacha-admin-modal" class="hidden fixed inset-0 z-[100] bg-black/90 flex items-center justify-center backdrop-blur-md">
            <div class="w-full max-w-lg bg-neutral-900 border border-purple-500/30 p-8 rounded-3xl shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4 uppercase">Configuration</h3>
                <textarea id="gacha-json-input" class="w-full h-64 bg-black border border-white/10 rounded-xl p-4 text-xs font-mono text-green-400 outline-none resize-none mb-4 custom-scrollbar">${JSON.stringify(gachaPool, null, 4)}</textarea>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('gacha-admin-modal').classList.add('hidden')" class="flex-1 py-3 bg-neutral-800 text-neutral-400 text-xs font-bold rounded-xl hover:text-white uppercase">Cancel</button>
                    <button onclick="saveGachaConfig()" class="flex-1 py-3 bg-purple-600 text-white text-xs font-bold rounded-xl hover:bg-purple-700 uppercase">Save Config</button>
                </div>
                <p class="text-[9px] text-neutral-500 mt-4 font-mono">* Format: [{"name":"Item", "rarity":5, "chance":10}, ...]</p>
            </div>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
    
    // ÏµúÍ∑º ÎΩëÍ∏∞ Í∏∞Î°ù Î°úÎìú
    loadRecentGachaHistory();
};

// Í∞ÄÏ±† Ïã§Ìñâ (Î°úÏßÅ)
window.pullGacha = async (times) => {
    // ÏΩîÏù∏ Ï≤¥ÌÅ¨
    const cost = times * 10;
    const currentCoins = state.userAccount.coins || 0;
    
    if (currentCoins < cost) {
        showToast(`Not enough coins! Need ${cost} coins.`);
        return;
    }
    
    // ÏΩîÏù∏ Ï∞®Í∞ê
    try {
        await syncUserCoins(state.user.uid, state.userAccount.loginId, currentCoins - cost);
        showToast(`-${cost} coins`);
    } catch(e) {
        console.error(e);
        showToast("Payment failed!");
        return;
    }
    
    const results = [];
    for(let i=0; i<times; i++) {
        const rand = Math.random() * 100;
        let cumulative = 0;
        let picked = gachaPool[gachaPool.length-1]; // Í∏∞Î≥∏Í∞í (Í∞ÄÏû• ÎÇÆÏùÄ Îì±Í∏â)
        
        for(const item of gachaPool) {
            cumulative += parseFloat(item.chance);
            if(rand <= cumulative) {
                picked = item;
                break;
            }
        }
        results.push(picked);
    }
    showGachaResults(results);
};

// Í≤∞Í≥º Ïó∞Ï∂ú ÌôîÎ©¥
function showGachaResults(results) {
    const resultArea = document.getElementById('gacha-result-area');
    const content = document.getElementById('gacha-result-content');
    
    // Ïù∏Î≤§ÌÜ†Î¶¨Ïóê ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
    addItemsToInventory(results);
    
    // ÏïÑÏù¥ÌÖú HTML ÏÉùÏÑ±
    const itemsHtml = results.map((item, idx) => {
        // Îì±Í∏âÎ≥Ñ ÏÉâÏÉÅ
        const colorClass = item.rarity >= 5 ? 'text-amber-400 border-amber-500/50 bg-amber-900/40 shadow-[0_0_30px_rgba(245,158,11,0.4)]' : 
                           (item.rarity === 4 ? 'text-purple-400 border-purple-500/50 bg-purple-900/40' : 'text-neutral-400 border-white/10 bg-white/5');
        
        // Îì±Ïû• ÎîúÎ†àÏù¥ (ÏàúÏ∞®Ï†Å Îì±Ïû•)
        const delay = idx * 0.1;

        return `
            <div class="w-32 h-40 ${colorClass} border-2 rounded-xl flex flex-col items-center justify-center p-3 m-2" style="animation: slideUp 0.5s ease-out ${delay}s both;">
                <span class="text-4xl mb-2 filter drop-shadow-md">${item.rarity >= 5 ? 'üëë' : (item.rarity === 4 ? '‚ú®' : 'üì¶')}</span>
                <p class="text-xs font-bold uppercase leading-tight text-center break-words w-full px-1">${item.name}</p>
                <div class="mt-2 text-[10px] opacity-70 font-mono tracking-widest">${"‚òÖ".repeat(item.rarity)}</div>
            </div>
        `;
    }).join('');

    content.innerHTML = `
        <h3 class="text-4xl font-black text-white uppercase italic mb-10 drop-shadow-lg tracking-tighter">Acquired Items</h3>
        <div class="flex flex-wrap justify-center max-w-4xl gap-2">
            ${itemsHtml}
        </div>
    `;

    resultArea.classList.remove('hidden');
    // ÌåùÏóÖ Ïï†ÎãàÎ©îÏù¥ÏÖò
    setTimeout(() => {
        content.classList.remove('scale-0');
        content.classList.add('scale-100');
    }, 50);
}

// Ïù∏Î≤§ÌÜ†Î¶¨Ïóê ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
async function addItemsToInventory(items) {
    try {
        const userRef = doc(db, 'artifacts', appId, 'users', state.user.uid);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
            const currentInventory = userSnap.data().inventory || [];
            const gachaHistory = userSnap.data().gachaHistory || [];
            
            const newInventory = [...currentInventory, ...items.map(item => ({
                ...item,
                acquiredAt: Date.now(),
                id: `item_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
            }))];
            
            // Í∞ÄÏ±† Í∏∞Î°ù Ï∂îÍ∞Ä (ÏµúÏã† 5Í∞úÎßå Ïú†ÏßÄ)
            const newRecord = {
                timestamp: Date.now(),
                items: items,
                userName: state.userAccount.ocName
            };
            const updatedHistory = [newRecord, ...gachaHistory].slice(0, 5);
            
            await setDoc(userRef, { 
                inventory: newInventory,
                gachaHistory: updatedHistory
            }, { merge: true });
            
            state.userAccount.inventory = newInventory;
            state.userAccount.gachaHistory = updatedHistory;
            
            showToast(`+${items.length} items to inventory!`);
            
            // Í∞ÄÏ±† Í∏∞Î°ùÏùÑ public Ïª¨Î†âÏÖòÏóêÎèÑ Ï†ÄÏû• (Îã§Î•∏ Ïú†Ï†ÄÎì§Ïù¥ Î≥º Ïàò ÏûàÎèÑÎ°ù)
            await savePublicGachaHistory(newRecord);
        }
    } catch(e) {
        console.error("Failed to add items to inventory:", e);
    }
}

// Í≥µÍ∞ú Í∞ÄÏ±† Í∏∞Î°ù Ï†ÄÏû•
async function savePublicGachaHistory(record) {
    try {
        const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'gacha_history');
        await addDoc(historyRef, {
            ...record,
            userId: state.user.uid,
            loginId: state.userAccount.loginId
        });
    } catch(e) {
        console.error("Failed to save public gacha history:", e);
    }
}

// ÏµúÍ∑º Í∞ÄÏ±† Í∏∞Î°ù Î°úÎìú
async function loadRecentGachaHistory() {
    try {
        const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'gacha_history');
        const q = query(historyRef, orderBy('timestamp', 'desc'), limit(5));
        const snapshot = await getDocs(q);
        
        const historyEl = document.getElementById('gacha-recent-history');
        if (!historyEl) return;
        
        if (snapshot.empty) {
            historyEl.innerHTML = '<p class="text-[9px] text-neutral-600 italic">No recent pulls yet.</p>';
            return;
        }
        
        const historyHtml = snapshot.docs.map(doc => {
            const data = doc.data();
            const timeAgo = getTimeAgo(data.timestamp);
            const topItem = data.items.sort((a,b) => b.rarity - a.rarity)[0];
            const rarityColor = topItem.rarity >= 5 ? 'text-amber-400' : (topItem.rarity === 4 ? 'text-purple-400' : 'text-neutral-400');
            
            return `
                <div class="flex items-center gap-2 text-[9px] text-neutral-400 py-1 border-b border-white/5">
                    <span class="font-bold text-white">${data.userName}</span>
                    <span>pulled</span>
                    <span class="${rarityColor} font-bold">${topItem.name}</span>
                    ${data.items.length > 1 ? `<span class="text-neutral-600">+${data.items.length-1}</span>` : ''}
                    <span class="ml-auto text-neutral-600 font-mono">${timeAgo}</span>
                </div>
            `;
        }).join('');
        
        historyEl.innerHTML = historyHtml;
    } catch(e) {
        console.error("Failed to load gacha history:", e);
    }
}

// ÏãúÍ∞Ñ Í≤ΩÍ≥º ÌëúÏãú Ìó¨Ìçº
function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = Math.floor((now - timestamp) / 1000);
    
    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
}

// Ïù∏Î≤§ÌÜ†Î¶¨ Ïó¥Í∏∞
window.openInventory = async () => {
    const modal = document.getElementById('inventory-modal');
    const content = document.getElementById('inventory-content');
    
    // Ïù∏Î≤§ÌÜ†Î¶¨ Î°úÎìú
    try {
        const userRef = doc(db, 'artifacts', appId, 'users', state.user.uid);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
            const inventory = userSnap.data().inventory || [];
            
            if (inventory.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-20">
                        <i data-lucide="package-x" class="w-16 h-16 mx-auto text-neutral-600 mb-4"></i>
                        <p class="text-neutral-500 text-sm">Your inventory is empty.</p>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${inventory.map(item => {
                            const colorClass = item.rarity >= 5 ? 'border-amber-500 bg-amber-900/20' : 
                                               (item.rarity === 4 ? 'border-purple-500 bg-purple-900/20' : 'border-white/10 bg-white/5');
                            return `
                                <div class="p-4 ${colorClass} border rounded-xl flex flex-col items-center justify-center hover:scale-105 transition-transform">
                                    <span class="text-4xl mb-2">${item.rarity >= 5 ? 'üëë' : (item.rarity === 4 ? '‚ú®' : 'üì¶')}</span>
                                    <p class="text-[10px] font-bold uppercase text-center text-white">${item.name}</p>
                                    <div class="mt-2 text-[9px] text-amber-500 font-mono">${"‚òÖ".repeat(item.rarity)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        }
    } catch(e) {
        console.error(e);
        content.innerHTML = `<p class="text-red-500 text-center">Failed to load inventory.</p>`;
    }
    
    modal.classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// Ïù∏Î≤§ÌÜ†Î¶¨ Îã´Í∏∞
window.closeInventory = () => {
    document.getElementById('inventory-modal').classList.add('hidden');
};

// Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ïÏ∞Ω Ïó¥Í∏∞
window.openGachaAdmin = () => {
    document.getElementById('gacha-admin-modal').classList.remove('hidden');
};

// Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï Ï†ÄÏû• (DB)
window.saveGachaConfig = async () => {
    try {
        const jsonStr = document.getElementById('gacha-json-input').value;
        const newPool = JSON.parse(jsonStr);
        
        gachaPool = newPool; // Î©îÎ™®Î¶¨ Í∞±Ïã†
        
        await setDoc(doc(db, 'artifacts', appId, 'public', 'gachaConfig'), {
            pool: newPool,
            updatedAt: serverTimestamp()
        });
        
        alert("Gacha pool updated!");
        document.getElementById('gacha-admin-modal').classList.add('hidden');
        renderGacha(); 
        
    } catch(e) {
        alert("Invalid JSON format. Please check syntax.");
    }
};

/* -----------------------------------------
   4. Ïä¨Î°ØÎ®∏Ïã† (Slot Machine) ÏãúÏä§ÌÖú
   ----------------------------------------- */
const slotSymbols = ['üçí', 'üçã', 'üçä', '7Ô∏è‚É£', 'üíé'];
let isSpinning = false;

window.renderSlots = () => {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
            <div class="absolute inset-0 bg-gradient-to-br from-green-900/20 via-black to-yellow-900/20 pointer-events-none"></div>

            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-black/40 backdrop-blur-xl z-20">
                <div>
                    <h2 class="text-3xl font-black text-green-400 uppercase italic tracking-tighter">Lucky 777</h2>
                    <p class="text-[10px] text-neutral-500 uppercase tracking-widest mt-1">Slot Machine Protocol</p>
                </div>
                <button onclick="openMiniGameHub()" class="px-4 py-2 border border-white/10 rounded-lg text-xs text-neutral-400 hover:text-white hover:bg-white/5 transition-all">EXIT</button>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center relative overflow-hidden p-10">
                <!-- Ïä¨Î°Ø Î®∏Ïã† -->
                <div class="relative bg-neutral-900 border-4 border-green-900/50 rounded-3xl p-12 shadow-[0_0_100px_rgba(34,197,94,0.3)] backdrop-blur-md">
                    <!-- ÏÉÅÎã® Ïû•Ïãù -->
                    <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-amber-500 text-black font-black text-xs px-6 py-2 rounded-full shadow-xl">
                        LUCKY 777
                    </div>
                    
                    <!-- Ïä¨Î°Ø ÎîîÏä§ÌîåÎ†àÏù¥ -->
                    <div class="flex gap-4 mb-8">
                        <div id="slot-1" class="w-24 h-32 bg-black border-2 border-green-500/50 rounded-xl flex items-center justify-center text-6xl shadow-inner">
                            üçí
                        </div>
                        <div id="slot-2" class="w-24 h-32 bg-black border-2 border-green-500/50 rounded-xl flex items-center justify-center text-6xl shadow-inner">
                            üçí
                        </div>
                        <div id="slot-3" class="w-24 h-32 bg-black border-2 border-green-500/50 rounded-xl flex items-center justify-center text-6xl shadow-inner">
                            üçí
                        </div>
                    </div>
                    
                    <!-- Í≤∞Í≥º ÌëúÏãú -->
                    <div id="slot-result" class="h-12 mb-6 flex items-center justify-center">
                        <p class="text-sm text-neutral-500 font-mono">Ready to spin!</p>
                    </div>
                    
                    <!-- Ïä§ÌïÄ Î≤ÑÌäº -->
                    <button onclick="spinSlots()" id="spin-button" class="w-full py-6 bg-gradient-to-b from-green-500 to-green-700 hover:from-green-400 hover:to-green-600 text-white font-black text-xl uppercase rounded-xl shadow-xl hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        üé∞ SPIN (10 Coins)
                    </button>
                </div>
                
                <!-- ÌéòÏù¥ÌÖåÏù¥Î∏î -->
                <div class="mt-12 bg-black/50 border border-white/5 rounded-xl p-6 backdrop-blur-md max-w-md">
                    <h4 class="text-xs font-bold text-white uppercase mb-4 tracking-widest border-b border-white/10 pb-2">Paytable</h4>
                    <ul class="text-[10px] text-neutral-400 space-y-2 font-mono">
                        <li class="flex justify-between">
                            <span>üíé üíé üíé</span> <span class="text-yellow-500 font-bold">3x (30 Coins)</span>
                        </li>
                        <li class="flex justify-between">
                            <span>7Ô∏è‚É£ 7Ô∏è‚É£ 7Ô∏è‚É£</span> <span class="text-amber-500 font-bold">2x (20 Coins)</span>
                        </li>
                        <li class="flex justify-between">
                            <span>üçä üçä üçä / üçã üçã üçã / üçí üçí üçí</span> <span class="text-green-500 font-bold">1x (10 Coins)</span>
                        </li>
                        <li class="flex justify-between">
                            <span>Any other</span> <span class="text-red-500">0x (Lose)</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

// Ïä¨Î°Ø Ïä§ÌïÄ Ïã§Ìñâ
window.spinSlots = async () => {
    if (isSpinning) return;
    
    // ÏΩîÏù∏ Ï≤¥ÌÅ¨
    const cost = 10;
    const currentCoins = state.userAccount.coins || 0;
    
    if (currentCoins < cost) {
        showToast("Not enough coins! Need 10 coins.");
        return;
    }
    
    // ÏΩîÏù∏ Ï∞®Í∞ê
    try {
        await syncUserCoins(state.user.uid, state.userAccount.loginId, currentCoins - cost);
        showToast("-10 coins");
    } catch(e) {
        console.error(e);
        showToast("Payment failed!");
        return;
    }
    
    isSpinning = true;
    const spinButton = document.getElementById('spin-button');
    const resultDiv = document.getElementById('slot-result');
    spinButton.disabled = true;
    resultDiv.innerHTML = '<p class="text-sm text-yellow-500 font-mono animate-pulse">Spinning...</p>';
    
    // Ïä¨Î°Ø Ïï†ÎãàÎ©îÏù¥ÏÖò (ÏàúÏ∞®Ï†ÅÏúºÎ°ú Î©àÏ∂§)
    const slots = [
        document.getElementById('slot-1'),
        document.getElementById('slot-2'),
        document.getElementById('slot-3')
    ];
    
    const results = [];
    
    for (let i = 0; i < 3; i++) {
        // Ïä¨Î°Ø ÌöåÏ†Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò
        let spinCount = 0;
        const spinInterval = setInterval(() => {
            slots[i].textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
            spinCount++;
            if (spinCount > 20 + i * 10) {
                clearInterval(spinInterval);
            }
        }, 100);
        
        // Í≤∞Í≥º Í≤∞Ï†ï (ÎåÄÍ∏∞ ÌõÑ)
        await new Promise(resolve => setTimeout(resolve, 2000 + i * 500));
        
        // ÏµúÏ¢Ö Í≤∞Í≥º
        const result = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
        slots[i].textContent = result;
        results.push(result);
    }
    
    // Í≤∞Í≥º ÌåêÏ†ï
    let winAmount = 0;
    let message = "";
    
    if (results[0] === 'üíé' && results[1] === 'üíé' && results[2] === 'üíé') {
        winAmount = 30;
        message = '<p class="text-2xl font-black text-yellow-500 animate-bounce">üíé JACKPOT! +30 COINS! üíé</p>';
    } else if (results[0] === '7Ô∏è‚É£' && results[1] === '7Ô∏è‚É£' && results[2] === '7Ô∏è‚É£') {
        winAmount = 20;
        message = '<p class="text-xl font-black text-amber-500">üéâ LUCKY 777! +20 COINS! üéâ</p>';
    } else if (results[0] === results[1] && results[1] === results[2]) {
        winAmount = 10;
        message = '<p class="text-lg font-bold text-green-500">‚ú® MATCH! +10 COINS! ‚ú®</p>';
    } else {
        message = '<p class="text-sm text-red-500 font-mono">üò¢ No match... Try again!</p>';
    }
    
    // Í≤∞Í≥º ÌëúÏãú
    resultDiv.innerHTML = message;
    
    // ÏÉÅÍ∏à ÏßÄÍ∏â
    if (winAmount > 0) {
        try {
            const newTotal = state.userAccount.coins + winAmount;
            await syncUserCoins(state.user.uid, state.userAccount.loginId, newTotal);
            showToast(`+${winAmount} coins!`);
        } catch(e) {
            console.error(e);
        }
    }
    
    isSpinning = false;
    spinButton.disabled = false;
};

/* -----------------------------------------
   5. Story Timeline (Í∏∞Ï°¥ ÏΩîÎìú)
   ----------------------------------------- */
window.renderStoryTimeline = () => {
    const chapters = state.storyData?.chapters || [];
    const isAdmin = state.isAdmin;

    $('content-area').innerHTML = `
        <div id="story-timeline-root" class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden animate-fade-in relative h-full select-none">
            
            <div class="p-12 pb-6 flex justify-between items-start z-20 bg-[#0a0a0a]/90 backdrop-blur-sm border-b border-white/5">
                <div>
                    <h2 class="text-5xl font-serif font-black text-white uppercase tracking-tighter">Main Story Timeline</h2>
                    <p class="text-[10px] text-amber-500 font-bold tracking-[0.3em] mt-2 uppercase">Chronological Records</p>
                </div>
                <div class="flex gap-4">
                    ${isAdmin ? `<button onclick="openStoryEditor('chapter', null)" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold rounded-lg uppercase tracking-wider">+ Add Chapter</button>` : ''}
                    <button
  onclick="renderOperation();"
  class="flex items-center gap-2 text-neutral-500 hover:text-white transition-colors uppercase text-xs font-bold tracking-widest border border-white/10 px-4 py-2 rounded-lg hover:bg-white/5 relative z-[100]">
  <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
</button>


                </div>
            </div>

            <div id="timeline-container" class="flex-1 overflow-x-auto custom-scrollbar w-full flex items-center cursor-grab active:cursor-grabbing relative bg-black">
                <div class="flex items-stretch h-full min-w-max pointer-events-none"> 
                    
                    ${chapters.map((chapter, cIndex) => `
                        <div class="relative flex flex-col justify-center h-full group/chapter pointer-events-auto border-r border-white/5">
                            
                            ${chapter.bgImage ? `
                                <div class="absolute inset-0 z-0 overflow-hidden">
                                    <img src="${chapter.bgImage}" class="w-full h-full object-cover opacity-20 grayscale hover:grayscale-0 transition-all duration-700 scale-105 group-hover/chapter:scale-100">
                                    <div class="absolute inset-0 bg-gradient-to-r from-black via-black/50 to-black"></div>
                                </div>
                            ` : ''}

                            <div class="relative z-10 px-12 py-20 flex flex-col h-full justify-center">
                                <div class="mb-40 border-l-4 border-amber-600 pl-4 relative">
                                    <h3 class="text-4xl font-black text-white uppercase italic tracking-tighter drop-shadow-lg">${chapter.title}</h3>
                                    <p class="text-xs text-neutral-400 font-mono mt-1 uppercase tracking-widest drop-shadow-md">${chapter.subtitle || ''}</p>
                                    
                                    ${isAdmin ? `
                                    <div class="absolute -right-2 -top-8 flex gap-2 opacity-0 group-hover/chapter:opacity-100 transition-opacity bg-black/80 px-2 py-1 rounded-lg border border-white/10 backdrop-blur-md">
                                        <button onclick="openStoryEditor('chapter', {cIdx:${cIndex}})" class="text-neutral-400 hover:text-amber-500" title="Edit Chapter"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                        <button onclick="deleteStoryChapter(${cIndex})" class="text-neutral-400 hover:text-red-500" title="Delete Chapter"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                    </div>` : ''}
                                </div>

                                <div class="flex items-center gap-0 relative">
                                    <div class="absolute top-1/2 left-0 w-full h-[2px] bg-neutral-800/80 -translate-y-1/2 z-0"></div>

                                    ${chapter.events ? chapter.events.map((evt, eIndex) => `
                                        <div class="relative z-10 flex flex-col items-center w-64 group h-16 justify-center">
                                            
                                            <div class="absolute w-60 text-center transition-all duration-300 ${eIndex % 2 === 0 ? 'bottom-full mb-1' : 'top-full mt-1'}">
                                                <p class="text-amber-500 font-bold font-mono text-xs mb-1 drop-shadow-md">${evt.year}</p>
                                                <h4 class="text-white font-black text-lg uppercase italic break-keep leading-tight drop-shadow-md">${evt.title}</h4>
                                                <p class="text-neutral-400 text-[10px] mt-2 px-2 leading-relaxed line-clamp-2 opacity-60 group-hover:opacity-100 transition-opacity drop-shadow-md">${evt.desc}</p>
                                                <div class="absolute left-1/2 -translate-x-1/2 w-px h-1 bg-neutral-600 ${eIndex % 2 === 0 ? '-bottom-1' : '-top-1'}"></div>
                                            </div>

                                            <div class="absolute w-72 p-4 rounded-xl bg-neutral-900 border border-white/20 shadow-[0_10px_40px_rgba(0,0,0,0.8)] opacity-0 group-hover:opacity-100 transition-all duration-300 z-50 pointer-events-none scale-95 group-hover:scale-100
                                                ${eIndex % 2 === 0 ? 'top-full mt-6 translate-y-2 group-hover:translate-y-0' : 'bottom-full mb-6 -translate-y-2 group-hover:translate-y-0'}">
                                                <div class="flex items-center gap-2 mb-2 border-b border-white/10 pb-2">
                                                    <i data-lucide="file-text" class="w-3 h-3 text-amber-500"></i>
                                                    <span class="text-[10px] font-bold text-white uppercase tracking-widest">Plot Summary</span>
                                                </div>
                                                <p class="text-neutral-300 text-xs leading-relaxed text-justify font-sans whitespace-pre-line">
                                                    ${evt.summary ? evt.summary : '<span class="text-neutral-600 italic">No summary details registered.</span>'}
                                                </p>
                                                <div class="absolute left-1/2 -translate-x-1/2 w-3 h-3 bg-neutral-900 border-l border-t border-white/20 transform rotate-45 ${eIndex % 2 === 0 ? '-top-1.5' : '-bottom-1.5 border-l-0 border-t-0 border-r border-b'}"></div>
                                            </div>

                                            <div onclick="${isAdmin ? `openStoryEditor('event', {cIdx:${cIndex}, eIdx:${eIndex}})` : ''}" 
                                                 class="w-12 h-12 rounded-full bg-[#0a0a0a] border-2 border-neutral-600 group-hover:border-amber-500 group-hover:scale-110 transition-all duration-300 flex items-center justify-center relative z-20 shadow-lg cursor-pointer hover:bg-neutral-800">
                                                <i data-lucide="${evt.icon || 'circle'}" class="w-5 h-5 text-neutral-400 group-hover:text-white transition-colors"></i>
                                            </div>

                                            ${eIndex !== chapter.events.length - 1 ? `<div class="absolute top-1/2 -right-[50%] -translate-y-1/2 w-1.5 h-1.5 rounded-full bg-neutral-800 z-10"></div>` : ''}
                                        </div>
                                        <div class="w-16 h-1 bg-transparent"></div>
                                    `).join('') : ''}

                                    ${isAdmin ? `<button onclick="openStoryEditor('event', {cIdx:${cIndex}, eIdx:null})" class="relative z-10 w-10 h-10 rounded-full bg-neutral-900 border border-white/20 hover:bg-amber-600 hover:text-white hover:border-amber-600 flex items-center justify-center transition-all ml-4"><i data-lucide="plus" class="w-4 h-4"></i></button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <div id="story-editor-modal" class="hidden fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-neutral-900 border border-amber-600/30 rounded-[2.5rem] p-10 shadow-2xl modal-enter">
                <h3 id="story-editor-title" class="text-xl font-serif font-black text-white uppercase tracking-tighter mb-6 text-center">Edit Timeline</h3>
                
                <div id="story-editor-content" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"></div>

                <div class="flex gap-4 mt-8">
                    <button onclick="document.getElementById('story-editor-modal').classList.add('hidden')" class="flex-1 py-4 bg-neutral-800 text-neutral-400 font-bold rounded-xl uppercase text-xs hover:text-white">Cancel</button>
                    <button id="story-save-btn" class="flex-1 py-4 bg-amber-600 text-white font-bold rounded-xl uppercase text-xs hover:bg-amber-700 shadow-lg">Save</button>
                    <button id="story-delete-btn" class="hidden w-12 py-4 bg-red-900/50 text-red-500 font-bold rounded-xl uppercase text-xs hover:bg-red-600 hover:text-white"><i data-lucide="trash-2" class="w-4 h-4 mx-auto"></i></button>
                </div>
            </div>
        </div>
    `;

    // ÎìúÎûòÍ∑∏ Ïä§ÌÅ¨Î°§
    const slider = document.getElementById('timeline-container');
    let isDown = false;
    let startX;
    let scrollLeft;
    slider.addEventListener('mousedown', (e) => { if (e.target.closest('button')) return;isDown = true; slider.classList.add('active'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
    slider.addEventListener('mouseleave', () => { isDown = false; });
    slider.addEventListener('mouseup', () => { isDown = false; });
    slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 1.5; slider.scrollLeft = scrollLeft - walk; });
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.openStoryEditor = (type, target) => {
    const modal = document.getElementById('story-editor-modal');
    const content = document.getElementById('story-editor-content');
    const title = document.getElementById('story-editor-title');
    const saveBtn = document.getElementById('story-save-btn');
    const delBtn = document.getElementById('story-delete-btn');
    
    modal.classList.remove('hidden');
    delBtn.classList.add('hidden');

    if (type === 'chapter') {
        // [ÏàòÏ†ïÎê®] Ï±ïÌÑ∞ Ï∂îÍ∞Ä ÎòêÎäî ÏàòÏ†ï
        const chapters = state.storyData?.chapters || [];
        const isEdit = target && target.cIdx !== undefined && target.cIdx !== null;
        const ch = isEdit ? chapters[target.cIdx] : {};

        title.innerText = isEdit ? "Edit Chapter" : "New Chapter";
        content.innerHTML = `
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Chapter Title</label>
            <input id="edit-ch-title" value="${ch.title || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-amber-500" placeholder="e.g. Chapter 1"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Subtitle</label>
            <input id="edit-ch-sub" value="${ch.subtitle || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-amber-500" placeholder="e.g. The Beginning"></div>
            
            <div><label class="text-[10px] text-amber-500 font-bold uppercase">Background Image URL</label>
            <input id="edit-ch-bg" value="${ch.bgImage || ''}" class="w-full bg-black border border-amber-500/30 rounded-xl px-4 py-3 text-sm text-amber-500 font-mono" placeholder="https://..."></div>
        `;
        // Ï†ÄÏû• Ìï®ÏàòÏóê Ïù∏Îç±Ïä§ Ï†ÑÎã¨ (ÏàòÏ†ïÏù¥Î©¥ Ïù∏Îç±Ïä§, Ï∂îÍ∞ÄÎ©¥ null)
        saveBtn.onclick = () => saveStoryChapter(isEdit ? target.cIdx : null);

    } else if (type === 'event') {
        const { cIdx, eIdx } = target;
        const chapters = state.storyData.chapters;
        const isEdit = eIdx !== null;
        const evt = isEdit ? chapters[cIdx].events[eIdx] : {};

        title.innerText = isEdit ? "Edit Event" : "Add Event";
        content.innerHTML = `
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Year / Date</label>
            <input id="edit-ev-year" value="${evt.year || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-amber-500 font-bold" placeholder="2024.01"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Title</label>
            <input id="edit-ev-title" value="${evt.title || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-white font-bold" placeholder="Title"></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Short Desc (Always Visible)</label>
            <input id="edit-ev-desc" value="${evt.desc || ''}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-neutral-400" placeholder="Brief description..."></div>

            <div><label class="text-[10px] text-amber-500 font-bold uppercase">Plot Summary (Hover Popup)</label>
            <textarea id="edit-ev-summary" class="w-full bg-black border border-amber-500/30 rounded-xl px-4 py-3 text-sm text-white resize-none h-24 custom-scrollbar leading-relaxed" placeholder="Enter detailed story plot here...">${evt.summary || ''}</textarea></div>
            
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase">Icon (Lucide)</label>
            <input id="edit-ev-icon" value="${evt.icon || 'circle'}" class="w-full bg-black border border-white/10 rounded-xl px-4 py-3 text-sm text-neutral-500 font-mono" placeholder="anchor, star..."></div>
        `;
        
        saveBtn.onclick = () => saveStoryEvent(cIdx, eIdx);
        
        if (isEdit) {
            delBtn.classList.remove('hidden');
            delBtn.onclick = () => deleteStoryEvent(cIdx, eIdx);
        }
    }
};

// [Î°úÏßÅ] Ï±ïÌÑ∞ Ï†ÄÏû•
window.saveStoryChapter = async (cIdx) => {
    const title = document.getElementById('edit-ch-title').value;
    const sub = document.getElementById('edit-ch-sub').value;
    const bgImage = document.getElementById('edit-ch-bg').value; // [Ï∂îÍ∞Ä] Ïù¥ÎØ∏ÏßÄ

    if (!title) return showToast("Title required.");

    const currentChapters = state.storyData?.chapters || [];
    let updatedChapters = [...currentChapters];

    if (cIdx === null) {
        // [Ï∂îÍ∞Ä Î™®Îìú]
        const newChapter = { title, subtitle: sub, bgImage, events: [] };
        updatedChapters.push(newChapter);
    } else {
        // [ÏàòÏ†ï Î™®Îìú] Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏Îäî Ïú†ÏßÄÌïòÍ≥† Ï†ïÎ≥¥Îßå ÏóÖÎç∞Ïù¥Ìä∏
        updatedChapters[cIdx] = { 
            ...updatedChapters[cIdx], 
            title, 
            subtitle: sub, 
            bgImage 
        };
    }
    
    await updateStoryDB(updatedChapters);
    document.getElementById('story-editor-modal').classList.add('hidden');
};
// [Î°úÏßÅ] Ï±ïÌÑ∞ ÏÇ≠Ï†ú
window.deleteStoryChapter = async (cIdx) => {
    if(!confirm("Delete this entire chapter?")) return;
    const chapters = [...state.storyData.chapters];
    chapters.splice(cIdx, 1);
    await updateStoryDB(chapters);
};

// [Î°úÏßÅ] Ïù¥Î≤§Ìä∏ Ï†ÄÏû• (Ï∂îÍ∞Ä/ÏàòÏ†ï)
window.saveStoryEvent = async (cIdx, eIdx) => {
    const year = document.getElementById('edit-ev-year').value;
    const title = document.getElementById('edit-ev-title').value;
    const desc = document.getElementById('edit-ev-desc').value;
    const summary = document.getElementById('edit-ev-summary').value; // [ÌïÑÏàò] Ï§ÑÍ±∞Î¶¨
    const icon = document.getElementById('edit-ev-icon').value;

    if (!title) return showToast("Title required.");

    const chapters = [...state.storyData.chapters];
    const newEvent = { year, title, desc, summary, icon };

    if (eIdx === null) {
        chapters[cIdx].events.push(newEvent);
    } else {
        chapters[cIdx].events[eIdx] = newEvent;
    }

    await updateStoryDB(chapters);
    document.getElementById('story-editor-modal').classList.add('hidden');
};

// [Î°úÏßÅ] Ïù¥Î≤§Ìä∏ ÏÇ≠Ï†ú
window.deleteStoryEvent = async (cIdx, eIdx) => {
    if(!confirm("Delete this event?")) return;
    const chapters = [...state.storyData.chapters];
    chapters[cIdx].events.splice(eIdx, 1);
    await updateStoryDB(chapters);
    $('story-editor-modal').classList.add('hidden');
};

// [Í≥µÌÜµ] DB ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
window.updateStoryDB = async (chapters) => {
    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'story'), {
            chapters: chapters
        });
        showToast("Timeline Updated.");
    } catch(e) {
        console.error(e);
        showToast("Save Failed.");
    }
};
// [Ï∂îÍ∞Ä] Ïú†Ï†Ä Í≥ÑÏ†ï Í∞ïÏ†ú ÏÇ≠Ï†ú (Í¥ÄÎ¶¨ÏûêÏö©)
window.deleteUserAccount = async (loginId) => {
    // 1. ÏïàÏ†ÑÏû•Ïπò: Ï†ïÎßê ÏÇ≠Ï†úÌï† Í≤ÉÏù∏ÏßÄ ÌôïÏù∏
    if (!confirm(`WARNING: You are about to DELETE user [${loginId}].\nThis action cannot be undone.\n\nAre you sure?`)) {
        return;
    }

    try {
        // 2. DBÏóêÏÑú Í≥ÑÏ†ï Î¨∏ÏÑú ÏÇ≠Ï†ú
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId));
        
        // 3. Î™®Îã¨ Îã´Í∏∞ Î∞è ÏïåÎ¶º
        document.getElementById('admin-edit-modal').classList.add('hidden');
        showToast("User Account Terminated.");
        
        // (Ï∞∏Í≥†: Î¶¨Ïä§Ìä∏Îäî onSnapshotÏóê ÏùòÌï¥ ÏûêÎèôÏúºÎ°ú Í∞±Ïã†Îê©ÎãàÎã§)
    } catch(e) {
        console.error(e);
        showToast("Termination Failed.");
    }
};
// [Î≥µÍµ¨Îê®] Ï±ÑÌåÖÎ∞© Î©§Î≤Ñ Î™©Î°ù Î≥¥Ïó¨Ï£ºÍ∏∞ (Í∑∏Î£π Ïù¥Î¶Ñ ÌÅ¥Î¶≠ Ïãú)
window.showRoomMembers = (roomId) => {
    const room = state.chatRooms.find(r => r.id === roomId);
    if (!room) return;

    const list = document.getElementById('room-members-list');
    if (list) {
        list.innerHTML = room.members.map(mid => {
            const acc = state.accounts.find(a => a.loginId === mid);
            // Ïú†Ï†Ä Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥(ÌÉàÌá¥ Îì±) Í∏∞Î≥∏Í∞í ÌëúÏãú
            const name = acc ? acc.ocName : 'Unknown User';
            const img = acc ? acc.profile : '';
            const id = mid;
            
            return `
                <div class="flex items-center justify-between p-3 bg-neutral-950/50 rounded-xl border border-white/5 mb-2 last:mb-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-black overflow-hidden border border-white/10 shrink-0">
                            ${img ? `<img src="${img}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-neutral-800 flex items-center justify-center"><i data-lucide="user" class="w-5 h-5 text-neutral-500"></i></div>`}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white">${name}</p>
                            <p class="text-[9px] text-neutral-600 font-mono">ID: ${id}</p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Î™®Îã¨ ÎùÑÏö∞Í∏∞
    const modal = document.getElementById('room-members-modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
    
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
// [Ï∂îÍ∞Ä] ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïù¥Î©îÏùº Î∞úÏÜ° Ìï®Ïàò
window.handleSendPasswordReset = async (email) => {
    if (!email) {
        return showToast("Error: No email address found for this user.");
    }

    if (!confirm(`Send password reset email to [${email}]?`)) return;

    try {
        await sendPasswordResetEmail(auth, email);
        showToast(`Reset email sent to ${email}`);
    } catch (error) {
        console.error("Password Reset Error:", error);
        if (error.code === 'auth/user-not-found') {
            showToast("Error: User not found in Authentication.");
        } else {
            showToast("Failed to send email: " + error.message);
        }
    }
};
function renderInvestigation() {
    const inv = state.investigation;
    if (!inv.selectedSector) {
        renderSectorSelection();
        return;
    }

    const sectorIdx = inv.sectors.findIndex(s => s.id === inv.selectedSector);
    const sector = inv.sectors[sectorIdx];
    const sectorPoints = inv.points.filter(p => p.sector === inv.selectedSector);

    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-black overflow-hidden animate-fade-in relative h-full">
            <div class="absolute inset-0 z-10 pointer-events-none shadow-[inset_0_0_300px_rgba(0,0,0,1)]"></div>
            <div class="absolute inset-0 z-10 pointer-events-none bg-gradient-to-b from-black/90 via-transparent to-black/95"></div>

            <div class="p-8 flex justify-between items-center z-20 bg-black/20 backdrop-blur-sm border-b border-white/5">
    <div>
        <h2 class="text-3xl font-serif font-black text-white uppercase tracking-tighter">${sector.name}</h2>
        <button onclick="window.returnToSectors()" class="text-[10px] text-amber-500 font-bold hover:underline uppercase tracking-widest mt-1">‚óÄ Return to Sector Selection</button>
    </div>
    <div class="flex gap-3">
        ${state.isAdmin ? `<button onclick="changeMapImage(${sectorIdx})" class="px-6 py-2 border border-amber-500/30 text-amber-500 hover:bg-amber-500 hover:text-white rounded-lg text-xs font-bold uppercase transition-all">Change Map</button>` : ''}
        <button onclick="switchView('operation')" class="px-6 py-2 border border-white/10 text-neutral-400 hover:text-white rounded-lg text-xs font-bold uppercase transition-all">Withdraw</button>
    </div>
</div>

            <div class="flex-1 relative flex flex-row overflow-hidden">
                <div class="flex-1 relative overflow-hidden flex items-center justify-center cursor-crosshair" onclick="handleMapClick(event)">
                    <div class="absolute inset-0 flex items-center justify-center" id="map-container">
                        <img src="${sector.map}" class="w-full h-full object-cover opacity-40 grayscale hover:grayscale-0 transition-all duration-[2000ms]">
                        <div class="absolute inset-0 pointer-events-none">
                            ${sectorPoints.map((p) => {
                                const isFound = inv.foundClueIds && inv.foundClueIds.includes(p.id);
                                // Ï†ÑÏó≠ points Î∞∞Ïó¥ÏóêÏÑúÏùò Ïã§Ï†ú Ïù∏Îç±Ïä§Î•º Ï∞æÏäµÎãàÎã§ (ÏàòÏ†ïÏö©)
                                const globalIdx = inv.points.findIndex(gp => gp.id === p.id);
                                
                                return `
                                    <div class="absolute w-10 h-10 -ml-5 -mt-5 flex items-center justify-center group pointer-events-auto" style="left: ${p.x}%; top: ${p.y}%;">
                                        ${!isFound ? '<div class="absolute inset-0 bg-amber-500 rounded-full animate-ping opacity-20"></div>' : ''}
                                        <div onclick="handleDiscovery('${p.id}'); event.stopPropagation();" 
                                             class="w-3 h-3 ${isFound ? 'bg-neutral-600' : 'bg-amber-600 border-amber-400'} border rounded-full transition-all cursor-pointer group-hover:scale-150">
                                        </div>
                                        
                                        <div class="absolute bottom-full mb-4 opacity-0 group-hover:opacity-100 transition-all pointer-events-none z-50 translate-y-2 group-hover:translate-y-0">
<div class="bg-neutral-900/90 backdrop-blur-md text-white text-[10px] font-black px-4 py-2 rounded-xl border border-amber-500/30 shadow-2xl flex items-center gap-3 pointer-events-auto whitespace-nowrap w-max min-w-max">
    <span class="tracking-widest inline-block">${p.title}</span>
    ${state.isAdmin ? `
        <div class="flex gap-2 ml-2 border-l border-white/10 pl-2 text-[9px] shrink-0">
            <button onclick="event.stopPropagation(); editPOI(${globalIdx})" class="text-amber-500 hover:text-white">EDIT</button>
            <button onclick="event.stopPropagation(); handlePointRightClick(event, ${globalIdx})" class="text-red-500 hover:text-white">DEL</button>
        </div>
    ` : ''}
</div>
                                        </div>
                                    </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <div class="w-80 border-l border-white/5 bg-black/40 backdrop-blur-xl z-20 flex flex-col p-6 overflow-hidden">
                    <h3 class="text-[10px] font-black text-neutral-500 uppercase tracking-[0.3em] mb-6 border-b border-white/5 pb-4">Recent Archive Logs</h3>
                    <div id="investigation-side-list" class="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2"></div>
                    <button onclick="toggleArchive()" class="mt-6 py-4 bg-white/5 border border-white/10 rounded-xl text-[9px] font-bold text-neutral-400 uppercase tracking-widest hover:bg-white/10 hover:text-white transition-all">
                        Open Full Archive
                    </button>
                </div>
            </div>
            ... 
        </div>
    `;
    updateInvestigationSideList();
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function renderSectorSelection() {
    const inv = state.investigation;
    const isAdmin = state.isAdmin;

    $('content-area').innerHTML = `
        <div class="flex-1 flex flex-col bg-[#080808] overflow-hidden animate-fade-in relative h-full select-none">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20 pointer-events-none"></div>
            <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-black to-transparent z-10"></div>
            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-black to-transparent z-10"></div>

            <div class="relative z-20 pt-16 pb-8 text-center space-y-2 pointer-events-none">
                <div class="inline-block border-b border-amber-600/50 pb-1 mb-2">
                    <p class="text-[10px] text-amber-500 font-bold tracking-[0.5em] uppercase">Target Selection</p>
                </div>
                <h2 class="text-6xl md:text-7xl font-serif font-black text-white italic tracking-tighter uppercase drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                    Select Sector
                </h2>
            </div>
            
            <button onclick="window.switchView('operation')" 
                    class="absolute left-12 top-20 z-30 flex items-center gap-2 text-neutral-600 hover:text-white transition-colors text-[10px] font-bold uppercase tracking-widest group cursor-pointer">
                <div class="w-8 h-[1px] bg-neutral-600 group-hover:bg-white transition-colors"></div>
                Back to Operation
            </button>

            <div id="sector-slide-container" class="flex-1 flex items-center overflow-x-auto overflow-y-hidden custom-scrollbar px-12 pb-12 z-20 cursor-grab active:cursor-grabbing w-full">
                
                <div class="flex gap-6 items-center min-w-max px-12 mx-auto">
                    
                    ${inv.sectors.map((s, idx) => {
                        const available = s.isAvailable;
                        const canEnter = available || isAdmin;
                        
                        return `
                        <div class="group relative w-[280px] h-[420px] bg-neutral-900 border border-white/10 rounded-[4px] transition-all duration-500 flex-shrink-0
                                    ${canEnter ? 'hover:w-[320px] hover:h-[460px] hover:border-amber-500/50 hover:shadow-[0_0_30px_rgba(217,119,6,0.2)] hover:z-30' : 'opacity-50 grayscale'}"
                             onclick="if(!window.isDragging) handleSectorClick('${s.id}', ${available})">
                            
                            <div class="absolute inset-0 overflow-hidden pointer-events-none">
                                <img src="${s.map}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-60 group-hover:opacity-100" draggable="false">
                                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90 group-hover:opacity-60 transition-opacity duration-500"></div>
                            </div>

                            ${!available ? `
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <i data-lucide="lock" class="w-8 h-8 text-white/30"></i>
                            </div>` : ''}

                            <div class="absolute bottom-0 left-0 w-full p-6 transform transition-all duration-500 group-hover:translate-y-[-40px] pointer-events-none">
                                <div class="w-8 h-[2px] bg-amber-500 mb-3 group-hover:w-16 transition-all duration-500"></div>
                                <span class="inline-block px-2 py-0.5 bg-neutral-800/80 border border-white/10 rounded text-[9px] text-neutral-400 font-mono mb-2 uppercase tracking-widest backdrop-blur-sm">
                                    ${s.unlockDate || 'DATE: UNKNOWN'}
                                </span>
                                <h3 class="text-3xl font-black text-white uppercase italic leading-none tracking-tighter mb-1 font-serif drop-shadow-lg">
                                    ${s.name}
                                </h3>
                                <p class="text-[10px] text-neutral-400 line-clamp-1 group-hover:text-neutral-200 transition-colors">
                                    ${s.desc}
                                </p>
                            </div>

                            ${isAdmin ? `
                            <div class="absolute bottom-0 left-0 w-full h-10 bg-black/80 border-t border-white/10 flex divide-x divide-white/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-auto z-40">
                                <button onclick="event.stopPropagation(); openSectorEditor(${idx})" class="flex-1 text-[9px] font-bold text-neutral-400 hover:text-amber-500 hover:bg-white/5 uppercase tracking-widest transition-colors">
                                    EDIT
                                </button>
                                <button onclick="event.stopPropagation(); deleteSector(${idx})" class="flex-1 text-[9px] font-bold text-neutral-400 hover:text-red-500 hover:bg-red-900/20 uppercase tracking-widest transition-colors">
                                    DEL
                                </button>
                                <button onclick="event.stopPropagation(); toggleSectorStatus(${idx})" class="flex-1 text-[9px] font-bold text-neutral-400 hover:text-white hover:bg-white/5 uppercase tracking-widest transition-colors">
                                    ${available ? 'LOCK' : 'UNLOCK'}
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        `;
                    }).join('')}

                    ${isAdmin ? `
                    <div onclick="if(!window.isDragging) openSectorEditor(null)" 
                         class="group relative w-[100px] h-[420px] hover:w-[140px] bg-neutral-900/30 border border-dashed border-white/20 rounded-[4px] cursor-pointer hover:border-amber-500 hover:bg-amber-600/10 transition-all duration-300 flex flex-col items-center justify-center gap-4 flex-shrink-0">
                        <div class="w-12 h-12 rounded-full border border-white/10 flex items-center justify-center group-hover:border-amber-500 group-hover:scale-110 transition-all">
                            <i data-lucide="plus" class="w-5 h-5 text-neutral-500 group-hover:text-amber-500"></i>
                        </div>
                        <p class="text-[9px] text-neutral-600 font-bold uppercase tracking-widest group-hover:text-amber-500 writing-vertical">
                            Add Sector
                        </p>
                    </div>
                    ` : ''}
                    
                    <div class="w-12 flex-shrink-0"></div>
                </div>
            </div>

            <div class="absolute bottom-8 w-full text-center pointer-events-none z-30">
                <p class="text-[9px] text-white/20 font-mono tracking-[1em] uppercase animate-pulse">Drag to Explore</p>
            </div>
        </div>

        <div id="sector-editor-modal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-6 backdrop-blur-md">
            <div class="w-full max-w-md bg-[#0a0a0a] border border-amber-600/30 rounded-2xl p-8 shadow-2xl modal-enter relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-600 to-transparent opacity-50"></div>
                <h3 id="sector-editor-title" class="text-2xl font-serif font-black text-white uppercase italic tracking-tighter mb-8 text-center">New Sector</h3>
                <div class="space-y-5">
                    <div><label class="text-[9px] text-amber-500 font-bold uppercase tracking-widest ml-1">Sector Name</label><input id="sec-edit-name" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none transition-colors" placeholder="e.g. Ruined City"></div>
                    <div><label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest ml-1">Unlock Date / Tag</label><input id="sec-edit-date" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none transition-colors" placeholder="e.g. 1999.12.31"></div>
                    <div><label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest ml-1">Image URL</label><input id="sec-edit-img" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-xs text-amber-500 font-mono focus:border-amber-500 outline-none transition-colors" placeholder="https://..."></div>
                    <div><label class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest ml-1">Description</label><textarea id="sec-edit-desc" class="w-full bg-neutral-900 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-amber-500 outline-none resize-none h-20" placeholder="Brief description..."></textarea></div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button onclick="document.getElementById('sector-editor-modal').classList.add('hidden')" class="flex-1 py-3 bg-neutral-800 text-neutral-400 font-bold rounded-lg uppercase text-[10px] hover:text-white transition-colors tracking-widest">Cancel</button>
                    <button id="sector-save-btn" class="flex-1 py-3 bg-amber-600 text-white font-bold rounded-lg uppercase text-[10px] hover:bg-amber-700 shadow-[0_0_15px_rgba(217,119,6,0.3)] tracking-widest transition-all">Confirm</button>
                </div>
            </div>
        </div>
    `;

    // [ÎìúÎûòÍ∑∏ Í∏∞Îä• Ïä§ÌÅ¨Î¶ΩÌä∏]
    const slider = document.getElementById('sector-slide-container');
    if(slider) {
        let isDown = false;
        let startX;
        let scrollLeft;
        window.isDragging = false; 

        slider.addEventListener('mousedown', (e) => {
            if(e.target.closest('button') || e.target.closest('input')) return;
            isDown = true;
            window.isDragging = false;
            slider.classList.add('active');
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        });
        slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); setTimeout(() => window.isDragging = false, 50); });
        slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('active'); setTimeout(() => window.isDragging = false, 50); });
        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 1.5;
            if(Math.abs(walk) > 5) window.isDragging = true;
            slider.scrollLeft = scrollLeft - walk;
        });
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
// Íµ¨Ïó≠ ÌÅ¥Î¶≠ Ï≤òÎ¶¨ Ìï®Ïàò (Ïù¥Îèô Î≤ÑÍ∑∏ ÏàòÏ†ï)
window.handleSectorClick = (sectorId, isAvailable) => {
    // Í¥ÄÎ¶¨ÏûêÏù¥Í±∞ÎÇò, Ìï¥Í∏àÎêú Íµ¨Ïó≠Ïùº Í≤ΩÏö∞ÏóêÎßå ÏßÑÏûÖ
    if (state.isAdmin || isAvailable) {
        state.investigation.selectedSector = sectorId;
        renderInvestigation(); // Ïã§Ï†ú ÏßÄÎèÑ ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
    } else {
        showToast('ÌòÑÏû¨ ÏßÑÏûÖÏù¥ Î∂àÍ∞ÄÎä•Ìïú Íµ¨Ïó≠ÏûÖÎãàÎã§.');
    }
};
window.openSectorEditor = (idx) => {
    const modal = document.getElementById('sector-editor-modal');
    const title = document.getElementById('sector-editor-title');
    const saveBtn = document.getElementById('sector-save-btn');
    
    // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
    const nameIn = document.getElementById('sec-edit-name');
    const dateIn = document.getElementById('sec-edit-date');
    const imgIn = document.getElementById('sec-edit-img');
    const descIn = document.getElementById('sec-edit-desc');

    if (idx !== null) {
        // ÏàòÏ†ï Î™®Îìú: Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
        const s = state.investigation.sectors[idx];
        title.innerText = "Edit Sector";
        nameIn.value = s.name;
        dateIn.value = s.unlockDate;
        imgIn.value = s.map;
        descIn.value = s.desc;
        saveBtn.onclick = () => saveSector(idx);
    } else {
        // Ï∂îÍ∞Ä Î™®Îìú: Îπà Ïπ∏
        title.innerText = "New Sector";
        nameIn.value = "";
        dateIn.value = "";
        imgIn.value = "";
        descIn.value = "";
        saveBtn.onclick = () => saveSector(null);
    }

    modal.classList.remove('hidden');
};

// 2. ÏÑπÌÑ∞ Ï†ÄÏû• (Ï∂îÍ∞Ä/ÏàòÏ†ï Î°úÏßÅ)
window.saveSector = async (idx) => {
    const name = document.getElementById('sec-edit-name').value;
    const date = document.getElementById('sec-edit-date').value;
    const img = document.getElementById('sec-edit-img').value;
    const desc = document.getElementById('sec-edit-desc').value;

    if (!name || !img) return showToast("Ïù¥Î¶ÑÍ≥º Ïù¥ÎØ∏ÏßÄÎäî ÌïÑÏàòÏûÖÎãàÎã§.");

    const newSectorData = {
        id: (idx !== null) ? state.investigation.sectors[idx].id : ('s_' + Date.now()), // ID Ïú†ÏßÄ ÌòπÏùÄ Ïã†Í∑ú ÏÉùÏÑ±
        name: name,
        unlockDate: date,
        map: img,
        desc: desc,
        isAvailable: (idx !== null) ? state.investigation.sectors[idx].isAvailable : false // Í∏∞Ï°¥ ÏÉÅÌÉú Ïú†ÏßÄ ÌòπÏùÄ Ïû†Í∏à ÏÉÅÌÉúÎ°ú ÏãúÏûë
    };

    if (idx !== null) {
        // ÏàòÏ†ï
        state.investigation.sectors[idx] = newSectorData;
    } else {
        // Ï∂îÍ∞Ä
        state.investigation.sectors.push(newSectorData);
    }

    // ÏÑúÎ≤Ñ ÎèôÍ∏∞Ìôî
    await window.handleSystemUpdate();
    
    // Î™®Îã¨ Îã´Í∏∞ Î∞è ÌôîÎ©¥ Í∞±Ïã†
    document.getElementById('sector-editor-modal').classList.add('hidden');
    renderSectorSelection();
    showToast(idx !== null ? "ÏÑπÌÑ∞ Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§." : "ÏÉà ÏÑπÌÑ∞Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.");
};

// 3. ÏÑπÌÑ∞ ÏÇ≠Ï†ú
window.deleteSector = async (idx) => {
    const s = state.investigation.sectors[idx];
    if (!confirm(`Ï†ïÎßê [${s.name}] Íµ¨Ïó≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) return;

    // Î∞∞Ïó¥ÏóêÏÑú Ï†úÍ±∞
    state.investigation.sectors.splice(idx, 1);
    
    // Ïù¥ Íµ¨Ïó≠Ïóê ÏÜçÌïú Ìè¨Ïù∏Ìä∏Îì§ÎèÑ ÏÇ≠Ï†úÌï†ÏßÄ Ïó¨Î∂ÄÎäî ÏÑ†ÌÉùÏÇ¨Ìï≠Ïù¥ÏßÄÎßå, ÏùºÎã® Íµ¨Ïó≠Îßå ÏÇ≠Ï†úÌï©ÎãàÎã§.
    // (ÏôÑÎ≤ΩÌïòÍ≤å ÌïòÎ†§Î©¥ points Î∞∞Ïó¥ÏóêÏÑúÎèÑ Ìï¥Îãπ sector IDÎ•º Í∞ÄÏßÑ Í≤ÉÎì§ÏùÑ filterÎ°ú Ï†úÍ±∞Ìï¥Ïïº Ìï®)
    state.investigation.points = state.investigation.points.filter(p => p.sector !== s.id);

    // ÏÑúÎ≤Ñ ÎèôÍ∏∞Ìôî
    await window.handleSystemUpdate();
    renderSectorSelection();
    showToast("ÏÑπÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
};
window.toggleSectorStatus = async (idx) => {
    if (!state.isAdmin) return;

    // 1. Îç∞Ïù¥ÌÑ∞ ÏÉÅÌÉú Î∞òÏ†Ñ (true -> false / false -> true)
    state.investigation.sectors[idx].isAvailable = !state.investigation.sectors[idx].isAvailable;

    // 2. ÏÑúÎ≤Ñ DBÏóê Î≥ÄÍ≤ΩÎêú ÏÉÅÌÉú Ï†ÄÏû•
    if (window.handleSystemUpdate) {
        await window.handleSystemUpdate();
    }

    // 3. UI Í∞±Ïã†: ÏÑπÌÑ∞ ÏÑ†ÌÉù ÌôîÎ©¥(ÏûêÎ¨ºÏá† Î≤ÑÌäºÏù¥ ÏûàÎäî Í≥≥)ÏùÑ Îã§Ïãú Í∑∏Î¶ΩÎãàÎã§.
    renderSectorSelection();
    
    const statusMsg = state.investigation.sectors[idx].isAvailable ? 'Ìï¥Í∏à' : 'Ïû†Í∏à';
    showToast(`Íµ¨Ïó≠Ïù¥ ${statusMsg}ÎêòÏóàÏäµÎãàÎã§.`);
};
window.updateInvestigationSideList = () => {
    const sideList = document.getElementById('investigation-side-list');
    if (!sideList) return;

    const logs = state.investigation.logs || [];

    if (logs.length === 0) {
        sideList.innerHTML = '<p class="text-[10px] text-neutral-700 italic text-center py-10">NO LOGS FOUND.</p>';
        return;
    }

    // ÏµúÏã† Î°úÍ∑∏Í∞Ä ÏïÑÎûòÎ°ú Í∞ÄÍ≤å ÌïòÎ†§Î©¥ reverse()Î•º ÎπºÍ≥†, ÏúÑÎ°ú Í∞ÄÍ≤å ÌïòÎ†§Î©¥ ÎÑ£ÏúºÏÑ∏Ïöî.
    // ÎπÑÏ£ºÏñº ÎÖ∏Î≤® ÎäêÎÇåÏùÄ ÏµúÏã† Î°úÍ∑∏Í∞Ä ÏïÑÎûòÏóê ÏåìÏù¥Îäî Í≤ÉÏù¥ ÏùºÎ∞òÏ†ÅÏûÖÎãàÎã§.
    sideList.innerHTML = logs.map(log => `
        <div class="p-4 bg-white/5 border-l-2 border-amber-600/30 mb-2 animate-fade-in">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[9px] text-amber-500 font-black uppercase tracking-widest">${log.title}</span>
                <span class="text-[8px] text-neutral-600">${log.time}</span>
            </div>
            <p class="text-xs text-neutral-300 leading-relaxed whitespace-pre-wrap">${log.text}</p>
        </div>
    `).join('');

    // Î°úÍ∑∏Í∞Ä Ï∂îÍ∞ÄÎê† Îïå ÏûêÎèôÏúºÎ°ú Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú ÎÇ¥Î¶º
    sideList.scrollTop = sideList.scrollHeight;
};

window.openOperationEditor = (idx) => {
    const ops = state.world.operations;
    const op = ops[idx];
    
    document.getElementById('op-edit-title').value = op.title;
    document.getElementById('op-edit-desc').value = op.desc;
    document.getElementById('op-edit-img').value = op.img;
    document.getElementById('op-edit-icon').value = op.icon;
    document.getElementById('op-edit-action').value = op.action;
    
    const saveBtn = document.getElementById('op-save-btn');
    saveBtn.onclick = () => saveOperation(idx);
    
    document.getElementById('op-editor-modal').classList.remove('hidden');
};

window.saveOperation = async (idx) => {
    const ops = state.world.operations;
    
    // Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
    ops[idx].title = document.getElementById('op-edit-title').value;
    ops[idx].desc = document.getElementById('op-edit-desc').value;
    ops[idx].img = document.getElementById('op-edit-img').value;
    ops[idx].icon = document.getElementById('op-edit-icon').value;
    ops[idx].action = document.getElementById('op-edit-action').value;
    
    // ÏÑúÎ≤Ñ Ï†ÄÏû• (state.world Ï†ÑÏ≤¥Î•º Ï†ÄÏû•ÌïòÎäî handleSystemUpdate ÌôúÏö©)
    // Ï£ºÏùò: handleSystemUpdate Ìï®ÏàòÍ∞Ä world Í∞ùÏ≤¥ ÏïàÏùò operationsÎ•º Ìè¨Ìï®Ìï¥ÏÑú Ï†ÄÏû•ÌïòÎèÑÎ°ù
    // handleSystemUpdate Ìï®Ïàò ÎÇ¥Î∂ÄÏóê 'operations: state.world.operations'Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÍ±∞ÎÇò,
    // state.world Ï†ÑÏ≤¥Î•º merge ÌïòÎäî Î∞©ÏãùÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§. 
    // Í∏∞Ï°¥ handleSystemUpdateÍ∞Ä Í∞úÎ≥Ñ ÌïÑÎìúÎßå ÏßÄÏ†ïÌïòÍ≥† ÏûàÎã§Î©¥ ÏïÑÎûòÏôÄ Í∞ôÏù¥ ÏßÅÏ†ë DB ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏàòÌñâÌï©ÎãàÎã§.
    
    try {
        // Î°úÏª¨ Í∞±Ïã†
        state.world.operations = ops;
        
        // DB Í∞±Ïã† (Í∏∞Ï°¥ world Îç∞Ïù¥ÌÑ∞Ïóê operations ÌïÑÎìú Ï∂îÍ∞Ä/Í∞±Ïã†)
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await setDoc(worldRef, { operations: ops }, { merge: true });
        
        document.getElementById('op-editor-modal').classList.add('hidden');
        renderOperation(); // ÌôîÎ©¥ Îã§Ïãú Í∑∏Î¶¨Í∏∞
        showToast("Operation card updated.");
    } catch(e) {
        console.error(e);
        showToast("Failed to save.");
    }
};
window.renderMembers = (filterCode = 'ALL') => {
    // 1. Îç∞Ïù¥ÌÑ∞ ÏïàÏ†ÑÏû•Ïπò: Í≥ÑÏ†ï Î™©Î°ùÏù¥ ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥Î°ú Ï≤òÎ¶¨
    const accounts = state.accounts || [];
    const members = accounts.filter(a => a.status === 'approved');

    // 2. [ÌïµÏã¨] ÏßÅÏóÖÍµ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í∞ïÏ†úÎ°ú Í∏∞Î≥∏Í∞í ÏÉùÏÑ± (Ïù¥Í≤å ÏóÜÏñ¥ÏÑú Ïïà Ïó¥Î†∏ÏùÑ Í≤ÅÎãàÎã§!)
    if (!state.world.classes || state.world.classes.length === 0) {
        state.world.classes = [
            { code: 'VANGUARD', name: 'VANGUARD', color: '#dc2626' },
            { code: 'SNIPER', name: 'SNIPER', color: '#ea580c' },
            { code: 'CASTER', name: 'CASTER', color: '#7c3aed' },
            { code: 'MEDIC', name: 'MEDIC', color: '#16a34a' },
            { code: 'GUARD', name: 'GUARD', color: '#2563eb' },
            { code: 'SPECIALIST', name: 'SPECIALIST', color: '#db2777' }
        ];
    }
    const classes = state.world.classes;

    // 3. ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ
    const filtered = filterCode === 'ALL' 
        ? members 
        : members.filter(m => (m.position || 'UNASSIGNED') === filterCode);

    // 4. ÌôîÎ©¥ Í∑∏Î¶¨Í∏∞
    const contentArea = document.getElementById('content-area');
    if (!contentArea) return;

    contentArea.innerHTML = `
        <div class="flex-1 flex flex-col bg-[#0a0a0a] overflow-hidden h-full relative select-none animate-fade-in">
            
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10 pointer-events-none"></div>
            <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-amber-600/10 rounded-full blur-[100px] pointer-events-none"></div>
            
            <div class="z-20 px-8 pt-10 pb-4 bg-gradient-to-b from-[#0a0a0a] to-transparent shrink-0">
                <div class="flex flex-col md:flex-row justify-between items-end border-b border-white/10 pb-6 gap-6">
                    <div>
                        <h2 class="text-5xl font-serif font-black text-white uppercase tracking-tighter italic drop-shadow-lg">
                            Personnel
                        </h2>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                            <p class="text-[10px] text-amber-500 font-bold tracking-[0.3em] uppercase">
                                Active Agents: ${members.length}
                            </p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 justify-end">
                        <button onclick="renderMembers('ALL')" 
                                class="px-4 py-2 rounded-lg text-[9px] font-bold uppercase tracking-widest border transition-all duration-300
                                ${filterCode === 'ALL' ? 'bg-white text-black border-white shadow-lg scale-105' : 'bg-neutral-900 border-white/10 text-neutral-500 hover:text-white'}">
                            ALL
                        </button>
                        
                        ${classes.map(cls => `
                            <button onclick="renderMembers('${cls.code}')" 
                                    class="px-4 py-2 rounded-lg text-[9px] font-bold uppercase tracking-widest border transition-all duration-300"
                                    style="${filterCode === cls.code 
                                        ? `background-color: ${cls.color}; border-color: ${cls.color}; color: white; box-shadow: 0 0 15px ${cls.color}66; transform: scale(1.05);` 
                                        : `background-color: transparent; border-color: rgba(255,255,255,0.1); color: #737373;`}"
                                    onmouseover="this.style.color='${cls.color}'; this.style.borderColor='${cls.color}'"
                                    onmouseout="if('${filterCode}' !== '${cls.code}') { this.style.color='#737373'; this.style.borderColor='rgba(255,255,255,0.1)'; } else { this.style.color='white'; }">
                                ${cls.name}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-8 pt-4">
                ${filtered.length === 0 ? 
                    `<div class="h-64 flex flex-col items-center justify-center opacity-40">
                        <i data-lucide="users" class="w-16 h-16 mb-4 text-neutral-600"></i>
                        <p class="text-xs font-bold text-neutral-500 uppercase tracking-widest">No personnel found.</p>
                     </div>` 
                : 
                    `<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 pb-20">
                        ${filtered.map(m => {
                            const cls = classes.find(c => c.code === m.position) || { name: 'UNASSIGNED', color: '#737373' };
                            
                            return `
                            <div onclick="visitProfile('${m.loginId}')" 
                                 class="group relative aspect-[3/4.2] bg-neutral-900 rounded-[20px] overflow-hidden cursor-pointer border border-white/5 transition-all duration-300 hover:-translate-y-2 hover:shadow-[0_10px_30px_-5px_rgba(0,0,0,0.8)]"
                                 style="--hover-color: ${cls.color}">
                                
                                <div class="absolute inset-0 bg-neutral-800">
                                    <img src="${m.profile || 'https://via.placeholder.com/400x600?text=NO+IMG'}" class="w-full h-full object-cover object-top opacity-80 group-hover:opacity-100 group-hover:scale-110 transition-all duration-700 ease-in-out">
                                </div>
                                <div class="absolute inset-0 bg-gradient-to-t from-[#050505] via-black/20 to-transparent opacity-90 transition-opacity group-hover:opacity-80"></div>

                                <div class="absolute top-3 right-3 z-10">
                                    <span class="px-2 py-1 bg-black/60 backdrop-blur-md border border-white/10 rounded text-[8px] font-black uppercase tracking-wider shadow-lg"
                                          style="color: ${cls.color}; border-color: ${cls.color}44;">
                                        ${cls.name}
                                    </span>
                                </div>
                                
                                <div class="absolute bottom-0 left-0 w-full p-5 z-10">
                                    <div class="w-6 h-[3px] mb-2 group-hover:w-full transition-all duration-500 ease-out shadow-[0_0_10px_currentColor]"
                                         style="background-color: ${cls.color}; color: ${cls.color}"></div>
                                    
                                    <h3 class="text-xl md:text-2xl font-black text-white uppercase italic leading-none tracking-tighter truncate drop-shadow-md group-hover:text-white transition-colors">
                                        ${m.ocName}
                                    </h3>
                                    
                                    <div class="flex justify-between items-end mt-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                        <div class="flex flex-col flex-1">
                                            <p class="text-[8px] text-neutral-400 font-bold uppercase tracking-widest">Code Name</p>
                                            <p class="text-[9px] font-mono text-neutral-300 truncate tracking-tight">ID: ${m.loginId}</p>
                                            
                                            <!-- HP/MP Î∞î Ï∂îÍ∞Ä -->
                                            <div class="mt-2 space-y-1">
                                                <div class="flex items-center gap-1">
                                                    <span class="text-red-500 text-[8px]">‚ù§</span>
                                                    <div class="flex-1 h-1 bg-neutral-800 rounded-full overflow-hidden">
                                                        <div class="h-full bg-red-500" style="width: ${((m.currentHP || m.stat_hp || 100) / (m.stat_hp || 100)) * 100}%"></div>
                                                    </div>
                                                    <span class="text-[8px] text-neutral-500 font-mono">${m.currentHP || m.stat_hp || 100}/${m.stat_hp || 100}</span>
                                                </div>
                                                <div class="flex items-center gap-1">
                                                    <span class="text-blue-500 text-[8px]">üíß</span>
                                                    <div class="flex-1 h-1 bg-neutral-800 rounded-full overflow-hidden">
                                                        <div class="h-full bg-blue-500" style="width: ${((m.currentMP || m.stat_mp || 100) / (m.stat_mp || 100)) * 100}%"></div>
                                                    </div>
                                                    <span class="text-[8px] text-neutral-500 font-mono">${m.currentMP || m.stat_mp || 100}/${m.stat_mp || 100}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="absolute inset-0 border-2 border-transparent group-hover:border-[color:var(--hover-color)] opacity-30 rounded-[20px] pointer-events-none transition-all duration-300"></div>
                            </div>
                        `}).join('')}
                    </div>`
                }
            </div>
        </div>
    `;
    if (typeof lucide !== 'undefined') lucide.createIcons();
};
window.saveClassSettings = async () => {
    const currentClasses = state.world.classes || [];
    
    // ÏûÖÎ†•Îêú Í∞íÎì§Î°ú ÏóÖÎç∞Ïù¥Ìä∏
    const updatedClasses = currentClasses.map((cls, idx) => {
        return {
            code: cls.code, // ÏΩîÎìúÎäî Ïú†ÏßÄ
            name: document.getElementById(`cls-name-${idx}`).value.toUpperCase(), // Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
            color: document.getElementById(`cls-color-${idx}`).value // ÏÉâÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏
        };
    });

    try {
        // ÏÑúÎ≤Ñ Ï†ÄÏû•
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await setDoc(worldRef, { classes: updatedClasses }, { merge: true });
        
        // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        state.world.classes = updatedClasses;
        
        showToast("Class settings saved.");
        renderAdmin(); // ÌôîÎ©¥ Í∞±Ïã†
    } catch(e) {
        console.error(e);
        showToast("Failed to save settings.");
    }
};
window.syncClassInputs = () => {
    if (!state.world.classes) return;
    state.world.classes = state.world.classes.map((cls, idx) => {
        const nameInput = document.getElementById(`cls-name-${idx}`);
        const codeInput = document.getElementById(`cls-code-${idx}`);
        const colorInput = document.getElementById(`cls-color-${idx}`);
        return {
            name: nameInput ? nameInput.value.toUpperCase() : cls.name,
            code: codeInput ? codeInput.value.toUpperCase() : cls.code,
            color: colorInput ? colorInput.value : cls.color
        };
    });
};

// 2. ÏÉà ÏßÅÏóÖÍµ∞ Ï∂îÍ∞Ä
window.addNewClass = () => {
    syncClassInputs(); // ÌòÑÏû¨ ÏûÖÎ†•Í∞í Ï†ÄÏû•
    state.world.classes.push({ 
        code: 'NEW', 
        name: 'NEW POSITION', 
        color: '#888888' 
    });
    renderAdmin(); // ÌôîÎ©¥ Îã§Ïãú Í∑∏Î¶¨Í∏∞
};

// 3. ÏßÅÏóÖÍµ∞ ÏÇ≠Ï†ú
window.deleteClass = (idx) => {
    if (!confirm("Ï†ïÎßê Ïù¥ Ìè¨ÏßÄÏÖòÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Ìï¥Îãπ Ìè¨ÏßÄÏÖòÏùÑ Í∞ÄÏßÑ Î©§Î≤ÑÎì§ÏùÄ 'UNASSIGNED'Í∞Ä Îê©ÎãàÎã§.)")) return;
    syncClassInputs(); // ÌòÑÏû¨ ÏûÖÎ†•Í∞í Ï†ÄÏû•
    state.world.classes.splice(idx, 1);
    renderAdmin(); // ÌôîÎ©¥ Îã§Ïãú Í∑∏Î¶¨Í∏∞
};

// 4. ÏµúÏ¢Ö Ï†ÄÏû• (ÏÑúÎ≤Ñ Ï†ÑÏÜ°)
window.saveClassSettings = async () => {
    syncClassInputs(); // ÌòÑÏû¨ ÏûÖÎ†•Í∞í ÌôïÏ†ï
    
    try {
        const worldRef = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'world');
        await setDoc(worldRef, { classes: state.world.classes }, { merge: true });
        
        showToast("Class configurations saved.");
        renderAdmin(); // UI Í∞±Ïã†
    } catch(e) {
        console.error(e);
        showToast("Save failed.");
    }
};
window.openRaidBoard = function() {
    const modal = document.getElementById('raid-board-modal');
    const iframe = document.getElementById('raid-board-iframe');
    
    // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†Ä Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    const currentUser = state.user;
    const userId = currentUser ? currentUser.uid : 'anonymous';
    const userAccount = state.userAccount || {};
    const loginId = userAccount.loginId || userId; // loginId Ï∂îÍ∞Ä
    
    // Í∏∞Î≥∏ Ï†ïÎ≥¥ (Ïù¥Î¶Ñ, Ïù¥ÎØ∏ÏßÄ)
    const ocName = encodeURIComponent(userAccount.ocName || 'Unknown');
    const ocImage = encodeURIComponent(userAccount.profile || 'https://cdn.pixabay.com/photo/2012/04/18/18/16/man-37470_1280.png');
    
    // Combat Stats Í∞ÄÏ†∏Ïò§Í∏∞
    const statHp = userAccount.stat_hp || '100';
    const statMp = userAccount.stat_mp || '50';
    const statAtk = userAccount.stat_atk || '5-10';
    const statDef = userAccount.stat_def || '2-5';
    const statMove = userAccount.stat_move || '3';
    const mySkills = userAccount.combatSkills || ['move', 'slash']; // ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í
    const skillParam = encodeURIComponent(mySkills.join(','));
    let rawSkills = ['move', 'slash', 'heal']; // Í∏∞Î≥∏Í∞í
    
    // userAccountÍ∞Ä Ï°¥Ïû¨ÌïòÍ≥† combatSkillsÍ∞Ä Î∞∞Ïó¥Ïù¥Î©¥ ÏÇ¨Ïö©
    if (userAccount && Array.isArray(userAccount.combatSkills) && userAccount.combatSkills.length > 0) {
        rawSkills = userAccount.combatSkills;
    }
    
    
    // Ïñ¥ÎìúÎØº Í∂åÌïú ÌôïÏù∏
    const isAdmin = state.isAdmin || false;
    
    console.log("üéÆ Î†àÏù¥Îìú Î≥¥Îìú Ïó¥Í∏∞:", {
        userId,
        loginId,
        ocName: decodeURIComponent(ocName),
        skills: rawSkills,
        isAdmin: isAdmin
    });
    
    // game_board.htmlÏóê Ïú†Ï†Ä Ï†ïÎ≥¥ Ï†ÑÎã¨ (loginId Ï∂îÍ∞Ä)
    iframe.src = `game_board.html?userId=${userId}&loginId=${loginId}&fromHomepage=true&userName=${ocName}&userImage=${ocImage}&statHp=${statHp}&statMp=${statMp}&statAtk=${encodeURIComponent(statAtk)}&statDef=${encodeURIComponent(statDef)}&statMove=${statMove}&skills=${skillParam}&isAdmin=${isAdmin}`;
    
    modal.classList.remove('hidden');
}
// Î†àÏù¥Îìú Î≥¥Îìú Îã´Í∏∞ Ìï®Ïàò
window.closeRaidBoard = function() {
    const modal = document.getElementById('raid-board-modal');
    const iframe = document.getElementById('raid-board-iframe');
    
    modal.classList.add('hidden');
    iframe.src = ''; // Î¶¨ÏÜåÏä§ Ìï¥Ï†ú
}
let myEquippedSkills = []; // ÌòÑÏû¨ Ïû•Ï∞© Ï§ëÏù∏ Ïä§ÌÇ¨ ID Î™©Î°ù

window.openSkillEditor = async function() {
    const user = (window.state && window.state.user) || auth.currentUser;
    if (!user) { alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."); return; }
    
    document.getElementById('skill-edit-modal').classList.remove('hidden');
    await loadSkillData();
}

// 2. Ïä§ÌÇ¨ Ìé∏ÏßëÍ∏∞ Îã´Í∏∞
window.closeSkillEditor = function() {
    document.getElementById('skill-edit-modal').classList.add('hidden');
}

// 3. Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è Î†åÎçîÎßÅ (Í¥ÄÎ¶¨Ïûê UI Ìè¨Ìï®)
async function loadSkillData() {
    const libraryList = document.getElementById('skill-library-list');
    const equippedList = document.getElementById('equipped-skill-list');
    const user = (window.state && window.state.user) || auth.currentUser;

    libraryList.innerHTML = '<div class="text-gray-500 text-center text-xs py-4">Loading...</div>';
    equippedList.innerHTML = '';
    
    try {
        // A. Í¥ÄÎ¶¨Ïûê Ïó¨Î∂Ä ÌôïÏù∏ (state.userAccount ÌôúÏö©)
        // (Ï£ºÏùò: Ïã§Ï†ú Ïö¥ÏòÅ ÏãúÏóî DBÏùò role ÌïÑÎìúÎ•º Ï≤¥ÌÅ¨ÌïòÎäî Í≤ÉÏù¥ Îçî ÏïàÏ†ÑÌï®)
        const isAdmin = window.state?.userAccount?.role === 'admin' || window.state?.userAccount?.isAdmin === true; 

        // B. Í¥ÄÎ¶¨ÏûêÎùºÎ©¥ 'Ïä§ÌÇ¨ Ï∂îÍ∞Ä Ìèº'ÏùÑ ÏÉÅÎã®Ïóê ÌëúÏãú
        let adminHtml = '';
        if (isAdmin) {
            adminHtml = `
                <div class="mb-4 p-3 bg-white/5 border border-amber-500/30 rounded">
                    <p class="text-[10px] text-amber-500 font-bold mb-2 uppercase">Admin: Add New Skill</p>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input id="new-skill-name" placeholder="Ïä§ÌÇ¨ Ïù¥Î¶Ñ (Ïòà: ÌôîÏóºÍµ¨)" class="bg-black text-white text-xs p-2 border border-white/10 rounded">
                        <input id="new-skill-id" placeholder="ID (ÏòÅÎ¨∏, Ïòà: fireball)" class="bg-black text-white text-xs p-2 border border-white/10 rounded">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input id="new-skill-icon" placeholder="ÏïÑÏù¥ÏΩò (Ïòà: üî•)" class="bg-black text-white text-xs p-2 border border-white/10 rounded">
                        <select id="new-skill-type" class="bg-black text-white text-xs p-2 border border-white/10 rounded">
                            <option value="Attack">Attack</option>
                            <option value="Heal">Heal</option>
                            <option value="Utility">Utility</option>
                            <option value="Support">Support</option>
                        </select>
                    </div>
                    <button onclick="addNewSkillToLibrary()" class="w-full bg-amber-600 hover:bg-amber-500 text-white text-xs font-bold py-1 rounded transition">
                        + ADD TO LIBRARY
                    </button>
                </div>
                <div class="border-b border-white/10 mb-2"></div>
            `;
        }

        // C. DBÏóêÏÑú Ïä§ÌÇ¨ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
        const libSnapshot = await getDocs(collection(db, 'skillLibrary'));
        const allSkills = {};
        libSnapshot.forEach(doc => allSkills[doc.id] = doc.data());

        // D. ÎÇ¥ Ïû•Ï∞© Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const userDocRef = doc(db, 'users', user.uid);
        const userDocSnap = await getDoc(userDocRef);
        const userData = userDocSnap.data() || {};
        const myEquippedSkills = userData.combatSkills || []; 

        // E. ÌôîÎ©¥ Í∑∏Î¶¨Í∏∞
        // 1) ÎùºÏù¥Î∏åÎü¨Î¶¨ (ÏôºÏ™Ω)
        libraryList.innerHTML = adminHtml; // Í¥ÄÎ¶¨Ïûê Ìèº Î®ºÏ†Ä ÎÑ£Í≥†

        const sortedSkillIds = Object.keys(allSkills).sort(); // Í∞ÄÎÇòÎã§Ïàú Ï†ïÎ†¨
        
        if (sortedSkillIds.length === 0 && !isAdmin) {
             libraryList.innerHTML += '<div class="text-gray-600 text-center text-xs py-4">Îì±Î°ùÎêú Ïä§ÌÇ¨Ïù¥ ÏóÜÏäµÎãàÎã§.<br>Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.</div>';
        }

        sortedSkillIds.forEach(skillId => {
            // ÎÇ¥Í∞Ä Ïû•Ï∞©ÌïòÏßÄ ÏïäÏùÄ Í≤ÉÎßå ÏôºÏ™ΩÏóê ÌëúÏãú
            if (!myEquippedSkills.includes(skillId)) {
                createSkillElement(allSkills[skillId], libraryList);
            }
        });

        // 2) Ïû•Ï∞© Î™©Î°ù (Ïò§Î•∏Ï™Ω)
        myEquippedSkills.forEach(skillId => {
            const skill = allSkills[skillId];
            if(skill) {
                createSkillElement(skill, equippedList);
            } else {
                // DBÏóêÎäî ÏóÜÎäîÎç∞ ÎÇ¥ Î™©Î°ùÏóî ÏûàÎäî Í≤ΩÏö∞ (ÏÇ≠Ï†úÎêú Ïä§ÌÇ¨ Îì±) - ÌÖçÏä§Ìä∏Î°úÎùºÎèÑ ÌëúÏãú
                createSkillElement({ id: skillId, name: skillId, icon: '‚ùì', type: 'Unknown' }, equippedList);
            }
        });
        
        updateSkillCount();

    } catch (error) {
        console.error("Ïä§ÌÇ¨ Î°úÎìú Ïò§Î•ò:", error);
        libraryList.innerHTML = `<div class="text-red-500 text-center text-xs">Error: ${error.message}</div>`;
    }
}

// 4. [Í¥ÄÎ¶¨ÏûêÏö©] ÏÉà Ïä§ÌÇ¨ DBÏóê Îì±Î°ùÌïòÍ∏∞
window.addNewSkillToLibrary = async function() {
    const name = document.getElementById('new-skill-name').value.trim();
    const id = document.getElementById('new-skill-id').value.trim();
    const icon = document.getElementById('new-skill-icon').value.trim();
    const type = document.getElementById('new-skill-type').value;

    if (!name || !id || !icon) {
        alert("Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
        return;
    }

    try {
        await setDoc(doc(db, 'skillLibrary', id), {
            id: id,
            name: name,
            icon: icon,
            type: type,
            desc: name // ÏÑ§Î™ÖÏùÄ ÏùºÎã® Ïù¥Î¶ÑÍ≥º ÎèôÏùºÌïòÍ≤å
        });
        
        alert(`Ïä§ÌÇ¨ [${name}] Îì±Î°ù ÏôÑÎ£å!`);
        await loadSkillData(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
    } catch (e) {
        console.error(e);
        alert("Îì±Î°ù Ïã§Ìå®: " + e.message);
    }
}

// 5. Ïä§ÌÇ¨ ÏóòÎ¶¨Î®ºÌä∏ ÏÉùÏÑ± UI
function createSkillElement(skill, container) {
    const div = document.createElement('div');
    div.className = 'skill-item group';
    div.draggable = true;
    div.id = `skill-${skill.id}`;
    div.dataset.skillId = skill.id;
    
    // ÏÇ≠Ï†ú Î≤ÑÌäº (Í¥ÄÎ¶¨ÏûêÏùº Í≤ΩÏö∞ ÎùºÏù¥Î∏åÎü¨Î¶¨ Î™©Î°ùÏóêÏÑúÎßå Î≥¥ÏûÑ)
    const isAdmin = window.state?.userAccount?.role === 'admin';
    const isLibrary = container.id === 'skill-library-list';
    let deleteBtn = '';
    
    if (isAdmin && isLibrary) {
        deleteBtn = `<button onclick="deleteSkillFromLibrary('${skill.id}', event)" class="text-gray-600 hover:text-red-500 ml-2 p-1" title="Ïä§ÌÇ¨ ÏÇ≠Ï†ú">‚úï</button>`;
    }

    div.innerHTML = `
        <span class="skill-icon text-base">${skill.icon}</span>
        <div class="skill-info flex flex-col min-w-0">
            <div class="skill-name text-xs font-bold text-gray-200 truncate">${skill.name}</div>
            <div class="skill-type text-[9px] text-gray-500 uppercase tracking-wider">${skill.type}</div>
        </div>
        ${deleteBtn}
        <div class="text-gray-600 text-xs cursor-move ml-auto">‚â°</div>
    `;
    
    div.addEventListener('dragstart', window.drag);
    div.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON') return; // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú Ïù¥Îèô Î∞©ÏßÄ
        toggleSkillLocation(div)
    });

    container.appendChild(div);
}

// 6. [Í¥ÄÎ¶¨ÏûêÏö©] Ïä§ÌÇ¨ ÏÇ≠Ï†ú
window.deleteSkillFromLibrary = async function(skillId, event) {
    event.stopPropagation(); // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ
    if(!confirm(`Ï†ïÎßê [${skillId}] Ïä§ÌÇ¨ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

    try {
        await deleteDoc(doc(db, 'skillLibrary', skillId));
        await loadSkillData(); // ÏÉàÎ°úÍ≥†Ïπ®
    } catch(e) {
        alert("ÏÇ≠Ï†ú Ïã§Ìå®: " + e.message);
    }
}

// 7. ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ ÌïÑÏàò Ìï®ÏàòÎì§ (window Ïó∞Í≤∞)
window.allowDrop = function(ev) { ev.preventDefault(); }
window.drag = function(ev) { ev.dataTransfer.setData("text", ev.target.id); }
window.drop = function(ev) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    const draggedEl = document.getElementById(data);
    if(!draggedEl) return;

    const targetZone = ev.target.closest('#equipped-skill-list') ? 'equipped' : 
                       ev.target.closest('#skill-library-list') ? 'library' : null;

    if (targetZone === 'equipped') moveSkillToEquipped(draggedEl);
    else if (targetZone === 'library') moveSkillToLibrary(draggedEl);
}

// ÎÇ¥Î∂Ä Ïù¥Îèô Î°úÏßÅ
function moveSkillToEquipped(el) {
    const equippedList = document.getElementById('equipped-skill-list');
    const currentCount = equippedList.querySelectorAll('.skill-item').length;
    if(currentCount >= 5) {
        alert("ÏµúÎåÄ 5Í∞úÍπåÏßÄÎßå Ïû•Ï∞©Ìï† Ïàò ÏûàÏäµÎãàÎã§.");
        return;
    }
    equippedList.appendChild(el);
    updateSkillCount();
}

function moveSkillToLibrary(el) {
    // ÎùºÏù¥Î∏åÎü¨Î¶¨Î°ú ÎèåÏïÑÍ∞à ÎïåÎäî 'Í¥ÄÎ¶¨Ïûê Ï∂îÍ∞Ä Ìèº' Îã§ÏùåÏúºÎ°ú ÎÑ£Í∏∞ ÏúÑÌï¥ appendChild ÏÇ¨Ïö©
    document.getElementById('skill-library-list').appendChild(el);
    updateSkillCount();
}

function toggleSkillLocation(el) {
    const parentId = el.parentElement.id;
    if (parentId === 'skill-library-list') moveSkillToEquipped(el);
    else moveSkillToLibrary(el);
}

function updateSkillCount() {
    const equippedList = document.getElementById('equipped-skill-list');
    const count = equippedList.querySelectorAll('.skill-item').length;
    const badge = document.getElementById('skill-count-badge');
    if(badge) {
        badge.textContent = `${count} / 5`;
        badge.style.color = count === 5 ? '#ef4444' : '#6b7280';
    }
    const placeholder = equippedList.querySelector('p');
    if(placeholder) placeholder.style.display = count > 0 ? 'none' : 'block';
}

window.saveMySkills = async function() {
    // 1. ÌòÑÏû¨ ÎÇ¥ Í≥ÑÏ†ï Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏïàÏ†ÑÌïòÍ≤å state ÏÇ¨Ïö©)
    const myAccount = window.state?.userAccount;
    
    if (!myAccount || !myAccount.loginId) {
        alert("Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
        return;
    }

    // 2. Ïû•Ï∞©Îêú Ïä§ÌÇ¨ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
    const equippedList = document.getElementById('equipped-skill-list');
    const skillItems = equippedList.querySelectorAll('.skill-item');
    const newSkills = Array.from(skillItems).map(el => el.dataset.skillId);
    
    try {
        // ‚ñº‚ñº‚ñº [ÌïµÏã¨] Ï†ÄÏû• Í≤ΩÎ°úÎ•º ÌôàÌéòÏù¥ÏßÄÍ∞Ä ÏùΩÎäî Í≥≥(artifacts)ÏúºÎ°ú Î≥ÄÍ≤Ω ‚ñº‚ñº‚ñº
        const loginId = myAccount.loginId;
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', loginId);
        
        // 3. DBÏóê Ï†ÄÏû• (merge: trueÎ°ú Í∏∞Ï°¥ Ï†ïÎ≥¥ Ïú†ÏßÄ)
        await setDoc(userRef, {
            combatSkills: newSkills,
            updatedAt: new Date()
        }, { merge: true });
        
        // 4. ÌôîÎ©¥ Ï¶âÏãú Í∞±Ïã† (ÏÉàÎ°úÍ≥†Ïπ® ÏóÜÏù¥ Î∞òÏòÅ)
        // Î°úÏª¨ state ÏóÖÎç∞Ïù¥Ìä∏
        if(window.state && window.state.userAccount) {
            window.state.userAccount.combatSkills = newSkills;
        }
        // ÌîÑÎ°úÌïÑ ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        if (typeof window.renderProfileSkills === 'function') {
            window.renderProfileSkills(newSkills);
        }

        window.closeSkillEditor();
        alert("Ïä§ÌÇ¨ ÏÑ§Ï†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!");
        
    } catch (e) {
        console.error(e);
        alert("Ï†ÄÏû• Ïã§Ìå®: " + e.message);
    }
}
    </script>
    <div id="raid-board-modal" class="fixed inset-0 bg-black/95 z-[9999] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
    
    <div class="relative w-[98vw] h-[98vh] lg:w-[95vw] lg:h-[95vh] bg-[#0a0a0a] border border-[#D4B783]/40 shadow-[0_0_60px_rgba(212,183,131,0.15)] flex flex-col overflow-hidden">
        
        <div class="h-12 border-b border-[#D4B783]/20 bg-gradient-to-r from-[#1a1a1a] to-[#0a0a0a] flex items-center justify-between px-6 select-none flex-shrink-0">
            
            <div class="flex items-center gap-3">
                <div class="w-1 h-4 bg-[#D4B783] shadow-[0_0_8px_#D4B783]"></div>
                <span class="text-[#D4B783] font-serif tracking-[0.2em] text-xs lg:text-sm font-bold opacity-90">
                    TACTICAL INTERFACE
                </span>
            </div>

            <button onclick="closeRaidBoard()" class="group flex items-center gap-2 text-[#666] hover:text-[#D4B783] transition-colors duration-300 focus:outline-none">
                <span class="font-serif text-[10px] tracking-widest uppercase group-hover:tracking-[0.15em] transition-all duration-300">
                    TERMINATE
                </span>
                <div class="relative w-6 h-6 flex items-center justify-center border border-transparent group-hover:border-[#D4B783]/30 transition-all">
                    <svg class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
            </button>
        </div>

        <div class="flex-1 relative bg-black w-full h-full">
            <iframe 
                id="raid-board-iframe" 
                src="" 
                class="absolute inset-0 w-full h-full border-0"
                allow="clipboard-write"
            ></iframe>
            
            <div class="absolute bottom-0 right-0 w-3 h-3 border-b border-r border-[#D4B783]/50 pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 w-3 h-3 border-b border-l border-[#D4B783]/50 pointer-events-none"></div>
        </div>
    </div>
</div>
<div id="skill-edit-modal" class="fixed inset-0 bg-black/90 z-[10000] hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-[#0a0a0a] border border-[#D4B783]/50 w-[800px] h-[600px] flex flex-col shadow-[0_0_50px_rgba(212,183,131,0.2)]">
        
        <div class="flex justify-between items-center p-4 border-b border-[#D4B783]/30 bg-white/5">
            <h2 class="text-[#D4B783] font-serif text-xl tracking-widest">ARCANE MAPPING</h2>
            <button onclick="closeSkillEditor()" class="text-gray-400 hover:text-white">‚úï</button>
        </div>

        <div class="flex-1 flex overflow-hidden">
            <div class="w-1/2 p-4 border-r border-[#D4B783]/30 flex flex-col bg-[#111]">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-gray-400 text-xs tracking-widest uppercase">Available Arcanum</h3>
                    <button id="admin-add-skill-btn" onclick="openAdminSkillAdd()" 
                            class="hidden px-3 py-1 bg-[#D4B783]/20 hover:bg-[#D4B783]/40 text-[#D4B783] text-[10px] rounded border border-[#D4B783]/30 transition-colors">
                        + ADD SKILL
                    </button>
                </div>
                <div id="skill-library-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar" ondrop="drop(event)" ondragover="allowDrop(event)">
                    </div>
            </div>

            <div class="w-1/2 p-4 flex flex-col bg-[#0a0a0a]">
                <div class="flex justify-between mb-3">
                    <h3 class="text-[#D4B783] text-xs tracking-widest uppercase">Equipped Slots</h3>
                    <span id="skill-count-badge" class="text-xs text-gray-500">0 / 5</span>
                </div>
                
                <div id="equipped-skill-list" class="flex-1 border border-dashed border-[#D4B783]/30 rounded p-2 space-y-2 overflow-y-auto" 
                     ondrop="drop(event)" ondragover="allowDrop(event)">
                    <p class="text-gray-600 text-xs text-center mt-10 pointer-events-none">Drag skills here</p>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-[#D4B783]/30 flex justify-end gap-3 bg-black">
            <button onclick="closeSkillEditor()" class="px-6 py-2 text-gray-400 hover:text-white text-sm">CANCEL</button>
            <button onclick="saveMySkills()" class="px-6 py-2 bg-[#D4B783] text-black font-bold text-sm hover:bg-[#c1a26c]">CONFIRM SETUP</button>
        </div>
    </div>
</div>

<style>
    /* ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïä§ÌÉÄÏùº */
    .skill-item {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 10px;
        cursor: grab;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s;
    }
    .skill-item:hover {
        background: rgba(212, 183, 131, 0.1);
        border-color: #D4B783;
    }
    .skill-item:active { cursor: grabbing; }
    .skill-icon { font-size: 1.2rem; }
    .skill-info { flex: 1; }
    .skill-name { color: #e5e5e5; font-size: 0.9rem; font-weight: bold; }
    .skill-type { font-size: 0.7rem; color: #888; }
</style>

<!-- Í¥ÄÎ¶¨Ïûê Ïä§ÌÇ¨ Ï∂îÍ∞Ä Î™®Îã¨ -->
<div id="admin-skill-add-modal" class="fixed inset-0 bg-black/90 z-[10001] hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-[#0a0a0a] border border-[#D4B783]/50 w-[500px] flex flex-col shadow-[0_0_50px_rgba(212,183,131,0.2)]">
        
        <div class="flex justify-between items-center p-4 border-b border-[#D4B783]/30 bg-white/5">
            <h2 class="text-[#D4B783] font-serif text-xl tracking-widest">ADD NEW SKILL</h2>
            <button onclick="closeAdminSkillAdd()" class="text-gray-400 hover:text-white">‚úï</button>
        </div>

        <div class="p-6 space-y-4">
            <div>
                <label class="text-gray-400 text-xs block mb-2">Skill ID (English only, e.g., thunder_strike)</label>
                <input id="admin-skill-id" type="text" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm" placeholder="thunder_strike">
            </div>
            
            <div>
                <label class="text-gray-400 text-xs block mb-2">Skill Name (Display)</label>
                <input id="admin-skill-name" type="text" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm" placeholder="Ï≤úÎë• Í∞ïÌÉÄ">
            </div>
            
            <div>
                <label class="text-gray-400 text-xs block mb-2">Icon (Emoji)</label>
                <input id="admin-skill-icon" type="text" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm" placeholder="‚ö°" maxlength="2">
            </div>
            
            <div>
                <label class="text-gray-400 text-xs block mb-2">Type</label>
                <select id="admin-skill-type" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm">
                    <option value="Attack">Attack</option>
                    <option value="Support">Support</option>
                    <option value="Heal">Heal</option>
                    <option value="Utility">Utility</option>
                    <option value="Defense">Defense</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div>
                <label class="text-gray-400 text-xs block mb-2">Description</label>
                <textarea id="admin-skill-desc" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-white text-sm" rows="2" placeholder="Ïä§ÌÇ¨ ÏÑ§Î™Ö"></textarea>
            </div>
        </div>

        <div class="p-4 border-t border-[#D4B783]/30 flex justify-end gap-3 bg-black">
            <button onclick="closeAdminSkillAdd()" class="px-6 py-2 text-gray-400 hover:text-white text-sm">CANCEL</button>
            <button onclick="saveAdminSkill()" class="px-6 py-2 bg-[#D4B783] text-black font-bold text-sm hover:bg-[#c1a26c]">CREATE SKILL</button>
        </div>
    </div>
</div>

<script>
// Í¥ÄÎ¶¨Ïûê Ïä§ÌÇ¨ Ï∂îÍ∞Ä Î™®Îã¨ Ïó¥Í∏∞/Îã´Í∏∞
window.openAdminSkillAdd = function() {
    document.getElementById('admin-skill-add-modal').classList.remove('hidden');
}

window.closeAdminSkillAdd = function() {
    document.getElementById('admin-skill-add-modal').classList.add('hidden');
    // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
    document.getElementById('admin-skill-id').value = '';
    document.getElementById('admin-skill-name').value = '';
    document.getElementById('admin-skill-icon').value = '';
    document.getElementById('admin-skill-type').value = 'Attack';
    document.getElementById('admin-skill-desc').value = '';
}

// Í¥ÄÎ¶¨Ïûê Ïä§ÌÇ¨ Ï†ÄÏû•
window.saveAdminSkill = async function() {
    const skillId = document.getElementById('admin-skill-id').value.trim();
    const skillName = document.getElementById('admin-skill-name').value.trim();
    const skillIcon = document.getElementById('admin-skill-icon').value.trim();
    const skillType = document.getElementById('admin-skill-type').value;
    const skillDesc = document.getElementById('admin-skill-desc').value.trim();
    
    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    if (!skillId || !skillName || !skillIcon) {
        alert('Ïä§ÌÇ¨ ID, Ïù¥Î¶Ñ, ÏïÑÏù¥ÏΩòÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.');
        return;
    }
    
    // ÏòÅÎ¨∏ ID Í≤ÄÏ¶ù
    if (!/^[a-z_]+$/.test(skillId)) {
        alert('Ïä§ÌÇ¨ IDÎäî ÏòÅÎ¨∏ ÏÜåÎ¨∏ÏûêÏôÄ Ïñ∏ÎçîÏä§ÏΩîÏñ¥(_)Îßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.');
        return;
    }
    
    try {
        // FirestoreÏóê Ïä§ÌÇ¨ Ï∂îÍ∞Ä
        const skillRef = doc(window.db, 'skillLibrary', skillId);
        await setDoc(skillRef, {
            id: skillId,
            name: skillName,
            icon: skillIcon,
            type: skillType,
            desc: skillDesc || 'ÏÑ§Î™Ö ÏóÜÏùå'
        });
        
        console.log('‚úÖ Ïä§ÌÇ¨ Ï∂îÍ∞Ä ÏôÑÎ£å:', skillId);
        alert(`Ïä§ÌÇ¨ "${skillName}"Ïù¥(Í∞Ä) Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);
        
        // Î™®Îã¨ Îã´Í≥† Ïä§ÌÇ¨ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        closeAdminSkillAdd();
        await loadSkillData();
        
    } catch (error) {
        console.error('‚ùå Ïä§ÌÇ¨ Ï∂îÍ∞Ä Ïã§Ìå®:', error);
        alert('Ïä§ÌÇ¨ Ï∂îÍ∞Ä Ïã§Ìå®: ' + error.message);
    }
}
window.renderProfileSkills = function(skills) {
    const container = document.getElementById('profile-equipped-skills');
    
    // Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä ÏóÜÏúºÎ©¥(Î™®Îã¨Ïù¥ Îã´ÌòÄÏûàÍ±∞ÎÇò ÌïòÎ©¥) Ï§ëÎã®
    if (!container) return;

    // Ïä§ÌÇ¨Ïù¥ ÏóÜÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÏùÑ Îïå
    if (!skills || skills.length === 0) {
        container.innerHTML = `
            <div class="col-span-5 text-center py-3 border border-dashed border-white/10 rounded-xl">
                <span class="text-[10px] text-neutral-600">No skills equipped</span>
            </div>`;
        return;
    }

    // Ïä§ÌÇ¨Ïù¥ ÏûàÏúºÎ©¥: ÏúÑÏ™Ω Stats ÏûÖÎ†•Ï∞ΩÍ≥º ÎòëÍ∞ôÏùÄ ÎîîÏûêÏù∏ÏúºÎ°ú ÌëúÏãú
    // (ÌòÑÏû¨Îäî IDÎßå ÌëúÏãúÎêòÏßÄÎßå, Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï†ÄÏû•Îêú Í≤ÉÏûÑÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§)
    container.innerHTML = skills.map(id => `
        <div class="w-full bg-black border border-white/10 rounded-xl px-1 py-3 text-[10px] text-white text-center font-mono truncate cursor-help hover:border-amber-500 transition-colors uppercase" title="${id}">
            ${id}
        </div>
    `).join('');
}
window.importSkillsFromFile = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    
    reader.onload = async (e) => {
        try {
            const jsonContent = e.target.result;
            const importedData = JSON.parse(jsonContent);
            
            // Îç∞Ïù¥ÌÑ∞Í∞Ä Î∞∞Ïó¥Ïù∏ÏßÄ Í∞ùÏ≤¥Ïù∏ÏßÄ ÌôïÏù∏ÌïòÏó¨ Î¶¨Ïä§Ìä∏Î°ú Î≥ÄÌôò
            let skillsToImport = [];
            if (Array.isArray(importedData)) {
                skillsToImport = importedData;
            } else if (typeof importedData === 'object' && importedData !== null) {
                skillsToImport = Object.values(importedData);
            }

            if (skillsToImport.length === 0) {
                alert("ÌååÏùºÏóê Ïú†Ìö®Ìïú Ïä§ÌÇ¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
                return;
            }

            if (!confirm(`${skillsToImport.length}Í∞úÏùò Ïä§ÌÇ¨ÏùÑ ÎèÑÍ∞êÏóê Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Ï§ëÎ≥µÎêú IDÎäî ÎçÆÏñ¥ÏîåÏõåÏßëÎãàÎã§)`)) {
                event.target.value = ''; // Ï∑®ÏÜå Ïãú ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                return;
            }

            let successCount = 0;

            // ÌïòÎÇòÏî© DBÏóê Ï†ÄÏû•
            for (const skill of skillsToImport) {
                // ÌïÑÏàò Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù (IDÏôÄ Ïù¥Î¶ÑÏù¥ ÏóÜÏúºÎ©¥ Í±¥ÎÑàÎúÄ)
                if (!skill.id || !skill.name) continue;

                // Firestore 'skillLibrary' Ïª¨Î†âÏÖòÏóê Ï†ÄÏû•
                await setDoc(doc(db, 'skillLibrary', skill.id), {
                    id: skill.id,
                    name: skill.name,
                    icon: skill.icon || '‚öîÔ∏è',
                    type: skill.type || 'Other',
                    desc: skill.desc || skill.description || 'Í∞ÄÏ†∏Ïò® Ïä§ÌÇ¨ÏûÖÎãàÎã§.'
                }, { merge: true }); // merge: trueÎ°ú Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄÌïòÎ©∞ ÏóÖÎç∞Ïù¥Ìä∏

                successCount++;
            }

            alert(`‚úÖ Ï¥ù ${successCount}Í∞úÏùò Ïä§ÌÇ¨Ïù¥ ÎèÑÍ∞êÏóê Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!`);
            
            // Ïä§ÌÇ¨ Ìé∏ÏßëÏ∞ΩÏù¥ Ïó¥Î†§ÏûàÎã§Î©¥ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
            const editModal = document.getElementById('skill-edit-modal');
            if (editModal && !editModal.classList.contains('hidden')) {
                await loadSkillData();
            }

        } catch (error) {
            console.error("Ïä§ÌÇ¨ Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:", error);
            alert("ÌååÏùºÏùÑ Ï≤òÎ¶¨ÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        } finally {
            // Í∞ôÏùÄ ÌååÏùºÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌï† Ïàò ÏûàÎèÑÎ°ù Ï¥àÍ∏∞Ìôî
            event.target.value = '';
        }
    };
    
    reader.readAsText(file);
};

/* ============================================
   Ï∂îÍ∞Ä Í∏∞Îä•: Í¥ÄÎ¶¨Ïûê Ïù∏Î≤§ÌÜ†Î¶¨ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú
   ============================================ */

let currentManagingUserId = null;

// Í¥ÄÎ¶¨Ïûê Ïù∏Î≤§ÌÜ†Î¶¨ Í¥ÄÎ¶¨ Î™®Îã¨ Ïó¥Í∏∞
window.openAdminInventoryManager = async (loginId) => {
    const user = state.accounts.find(a => a.loginId === loginId);
    if (!user || !user.uid) {
        showToast("User not found!");
        return;
    }
    
    currentManagingUserId = user.uid;
    const modal = document.getElementById('admin-inventory-modal');
    const content = document.getElementById('admin-inventory-content');
    
    modal.classList.remove('hidden');
    content.innerHTML = '<p class="text-neutral-500 text-sm text-center py-10">Loading...</p>';
    
    try {
        // Ïú†Ï†Ä Ïù∏Î≤§ÌÜ†Î¶¨ Î°úÎìú
        const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
        const userSnap = await getDoc(userRef);
        const inventory = userSnap.exists() ? (userSnap.data().inventory || []) : [];
        
        // ÏïÑÏù¥ÌÖú ÎßàÏä§ÌÑ∞ Î™©Î°ù Î°úÎìú (Ïò¨Î∞îÎ•∏ Í≤ΩÎ°ú: 5Í∞ú ÏÑ∏Í∑∏Î®ºÌä∏)
        const itemMasterRef = collection(db, 'artifacts', appId, 'public', 'data', 'item_master');
        const itemMasterSnap = await getDocs(itemMasterRef);
        const itemMasterList = itemMasterSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        content.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-sm font-bold text-green-400">Current Items (${inventory.length})</h4>
                <button onclick="showAddItemToUser()" class="px-4 py-2 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700">
                    + Add Item
                </button>
            </div>
            
            <div id="user-inventory-list" class="grid grid-cols-4 gap-3 mb-6 max-h-64 overflow-y-auto custom-scrollbar">
                ${inventory.length === 0 ? 
                    '<p class="col-span-4 text-neutral-600 text-xs text-center py-10">Empty inventory</p>' :
                    inventory.map((item, idx) => {
                        const rarityColor = item.rarity >= 5 ? 'border-amber-500/50 bg-amber-900/20' : 
                                           (item.rarity === 4 ? 'border-purple-500/50 bg-purple-900/20' : 'border-white/10 bg-white/5');
                        return `
                            <div class="p-3 ${rarityColor} border rounded-xl relative group">
                                <button onclick="removeItemFromUser('${item.id}')" 
                                        class="absolute top-1 right-1 w-5 h-5 bg-red-600/80 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="x" class="w-3 h-3 text-white"></i>
                                </button>
                                <div class="text-2xl text-center mb-1">${item.icon || 'üì¶'}</div>
                                <p class="text-[10px] text-white text-center font-bold truncate">${item.name}</p>
                                <p class="text-[8px] text-neutral-500 text-center">${"‚òÖ".repeat(item.rarity)}</p>
                            </div>
                        `;
                    }).join('')
                }
            </div>
            
            <div id="add-item-section" class="hidden bg-black/50 border border-green-500/30 rounded-xl p-4">
                <h5 class="text-xs font-bold text-green-400 mb-3">Select Item to Add</h5>
                <div class="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto custom-scrollbar">
                    ${itemMasterList.map(item => `
                        <button onclick="addItemToUser('${item.id}')" 
                                class="p-2 bg-neutral-800 hover:bg-green-600 border border-white/10 hover:border-green-500 rounded-lg transition-all text-left">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${item.icon || 'üì¶'}</span>
                                <div class="flex-1 min-w-0">
                                    <p class="text-[10px] text-white font-bold truncate">${item.name}</p>
                                    <p class="text-[8px] text-neutral-500">${item.type}</p>
                                </div>
                            </div>
                        </button>
                    `).join('')}
                </div>
                <button onclick="hideAddItemToUser()" class="mt-3 w-full py-2 bg-neutral-700 text-neutral-300 text-xs font-bold rounded-lg">
                    Cancel
                </button>
            </div>
        `;
        
        if (typeof lucide !== 'undefined') lucide.createIcons();
    } catch(e) {
        console.error("Failed to load inventory:", e);
        content.innerHTML = '<p class="text-red-500 text-sm text-center py-10">Error loading inventory</p>';
    }
};

window.showAddItemToUser = () => {
    document.getElementById('add-item-section').classList.remove('hidden');
};

window.hideAddItemToUser = () => {
    document.getElementById('add-item-section').classList.add('hidden');
};

window.addItemToUser = async (itemMasterId) => {
    if (!currentManagingUserId) return;
    
    try {
        const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'item_master', itemMasterId);
        const itemSnap = await getDoc(itemRef);
        
        if (!itemSnap.exists()) {
            showToast("Item not found!");
            return;
        }
        
        const itemData = itemSnap.data();
        const newItem = {
            ...itemData,
            id: `item_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            acquiredAt: Date.now(),
            addedByAdmin: true
        };
        
        // users Ïª¨Î†âÏÖòÏóê Ï†ÄÏû•
        const userRef = doc(db, 'artifacts', appId, 'users', currentManagingUserId);
        const userSnap = await getDoc(userRef);
        const currentInventory = userSnap.exists() ? (userSnap.data().inventory || []) : [];
        const newInventory = [...currentInventory, newItem];
        
        await setDoc(userRef, {
            inventory: newInventory
        }, { merge: true });
        
        // accounts Ïª¨Î†âÏÖòÏóêÎèÑ ÎèôÍ∏∞Ìôî
        const user = state.accounts.find(a => a.uid === currentManagingUserId);
        if (user && user.loginId) {
            const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', user.loginId);
            await setDoc(accountRef, {
                inventory: newInventory
            }, { merge: true });
            
            // Î°úÏª¨ state ÏóÖÎç∞Ïù¥Ìä∏
            const accountIdx = state.accounts.findIndex(a => a.uid === currentManagingUserId);
            if (accountIdx !== -1) {
                state.accounts[accountIdx].inventory = newInventory;
                
                // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†ÄÍ∞Ä ÏàòÏ†ïÎêú Í≤ΩÏö∞
                if (state.userAccount && state.userAccount.uid === currentManagingUserId) {
                    state.userAccount.inventory = newInventory;
                }
            }
        }
        
        showToast("Item added successfully!");
        
        if (user) {
            openAdminInventoryManager(user.loginId);
        }
    } catch(e) {
        console.error("Failed to add item:", e);
        showToast("Error adding item!");
    }
};

window.removeItemFromUser = async (itemId) => {
    if (!currentManagingUserId) return;
    if (!confirm("Are you sure you want to remove this item?")) return;
    
    try {
        // users Ïª¨Î†âÏÖòÏóêÏÑú ÏÇ≠Ï†ú
        const userRef = doc(db, 'artifacts', appId, 'users', currentManagingUserId);
        const userSnap = await getDoc(userRef);
        
        if (!userSnap.exists()) return;
        
        const currentInventory = userSnap.data().inventory || [];
        const newInventory = currentInventory.filter(item => item.id !== itemId);
        
        await setDoc(userRef, {
            inventory: newInventory
        }, { merge: true });
        
        // accounts Ïª¨Î†âÏÖòÏóêÎèÑ ÎèôÍ∏∞Ìôî
        const user = state.accounts.find(a => a.uid === currentManagingUserId);
        if (user && user.loginId) {
            const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', user.loginId);
            await setDoc(accountRef, {
                inventory: newInventory
            }, { merge: true });
            
            // Î°úÏª¨ state ÏóÖÎç∞Ïù¥Ìä∏
            const accountIdx = state.accounts.findIndex(a => a.uid === currentManagingUserId);
            if (accountIdx !== -1) {
                state.accounts[accountIdx].inventory = newInventory;
                
                // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†ÄÍ∞Ä ÏàòÏ†ïÎêú Í≤ΩÏö∞
                if (state.userAccount && state.userAccount.uid === currentManagingUserId) {
                    state.userAccount.inventory = newInventory;
                }
            }
        }
        
        showToast("Item removed!");
        
        if (user) {
            openAdminInventoryManager(user.loginId);
        }
    } catch(e) {
        console.error("Failed to remove item:", e);
        showToast("Error removing item!");
    }
};

window.closeAdminInventoryModal = () => {
    document.getElementById('admin-inventory-modal').classList.add('hidden');
    currentManagingUserId = null;
};

/* ============================================
   ÏÉÅÏ†ê ÏãúÏä§ÌÖú (ÏµúÏ†ÅÌôî: Firebase ÏùΩÍ∏∞ Ï∫êÏã± + NPC ÎåÄÏÇ¨ ÌôïÏû• + NPC ÌÑ∞Ïπò Î∞òÏùë)
   ============================================ */

/* ‚îÄ‚îÄ Ï∫êÏãú Î≥ÄÏàò (Ïï± ÏÑ∏ÏÖò Ï§ë 1ÌöåÎßå Î°úÎî©) ‚îÄ‚îÄ */
let _shopCache = null;          // { items: [], npcConfig: {}, loadedAt: 0 }
let shopAccountUnsub = null;

const SHOP_CACHE_TTL = 5 * 60 * 1000; // 5Î∂Ñ (NPC ÏÑ§Ï†ï Ï†ÄÏû• Ïãú ÏûêÎèô Î¨¥Ìö®Ìôî)

async function loadShopData(forceReload = false) {
    const now = Date.now();
    if (!forceReload && _shopCache && (now - _shopCache.loadedAt) < SHOP_CACHE_TTL) {
        console.log("üõí ÏÉÅÏ†ê Ï∫êÏãú ÏÇ¨Ïö© (Firebase ÏùΩÍ∏∞ Ï†àÏïΩ)");
        return _shopCache;
    }

    console.log("üõí ÏÉÅÏ†ê Firebase Î°úÎî© (ÏµúÏ¥à or Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®)");

    // NPC ÏÑ§Ï†ï Î°úÎî©
    let npcConfig = {
        name: "Sonetto",
        image: "https://i.pinimg.com/564x/cd/6d/46/cd6d460877960309a473467406a66596.jpg",
        defaultText: "Timekeeper, supplies have arrived. Please take a look.",
        greetTexts: [
            "Ah, welcome back. Looking for something special?",
            "I was expecting you. Come, see what I have.",
            "The finest selection awaits, as always."
        ],
        selectTexts: [
            "A fine choice, I must say.",
            "Oh? You have refined taste.",
            "That item has caught many eyes.",
            "A necessary supply for what lies ahead."
        ],
        buyTexts: [
            "A pleasure doing business with you.",
            "May it serve you well.",
            "Excellent. That item will not disappoint.",
            "Transaction complete. A wise investment."
        ],
        touchTexts: [
            "..Is something the matter?",
            "Please, browse at your leisure.",
            "I assure you, every item is authentic.",
            "Take your time. No rush here."
        ]
    };

    try {
        const npcSnap = await getDoc(doc(window.db, 'artifacts', window.appId, 'public', 'npcConfig_shop'));
        if (npcSnap.exists()) {
            npcConfig = { ...npcConfig, ...npcSnap.data() };
        }
    } catch(e) { console.log("NPC Config error, using default."); }

    // ÏïÑÏù¥ÌÖú Î™©Î°ù Î°úÎî©
    const itemsRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'item_master');
    const snapshot = await getDocs(itemsRef);
    const items = snapshot.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .filter(item => item.price > 0 && item.availability?.inShop);

    _shopCache = { items, npcConfig, loadedAt: Date.now() };
    return _shopCache;
}

window.renderShop = async () => {
    const contentArea = document.getElementById('content-area');
    const isAdmin = state.isAdmin;

    // Ïã§ÏãúÍ∞Ñ ÏΩîÏù∏ Î¶¨Ïä§ÎÑà (ÏÉÅÏ†ê ÏßÑÏûÖ Ïãú 1ÌöåÎßå ÏÑ§Ï†ï)
    if (shopAccountUnsub) shopAccountUnsub();
    if (state.userAccount?.loginId) {
        const myAccountRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'accounts', state.userAccount.loginId);
        shopAccountUnsub = onSnapshot(myAccountRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                state.userAccount.gold = data.coins || 0;
                state.userAccount.inventory = data.inventory || [];
                const coinDisplay = document.getElementById('shop-coins-display');
                if (coinDisplay) coinDisplay.innerText = state.userAccount.gold.toLocaleString();
            }
        });
    }

    // Î°úÎî© ÌôîÎ©¥
    contentArea.innerHTML = `
        <div class="flex-1 flex items-center justify-center bg-[#080808]">
            <div class="flex flex-col items-center gap-4">
                <div class="w-12 h-[1px] bg-amber-600/50"></div>
                <div class="text-xs font-serif text-amber-600 tracking-[0.4em] animate-pulse uppercase">Accessing Boutique</div>
            </div>
        </div>`;

    try {
        const { items: shopItems, npcConfig } = await loadShopData();

        // ÏûÖÏû• ÎåÄÏÇ¨ (greetTextsÏóêÏÑú ÎûúÎç§)
        const greetList = npcConfig.greetTexts || [npcConfig.defaultText];
        const greetText = greetList[Math.floor(Math.random() * greetList.length)];

        contentArea.innerHTML = `
        <style>
            @keyframes npcShake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-4px)} 40%{transform:translateX(4px)} 60%{transform:translateX(-3px)} 80%{transform:translateX(3px)} }
            @keyframes npcGlow { 0%{box-shadow:0 0 0 0 rgba(217,119,6,0)} 50%{box-shadow:0 0 30px 5px rgba(217,119,6,0.3)} 100%{box-shadow:0 0 0 0 rgba(217,119,6,0)} }
            .npc-portrait-area { cursor: pointer; transition: filter 0.3s; }
            .npc-portrait-area:hover img { filter: brightness(1.1); }
            .npc-portrait-area.npc-touched { animation: npcGlow 0.6s ease-out; }
            #npc-text { transition: opacity 0.3s ease; }
        </style>

        <div class="flex-1 flex bg-[#050505] overflow-hidden animate-fade-in relative h-full w-full select-none font-serif">
            
            <!-- NPC Ìå®ÎÑê (ÌÅ¥Î¶≠ Í∞ÄÎä•) -->
            <div class="w-[400px] relative h-full border-r border-white/5 overflow-hidden z-20 shadow-[20px_0_50px_rgba(0,0,0,0.8)]">
                <div class="absolute inset-0 bg-[#0a0a0a]"></div>

                <!-- NPC Ïù¥ÎØ∏ÏßÄ (ÌÑ∞Ïπò Î∞òÏùë ÏòÅÏó≠) -->
                <div id="npc-portrait-area" class="npc-portrait-area absolute inset-0 z-0" onclick="handleNpcTouch()">
                    <img id="npc-portrait" src="${npcConfig.image}" class="w-full h-full object-cover object-top opacity-90 transition-all duration-1000">
                    <div class="absolute bottom-0 left-0 w-full h-[40%] bg-gradient-to-t from-[#050505] via-[#050505]/90 to-transparent"></div>
                    <!-- ÌÑ∞Ïπò ÌûåÌä∏ -->
                    <div class="absolute top-4 right-4 opacity-0 hover:opacity-100 transition-opacity">
                        <span class="text-[8px] text-amber-500/60 font-mono tracking-widest uppercase bg-black/40 px-2 py-1 rounded">tap me</span>
                    </div>
                </div>

                ${isAdmin ? `
                <button onclick="openNpcEditor()" class="absolute top-6 left-6 z-50 p-2 text-white/20 hover:text-amber-500 bg-black/20 hover:bg-black/50 rounded-full transition-all backdrop-blur-sm">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                </button>` : ''}

                <div class="absolute bottom-0 left-0 w-full p-8 z-20 flex flex-col items-start pointer-events-none">
                    <div class="flex items-center gap-3 mb-2 opacity-70">
                        <div class="w-1.5 h-1.5 rotate-45 border border-amber-500/50"></div>
                        <div class="w-8 h-[1px] bg-amber-500/50"></div>
                        <span class="text-[9px] text-amber-500/80 tracking-[0.3em] uppercase">Reception</span>
                    </div>

                    <h2 class="text-3xl text-white italic font-light tracking-wide mb-6 drop-shadow-lg">
                        ${npcConfig.name}
                    </h2>

                    <div class="relative w-full pointer-events-auto">
                        <div class="w-full min-h-[120px] bg-gradient-to-br from-white/10 to-transparent border-l-[2px] border-amber-600/60 backdrop-blur-sm p-5 relative">
                            <p id="npc-text" class="text-[#e5e5e5] text-xs leading-6 tracking-wide font-light">
                                "${greetText}"
                            </p>
                            <i data-lucide="quote" class="absolute bottom-3 right-3 w-4 h-4 text-amber-600/30 rotate-180"></i>
                        </div>
                    </div>

                    <button onclick="if(shopAccountUnsub) shopAccountUnsub(); renderOperation();"
                        class="mt-8 flex items-center gap-3 text-[10px] text-neutral-500 hover:text-amber-500 transition-colors tracking-[0.2em] uppercase group pointer-events-auto">
                        <span class="w-6 h-[1px] bg-neutral-700 group-hover:bg-amber-500 transition-colors"></span>
                        Leave Boutique
                    </button>
                </div>
            </div>

            <!-- ÏïÑÏù¥ÌÖú Ìå®ÎÑê -->
            <div class="flex-1 flex flex-col relative z-10">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5 pointer-events-none"></div>

                <div class="px-10 pt-10 pb-4 flex justify-between items-end border-b border-white/5 mx-6 bg-gradient-to-b from-[#050505] to-transparent z-20">
                    <div>
                        <h2 class="text-4xl font-light text-white tracking-widest uppercase italic font-serif">Artifacts</h2>
                        <p class="text-[9px] text-amber-600/80 mt-1 tracking-[0.4em] uppercase">Exchange & Supply</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-[9px] text-neutral-600 uppercase tracking-widest mb-1">Current Assets</span>
                        <div class="flex items-center gap-2 border border-white/10 bg-white/5 px-3 py-1.5 rounded-sm">
                            <span id="shop-coins-display" class="text-xl font-medium text-amber-500 font-serif">
                                ${state.userAccount.gold ? state.userAccount.gold.toLocaleString() : 0}
                            </span>
                            <span class="text-[9px] text-neutral-400 uppercase tracking-wider">Coins</span>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar px-10 py-8">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-w-7xl mx-auto pb-20">
                        ${shopItems.length === 0 ?
                            '<p class="col-span-full text-center text-neutral-600 py-20 font-serif italic text-sm">Inventory Empty.</p>' :
                            shopItems.map(item => {
                                const isHighRank = item.rarity >= 5;
                                const borderColor = isHighRank ? 'border-amber-600/40' : 'border-white/10';
                                const hoverBorder = isHighRank ? 'group-hover:border-amber-500' : 'group-hover:border-white/40';
                                const glow = isHighRank ? 'shadow-[0_0_15px_rgba(217,119,6,0.15)]' : '';
                                return `
                                <div onclick="handleShopItemClick('${item.id}', ${item.price}, '${item.name.replace(/'/g,"\\\'")}')"
                                     class="group relative h-[220px] bg-[#0f0f0f] border ${borderColor} ${hoverBorder} ${glow} cursor-pointer transition-all duration-300 overflow-hidden hover:-translate-y-1">
                                    <div class="absolute -right-2 -bottom-2 text-[5rem] opacity-5 group-hover:opacity-10 transition-opacity duration-500 select-none grayscale group-hover:grayscale-0">
                                        ${item.icon || '‚ú¶'}
                                    </div>
                                    <div class="absolute inset-0 p-5 flex flex-col justify-between z-10">
                                        <div class="flex justify-between items-start">
                                            <span class="text-[8px] font-bold px-1.5 py-0.5 bg-black/50 border border-white/10 text-neutral-400 uppercase tracking-widest">
                                                Rank ${item.rarity || 1}
                                            </span>
                                            <div class="flex items-center gap-1 text-amber-500">
                                                <i data-lucide="coins" class="w-3 h-3"></i>
                                                <span class="text-xs font-bold font-mono">${item.price.toLocaleString()}</span>
                                            </div>
                                        </div>
                                        <div class="relative">
                                            <div class="w-6 h-[1px] bg-white/20 mb-2 group-hover:w-full group-hover:bg-amber-600/50 transition-all duration-500"></div>
                                            <h3 class="text-sm font-bold text-white uppercase tracking-wide group-hover:text-amber-500 transition-colors mb-1 truncate">
                                                ${item.name}
                                            </h3>
                                            <p class="text-[10px] text-neutral-500 font-light leading-snug line-clamp-2 group-hover:text-neutral-300">
                                                ${item.description || 'No description.'}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="absolute inset-0 bg-gradient-to-t from-amber-900/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                                </div>`;
                            }).join('')
                        }
                    </div>
                </div>
            </div>

            <!-- NPC ÏóêÎîîÌÑ∞ Î™®Îã¨ (Í¥ÄÎ¶¨ÏûêÏö©) -->
            <div id="npc-editor-modal" class="hidden fixed inset-0 z-[300] bg-black/90 flex items-center justify-center backdrop-blur-md p-6">
                <div class="w-full max-w-lg bg-[#0f0f0f] border border-amber-600/30 p-8 shadow-2xl relative overflow-y-auto max-h-[90vh]">
                    <h3 class="text-2xl font-serif text-white italic mb-2 text-center">Configure Persona</h3>
                    <p class="text-[9px] text-amber-500/60 text-center tracking-widest uppercase mb-8">NPC ÏÑ§Ï†ï & ÎåÄÏÇ¨ Ìé∏Ïßë</p>
                    
                    <div class="space-y-5">
                        <!-- Í∏∞Î≥∏ ÏÑ§Ï†ï -->
                        <div>
                            <label class="text-[9px] text-neutral-500 uppercase tracking-widest font-bold block mb-1">NPC Ïù¥Î¶Ñ</label>
                            <input id="npc-edit-name" type="text" value="${npcConfig.name}" class="w-full bg-black border border-white/20 rounded-lg px-4 py-2.5 text-white text-sm outline-none focus:border-amber-500">
                        </div>
                        <div>
                            <label class="text-[9px] text-neutral-500 uppercase tracking-widest font-bold block mb-1">NPC Ïù¥ÎØ∏ÏßÄ URL</label>
                            <input id="npc-edit-image" type="text" value="${npcConfig.image}" class="w-full bg-black border border-white/20 rounded-lg px-4 py-2.5 text-white text-sm outline-none focus:border-amber-500">
                        </div>

                        <!-- ÏûÖÏû• ÎåÄÏÇ¨ -->
                        <div>
                            <label class="text-[9px] text-amber-500/80 uppercase tracking-widest font-bold block mb-1">
                                üö™ ÏûÖÏû• ÎåÄÏÇ¨ <span class="text-neutral-600">(Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂Ñ, ÎûúÎç§ Ï∂úÎ†•)</span>
                            </label>
                            <textarea id="npc-edit-greet" class="w-full bg-black border border-white/20 rounded-lg px-4 py-2.5 text-white text-xs h-20 outline-none focus:border-amber-500 leading-6">${(npcConfig.greetTexts || [npcConfig.defaultText]).join('\n')}</textarea>
                        </div>

                        <!-- ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù ÎåÄÏÇ¨ -->
                        <div>
                            <label class="text-[9px] text-blue-400/80 uppercase tracking-widest font-bold block mb-1">
                                üëÜ ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù Ïãú ÎåÄÏÇ¨ <span class="text-neutral-600">(Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂Ñ, ÎûúÎç§ Ï∂úÎ†•)</span>
                            </label>
                            <textarea id="npc-edit-select" class="w-full bg-black border border-white/20 rounded-lg px-4 py-2.5 text-white text-xs h-20 outline-none focus:border-amber-500 leading-6">${(npcConfig.selectTexts || ["A fine choice, I must say.","Oh? You have refined taste.","That item has caught many eyes.","A necessary supply for what lies ahead."]).join('\n')}</textarea>
                        </div>

                        <!-- Íµ¨Îß§ ÏôÑÎ£å ÎåÄÏÇ¨ -->
                        <div>
                            <label class="text-[9px] text-green-400/80 uppercase tracking-widest font-bold block mb-1">
                                üí∞ Íµ¨Îß§ ÏôÑÎ£å ÎåÄÏÇ¨ <span class="text-neutral-600">(Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂Ñ, ÎûúÎç§ Ï∂úÎ†•)</span>
                            </label>
                            <textarea id="npc-edit-buy" class="w-full bg-black border border-white/20 rounded-lg px-4 py-2.5 text-white text-xs h-20 outline-none focus:border-amber-500 leading-6">${(npcConfig.buyTexts || ["A pleasure doing business with you.","May it serve you well.","Excellent. That item will not disappoint.","Transaction complete. A wise investment."]).join('\n')}</textarea>
                        </div>

                        <!-- NPC ÌÑ∞Ïπò ÎåÄÏÇ¨ -->
                        <div>
                            <label class="text-[9px] text-purple-400/80 uppercase tracking-widest font-bold block mb-1">
                                ‚ú® NPC ÌÑ∞Ïπò Ïãú ÎåÄÏÇ¨ <span class="text-neutral-600">(Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂Ñ, ÎûúÎç§ Ï∂úÎ†•)</span>
                            </label>
                            <textarea id="npc-edit-touch" class="w-full bg-black border border-white/20 rounded-lg px-4 py-2.5 text-white text-xs h-20 outline-none focus:border-amber-500 leading-6">${(npcConfig.touchTexts || ["..Is something the matter?","Please, browse at your leisure.","I assure you, every item is authentic.","Take your time. No rush here."]).join('\n')}</textarea>
                        </div>
                    </div>

                    <div class="flex gap-4 mt-8">
                        <button onclick="document.getElementById('npc-editor-modal').classList.add('hidden')" 
                                class="flex-1 py-3 text-white bg-neutral-800 rounded-lg text-xs font-bold uppercase tracking-widest hover:bg-neutral-700 transition-colors">
                            Cancel
                        </button>
                        <button onclick="saveNpcConfig()" 
                                class="flex-1 py-3 text-black bg-amber-600 rounded-lg text-xs font-bold uppercase tracking-widest hover:bg-amber-500 transition-colors">
                            Save Config
                        </button>
                    </div>
                </div>
            </div>
        </div>`;

        if (window.lucide) lucide.createIcons();

    } catch (e) {
        console.error("Shop Error:", e);
        contentArea.innerHTML = `<div class="flex h-full items-center justify-center text-red-500 font-serif">System Malfunction.</div>`;
    }
};

/* --- NPC ÎåÄÏÇ¨ ÏóÖÎç∞Ïù¥Ìä∏ (ÌéòÏù¥Îìú Ìö®Í≥º) --- */
window.updateNPCText = (text) => {
    const el = document.getElementById('npc-text');
    if (!el) return;
    el.style.opacity = '0';
    setTimeout(() => {
        el.innerText = `"${text}"`;
        el.style.opacity = '1';
    }, 300);
};

/* --- NPC ÌÑ∞Ïπò Î∞òÏùë --- */
window.handleNpcTouch = () => {
    const cache = _shopCache;
    if (!cache) return;
    const touchList = cache.npcConfig.touchTexts;
    if (!touchList || touchList.length === 0) return;

    const text = touchList[Math.floor(Math.random() * touchList.length)];
    window.updateNPCText(text);

    // Ïù¥ÎØ∏ÏßÄ ÏòÅÏó≠ ÌùîÎì§Í∏∞ Ìö®Í≥º
    const area = document.getElementById('npc-portrait-area');
    if (area) {
        area.classList.remove('npc-touched');
        void area.offsetWidth; // reflow
        area.classList.add('npc-touched');
        // Ïù¥ÎØ∏ÏßÄ ÏÇ¥Ïßù Î∞òÏùë (Ïä§ÏºÄÏùº)
        const img = document.getElementById('npc-portrait');
        if (img) {
            img.style.transform = 'scale(1.03)';
            setTimeout(() => { img.style.transform = 'scale(1)'; }, 600);
        }
    }
};

/* --- ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ (ÏÑ†ÌÉù ÎåÄÏÇ¨) --- */
window.handleShopItemClick = (id, price, name) => {
    const cache = _shopCache;
    if (cache && cache.npcConfig.selectTexts?.length > 0) {
        const list = cache.npcConfig.selectTexts;
        window.updateNPCText(list[Math.floor(Math.random() * list.length)]);
    } else {
        window.updateNPCText(`"${name}"... A fascinating choice.`);
    }
    if (window.buyShopItem) {
        window.buyShopItem(id, price, name);
    } else {
        console.error("buyShopItem function missing!");
    }
};

/* --- Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï Ï†ÄÏû• (Ï∫êÏãú Î¨¥Ìö®Ìôî Ìè¨Ìï®) --- */
window.openNpcEditor = () => document.getElementById('npc-editor-modal').classList.remove('hidden');

window.saveNpcConfig = async () => {
    const parseLines = (id) => document.getElementById(id).value
        .split('\n').map(s => s.trim()).filter(Boolean);

    const config = {
        name: document.getElementById('npc-edit-name').value.trim(),
        image: document.getElementById('npc-edit-image').value.trim(),
        defaultText: parseLines('npc-edit-greet')[0] || "Welcome.",
        greetTexts: parseLines('npc-edit-greet'),
        selectTexts: parseLines('npc-edit-select'),
        buyTexts: parseLines('npc-edit-buy'),
        touchTexts: parseLines('npc-edit-touch')
    };

    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'npcConfig_shop'), config);
        _shopCache = null; // Ï∫êÏãú Î¨¥Ìö®Ìôî ‚Üí Îã§Ïùå ÏßÑÏûÖ Ïãú Ïû¨Î°úÎî©
        document.getElementById('npc-editor-modal').classList.add('hidden');
        renderShop(); // Ï¶âÏãú Î¶¨Î†åÎçîÎßÅ
    } catch(e) { alert("Error saving configuration: " + e.message); }
};

/* --- Íµ¨Îß§ Ìï®Ïàò (ÎèÖÎ¶ΩÌòï ÏïàÏ†Ñ Î°úÏßÅ) --- */
window.buyShopItem = async (itemId, price, itemName) => {
    // 1. ÌòÑÏû¨ ÏΩîÏù∏ ÌôïÏù∏ (stateÏóêÏÑú Í∞ÄÏ†∏Ïò¥)
    const currentGold = state.userAccount.gold || 0;

    if (currentGold < price) {
        window.updateNPCText("Insufficient funds. I cannot offer charity.");
        return;
    }

    if (!confirm(`Purchase [${itemName}] for ${price} coins?`)) return;

    try {
        const myId = state.userAccount.loginId;
        const myUid = state.userAccount.uid; // uidÎèÑ ÌïÑÏöîÌï† Ïàò ÏûàÏùå

        // 2. DB Ï∞∏Ï°∞ (accounts Î∞è users Ïª¨Î†âÏÖò Î™®Îëê ÏóÖÎç∞Ïù¥Ìä∏)
        // accounts Ïª¨Î†âÏÖò (Î©îÏù∏ Îç∞Ïù¥ÌÑ∞)
        const accountRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'accounts', myId);
        
        // users Ïª¨Î†âÏÖò (Î≥¥Ï°∞ Îç∞Ïù¥ÌÑ∞ - Í≤åÏûÑ Îì±ÏóêÏÑú ÏÇ¨Ïö©)
        // uidÍ∞Ä ÏûàÏúºÎ©¥ users Ïª¨Î†âÏÖòÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÎèÑ
        let userRef = null;
        if (myUid) {
            userRef = doc(window.db, 'artifacts', window.appId, 'users', myUid);
        }

        // 3. Ïù∏Î≤§ÌÜ†Î¶¨ ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
        const currentInventory = state.userAccount.inventory || [];
        const newItem = {
            id: itemId,
            name: itemName,
            uid: Date.now().toString() + Math.random().toString(36).substr(2,5), // Í≥†Ïú† ID ÏÉùÏÑ±
            purchasedAt: Date.now()
        };
        const newInventory = [...currentInventory, newItem];
        const newGold = currentGold - price;

        // 4. DB ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìñâ
        const updates = {
            coins: newGold, // coins ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏
            gold: newGold,  // gold ÌïÑÎìúÎèÑ Í∞ôÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ (Ìò∏ÌôòÏÑ± ÏúÑÌï®)
            inventory: newInventory
        };

        await updateDoc(accountRef, updates);
        
        if (userRef) {
            // users Ïª¨Î†âÏÖòÏù¥ ÏóÜÏúºÎ©¥ ÏÉùÏÑ±(setDoc merge), ÏûàÏúºÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            await setDoc(userRef, updates, { merge: true });
        }

        // 5. Î°úÏª¨ ÏÉÅÌÉú Ï¶âÏãú Î∞òÏòÅ (Î¶¨Ïä§ÎÑàÍ∞Ä Îä¶Í≤å Îèå Í≤ΩÏö∞Î•º ÎåÄÎπÑ)
        state.userAccount.gold = newGold;
        state.userAccount.inventory = newInventory;
        
        // ÏÉÅÎã® ÏΩîÏù∏ UI Í∞ïÏ†ú Í∞±Ïã†
        const coinDisplay = document.getElementById('shop-coins-display');
        if (coinDisplay) coinDisplay.innerText = newGold.toLocaleString();

        // 6. NPC Íµ¨Îß§ ÏôÑÎ£å ÎåÄÏÇ¨ (Ï∫êÏãúÏóêÏÑú buyTexts Ï∞∏Ï°∞)
        if (window.updateNPCText) {
            const buyList = _shopCache?.npcConfig?.buyTexts;
            if (buyList && buyList.length > 0) {
                window.updateNPCText(buyList[Math.floor(Math.random() * buyList.length)]);
            } else {
                window.updateNPCText(`Transaction complete. "${itemName}" is now yours.`);
            }
        }
        
    } catch (e) {
        console.error("Purchase Failed:", e);
        if (window.updateNPCText) {
            window.updateNPCText("Transaction error. System malfunctioning.");
        }
        alert("Íµ¨Îß§ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message);
    }
};
/* ============================================
   ÏÑ†Î¨º Í∏∞Îä•
   ============================================ */

let giftTargetId = null;
let selectedGiftItemId = null;

window.openGiftModal = async (targetLoginId) => {
    giftTargetId = targetLoginId;
    const myInventory = state.userAccount.inventory || [];
    
    if (myInventory.length === 0) {
        showToast("You have no items to gift!");
        return;
    }
    
    const modal = document.getElementById('gift-modal');
    const content = document.getElementById('gift-items-list');
    
    if (!modal || !content) {
        console.error("Gift modal not found");
        return;
    }
    
    content.innerHTML = myInventory.map((item, index) => {
        const rarityColor = item.rarity >= 5 ? 'border-amber-500/50 bg-amber-900/20' : 
                           (item.rarity === 4 ? 'border-purple-500/50 bg-purple-900/20' : 'border-white/10 bg-white/5');
        const isSelected = selectedGiftItemId === item.id;
        return `
            <div class="gift-item p-4 ${rarityColor} ${isSelected ? 'ring-2 ring-amber-500' : ''} border-2 rounded-xl hover:scale-105 transition-all cursor-pointer"
                 data-item-id="${item.id}"
                 data-item-index="${index}">
                <div class="text-3xl text-center mb-2">${item.icon || 'üì¶'}</div>
                <p class="text-xs text-white text-center font-bold truncate">${item.name}</p>
                <p class="text-[8px] text-neutral-500 text-center mt-1">${"‚òÖ".repeat(item.rarity)}</p>
            </div>
        `;
    }).join('');
    
    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    content.querySelectorAll('.gift-item').forEach((itemEl, index) => {
        itemEl.addEventListener('click', () => {
            const itemId = myInventory[index].id;
            console.log('ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠:', itemId, myInventory[index]);
            selectGiftItem(itemId);
        });
    });
    
    modal.classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.selectGiftItem = (itemId) => {
    selectedGiftItemId = itemId;
    
    // Î™®Îì† ÏïÑÏù¥ÌÖúÏóêÏÑú ÏÑ†ÌÉù ÌëúÏãú Ï†úÍ±∞
    const allItems = document.querySelectorAll('.gift-item');
    allItems.forEach(item => {
        item.classList.remove('ring-2', 'ring-amber-500');
    });
    
    // ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖúÏóê ÌëúÏãú Ï∂îÍ∞Ä
    const selectedItem = document.querySelector(`.gift-item[data-item-id="${itemId}"]`);
    if (selectedItem) {
        selectedItem.classList.add('ring-2', 'ring-amber-500');
    }
    
    console.log('‚úÖ ÏÑ†Î¨º ÏïÑÏù¥ÌÖú ÏÑ†ÌÉùÎê®:', itemId);
};

window.sendGift = async () => {
    if (!giftTargetId || !selectedGiftItemId) {
        showToast("Please select an item to send!");
        return;
    }
    
    if (!confirm("Are you sure you want to send this gift?")) return;
    
    try {
        // stateÏóêÏÑú ÏßÅÏ†ë ÏïÑÏù¥ÌÖú Ï∞æÍ∏∞
        const myInventory = state.userAccount.inventory || [];
        const item = myInventory.find(i => i.id === selectedGiftItemId);
        
        if (!item) {
            showToast("Item not found in your inventory!");
            console.log("Available items:", myInventory.map(i => i.id));
            console.log("Looking for:", selectedGiftItemId);
            return;
        }
        
        // ÎÇ¥ Ïù∏Î≤§ÌÜ†Î¶¨ÏóêÏÑú Ï†úÍ±∞
        const newMyInventory = myInventory.filter(i => i.id !== selectedGiftItemId);
        
        // users Ïª¨Î†âÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        const userRef = doc(db, 'artifacts', appId, 'users', state.user.uid);
        await setDoc(userRef, { inventory: newMyInventory }, { merge: true });
        
        // accounts Ïª¨Î†âÏÖòÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        const accountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', state.userAccount.loginId);
        await setDoc(accountRef, { inventory: newMyInventory }, { merge: true });
        
        // Î°úÏª¨ state ÏóÖÎç∞Ïù¥Ìä∏
        state.userAccount.inventory = newMyInventory;
        
        // ÌÉÄÍ≤ü Ïú†Ï†Ä Ï∞æÍ∏∞
        const targetAccount = state.accounts.find(a => a.loginId === giftTargetId);
        if (!targetAccount || !targetAccount.uid) {
            showToast("Target user not found!");
            return;
        }
        
        // ÌÉÄÍ≤ü Ïù∏Î≤§ÌÜ†Î¶¨ Í∞ÄÏ†∏Ïò§Í∏∞
        const targetRef = doc(db, 'artifacts', appId, 'users', targetAccount.uid);
        const targetSnap = await getDoc(targetRef);
        const targetInventory = targetSnap.exists() ? (targetSnap.data().inventory || []) : [];
        
        // ÏÑ†Î¨º ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
        const giftItem = {
            ...item,
            giftFrom: state.userAccount.loginId,
            giftFromName: state.userAccount.ocName,
            giftedAt: Date.now()
        };
        
        const newTargetInventory = [...targetInventory, giftItem];
        
        // ÌÉÄÍ≤ü users Ïª¨Î†âÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        await setDoc(targetRef, {
            inventory: newTargetInventory
        }, { merge: true });
        
        // ÌÉÄÍ≤ü accounts Ïª¨Î†âÏÖòÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        const targetAccountRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', giftTargetId);
        await setDoc(targetAccountRef, {
            inventory: newTargetInventory
        }, { merge: true });
        
        // ÏïåÎ¶º ÏÉùÏÑ±
        const notiRef = collection(db, 'artifacts', appId, 'public', 'data', 'notifications');
        await addDoc(notiRef, {
            targetUserId: giftTargetId,
            title: "üéÅ Gift Received!",
            message: `${state.userAccount.ocName} sent you ${item.name}`,
            memo: `From: ${state.userAccount.ocName}`,
            timestamp: serverTimestamp(),
            isRead: false
        });
        
        showToast("Gift sent successfully!");
        closeGiftModal();
        
    } catch(e) {
        console.error("Failed to send gift:", e);
        showToast("Error sending gift!");
    }
};

window.closeGiftModal = () => {
    const modal = document.getElementById('gift-modal');
    if (modal) modal.classList.add('hidden');
    giftTargetId = null;
    selectedGiftItemId = null;
};

</script>
</body>
</html>
